(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{1469:(e,t,i)=>{Promise.resolve().then(i.bind(i,3160))},3160:(e,t,i)=>{"use strict";i.d(t,{default:()=>e$});var l=i(5155);let r={invalidDrop:"無効なドロップ操作です",dropChildElement:"子要素にドロップすることはできません",dropSelfChild:"自身の子要素に移動することはできません",dropCircularReference:"循環参照となるため移動できません",dropInvalidHierarchy:"要素の階層構造が不正となるため移動できません",noSelect:"要素を選択してから実行してください",dragError:"ドラッグ操作中にエラーが発生しました",aiError:"AI処理に失敗しました",noApiKey:"APIキーが設定されていません",noPrompt:"入力情報(プロンプト)が設定されていません",clipboardEmpty:"クリップボードにテキストがありません",clipboardReadError:"クリップボードの読み取りに失敗しました"};var n=i(2115);let o=(0,n.createContext)(void 0),a=e=>{let{children:t,state:i,dispatch:r}=e,a=(0,n.useMemo)(()=>({state:i,dispatch:r}),[i,r]);return(0,l.jsx)(o.Provider,{value:a,children:t})},s=()=>{let e=(0,n.useContext)(o);if(!e)throw Error("useCanvas must be used within a CanvasProvider");return e};var d=i(6924),h=i(3346),c=i(8265),u=i(2226);let p=(0,n.memo)(e=>{let{x:t,y:i,width:r,height:o,text:a,zoomRatio:s,fontFamily:p,onHeightChange:x}=e,[f,g]=(0,n.useState)({width:0,height:0}),[E,m]=(0,n.useState)(!1),[y,b]=(0,n.useState)(d._K),T=(0,n.useRef)(null),O=(0,n.useRef)({width:0,height:0}),C=(0,n.useRef)(a);return((0,n.useRef)(x).current=x,(0,n.useEffect)(()=>{b((0,u.vG)())},[]),(0,n.useEffect)(()=>{let e;return m(!0),E&&(a!==C.current||r!==O.current.width||o!==O.current.height)&&(e=requestAnimationFrame(()=>{if(!T.current)return;let e=Math.min(d.SK.WIDTH.MAX,r);(0,c.c)(`[updateDimensions] text: ${a}  size: ${e} x ${o}`);let t=(0,h.C1)(a||"",e,s),i=d.gI*d.RZ*s,l=Math.max(d.SK.SECTION_HEIGHT*s,(i+d.rF.VERTICAL)*s),n=Math.max(t.length*i,l)+d.rF.VERTICAL*s,u=Math.abs(e-O.current.width)>1,p=Math.abs(n-O.current.height)>1;(u||p)&&(g({width:e,height:n}),O.current={width:e,height:n})}),C.current=a),()=>{e&&cancelAnimationFrame(e)}},[a,r,o,s,E]),E)?(0,l.jsx)("foreignObject",{x:t,y:i,width:f.width,height:Math.round(f.height/s),pointerEvents:"none",children:(0,l.jsx)("div",{ref:T,style:{fontFamily:p||d.zs,color:y,fontSize:`${d.gI}px`,lineHeight:d.RZ,width:`${f.width-d.rF.HORIZONTAL}px`,minHeight:`${d.SK.SECTION_HEIGHT}px`,padding:`${.5*d.rF.VERTICAL}px ${.5*d.rF.HORIZONTAL}px`,overflow:"hidden",whiteSpace:"pre-wrap",wordBreak:"break-word",boxSizing:"content-box"},children:a})}):null});var x=i(6670),f=i(840),g=i(9605),E=i(978),m=i(1386);let y=()=>{let[e,t]=(0,n.useState)(!1);return(0,n.useEffect)(()=>{t(!0)},[]),e},b=(e,t,i)=>((e,t)=>{if(!e.tentative)return!1;let i=Math.min(...t.filter(t=>t.parentId===e.parentId&&t.tentative).map(e=>e.order));return e.order===i})(e,i)?(0,l.jsxs)("g",{transform:`translate(${e.x+1.1*e.width},${e.y})`,onClick:e=>e.stopPropagation(),style:{cursor:"pointer",pointerEvents:"all"},children:[(0,l.jsxs)("g",{children:[(0,l.jsx)("rect",{x:"0",y:"0",width:"24",height:"24",rx:"4",fill:"white",stroke:"#e0e0e0",strokeWidth:"1"}),(0,l.jsx)("foreignObject",{x:"4",y:"4",width:"16",height:"16",children:(0,l.jsx)(f.A,{sx:{color:"#4CAF50","&:hover":{color:"#388E3C"},transition:"color 0.2s ease-in-out"},style:{width:"100%",height:"100%"},onClick:()=>t({type:"CONFIRM_TENTATIVE_ELEMENTS",payload:e.parentId})})})]}),(0,l.jsxs)("g",{transform:"translate(30, 0)",children:[(0,l.jsx)("rect",{x:"0",y:"0",width:"24",height:"24",rx:"4",fill:"white",stroke:"#e0e0e0",strokeWidth:"1"}),(0,l.jsx)("foreignObject",{x:"4",y:"4",width:"16",height:"16",children:(0,l.jsx)(g.A,{sx:{color:"#F44336","&:hover":{color:"#D32F2F"},transition:"color 0.2s ease-in-out"},style:{width:"100%",height:"100%"},onClick:()=>t({type:"CANCEL_TENTATIVE_ELEMENTS",payload:e.parentId})})})]})]}):null,T=e=>{let{element:t,isHovered:i,currentDropTarget:r,dropPosition:n,isDraggedOrDescendant:o,siblingInfo:a}=e;if(!c.y||!i)return null;let s=o?t.width+350:t.width+10;return(0,l.jsx)("foreignObject",{x:t.x+s,y:t.y-10,width:"340",height:"400",className:"debug-info",children:(0,l.jsxs)("div",{style:{fontSize:"12px",color:"black",backgroundColor:"white",border:"1px solid black",padding:"5px",borderRadius:"5px",boxShadow:"0 2px 10px rgba(0, 0, 0, 0.2)"},children:[(0,l.jsxs)("div",{children:["id: ",t.id]}),(0,l.jsxs)("div",{children:["parentID: ",t.parentId]}),(0,l.jsxs)("div",{children:["order: ",t.order]}),(0,l.jsxs)("div",{children:["depth: ",t.depth]}),(0,l.jsxs)("div",{children:["children: ",t.children]}),(0,l.jsxs)("div",{children:["arrow: ",t.connectionPathType]}),(0,l.jsxs)("div",{children:["editing: ",t.editing?"true":"false"]}),(0,l.jsxs)("div",{children:["selected: ",t.selected?"true":"false"]}),(0,l.jsxs)("div",{children:["visible: ",t.visible?"true":"false"]}),(0,l.jsxs)("div",{children:["x: ",t.x]}),(0,l.jsxs)("div",{children:["y: ",t.y]}),(0,l.jsxs)("div",{children:["width: ",t.width]}),(0,l.jsxs)("div",{children:["height: ",t.height]}),(0,l.jsxs)("div",{children:["currentDropTarget: ",r?r.texts[0]||"empty":"null"]}),(0,l.jsxs)("div",{children:["dropPosition: ",n||"null"]}),(0,l.jsxs)("div",{children:["siblingInfo: ",a?`prev=${a.prevElement?a.prevElement.texts[0]||"empty":"null"}, 
             next=${a.nextElement?a.nextElement.texts[0]||"empty":"null"}`:"null"]})]})})},O=n.memo(e=>{let{element:t,currentDropTarget:i,dropPosition:r,draggingElement:o,handleMouseDown:a,onHoverChange:f,dropInsertY:g,siblingInfo:O}=e,{state:C,dispatch:v}=s(),{getCurrentTabState:A,getCurrentTabNumberOfSections:I}=(0,m.u)(),w=A()||{elements:{},zoomRatio:1};I();let N=y(),R=i?.id||-1,[D,_]=(0,n.useState)(!1),S=(0,n.useRef)(!1),[j,k]=(0,n.useState)(d.iC.NORMAL.COLOR),[L,M]=(0,n.useState)(d.iC.NORMAL.STROKE_COLOR),[B,$]=(0,n.useState)(d.iC.STROKE_WIDTH),[H,U]=(0,n.useState)("");(0,n.useEffect)(()=>{N&&(k((0,u.kN)()),M((0,u._1)()),$((0,u.xo)()),U((0,u.af)()))},[N]),(0,n.useEffect)(()=>{if(t.editing||!N)return;let{newWidth:e,newHeight:i,sectionHeights:l}=(()=>{let e=(0,h.PC)(t.texts,d.rF.HORIZONTAL),i=t.texts.map(t=>{let i=(0,h.C1)(t||"",e,w.zoomRatio).length;return Math.max(d.SK.SECTION_HEIGHT*w.zoomRatio,i*d.gI*d.RZ+d.rF.VERTICAL*w.zoomRatio)});return{newWidth:e,newHeight:i.reduce((e,t)=>e+t,0),sectionHeights:i}})();t.editing||e===t.width&&i===t.height||v({type:"UPDATE_ELEMENT_SIZE",payload:{id:t.id,width:e,height:i,sectionHeights:l}})},[t.editing,t.texts,t.width,t.height,v,t.id,w.zoomRatio]);let P=(0,n.useMemo)(()=>Object.values(w.elements).filter(e=>e.parentId===t.id&&!e.visible),[w.elements,t.id]),G=!!o&&(o.id===t.id||(0,E.K9)(w.elements,o.id,t.id)),X=(0,n.useCallback)((e,i)=>{let l=t.sectionHeights[e];if(null!==l&&Math.abs(i-l)>1){let l=[...t.sectionHeights];l[e]=i;let r=(0,h.PC)(t.texts,d.rF.HORIZONTAL),n=l.reduce((e,t)=>e+t,0);(0,c.c)(`[IdeaElement][handleHeightChange] resized: ${t.texts} ${t.width} x ${t.height} -> ${r} x ${n}`),v({type:"UPDATE_ELEMENT_SIZE",payload:{id:t.id,width:r,height:n,sectionHeights:l}})}},[v,t]),F=(0,n.useCallback)(()=>{_(!0),f&&!S.current&&(f(t.id,!0),S.current=!0)},[t.id,f]),K=(0,n.useCallback)(()=>{_(!1),f&&S.current&&(f(t.id,!1),S.current=!1)},[t.id,f]);return((0,n.useEffect)(()=>()=>{f&&S.current&&f(t.id,!1)},[t.id,f]),N)?(0,l.jsxs)(n.Fragment,{children:[(0,l.jsx)("g",{children:(0,l.jsx)(T,{element:t,isHovered:D,currentDropTarget:i,dropPosition:r,isDraggedOrDescendant:G,siblingInfo:O})}),(0,l.jsxs)("g",{opacity:G?.3:1,children:[b(t,v,Object.values(w.elements)),P.length>0&&(0,l.jsxs)(l.Fragment,{children:[t.texts.length>1?(0,l.jsx)("rect",{x:t.x+d.N,y:t.y+d.N,width:t.width,height:t.height,rx:d.iC.RX,fill:"none",stroke:d.iC.SHADDOW.COLOR,strokeWidth:B},`shadow-${t.id}`):(0,l.jsx)("line",{x1:t.x+d.N,y1:t.y+t.height+d.N,x2:t.x+t.width+d.N,y2:t.y+t.height+d.N,stroke:d.iC.SHADDOW.COLOR,strokeWidth:B},`shadow-line-${t.id}`),(0,l.jsxs)("g",{transform:`translate(${t.x+1.1*t.width},${t.y})`,onClick:e=>{e.stopPropagation(),v({type:"SELECT_ELEMENT",payload:{id:t.id,ctrlKey:!1,shiftKey:!1}}),v({type:"EXPAND_ELEMENT"})},style:{cursor:"pointer"},children:[(0,l.jsx)("rect",{x:"0",y:"0",width:"24",height:"24",rx:"4",fill:"white",stroke:"#e0e0e0",strokeWidth:"1"}),(0,l.jsx)("svg",{x:"4",y:"4",width:"16",height:"16",viewBox:"0 0 24 24",children:(0,l.jsx)(x.A,{sx:{color:"#666666"},style:{width:"100%",height:"100%"}})})]})]}),(0,l.jsx)("defs",{children:(0,l.jsx)("filter",{id:"boxShadow",x:"-20%",y:"-20%",width:"140%",height:"140%",children:(0,l.jsx)("feDropShadow",{dx:"2",dy:"2",stdDeviation:"3",floodColor:"gray"})})}),(0,l.jsx)("rect",{x:t.x,y:t.y,width:t.width,height:t.height,rx:d.iC.RX,strokeWidth:B,stroke:t.texts.length>1?t.selected?d.iC.SELECTED.STROKE_COLOR:t.tentative?"#9E9E9E":L:"transparent",strokeDasharray:t.tentative?"4 2":"none",onClick:e=>{e.stopPropagation(),v({type:"SELECT_ELEMENT",payload:{id:t.id,ctrlKey:e.ctrlKey||e.metaKey,shiftKey:e.shiftKey}})},onDoubleClick:()=>v({type:"EDIT_ELEMENT"}),onMouseDown:e=>a(e,t),onMouseEnter:F,onMouseLeave:K,"data-element-id":t.id,style:{fill:t.id===R&&"child"===r?d.iC.DRAGGING.COLOR:j,strokeOpacity:t.tentative?.6:1,pointerEvents:"all",cursor:D?"pointer":"default",filter:t.selected&&t.texts.length>1?"url(#boxShadow)":"none"}}),1===t.texts.length&&N&&(0,l.jsxs)(l.Fragment,{children:[t.selected&&(0,l.jsx)("line",{x1:t.x+2,y1:t.y+t.height+2,x2:t.x+t.width+1,y2:t.y+t.height+2,stroke:"rgba(0,0,255,0.2)",strokeWidth:B,strokeLinecap:"round",pointerEvents:"none"}),(0,l.jsx)("line",{x1:t.x,y1:t.y+t.height,x2:t.x+t.width,y2:t.y+t.height,stroke:t.selected?d.iC.SELECTED.STROKE_COLOR:t.tentative?"#9E9E9E":L,strokeWidth:B,strokeDasharray:t.tentative?"4 2":"none",pointerEvents:"none"})]}),t.texts.map((e,i)=>(0,l.jsxs)(n.Fragment,{children:[!t.editing&&(0,l.jsx)(p,{x:t.x,y:t.y+t.sectionHeights.slice(0,i).reduce((e,t)=>e+t,0),width:t.width,height:t.sectionHeights[i],text:e,fontSize:d.gI,zoomRatio:w.zoomRatio,fontFamily:H,onHeightChange:e=>X(i,e)}),i<t.texts.length-1&&(0,l.jsx)("line",{x1:t.x,y1:t.y+t.sectionHeights.slice(0,i+1).reduce((e,t)=>e+t,0),x2:t.x+t.width,y2:t.y+t.sectionHeights.slice(0,i+1).reduce((e,t)=>e+t,0),stroke:L,strokeWidth:"1"})]},`${t.id}-section-${i}`))]})]},t.id):null}),C={"Ctrl+z":"UNDO","Ctrl+Shift+z":"REDO",ArrowUp:"ARROW_UP",ArrowDown:"ARROW_DOWN",ArrowRight:"ARROW_RIGHT","Ctrl+ArrowRight":"EXPAND_ELEMENT",ArrowLeft:"ARROW_LEFT","Ctrl+ArrowLeft":"COLLAPSE_ELEMENT","Ctrl+x":"CUT_ELEMENT","Ctrl+c":"COPY_ELEMENT","Ctrl+v":"PASTE_ELEMENT",Tab:"ADD_ELEMENT","Shift+Tab":"ADD_SIBLING_ELEMENT",Delete:"DELETE_ELEMENT",Backspace:"DELETE_ELEMENT",Enter:"EDIT_ELEMENT"},v={Tab:"NEXT_FIELD",Escape:"END_EDITING","Ctrl+Enter":"END_EDITING","Alt+Enter":"END_EDITING","Meta+Enter":"END_EDITING"},A=n.memo(e=>{let{element:t,onEndEditing:i}=e,{dispatch:r,state:o}=s(),a=y(),c=(0,n.useRef)([]),[p,x]=(0,n.useState)([]),[f,g]=(0,n.useState)(-1),E=(0,n.useRef)(null),m=(0,n.useRef)(void 0),[b,T]=(0,n.useState)(""),[O,C]=(0,n.useState)(""),[A,I]=(0,n.useState)("");(0,n.useEffect)(()=>{a&&(E.current=document.createElement("canvas").getContext("2d"),T((0,u.af)()),C((0,u.kN)()),I((0,u.vG)()))},[a]),(0,n.useEffect)(()=>{a&&t?.id!==m.current&&(x(t?.sectionHeights||[]),g(0),m.current=t?.id,setTimeout(()=>{let e=c.current[0];if(e){e.focus({preventScroll:!0});let i=t?.texts[0]?.length||0;e.setSelectionRange(i,i)}},50))},[t,a]);let w=(0,n.useCallback)(e=>{let t=d.SK.WIDTH.MAX,i=(0,h.C1)(e,t,o.zoomRatio).length,l=d.gI*d.RZ*o.zoomRatio,r=d.rF.VERTICAL*o.zoomRatio;return Math.max(d.SK.SECTION_HEIGHT*o.zoomRatio,i*l+r)},[o.zoomRatio]),N=(0,n.useCallback)((e,i)=>{let l=e.target.value,n=w(l);x(e=>{let t=[...e];return t[i]=n/o.zoomRatio,t}),r({type:"UPDATE_TEXT",payload:{id:t.id,index:i,value:l}});let a=c.current[i];a&&(a.style.height=`${n}px`)},[t,o.zoomRatio,r,w]),R=(0,n.useCallback)(e=>{let l=e+1;if(t&&l<t.texts.length){let e=c.current[l];if(e){let{scrollX:i,scrollY:r}=window;e.focus({preventScroll:!0});let n=t.texts[l]?.length||0;e.setSelectionRange(n,n),g(l),window.scrollTo(i,r)}}else i?.(),r({type:"END_EDITING"})},[t,i,r]),D=(e,t)=>{let l=v[[e.ctrlKey&&"Ctrl",e.altKey&&"Alt",e.metaKey&&"Meta",e.key].filter(Boolean).join("+")];if(l)switch(e.preventDefault(),l){case"NEXT_FIELD":R(t);break;case"END_EDITING":i?.(),r({type:"END_EDITING"})}};return t&&a?(0,l.jsx)(l.Fragment,{children:t.texts.map((e,i)=>{let r=p.slice(0,i).reduce((e,t)=>e+t,0)*o.zoomRatio,n=d.SK.WIDTH.MAX*o.zoomRatio,s=w(e);return(0,l.jsx)("textarea",{ref:e=>{c.current[i]=e,i===f&&a&&e?.focus({preventScroll:!0})},value:e,onChange:e=>N(e,i),onKeyDown:e=>D(e,i),onClick:e=>e.stopPropagation(),style:{position:"absolute",left:`${t.x*o.zoomRatio}px`,top:`${t.y*o.zoomRatio+r}px`,width:`${n}px`,height:`${s}px`,minWidth:`${d.SK.WIDTH.MAX*o.zoomRatio}px`,maxWidth:`${d.SK.WIDTH.MAX*o.zoomRatio}px`,minHeight:`${d.SK.SECTION_HEIGHT*o.zoomRatio}px`,margin:"1px 1px",fontSize:`${d.gI*o.zoomRatio}px`,lineHeight:`${d.RZ}em`,padding:"0 3px",fontFamily:b,backgroundColor:O,color:A,boxSizing:"border-box",WebkitFontSmoothing:"antialiased",MozOsxFontSmoothing:"grayscale",overflow:"hidden",whiteSpace:"pre-wrap",wordWrap:"break-word",resize:"none",zIndex:1e4,opacity:1,transition:"all 0.2s ease-in-out",pointerEvents:"all"}},`${t.id}-${i}`)})}):null}),I=e=>{let t=Object.values(e),i=Math.max(...t.map(e=>e.x+e.width)),l=Math.max(...t.map(e=>e.y+e.height));return{width:i+d.e$.X,height:l+d.SK.SECTION_HEIGHT*d.zX}},w=e=>{let{setCanvasSize:t,setDisplayArea:i,state:l}=e;(0,n.useEffect)(()=>{let e=I(l.elements),r=window.innerHeight-2*d.JY;e.width=Math.max(e.width,window.innerWidth),e.height=Math.max(e.height,r);let n={width:e.width,height:e.height};e.width*=l.zoomRatio,e.height*=l.zoomRatio,t(e),i(`0 0 ${n.width} ${n.height}`)},[l.elements,l.zoomRatio,t,i])},N=(e,t)=>{let{dispatch:i}=s();(0,n.useEffect)(()=>{let l=e.current,r=e=>{e.target instanceof SVGElement&&"svg"===e.target.tagName&&(i({type:"DESELECT_ALL"}),t&&i({type:"END_EDITING"}))};return l?.addEventListener("mousedown",r),()=>{l?.removeEventListener("mousedown",r)}},[e,t,i])};var R=i(3147);let D=e=>"touches"in e,_=(e,t)=>Object.values(t).filter(t=>t.parentId===e.id&&t.visible).sort((e,t)=>e.order-t.order),S=()=>{let{state:e,dispatch:t}=s(),{addToast:i}=(0,R.d)(),[l,o]=(0,n.useState)(null),[a,h]=(0,n.useState)({x:0,y:0}),[u,p]=(0,n.useState)(null),x=(0,n.useRef)(new Map),f=(0,n.useCallback)(t=>{let i,l;return D(t)?(i=t.touches[0].clientX+window.scrollX,l=t.touches[0].clientY+window.scrollY):(i=t.clientX+window.scrollX,l=t.clientY+window.scrollY),{x:i/e.zoomRatio,y:(l-d.uF)/e.zoomRatio}},[e.zoomRatio]),g=(0,n.useCallback)((e,t,i)=>{let l=e.y,r=_(e,i),n=e.x+e.width+d.e$.X;return r.length,{position:"child",insertY:l+e.height/2,insertX:n}},[]),m=(0,n.useCallback)((e,t,i,r)=>{let n;let o=e.y,a=e.y+e.height,s=e.x+e.width,h=d.e$.X+(l?.width??0),u=t>=e.x&&t<s&&i>=o&&i<=a,p=t>=s&&t<s+h&&i>=o&&i<=a;if(u)n=g(e,i,r),(0,c.c)("Drop position mode (inside element):","child");else if(p){let t=_(e,r);if(0===t.length)e.x,e.width,d.e$.X,n={position:"child",insertY:e.y+e.height/2,siblingInfo:{}},(0,c.c)("Drop position mode (right side, no children):","child");else{let l,r;for(let e=0;e<t.length;e++){let n=t[e];if(i<n.y){r=n,e>0&&(l=t[e-1]);break}if(i<n.y+n.height){i<n.y+n.height/2?(r=n,e>0&&(l=t[e-1])):(l=n,e<t.length-1&&(r=t[e+1]));break}if(e===t.length-1||i<t[e+1].y){l=n,e<t.length-1&&(r=t[e+1]);break}}if(l&&r){let e=r.y-(l.y+l.height);n={position:"between",insertY:l.y+l.height+e/2,siblingInfo:{prevElement:l,nextElement:r}}}else n=l?{position:"between",insertY:l.y+l.height+d.e$.Y,siblingInfo:{prevElement:l}}:r?{position:"between",insertY:r.y-d.e$.Y,siblingInfo:{nextElement:r}}:{position:"between",insertY:e.y+e.height/2,siblingInfo:{}};(0,c.c)("Drop position mode (right side, with children):","between")}}else{let t=l?.id,o=Object.values(r).filter(i=>i.visible&&i.parentId===e.parentId&&i.depth===e.depth&&i.id!==t).sort((e,t)=>e.y-t.y);(0,c.c)(`[calculatePositionAndDistance] Found ${o.length} siblings (excluding dragging element) for element ${e.id}`);let a=null,s=null;for(let e=0;e<o.length;e++){let t=o[e];if(t.id===l?.id)continue;let r=t.y+t.height;if(i<t.y){s=t,e>0&&(a=o[e-1]);break}if(i<r){i<t.y+t.height/2?(s=t,e>0&&(a=o[e-1])):(a=t,e<o.length-1&&(s=o[e+1]));break}a=t,e<o.length-1&&(s=o[e+1])}if(a&&s){let e=s.y-(a.y+a.height);n={position:"between",insertY:a.y+a.height+e/2,siblingInfo:{prevElement:a,nextElement:s}}}else n=a?{position:"between",insertY:a.y+a.height+d.e$.Y,siblingInfo:{prevElement:a}}:s?{position:"between",insertY:s.y-d.e$.Y,siblingInfo:{nextElement:s}}:{position:"between",insertY:e.y+e.height+d.e$.Y,siblingInfo:{}};(0,c.c)("Drop position mode (between siblings):","between")}let x=e.x+e.width/2,f=e.y+e.height/2,E=t-x,m=i-f;return{...n,distanceSq:E*E+m*m}},[g,l,e.zoomRatio]),y=(0,n.useCallback)((e,t)=>{if(!l)return null;let i=f(e),r=i.x,n=i.y,o=Object.values(t).filter(e=>e.selected).map(e=>e.id),a=Object.values(t).filter(e=>{if(!e.visible||o.includes(e.id))return!1;let t=e.y,i=e.y+e.height,l=e.x,a=e.x+e.width,s=t-d.e$.Y,h=i+d.e$.Y,c=l-d.e$.X,u=a+d.e$.X;return r>=c&&r<=u&&n>=s&&n<=h});if(0===a.length){let e={};for(let i in Object.values(t).filter(e=>e.visible&&!o.includes(e.id)).forEach(t=>{let i=t.parentId||"root";e[i]||(e[i]=[]),e[i].push(t)}),e)e[i].sort((e,t)=>e.y-t.y);for(let[t,i]of Object.entries(e))if(!(i.length<2))for(let e=0;e<i.length-1;e++){let t=i[e],l=i[e+1],o=l.y-(t.y+t.height);if(o<5)continue;let a=t.y+t.height,s=l.y,d=t.x+t.width,h=l.x+l.width,c=Math.min(t.x,l.x),u=Math.max(d,h);if(r>=c&&r<=u&&n>=a&&n<=s)return{element:t,position:"between",insertY:a+o/2,siblingInfo:{prevElement:t,nextElement:l}}}for(let[i,l]of Object.entries(e)){let e,o;if(0===l.length)continue;let a=l.reduce((e,t)=>t.y+t.height>e.y+e.height?t:e,l[0]),s="root"!==i?t[i]:null;s?o=(e=s.x+s.width)+2*d.e$.X+a.width:(e=a.x-d.e$.X,o=a.x+a.width+d.e$.X);let h=a.y+a.height+2*d.e$.Y;if(r>=e&&r<=o&&n>=a.y+a.height&&n<=h)return{element:a,position:"between",insertY:a.y+a.height+d.e$.Y,siblingInfo:{prevElement:a}}}}let s=null,h=1/0;for(let e of a){let{position:i,distanceSq:l,insertY:o,siblingInfo:a}=m(e,r,n,t);l<h&&(h=l,s={element:e,position:i,insertY:o,siblingInfo:a})}return s},[l,f,m]),b=(0,n.useCallback)((t,i)=>{let l;if(!i.selected||!i.parentId)return;t.stopPropagation(),t.nativeEvent instanceof TouchEvent&&t.preventDefault();let r=f(t.nativeEvent);o(i),h({x:r.x-i.x,y:r.y-i.y}),x.current.clear(),Object.values(e.elements).filter(e=>e.selected).forEach(e=>{x.current.set(e.id,{x:e.x,y:e.y})})},[f,e.elements,t]),T=(0,n.useCallback)(()=>{Object.values(e.elements).filter(e=>e.selected).forEach(e=>{let i=x.current.get(e.id);i&&t({type:"MOVE_ELEMENT",payload:{id:e.id,x:i.x,y:i.y}})}),o(null),x.current.clear()},[e.elements,t]),O=(0,n.useCallback)((t,i)=>{if(null===i)return{isValid:!0};if(t.id===i)return(0,c.c)(`無効な操作: 自分自身を親にしようとしています element=${t.id}, newParentId=${i}`),{isValid:!1,errorMessage:r.dropSelfChild};if((0,E.K9)(e.elements,t.id,i)){let l=e.elements[i]?.parentId===t.id;return(0,c.c)(`無効な操作: ${l?"自身の子要素":"循環参照"} element=${t.id}, newParentId=${i}`),{isValid:!1,errorMessage:l?r.dropSelfChild:r.dropCircularReference}}let l=i&&e.elements[i]?.depth||0;return l>=10?((0,c.c)(`無効な操作: 最大深さ超過 currentDepth=${l}, max=10`),{isValid:!1,errorMessage:r.dropInvalidHierarchy}):{isValid:!0}},[e.elements]),C=(0,n.useCallback)((e,l)=>{let n=l.find(t=>!O(t,e.id).isValid);if(n){let{errorMessage:t}=O(n,e.id);return i(t||r.dropChildElement,"warn"),T(),!1}return t({type:"SNAPSHOT"}),l.forEach((i,l)=>{let r=e.depth+1;t({type:"DROP_ELEMENT",payload:{id:i.id,oldParentId:i.parentId,newParentId:e.id,newOrder:e.children+l,depth:r}})}),!0},[O,i,T,t]),v=(0,n.useCallback)((e,l)=>{let n;if((0,c.c)(`[processBetweenDrop] target=${e.id}, siblingInfo: ${JSON.stringify({prevElementId:u?.siblingInfo?.prevElement?.id,nextElementId:u?.siblingInfo?.nextElement?.id})}`),u?.siblingInfo){let{prevElement:t,nextElement:i}=u.siblingInfo;t&&i?((0,c.c)(`  Between two elements: prev=${t.id}(order=${t.order}), next=${i.id}(order=${i.order})`),n=t.parentId):t?((0,c.c)(`  After last element: prev=${t.id}(order=${t.order})`),n=t.parentId):i?((0,c.c)(`  Before first element: next=${i.id}(order=${i.order})`),n=i.parentId):((0,c.c)(`  No siblings: target=${e.id}`),n=e.id)}else(0,c.c)(`  No siblings info: target=${e.id}`),n=e.id;if(null===n&&!l.every(e=>1===e.depth))return i(r.invalidDrop,"warn"),T(),!1;let o=l.find(e=>!O(e,n).isValid);if(o){let{errorMessage:e}=O(o,n);return i(e||r.dropChildElement,"warn"),T(),!1}t({type:"SNAPSHOT"});let a=l.some(e=>e.parentId===n),s=l.filter(e=>e.parentId===n),d=A(u,s);return a?I(s,d.baseOrder,n):w(d.baseOrder,l.length,n),l.forEach((i,l)=>{let r=n===e.id?e.depth+1:e.depth;t({type:"DROP_ELEMENT",payload:{id:i.id,oldParentId:i.parentId,newParentId:n,newOrder:d.baseOrder+l,depth:r}})}),!0},[u,O,i,T,t,e.elements]),A=(0,n.useCallback)((e,t)=>{let i=0;if(e?.siblingInfo){let{prevElement:l,nextElement:r}=e.siblingInfo;l&&r?i=t.some(e=>e.order>l.order&&e.order<r.order)?t[0].order:t.every(e=>e.order<l.order)?r.order-t.length:l.order+1:l?i=l.order+1:r&&(t.some(e=>0===e.order)&&(r.order,t.length),i=0)}else i=0;return{baseOrder:i}},[]),I=(0,n.useCallback)((i,l,r)=>{if(0===i.length)return;let n=i.map(e=>e.order).sort((e,t)=>e-t),o=n[0],a=n[n.length-1];a<l?Object.values(e.elements).filter(e=>e.parentId===r&&e.order>a&&e.order<l+i.length&&!i.some(t=>t.id===e.id)).forEach(e=>{t({type:"UPDATE_ELEMENT_ORDER",payload:{id:e.id,order:e.order-i.length}})}):o>l&&Object.values(e.elements).filter(e=>e.parentId===r&&e.order>=l&&e.order<o&&!i.some(t=>t.id===e.id)).forEach(e=>{t({type:"UPDATE_ELEMENT_ORDER",payload:{id:e.id,order:e.order+i.length}})})},[e.elements,t]),w=(0,n.useCallback)((i,l,r)=>{Object.values(e.elements).filter(e=>e.parentId===r&&e.order>=i).forEach(e=>{t({type:"UPDATE_ELEMENT_ORDER",payload:{id:e.id,order:e.order+l}})})},[e.elements,t]),N=(0,n.useCallback)(async()=>{if(l)try{let t=Object.values(e.elements).filter(e=>e.selected);if(u){let{element:e,position:l}=u,n=t.find(t=>!O(t,e.id).isValid);if(n){let{errorMessage:t}=O(n,e.id);i(t||r.dropChildElement,"warn"),T();return}let o=!1;if("child"===l?o=C(e,t):"between"===l&&(o=v(e,t)),!o){T();return}}else T()}catch(e){console.error("Drag error:",e),i(r.dragError,"warn"),T()}finally{o(null),p(null),x.current.clear()}},[l,u,e.elements,t,i,T,C,v,O]),S=(0,n.useCallback)(i=>{if(!l)return;i instanceof TouchEvent&&1===i.touches.length&&i.preventDefault();let r=y(i,e.elements);(!u&&r||u&&!r||u&&r&&(u.element.id!==r.element.id||u.position!==r.position||"between"===r.position&&u.insertY!==r.insertY))&&p(r);let n=f(i),o={x:n.x-a.x,y:n.y-a.y};t({type:"MOVE_ELEMENT",payload:{id:l.id,...o}})},[l,u,e.elements,y,f,a,t]);return(0,n.useEffect)(()=>{if(!l)return;let e=e=>S(e),t=e=>{1===e.touches.length&&S(e)},i=()=>N(),r=()=>N();return document.addEventListener("mousemove",e),document.addEventListener("touchmove",t,{passive:!1}),document.addEventListener("mouseup",i),document.addEventListener("touchend",r),()=>{document.removeEventListener("mousemove",e),document.removeEventListener("touchmove",t),document.removeEventListener("mouseup",i),document.removeEventListener("touchend",r)}},[l,S,N]),{handleMouseDown:b,handleMouseUp:N,currentDropTarget:u?.element||null,dropPosition:u?.position||null,draggingElement:l,dropInsertY:u?.insertY,siblingInfo:u?.siblingInfo||null}};var j=i(8628);let k={arrow:{id:"arrowhead",width:d.tl.WIDTH,height:d.tl.HEIGHT,isFilled:!1,shape:"polygon",pointsOrAttributes:`${d.tl.WIDTH} 0, ${d.tl.WIDTH} ${d.tl.HEIGHT}, 0 ${d.tl.HEIGHT/2}`},filledArrow:{id:"filledarrowhead",width:d.tl.WIDTH,height:d.tl.HEIGHT,isFilled:!0,shape:"polygon",pointsOrAttributes:`${d.tl.WIDTH} 0, ${d.tl.WIDTH} ${d.tl.HEIGHT}, 0 ${d.tl.HEIGHT/2}`},circle:{id:"circlemarker",width:d.p1.SIZE,height:d.p1.SIZE,isFilled:!1,shape:"circle",pointsOrAttributes:{cx:d.p1.SIZE/2,cy:d.p1.SIZE/2,r:d.p1.SIZE/2-1}},filledCircle:{id:"filledcirclemarker",width:d.p1.SIZE,height:d.p1.SIZE,isFilled:!0,shape:"circle",pointsOrAttributes:{cx:d.p1.SIZE/2,cy:d.p1.SIZE/2,r:d.p1.SIZE/2-1}},square:{id:"squaremarker",width:d.p1.SIZE,height:d.p1.SIZE,isFilled:!1,shape:"rect",pointsOrAttributes:{x:1,y:1,width:d.p1.SIZE-2,height:d.p1.SIZE-2}},filledSquare:{id:"filledsquaremarker",width:d.p1.SIZE,height:d.p1.SIZE,isFilled:!0,shape:"rect",pointsOrAttributes:{x:1,y:1,width:d.p1.SIZE-2,height:d.p1.SIZE-2}},diamond:{id:"diamondmarker",width:d.tl.WIDTH,height:d.tl.HEIGHT,isFilled:!1,shape:"polygon",pointsOrAttributes:`${d.tl.WIDTH/2},1 ${d.tl.WIDTH-1},${d.tl.HEIGHT/2} ${d.tl.WIDTH/2},${d.tl.HEIGHT-1} 1,${d.tl.HEIGHT/2}`},filledDiamond:{id:"filleddiamondmarker",width:d.tl.WIDTH,height:d.tl.HEIGHT,isFilled:!0,shape:"polygon",pointsOrAttributes:`${d.tl.WIDTH/2},1 ${d.tl.WIDTH-1},${d.tl.HEIGHT/2} ${d.tl.WIDTH/2},${d.tl.HEIGHT-1} 1,${d.tl.HEIGHT/2}`}},L=e=>{switch(e){case"arrow":return"url(#arrowhead)";case"filled_arrow":return"url(#filledarrowhead)";case"circle":return"url(#circlemarker)";case"filled_circle":return"url(#filledcirclemarker)";case"square":return"url(#squaremarker)";case"filled_square":return"url(#filledsquaremarker)";case"diamond":return"url(#diamondmarker)";case"filled_diamond":return"url(#filleddiamondmarker)";default:return}},M=(e,t)=>Object.values(k).map(i=>{let r;let{id:n,width:o,height:a,isFilled:s,shape:d,pointsOrAttributes:h}=i,c=s?e:"none",u={id:n,markerWidth:o,markerHeight:a,refX:o,refY:a/2,orient:"auto",markerUnits:"userSpaceOnUse",viewBox:`0 0 ${o} ${a}`,strokeWidth:t,fill:c,stroke:e};return"polygon"===d?r=(0,l.jsx)("polygon",{points:h,fill:c,stroke:e}):"circle"===d?r=(0,l.jsx)("circle",{cx:h.cx,cy:h.cy,r:h.r,fill:c,stroke:e}):"rect"===d&&(r=(0,l.jsx)("rect",{x:h.x,y:h.y,width:h.width,height:h.height,fill:c,stroke:e})),(0,l.jsx)("marker",{...u,children:r},n)}),B=n.memo(e=>{let{isHelpOpen:t,toggleHelp:i}=e,o=(0,n.useRef)(null),[a,h]=(0,n.useState)(!1),{state:c,dispatch:p}=s(),{elements:x,zoomRatio:f}=c,[g,m]=(0,n.useState)(d.BH),[y,b]=(0,n.useState)(d._o),[v,I]=(0,n.useState)(d.i_),{addToast:D}=(0,R.d)(),[_,k]=(0,n.useState)({width:0,height:0}),[B,$]=(0,n.useState)("0 0 0 0"),[H,U]=(0,n.useState)(!1),[P,G]=(0,n.useState)(0),[X,F]=(0,n.useState)({x:0,y:0}),K=Object.values(x).find(e=>e.editing),[W,Y]=(0,n.useState)(null),[V,z]=(0,n.useState)(null),[Z,q]=(0,n.useState)({});(0,n.useEffect)(()=>{K||requestAnimationFrame(()=>{let{scrollX:e,scrollY:t}=window;o.current?.focus({preventScroll:!0}),window.scrollTo(e,t)})},[K]),(0,n.useEffect)(()=>{h(!0),k({width:window.innerWidth,height:window.innerHeight}),$(`0 0 ${window.innerWidth} ${window.innerHeight-d.JY}`),m((0,u.ZF)()||d.BH),b((0,u.S4)()||d._o),I((0,u.Es)()||d.i_)},[]),w({setCanvasSize:k,setDisplayArea:$,state:c}),N(o,!!K);let{handleMouseDown:J,handleMouseUp:Q,currentDropTarget:ee,dropPosition:et,draggingElement:ei,dropInsertY:el,siblingInfo:er}=S(),en=(0,n.useCallback)(async e=>{e.preventDefault();let t=C[`${e.ctrlKey||e.metaKey?"Ctrl+":""}${e.shiftKey?"Shift+":""}${e.key}`];if("PASTE_ELEMENT"===t){let e=(0,j.Lt)();if(e&&Object.keys(e).length>0)p({type:t});else try{let e=await navigator.clipboard.readText(),t=Object.values(c.elements).find(e=>e.selected);if(!t){D(r.noSelect);return}if(e){let i=e.split("\n").filter(e=>""!==e.trim());if(0===i.length){D(r.clipboardEmpty);return}p({type:"ADD_ELEMENTS_SILENT",payload:{parentId:t.id,texts:i}})}else D(r.clipboardEmpty)}catch(e){console.error("クリップボード読み取りエラー:",e),D(r.clipboardReadError)}}else t&&p({type:t})},[p,c.elements,D]),eo=(0,n.useCallback)(e=>{if(2===e.touches.length){U(!0);let t=e.touches[0],i=e.touches[1];G(Math.hypot(i.clientX-t.clientX,i.clientY-t.clientY)),F({x:window.scrollX,y:window.scrollY})}else if(1===e.touches.length){e.preventDefault();let t=e.touches[0],i=document.elementFromPoint(t.clientX,t.clientY);if(i&&(i instanceof SVGRectElement||i instanceof SVGGElement)){let l=i,r=null;for(;l&&!r;){if(l.dataset&&l.dataset.elementId){r=l.dataset.elementId;break}l=l.parentElement}if(r){let i=c.elements[r];i&&J({nativeEvent:e.nativeEvent,stopPropagation:()=>{},preventDefault:()=>{},clientX:t.clientX,clientY:t.clientY},i)}}}},[c.elements,J]),ea=(0,n.useCallback)(e=>{if(H&&2===e.touches.length){e.preventDefault();let t=e.touches[0],i=e.touches[1],l=Math.hypot(i.clientX-t.clientX,i.clientY-t.clientY),r=t.clientX-i.clientX,n=Math.atan2(t.clientY-i.clientY,r),o=l/P,a=(t.clientX+i.clientX)/2,s=(t.clientY+i.clientY)/2;window.scrollTo({left:X.x+a*(o-1)*Math.cos(n),top:X.y+s*(o-1)*Math.sin(n),behavior:"auto"})}else 1===e.touches.length&&e.preventDefault()},[H,P,X]),es=(0,n.useCallback)(()=>{U(!1),G(0),F({x:0,y:0})},[]),ed=(0,n.useCallback)((e,t)=>{if(!Object.values(x).some(t=>t.parentId===e.id&&t.visible))return null;let i=e.height;return(0,l.jsxs)("g",{children:[(W===e.id||V===e.id)&&(0,l.jsx)("circle",{cx:t.x+e.width+10,cy:t.y+i/2,r:10,fill:"#bfbfbf",opacity:.5}),(0,l.jsx)("circle",{cx:t.x+e.width+10,cy:t.y+i/2,r:10,fill:"transparent",onMouseEnter:()=>Y(e.id),onMouseLeave:()=>Y(null),onClick:()=>z(e.id)})]},`marker-button-${e.id}`)},[W,V,x]),eh=function(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:d.lB.COLOR,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:d.lB.STROKE;if(!e)return null;let o=0;switch(e.connectionPathType){case d.vX.ARROW:case d.vX.FILLED_ARROW:o=d.tl.OFFSET;break;case d.vX.CIRCLE:case d.vX.FILLED_CIRCLE:case d.vX.SQUARE:case d.vX.FILLED_SQUARE:o=d.p1.OFFSET;break;case d.vX.DIAMOND:case d.vX.FILLED_DIAMOND:o=d.tl.OFFSET;break;default:o=0}let a=i.parent,s=i.element,h=t.height,c=`M ${a.x+e.width+o},${a.y+e.height/2} C ${a.x+e.width+d.mO},${a.y+e.height/2} ${s.x-d.mO},${s.y+h/2} ${s.x},${s.y+h/2}`,u=L(e.connectionPathType);return(0,l.jsx)("g",{children:(0,l.jsx)("path",{d:c,stroke:r,strokeWidth:n,fill:"none",markerStart:u,style:{pointerEvents:"none"}})},`connection-${t.id}-${t.parentId}`)};(0,n.useEffect)(()=>{let e=e=>{V&&!e.target.closest(".popup-menu")&&z(null)};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[V]);let ec=(0,n.useCallback)((e,t)=>{q(i=>{if(i[e]===t)return i;let l={...i};return t?l[e]=!0:Object.prototype.hasOwnProperty.call(l,e)&&delete l[e],l})},[]);return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("div",{style:{position:"absolute",top:d.uF,left:0,width:"100%",height:"100%",backgroundColor:v,overflow:"hidden",zIndex:-1}}),(0,l.jsxs)("div",{style:{position:"absolute",top:d.uF,left:0,overflow:"auto",touchAction:H?"none":"manipulation",backgroundColor:v},children:[a&&(0,l.jsxs)("svg",{"data-testid":"view-area",ref:o,width:_.width,height:_.height,viewBox:B,tabIndex:0,onKeyDown:en,onTouchStart:eo,onTouchMove:ea,onTouchEnd:es,style:{outline:"none",touchAction:H?"none":"manipulation",userSelect:"none",WebkitUserSelect:"none",backgroundColor:v},className:"svg-element",children:[(0,l.jsx)("defs",{children:M(g,y)}),(()=>{let e={};return Object.values(x).filter(e=>e.visible).forEach(t=>{let i=t.parentId?`${t.parentId}_${t.depth}`:"root";e[i]||(e[i]=[]),e[i].push(t)}),Object.entries(e).flatMap(e=>{let[t,i]=e;if("root"===t)return i.map(e=>(0,l.jsxs)(n.Fragment,{children:[(0,l.jsx)(O,{element:e,currentDropTarget:ee,dropPosition:et,draggingElement:ei,handleMouseDown:J,handleMouseUp:Q,onHoverChange:ec,dropInsertY:el,siblingInfo:er}),ed(e,{x:e.x,y:e.y})]},e.id));let[r]=t.split("_"),o=x[r];if(!o)return[];let a=o.x+o.width+d.e$.X,s=o.y;return[(0,l.jsx)("g",{transform:`translate(${a}, ${s})`,className:"element-group","data-parent-id":r,"data-depth":i[0].depth,children:i.map(e=>{let t=e.x-a,i=e.y-s;return(0,l.jsx)(O,{element:{...e,x:t,y:i},currentDropTarget:ee,dropPosition:et,draggingElement:ei,handleMouseDown:t=>{J(t,e)},handleMouseUp:Q,onHoverChange:ec,dropInsertY:el,siblingInfo:er},e.id)})},t)]})})(),Object.values(x).filter(e=>e.visible&&!!e.parentId).map(e=>{let t=c.elements[e.parentId];return ei&&(e.id===ei.id||(0,E.K9)(c.elements,ei.id,e.id))?null:(0,l.jsxs)(n.Fragment,{children:[eh(t,e,{parent:{x:t.x,y:t.y},element:{x:e.x,y:e.y}},g,y),ed(e,{x:e.x,y:e.y})]},`connection-group-${e.id}`)}),ee&&ei&&(()=>{let e,t;let i="child"===et?ee:ee.parentId?c.elements[ee.parentId]:null;if("child"===et)e=ee.x+ee.width+d.e$.X,t=el?el-ei.height/2:ee.y+ee.height/2-ei.height/2;else if("between"===et){let i=ee.parentId?x[ee.parentId]:null;if(i){if(e=i.x+i.width+d.e$.X,er){let{prevElement:e,nextElement:i}=er;t=i&&!e?i.y-ei.height:e&&!i?e.y+e.height:e&&i?el?el-ei.height/2:(e.y+e.height+i.y)/2-ei.height/2:el?el-ei.height/2:ee.y+ee.height/2-ei.height/2}else t=el?el-ei.height/2:ee.y+ee.height/2-ei.height/2}else e=d.e$.X,t=el?el-ei.height/2:ee.y+ee.height/2-ei.height/2}else{let i=c.elements[ei.id];e=i.x,t=i.y}return i&&eh(i,{...ei,x:e,y:t},{parent:{x:i.x,y:i.y},element:{x:e,y:t}},d.lB.DRAGGING_COLOR,d.lB.STROKE)})(),(()=>{if(!V)return null;let e=x[V];if(!e)return null;let t=e.height,i=e.x+e.width+20,r=e.y+t/2-25;return(0,l.jsx)("foreignObject",{x:i,y:r,width:150,height:270,className:"popup-menu",children:(0,l.jsx)("div",{style:{backgroundColor:"white",border:"2px solid black",borderRadius:"4px",boxShadow:"0 2px 10px rgba(0, 0, 0, 0.2)",padding:"8px"},children:[{id:"arrow",label:"Arrow"},{id:"filled_arrow",label:"Filled Arrow"},{id:"circle",label:"Circle"},{id:"filled_circle",label:"Filled Circle"},{id:"square",label:"Square"},{id:"filled_square",label:"Filled Square"},{id:"diamond",label:"Diamond"},{id:"filled_diamond",label:"Filled Diamond"},{id:"none",label:"None"}].map(t=>(0,l.jsx)("div",{style:{padding:"4px 0",cursor:"pointer",backgroundColor:W===t.id?"#e0e0e0":"white"},onMouseEnter:()=>Y(t.id),onMouseLeave:()=>Y(null),onClick:()=>{p({type:"UPDATE_CONNECTION_PATH_TYPE",payload:{id:e.id,connectionPathType:t.id}}),z(null)},children:t.label},t.id))})})})(),Object.keys(Z).map(e=>{let t=x[e];return t&&t.visible?(0,l.jsx)(T,{element:t,isHovered:!0,currentDropTarget:ee,dropPosition:et},`debug-${e}`):null}).filter(Boolean),(()=>{let e,t;if(!ei||!ee)return null;if("child"===et)e=ee.x+ee.width+d.e$.X,t=el?el-ei.height/2:ee.y+ee.height/2-ei.height/2;else{if("between"!==et)return null;let i=ee.parentId?x[ee.parentId]:null;if(i){if(e=i.x+i.width+d.e$.X,er){let{prevElement:e,nextElement:i}=er;t=i&&!e?i.y-ei.height:e&&!i?e.y+e.height:e&&i?el?el-ei.height/2:(e.y+e.height+i.y)/2-ei.height/2:el?el-ei.height/2:ee.y+ee.height/2-ei.height/2}else t=el?el-ei.height/2:ee.y+ee.height/2-ei.height/2}else e=d.e$.X,t=el?el-ei.height/2:ee.y+ee.height/2-ei.height/2}return(0,l.jsx)("rect",{x:e,y:t,width:ei.width,height:ei.height,fill:"child"===et?"rgba(103, 208, 113, 0.3)":"rgba(157, 172, 244, 0.3)",stroke:"#555",strokeDasharray:"2,2",strokeWidth:1,rx:4,ry:4,className:"drop-preview"})})()]}),(0,l.jsx)(A,{element:K,onEndEditing:()=>{p({type:"END_EDITING"}),o.current?.focus()}})]})]})});var $=i(5857),H=i(2554),U=i(7040),P=i(2152),G=i(2397),X=i(5194),F=i(1311),K=i(1496),W=i(6597),Y=i(9691),V=i(1081),z=i(8694),Z=i(1401),q=i(5833),J=i(5785),Q=i(8283),ee=i(514);let et={NEW:"新規作成",OPEN:"ファイルを開く",SAVE:"保存（JSON形式）",SAVE_SVG:"SVG画像で保存",ADD:"新しい要素の追加",DELETE:"要素の削除",AI:"AI機能",EXPAND:"展開",COLLAPSE:"折りたたみ",UNDO:"元に戻す",REDO:"やり直す",ZOOM_IN:"ズームイン",ZOOM_OUT:"ズームアウト",HELP:"ヘルプを表示",SETTINGS:"設定"},ei={TAB_BAR:{BACKGROUND:"#f0f0f0",ACTIVE_TAB_BACKGROUND:"#fff",INACTIVE_TAB_BACKGROUND:"#ddd",ACTIVE_TAB_BORDER:"#87CEFA",TAB_TEXT:"#000000",CLOSE_BUTTON_COLOR:"#666",ADD_BUTTON_BACKGROUND:"transparent",ADD_BUTTON_TEXT:"#000"},MENU_BAR:{BACKGROUND:"#f1f1f1",ICON_COLOR:"#666666",DIVIDER_COLOR:"#e0e0e0"},MODAL:{BACKGROUND:"#ffffff",TEXT_COLOR:"#000000",BUTTON_BACKGROUND:"#f1f1f1",BUTTON_TEXT:"#000000",BUTTON_BORDER:"#cccccc",BUTTON_PRIMARY_BACKGROUND:"#1976d2",BUTTON_PRIMARY_TEXT:"#ffffff"}},el={TAB_BAR:{BACKGROUND:"#333333",ACTIVE_TAB_BACKGROUND:"#555555",INACTIVE_TAB_BACKGROUND:"#444444",ACTIVE_TAB_BORDER:"#00aaff",TAB_TEXT:"#ffffff",CLOSE_BUTTON_COLOR:"#aaaaaa",ADD_BUTTON_BACKGROUND:"transparent",ADD_BUTTON_TEXT:"#ffffff"},MENU_BAR:{BACKGROUND:"#333333",ICON_COLOR:"#bbbbbb",DIVIDER_COLOR:"#444444"},MODAL:{BACKGROUND:"#333333",TEXT_COLOR:"#fefefe",BUTTON_BACKGROUND:"#555555",BUTTON_TEXT:"#ffffff",BUTTON_BORDER:"#666666",BUTTON_PRIMARY_BACKGROUND:"#1976d2",BUTTON_PRIMARY_TEXT:"#ffffff"}},er=e=>{let t=e.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,(e,t,i,l)=>t+t+i+i+l+l),i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return i?{r:parseInt(i[1],16),g:parseInt(i[2],16),b:parseInt(i[3],16)}:null},en=e=>{let t="string"==typeof e?er(e):e;return t?(299*t.r+587*t.g+114*t.b)/1e3:255},eo=e=>128>en(e),ea=e=>eo(e)?el:ei,es=e=>{let{saveSvg:t,loadElements:i,saveElements:r,toggleHelp:o,toggleSettings:a,onAIClick:h}=e,{dispatch:c,state:p}=s(),{addTab:x}=(0,m.u)(),f=(0,n.useRef)(null),g=(0,n.useRef)(null);if(!y())return null;let E=ea((0,u.Es)()),b=e=>()=>{c({type:e})};return(0,l.jsx)("div",{style:{position:"fixed",width:"100%",height:d.JY,overflowX:"auto",WebkitOverflowScrolling:"touch",msOverflowStyle:"none",scrollbarWidth:"none"},ref:g,children:(0,l.jsxs)("div",{style:{display:"flex",justifyContent:"left",alignItems:"center",height:"100%",backgroundColor:E.MENU_BAR.BACKGROUND,padding:"0 20px",minWidth:"max-content"},children:[(0,l.jsx)("input",{type:"file",ref:f,onChange:i,style:{display:"none"}}),(0,l.jsx)(ee.A,{title:et.NEW,children:(0,l.jsx)($.A,{variant:"text",className:"iconbar-button",onClick:x,children:(0,l.jsx)(Y.A,{sx:{color:E.MENU_BAR.ICON_COLOR}})})}),(0,l.jsx)(ee.A,{title:et.OPEN,children:(0,l.jsx)($.A,{variant:"text",className:"iconbar-button",onClick:()=>{f.current?.click()},children:(0,l.jsx)(X.A,{sx:{color:E.MENU_BAR.ICON_COLOR}})})}),(0,l.jsx)(ee.A,{title:et.SAVE,children:(0,l.jsx)($.A,{variant:"text",className:"iconbar-button",onClick:r,children:(0,l.jsx)(F.A,{sx:{color:E.MENU_BAR.ICON_COLOR}})})}),(0,l.jsx)(ee.A,{title:et.SAVE_SVG,children:(0,l.jsx)($.A,{variant:"text",className:"iconbar-button",onClick:t,children:(0,l.jsx)(K.A,{sx:{color:E.MENU_BAR.ICON_COLOR}})})}),(0,l.jsx)("div",{style:{width:"10px",backgroundColor:E.MENU_BAR.DIVIDER_COLOR,height:"60%",margin:"0 5px",opacity:.3}}),(0,l.jsx)(ee.A,{title:et.ADD,children:(0,l.jsx)($.A,{variant:"text",className:"iconbar-button",onClick:b("ADD_ELEMENT"),children:(0,l.jsx)(V.A,{sx:{color:E.MENU_BAR.ICON_COLOR}})})}),(0,l.jsx)(ee.A,{title:et.DELETE,children:(0,l.jsx)($.A,{variant:"text",className:"iconbar-button",onClick:b("DELETE_ELEMENT"),children:(0,l.jsx)(z.A,{sx:{color:E.MENU_BAR.ICON_COLOR}})})}),(0,l.jsx)(ee.A,{title:et.AI,children:(0,l.jsx)($.A,{variant:"text",className:"iconbar-button",onClick:h,children:(0,l.jsx)(Q.A,{sx:{color:E.MENU_BAR.ICON_COLOR}})})}),(0,l.jsx)(ee.A,{title:et.EXPAND,children:(0,l.jsx)($.A,{variant:"text",className:"iconbar-button",onClick:b("EXPAND_ELEMENT"),children:(0,l.jsx)(q.A,{sx:{color:E.MENU_BAR.ICON_COLOR}})})}),(0,l.jsx)(ee.A,{title:et.COLLAPSE,children:(0,l.jsx)($.A,{variant:"text",className:"iconbar-button",onClick:b("COLLAPSE_ELEMENT"),children:(0,l.jsx)(Z.A,{sx:{color:E.MENU_BAR.ICON_COLOR}})})}),(0,l.jsx)("div",{style:{width:"10px",backgroundColor:E.MENU_BAR.DIVIDER_COLOR,height:"60%",margin:"0 5px",opacity:.3}}),(0,l.jsx)(ee.A,{title:et.UNDO,children:(0,l.jsx)($.A,{variant:"text",className:"iconbar-button",onClick:b("UNDO"),children:(0,l.jsx)(H.A,{sx:{color:E.MENU_BAR.ICON_COLOR}})})}),(0,l.jsx)(ee.A,{title:et.REDO,children:(0,l.jsx)($.A,{variant:"text",className:"iconbar-button",onClick:b("REDO"),children:(0,l.jsx)(U.A,{sx:{color:E.MENU_BAR.ICON_COLOR}})})}),(0,l.jsx)("div",{style:{width:"10px",backgroundColor:E.MENU_BAR.DIVIDER_COLOR,height:"60%",margin:"0 5px",opacity:.3}}),(0,l.jsx)(ee.A,{title:et.ZOOM_IN,children:(0,l.jsx)($.A,{variant:"text",className:"iconbar-button",onClick:b("ZOOM_IN"),children:(0,l.jsx)(P.A,{sx:{color:E.MENU_BAR.ICON_COLOR}})})}),(0,l.jsx)(ee.A,{title:et.ZOOM_OUT,children:(0,l.jsx)($.A,{variant:"text",className:"iconbar-button",onClick:b("ZOOM_OUT"),children:(0,l.jsx)(G.A,{sx:{color:E.MENU_BAR.ICON_COLOR}})})}),(0,l.jsx)("div",{style:{width:"10px",backgroundColor:E.MENU_BAR.DIVIDER_COLOR,height:"60%",margin:"0 5px",opacity:.3}}),(0,l.jsx)(ee.A,{title:et.HELP,children:(0,l.jsx)($.A,{variant:"text",className:"iconbar-button",onClick:o,children:(0,l.jsx)(W.A,{sx:{color:E.MENU_BAR.ICON_COLOR}})})}),(0,l.jsx)(ee.A,{title:et.SETTINGS,children:(0,l.jsx)($.A,{variant:"text",className:"iconbar-button",onClick:a,children:(0,l.jsx)(J.A,{sx:{color:E.MENU_BAR.ICON_COLOR}})})})]})})},ed=n.memo(e=>{let{tab:t,isCurrent:i,closeTab:r,switchTab:n,theme:o}=e;return y()?(0,l.jsxs)("div",{style:{padding:"6px",marginRight:"4px",backgroundColor:i?o.TAB_BAR.ACTIVE_TAB_BACKGROUND:o.TAB_BAR.INACTIVE_TAB_BACKGROUND,borderBottom:i?`3px solid ${o.TAB_BAR.ACTIVE_TAB_BORDER}`:"none",paddingBottom:"3px",borderRadius:"5px 5px 0 0",fontSize:"12px",cursor:"pointer",display:"flex",alignItems:"center",color:o.TAB_BAR.TAB_TEXT,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",minWidth:"48px",maxWidth:"150px"},onClick:()=>n(t.id),children:[(0,l.jsx)("span",{style:{flex:"1 1 auto",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",minWidth:"0"},children:t.name}),(0,l.jsx)("button",{onClick:e=>{e.stopPropagation(),r(t.id)},style:{flex:"0 0 auto",marginLeft:"2px",border:"0",backgroundColor:"transparent",fontSize:"16px",color:o.TAB_BAR.CLOSE_BUTTON_COLOR,fontWeight:"bold",cursor:"pointer"},children:"\xd7"})]}):null}),eh=n.memo(e=>{let{tabs:t,currentTabId:i,addTab:r,closeTab:o,switchTab:a}=e,s=y(),[h,c]=(0,n.useState)(d.i_),[p,x]=(0,n.useState)(()=>ea(d.i_));return((0,n.useEffect)(()=>{if(!s)return;let e=(0,u.Es)();c(e),x(ea(e))},[s]),s)?(0,l.jsxs)("div",{style:{display:"flex",alignItems:"center",backgroundColor:p.TAB_BAR.BACKGROUND,width:"100%",height:d.FM,marginTop:d.JY,position:"fixed"},children:[t.map(e=>(0,l.jsx)(ed,{tab:e,isCurrent:i===e.id,closeTab:o,switchTab:a,theme:p},e.id)),(0,l.jsx)("button",{onClick:r,style:{marginLeft:"8px",backgroundColor:p.TAB_BAR.ADD_BUTTON_BACKGROUND,color:p.TAB_BAR.ADD_BUTTON_TEXT,border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"16px",padding:"2px 8px"},children:"+"})]}):null}),ec=e=>{let{isOpen:t,onClose:i,children:r}=e,o=y(),[a,d]=(0,n.useState)(()=>ea((0,u.Es)())),{dispatch:h}=s();return((0,n.useEffect)(()=>{o&&d(ea((0,u.Es)()))},[o]),(0,n.useEffect)(()=>{t&&h({type:"END_EDITING"})},[t,h]),t)?(0,l.jsx)("div",{style:{position:"fixed",top:0,left:0,width:"100%",height:"100%",backgroundColor:"rgba(0, 0, 0, 0.5)",display:"flex",justifyContent:"center",alignItems:"center",zIndex:9e3},children:(0,l.jsx)("div",{style:{backgroundColor:a.MODAL.BACKGROUND,color:a.MODAL.TEXT_COLOR,padding:"40px 24px 24px",borderRadius:"10px",width:"80%",maxWidth:"500px",overflow:"hidden",position:"relative",zIndex:9001},children:(0,l.jsxs)("div",{style:{maxHeight:"80vh",overflow:"auto"},children:[(0,l.jsx)("button",{onClick:i,style:{position:"absolute",right:10,top:10,background:"transparent",border:"none",fontSize:"1.5em",color:a.MODAL.TEXT_COLOR,cursor:"pointer"},children:"\xd7"}),(0,l.jsx)("div",{style:{flex:1,overflow:"auto",paddingRight:"8px"},children:r})]})})}):null};var eu=i(2582),ep=i(7498),ex=i(9284),ef=i(9868),eg=i(7923),eE=i(3025),em=i(8893),ey=i(5358),eb=i(7298),eT=i(9439),eO=i(4512),eC=i(8410);let ev=e=>{let{field:t,value:i,error:r=!1,onChange:n}=e;switch(t.type){case"text":return(0,l.jsx)(eu.A,{label:t.label,value:i,onChange:e=>n(e.target.value),fullWidth:!0,margin:"normal",multiline:"prompt"===t.key||"systemPromptTemplate"===t.key,rows:"prompt"===t.key||"systemPromptTemplate"===t.key?6:1,type:"apiKey"===t.key?"password":"text",helperText:t.helperText,variant:"prompt"===t.key||"systemPromptTemplate"===t.key?"outlined":"standard"});case"number":return(0,l.jsx)(eu.A,{label:t.label,type:"number",value:i,onChange:e=>n(e.target.value),fullWidth:!0,margin:"normal",inputProps:{min:t.validation?.min,max:t.validation?.max,step:t.validation?.step},error:r,helperText:r?`${t.validation?.min}から${t.validation?.max}の数値を入力してください`:t.helperText});case"select":return(0,l.jsxs)(ep.A,{fullWidth:!0,margin:"normal",children:[(0,l.jsx)(ex.A,{children:t.label}),(0,l.jsx)(ef.A,{value:String(i),label:t.label,onChange:e=>{n(e.target.value)},MenuProps:{sx:{zIndex:9999}},children:t.options?.map(e=>l.jsx(eg.A,{value:e.value,children:e.label},e.value))}),(0,l.jsx)(eE.A,{children:t.helperText})]});case"color":return(0,l.jsxs)(em.A,{sx:{display:"flex",alignItems:"center",mt:2,mb:1},children:[(0,l.jsxs)(ey.A,{variant:"body1",sx:{mr:2,width:"120px"},children:[t.label,":"]}),(0,l.jsx)("input",{type:"color",value:String(i),onChange:e=>n(e.target.value)}),(0,l.jsx)(eE.A,{children:t.helperText})]});case"radio":return(0,l.jsxs)(ep.A,{component:"fieldset",fullWidth:!0,children:[(0,l.jsx)(eb.A,{component:"legend",children:t.label}),(0,l.jsx)(eT.A,{children:t.options?.map(e=>l.jsx(eO.A,{value:e.value,control:l.jsx(eC.A,{checked:i===e.value,onChange:e=>n(e.target.value)}),label:e.label},e.value))}),(0,l.jsx)(eE.A,{children:t.helperText})]});default:return null}};var eA=i(5055),eI=i(460),ew=i(270),eN=i(3745);let eR=[{id:0,label:"Elements Setting",fields:[{key:"numberOfSections",label:"Number of sections",type:"number",helperText:"同時に表示するセクションの数（1〜10） ※現在のタブと新規作成されるタブのデフォルト値として設定されます",defaultValue:3,validation:{min:1,max:10,required:!0}},{key:"markerType",label:"Default Marker Type",type:"select",helperText:"新規要素作成時のデフォルトマーカータイプ",defaultValue:d.vX.NONE,options:[{value:d.vX.NONE,label:"None"},{value:d.vX.ARROW,label:"Arrow"},{value:d.vX.CIRCLE,label:"Circle"},{value:d.vX.SQUARE,label:"Square"},{value:d.vX.DIAMOND,label:"Diamond"},{value:d.vX.FILLED_ARROW,label:"Filled Arrow"},{value:d.vX.FILLED_CIRCLE,label:"Filled Circle"},{value:d.vX.FILLED_SQUARE,label:"Filled Square"},{value:d.vX.FILLED_DIAMOND,label:"Filled Diamond"}]},{key:"canvasBackgroundColor",label:"Canvas Background Color",type:"color",helperText:"キャンバスの背景色",defaultValue:"#ffffff"},{key:"elementColor",label:"Element Color",type:"color",helperText:"要素の背景色",defaultValue:"#ffffff"},{key:"textColor",label:"Text Color",type:"color",helperText:"テキストの色",defaultValue:"#000000"},{key:"strokeColor",label:"Stroke Color",type:"color",helperText:"要素の枠線色",defaultValue:"#000000"},{key:"strokeWidth",label:"Stroke Width",type:"number",helperText:"要素の枠線の太さ",defaultValue:1,validation:{min:.5,step:.5,required:!0}},{key:"connectionPathColor",label:"Connection Path Color",type:"color",helperText:"接続線の色",defaultValue:"#000000"},{key:"connectionPathStroke",label:"Connection Path Stroke",type:"number",helperText:"接続線の太さ",defaultValue:1,validation:{min:.5,step:.5,required:!0}},{key:"fontFamily",label:"Font Family",type:"text",helperText:"表示に使用するフォントファミリ",defaultValue:""}]},{id:1,label:"API Setting",fields:[{key:"modelType",label:"Select Model",type:"radio",helperText:"APIモデルの選択",defaultValue:"gemini-1.5-flash",options:[{value:"gemini-1.5-flash",label:"Gemini-1.5-flash"},{value:"gemini-2.0-flash",label:"Gemini-2.0-flash"}]},{key:"apiKey",label:"Gemini API Key",type:"text",helperText:"入力されたキーは暗号化してlocalStorageに保存されます。サーバに送信されることはありません。",defaultValue:""}]},{id:2,label:"Prompt",fields:[{key:"prompt",label:"inputText",type:"text",helperText:"",defaultValue:""},{key:"systemPromptTemplate",label:"SystemPromptTemplate",type:"text",helperText:"",defaultValue:""}]}],eD=e=>{let{isOpen:t,onClose:i}=e,r=y(),[o,a]=(0,n.useState)(0),[s,d]=(0,n.useState)({}),[h,c]=(0,n.useState)({}),[p,x]=(0,n.useState)("light"),[f,g]=(0,n.useState)(()=>ea((0,u.Es)())),{getCurrentTabNumberOfSections:E,updateCurrentTabNumberOfSections:b}=(0,m.u)();if((0,n.useEffect)(()=>{let e=(0,u.Es)();x(eo(e)?"dark":"light"),g(ea(e))},[r]),(0,n.useEffect)(()=>{r&&t&&(async()=>{let e={};try{e.apiKey=await (0,u.CG)(),e.systemPromptTemplate=(0,u.k0)(),e.modelType=(0,u.OA)(),e.prompt=(0,u.XH)(),e.numberOfSections=E(),e.elementColor=(0,u.kN)(),e.strokeColor=(0,u._1)(),e.strokeWidth=(0,u.xo)(),e.fontFamily=(0,u.af)(),e.markerType=(0,u.zn)(),e.connectionPathColor=(0,u.ZF)(),e.connectionPathStroke=(0,u.S4)(),e.canvasBackgroundColor=(0,u.Es)(),e.textColor=(0,u.vG)(),d(e)}catch(e){console.error("Failed to load settings:",e)}})()},[r,t,E]),!r)return null;let T=(0,ew.A)({palette:{mode:p,background:{default:f.MODAL.BACKGROUND,paper:f.MODAL.BACKGROUND},text:{primary:f.MODAL.TEXT_COLOR,secondary:f.MODAL.TEXT_COLOR}},components:{MuiButton:{styleOverrides:{root:{color:f.MODAL.BUTTON_TEXT,borderColor:f.MODAL.BUTTON_BORDER},contained:{backgroundColor:f.MODAL.BUTTON_PRIMARY_BACKGROUND,color:f.MODAL.BUTTON_PRIMARY_TEXT,"&:hover":{backgroundColor:f.MODAL.BUTTON_PRIMARY_BACKGROUND,opacity:.9}},outlined:{backgroundColor:f.MODAL.BUTTON_BACKGROUND,"&:hover":{backgroundColor:f.MODAL.BUTTON_BACKGROUND,opacity:.9}}}}}}),O=(e,t)=>{if("number"===e.type){let i="string"==typeof t?parseFloat(t):t;if(e.validation?.required&&(""===t||isNaN(i))||!isNaN(i)&&(e.validation?.min!==void 0&&i<e.validation.min||e.validation?.max!==void 0&&i>e.validation.max))return!1}return!0},C=(e,t)=>{d(i=>({...i,[e.key]:t})),c(i=>({...i,[e.key]:!O(e,t)}))},v=async()=>{let e=!1;if(eR.forEach(t=>{t.fields.forEach(t=>{let i=s[t.key];O(t,i)||(e=!0,c(e=>({...e,[t.key]:!0})))})}),e)return;let t=s.apiKey;void 0!==t&&await (0,u.wt)(String(t));let l=s.systemPromptTemplate;void 0!==l&&(0,u.mF)(String(l));let r=s.modelType;void 0!==r&&(0,u.Iz)(String(r));let n=s.prompt;void 0!==n&&(0,u.bJ)(String(n));let o=s.numberOfSections;if(void 0!==o){let e=Number(o);(0,u.jE)(e),b(e)}let a=s.elementColor;void 0!==a&&(0,u.qu)(String(a));let d=s.strokeColor;void 0!==d&&(0,u.JT)(String(d));let h=s.strokeWidth;void 0!==h&&(0,u.Jg)(Number(h));let p=s.fontFamily;void 0!==p&&(0,u.Yu)(String(p));let x=s.markerType;void 0!==x&&(0,u.li)(String(x));let f=s.connectionPathColor;void 0!==f&&(0,u.xN)(String(f));let g=s.connectionPathStroke;void 0!==g&&(0,u.K2)(Number(g));let E=s.canvasBackgroundColor;void 0!==E&&(0,u.QY)(String(E));let m=s.textColor;void 0!==m&&(0,u.vY)(String(m)),i()};return(0,l.jsx)(ec,{isOpen:t,onClose:i,children:(0,l.jsx)(eN.A,{theme:T,children:(0,l.jsxs)(em.A,{sx:{backgroundColor:f.MODAL.BACKGROUND,color:f.MODAL.TEXT_COLOR,padding:2,borderRadius:1},children:[(0,l.jsx)(ey.A,{variant:"h6",gutterBottom:!0,color:"textPrimary",children:"Preference"}),(0,l.jsx)(eA.A,{value:o,onChange:(e,t)=>a(t),textColor:"primary",indicatorColor:"primary",children:eR.map(e=>(0,l.jsx)(eI.A,{label:e.label},e.id))}),(0,l.jsx)(em.A,{sx:{mt:2,minHeight:300},children:eR.map(e=>o===e.id&&(0,l.jsx)(em.A,{children:e.fields.map(e=>(0,l.jsx)(ev,{field:e,value:s[e.key]??e.defaultValue,error:h[e.key],onChange:t=>C(e,t)},e.key))},e.id))}),(0,l.jsxs)(em.A,{sx:{mt:2,display:"flex",justifyContent:"flex-end",gap:1},children:[(0,l.jsx)($.A,{variant:"outlined",onClick:i,children:"Cancel"}),(0,l.jsx)($.A,{variant:"contained",onClick:v,color:"primary",disabled:Object.values(h).some(Boolean),children:"OK"})]})]})})})},e_=e=>{let{showCloseConfirm:t,setShowCloseConfirm:i,tabToClose:r,closeTab:n}=e;return t?(0,l.jsx)(ec,{isOpen:t,onClose:()=>i(!1),children:(0,l.jsxs)("div",{style:{padding:"20px"},children:[(0,l.jsx)("p",{style:{marginBottom:"20px"},children:"タブを閉じてよろしいですか？"}),(0,l.jsxs)("div",{style:{display:"flex",justifyContent:"flex-end",gap:"10px"},children:[(0,l.jsx)($.A,{variant:"outlined",onClick:()=>i(!1),children:"いいえ"}),(0,l.jsx)($.A,{variant:"contained",color:"primary",onClick:()=>{r&&n(r),i(!1)},children:"はい"})]})]})}):null},eS=`
<h4>Keyboard shortcuts</h4>
<p>Tab: Add a child element to the selected element</p>
<p>Shift + Tab: Add a sibling element to the selected element</p>
<p>Delete/Backspace: Remove the selected element</p>
<p>Enter: Edit the selected element</p>
<p>Esc: Stop editing the selected element</p>
<p>Tab in editing mode: Move the focus to the next text box</p>
<p>Ctrl + Z: Undo the last action</p>
<p>Shift + Ctrl + Z: Redo the last action</p>
<p>Ctrl + X: Cut the selected element</p>
<p>Ctrl + C: Copy the selected element</p>
<p>Ctrl + V: Paste the copied element</p>
<p>Ctrl + ArrowLeft: Collapse the children of the selected element</p>
<p>Ctrl + ArrowRight: Expand the children of the selected element</p>
<p>Arrow keys: Navigate between elements</p>

<h4>Mouse operations</h4>
<p>Click: Select an element</p>
<p>Double click: Edit the selected element</p>
<p>Clicking outside the element will end the editing mode</p>
<p>Drag: Move the selected element</p>

<h4>Menu operations</h4>
<p>New: Create a new diagram. Unsaved changes will be discarded.</p>
<p>Open: Load saved data. The current data will be discarded.</p>
<p>Save as: Save the diagram data in JSON format</p>
<p>Export: Export the diagram in SVG format</p>
`;var ej=i(6545),ek=i(4098),eL=i(3464);let eM=async(e,t,i)=>{try{console.log("prompt: \n",e);let i=`${(0,u.G6)()}?key=${t}`,l=await eL.A.post(i,{contents:[{parts:[{text:e}]}]},{headers:{"Content-Type":"application/json"}}),r=l.data.candidates?.[0]?.content?.parts?.[0]?.text||"";return console.log(r),r}catch(e){throw console.error("Gemini API Error:",e),Error("API呼び出しに失敗しました")}},eB=e=>{let{structureText:t,inputText:i}=e;return(0,u.k0)().replace("{{structureText}}",t).replace("{{inputText}}",i)},e$=()=>{let{tabs:e,currentTabId:t,addTab:i,closeTab:o,switchTab:s,updateTabState:d,updateTabName:h}=(0,m.u)(),c=(0,n.useMemo)(()=>e.find(e=>e.id===t),[e,t]),[p,x]=(0,n.useState)(!1),[f,g]=(0,n.useState)(!1),[y,b]=(0,n.useState)(null),[T,O]=(0,n.useState)(!1),{addToast:C}=(0,R.d)(),v=(0,n.useCallback)(e=>{d(t,t=>(0,ej.F)(t,e))},[t,d]),A=(0,n.useCallback)(()=>{v({type:"END_EDITING"}),x(e=>!e)},[v]),I=(0,n.useCallback)(()=>{v({type:"END_EDITING"}),g(e=>!e)},[v]),w=e=>{b(e),O(!0)},N=(0,n.useCallback)(async()=>{if(!c)return;let e=Object.values(c.state.elements).find(e=>e.selected);if(!e){C(r.noSelect);return}let t=await (0,u.CG)();if(!t){C(r.noApiKey,"warn");return}let i=localStorage.getItem("prompt")||"";if(!i){C(r.noPrompt);return}try{let l=(0,E.YV)(c.state.elements,e.id),r=eB({structureText:l,inputText:i}),n=(0,u.OA)(),o=await eM(r,t,n),a=[];Array.isArray(o)?a=o:"string"==typeof o&&(a=(o.match(/```[\s\S]*?```/g)||[]).flatMap(e=>e.replace(/```/g,"").split("\n").map(e=>e.trim()).filter(e=>e.length>0))),v({type:"ADD_ELEMENTS_SILENT",payload:{parentId:e.id,texts:a,tentative:!0}})}catch(e){C(e instanceof Error?`${r.aiError}: ${e.message}`:r.aiError)}},[c,v,C]),D=(0,n.useMemo)(()=>c?(0,l.jsxs)(a,{state:c.state,dispatch:v,children:[(0,l.jsx)(B,{isHelpOpen:p,toggleHelp:A}),(0,l.jsx)(eh,{tabs:e,currentTabId:t,addTab:i,closeTab:w,switchTab:s}),(0,l.jsx)(es,{saveSvg:()=>(0,ek.Sz)(document.querySelector(".svg-element"),"download.svg"),loadElements:e=>(0,ek.wl)(e.nativeEvent).then(e=>{let{elements:i,fileName:l}=e;v({type:"LOAD_ELEMENTS",payload:i}),h(t,l.replace(".json",""))}).catch(e=>C(e.message)),saveElements:()=>(0,ek.$r)(Object.values(c.state.elements),c.name),toggleHelp:A,toggleSettings:I,onAIClick:N}),(0,l.jsx)(e_,{showCloseConfirm:T,setShowCloseConfirm:O,tabToClose:y,closeTab:o}),(0,l.jsx)(eD,{isOpen:f,onClose:I}),(0,l.jsx)(ec,{isOpen:p,onClose:A,children:(0,l.jsx)("div",{dangerouslySetInnerHTML:{__html:eS}})})]}):null,[c,v,A,p,t,h,I,C,N,T,y,o,f]);return(0,l.jsx)("div",{children:D})}}},e=>{var t=t=>e(e.s=t);e.O(0,[629,255,441,684,358],()=>t(1469)),_N_E=e.O()}]);
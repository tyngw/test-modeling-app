(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{4224:(e,t,i)=>{Promise.resolve().then(i.bind(i,5436))},5436:(e,t,i)=>{"use strict";i.d(t,{default:()=>tZ});var r=i(5155),n=i(2115),l=i(1782);let a=(0,n.createContext)(void 0),o=e=>{let{children:t,state:i,dispatch:l}=e,o=(0,n.useMemo)(()=>({state:i,dispatch:l}),[i,l]);return(0,r.jsx)(a.Provider,{value:o,children:t})},s=()=>{let e=(0,n.useContext)(a);if(!e)throw Error("useCanvas must be used within a CanvasProvider");return e};var c=i(829),d=i(3346),h=i(6323),u=i(2135);let g=/(https?:\/\/[^\s]+|www\.[^\s]+)/gi;function p(e){(function(e){try{return new URL(e),!0}catch{return!1}})(e)&&window.open(e,"_blank","noopener,noreferrer")}function f(){let e=navigator.userAgent,t=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(e),i="ontouchstart"in window||navigator.maxTouchPoints>0,r=window.innerWidth<=768;return t||i&&r}function x(e){let{url:t,isVisible:i,onClose:n}=e;return i?(0,r.jsx)("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:9999,display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"rgba(0, 0, 0, 0.3)"},onClick:e=>{e.target===e.currentTarget&&n()},children:(0,r.jsxs)("div",{style:{backgroundColor:"white",borderRadius:"8px",boxShadow:"0 10px 25px rgba(0, 0, 0, 0.1)",padding:"16px",margin:"16px",maxWidth:"320px",width:"100%",position:"relative"},children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{style:{fontSize:"14px",fontWeight:"500",color:"#111827",marginBottom:"8px",margin:"0 0 8px 0"},children:"リンクを開く"}),(0,r.jsx)("p",{style:{fontSize:"12px",color:"#6b7280",wordBreak:"break-all",backgroundColor:"#f9fafb",padding:"8px",borderRadius:"4px",marginBottom:"12px"},children:t})]}),(0,r.jsxs)("div",{style:{display:"flex",gap:"8px"},children:[(0,r.jsx)("button",{style:{flex:1,backgroundColor:"#3b82f6",color:"white",fontSize:"14px",padding:"8px 16px",borderRadius:"4px",border:"none",cursor:"pointer",transition:"background-color 0.2s"},onClick:()=>{p(t),n()},onMouseOver:e=>{e.target.style.backgroundColor="#2563eb"},onMouseOut:e=>{e.target.style.backgroundColor="#3b82f6"},children:"開く"}),(0,r.jsx)("button",{style:{flex:1,backgroundColor:"#e5e7eb",color:"#374151",fontSize:"14px",padding:"8px 16px",borderRadius:"4px",border:"none",cursor:"pointer",transition:"background-color 0.2s"},onClick:n,onMouseOver:e=>{e.target.style.backgroundColor="#d1d5db"},onMouseOut:e=>{e.target.style.backgroundColor="#e5e7eb"},children:"キャンセル"})]})]})}):null}let E=(0,n.memo)(function(e){let{x:t,y:i,width:l,height:a,text:o,zoomRatio:s,fontFamily:E,onHeightChange:m,onUrlClick:y,onElementClick:T,onMouseDown:C,onTouchStart:D,onDoubleClick:b,isSelected:w=!1}=e,[I,O]=(0,n.useState)({width:0,height:0}),[S,$]=(0,n.useState)(!1),[v,A]=(0,n.useState)(c._K),[k,N]=(0,n.useState)({isVisible:!1,url:"",position:{x:0,y:0}}),R=(0,n.useRef)(null),j=(0,n.useRef)({width:0,height:0}),_=(0,n.useRef)(o);if((0,n.useRef)(m).current=m,(0,n.useEffect)(()=>{A((0,h.vG)())},[]),(0,n.useEffect)(()=>{let e;return $(!0),S&&(o!==_.current||l!==j.current.width||a!==j.current.height)&&(e=requestAnimationFrame(()=>{if(!R.current)return;let e=Math.min(c.SK.WIDTH.MAX,l),t=(0,d.C1)(o||"",e,s),i=c.gI*c.RZ*s,r=Math.max(c.SK.SECTION_HEIGHT*s,(i+c.rF.VERTICAL)*s),n=Math.max(t.length*i,r)+c.rF.VERTICAL*s,a=Math.abs(e-j.current.width)>1,h=Math.abs(n-j.current.height)>1;(a||h)&&(O({width:e,height:n}),j.current={width:e,height:n})}),_.current=o),()=>{e&&cancelAnimationFrame(e)}},[o,l,a,s,S]),!S)return null;let L=(0,u.jZ)(o||""),M=(L.match(g)||[]).map(e=>e.startsWith("www.")?`https://${e}`:e),B=(e,t)=>{let i=t.ctrlKey||t.metaKey,r=f();i&&!r?p(e):r&&N({isVisible:!0,url:e,position:{x:t.clientX,y:t.clientY}}),y&&y(e,t)},P=(e,t)=>{let i=t.ctrlKey||t.metaKey,r=f();if(i&&!r){t.preventDefault(),t.stopPropagation(),p(e);return}if(r&&w){t.preventDefault(),t.stopPropagation(),B(e,t);return}T&&T(t)},H=(e,t)=>{let i=f(),r=t.changedTouches[0];if(!r)return;if(console.log(`[DEBUG] URL touched on mobile. isSelected: ${w}, url: ${e}`),i&&w){t.preventDefault(),t.stopPropagation(),console.log(`[DEBUG] Opening URL on mobile: ${e}`),p(e);return}let n={clientX:r.clientX,clientY:r.clientY,ctrlKey:!1,metaKey:!1,preventDefault:()=>t.preventDefault(),stopPropagation:()=>t.stopPropagation()};T&&T(n)};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("foreignObject",{x:t,y:i,width:I.width,height:Math.round(I.height/s),pointerEvents:"all",style:{touchAction:"manipulation"},children:(0,r.jsx)("div",{ref:R,style:{fontFamily:E||c.zs,color:v,fontSize:`${c.gI}px`,lineHeight:c.RZ,width:`${I.width-c.rF.HORIZONTAL}px`,minHeight:`${c.SK.SECTION_HEIGHT}px`,padding:`${.5*c.rF.VERTICAL}px ${.5*c.rF.HORIZONTAL}px`,overflow:"hidden",whiteSpace:"pre-wrap",wordBreak:"break-word",boxSizing:"content-box",pointerEvents:"all",touchAction:"manipulation"},onClick:e=>{let t=e.target;if("SPAN"===t.tagName&&t.hasAttribute("data-url")){let t=e.ctrlKey||e.metaKey,i=f();t||i||!T||T(e);return}T&&T(e)},onDoubleClick:b,onMouseDown:C,onTouchStart:D,onTouchEnd:e=>{let t=e.target;if("SPAN"===t.tagName&&t.hasAttribute("data-url"))return;let i=e.changedTouches[0];if(!i)return;let r={clientX:i.clientX,clientY:i.clientY,ctrlKey:!1,metaKey:!1,preventDefault:()=>e.preventDefault(),stopPropagation:()=>e.stopPropagation()};T&&T(r)},children:(e=>{if(0===M.length)return e;let t=[],i=0;return M.forEach((n,l)=>{let a=e.indexOf(n,i);-1!==a&&(a>i&&t.push(e.substring(i,a)),t.push((0,r.jsx)("span",{"data-url":n,style:{color:"#1a73e8",textDecoration:"underline",cursor:"pointer",touchAction:"manipulation"},onClick:e=>P(n,e),onTouchEnd:e=>H(n,e),children:n},`url-${l}`)),i=a+n.length)}),i<e.length&&t.push(e.substring(i)),t})(L)})}),(0,r.jsx)(x,{url:k.url,isVisible:k.isVisible,onClose:()=>N(e=>({...e,isVisible:!1})),position:k.position})]})});var m=i(6670),y=i(840),T=i(9605),C=i(9929),D=i(7242);let b=()=>{let[e,t]=(0,n.useState)(!1);return(0,n.useEffect)(()=>{t(!0)},[]),e},w=(e,t,i)=>(e=>{if(!e.tentative)return!1;let t=i?(0,l.c3)(i,e.id):null,r=t?t.data.id:null,n=Math.min(...(i&&r?(0,l.PW)(i,r):i&&null===r&&i.root?[i.root.data]:[]).filter(e=>e.tentative).map(e=>parseInt(e.id)));return parseInt(e.id)===n})(e)?(0,r.jsxs)("g",{transform:`translate(${e.x+1.1*e.width},${e.y})`,onClick:e=>e.stopPropagation(),style:{cursor:"pointer",pointerEvents:"all"},"data-exclude-from-export":"true",children:[(0,r.jsxs)("g",{children:[(0,r.jsx)("rect",{x:"0",y:"0",width:"24",height:"24",rx:"4",fill:"white",stroke:"#e0e0e0",strokeWidth:"1"}),(0,r.jsx)("foreignObject",{x:"4",y:"4",width:"16",height:"16",children:(0,r.jsx)(y.A,{sx:{color:"#4CAF50","&:hover":{color:"#388E3C"},transition:"color 0.2s ease-in-out"},style:{width:"100%",height:"100%"},onClick:()=>{let r=i?(0,l.c3)(i,e.id):null;t({type:"CONFIRM_TENTATIVE_ELEMENTS",payload:r?r.data.id:"root"})}})})]}),(0,r.jsxs)("g",{transform:"translate(30, 0)",children:[(0,r.jsx)("rect",{x:"0",y:"0",width:"24",height:"24",rx:"4",fill:"white",stroke:"#e0e0e0",strokeWidth:"1"}),(0,r.jsx)("foreignObject",{x:"4",y:"4",width:"16",height:"16",children:(0,r.jsx)(T.A,{sx:{color:"#F44336","&:hover":{color:"#D32F2F"},transition:"color 0.2s ease-in-out"},style:{width:"100%",height:"100%"},onClick:()=>{let r=i?(0,l.c3)(i,e.id):null;t({type:"CANCEL_TENTATIVE_ELEMENTS",payload:r?r.data.id:"root"})}})})]})]}):null,I=n.memo(e=>{let{element:t,currentDropTarget:i,dropPosition:a,draggingElement:o,handleMouseDown:u,onHoverChange:g,_dropInsertY:p,_siblingInfo:f}=e,{dispatch:x}=s(),{getCurrentTabState:y}=(0,D.u)(),T=(0,n.useMemo)(()=>y()||{elements:{},zoomRatio:1},[y]),I=b(),O=i?.id||-1,[S,$]=(0,n.useState)(!1),v=(0,n.useRef)(!1),[A,k]=(0,n.useState)(c.iC.NORMAL.COLOR),[N,R]=(0,n.useState)(c.iC.NORMAL.STROKE_COLOR),[j,_]=(0,n.useState)(c.iC.STROKE_WIDTH),[L,M]=(0,n.useState)(""),[B,P]=(0,n.useState)(c.iC.SELECTED.STROKE_COLOR);(0,n.useEffect)(()=>{I&&(k((0,h.kN)()),R((0,h._1)()),_((0,h.xo)()),M((0,h.af)()),P((0,h.N4)()))},[I]),(0,n.useEffect)(()=>{if(t.editing||!I)return;let{newWidth:e,newHeight:i,sectionHeights:r}=(()=>{let e=(0,d.PC)(t.texts,c.rF.HORIZONTAL),i=t.texts.map(t=>{let i=(0,d.C1)(t||"",e,T.zoomRatio).length;return Math.max(c.SK.SECTION_HEIGHT*T.zoomRatio,i*c.gI*c.RZ+c.rF.VERTICAL*T.zoomRatio)});return{newWidth:e,newHeight:i.reduce((e,t)=>e+t,0),sectionHeights:i}})();t.editing||e===t.width&&i===t.height||x({type:"UPDATE_ELEMENT_SIZE",payload:{id:t.id,width:e,height:i,sectionHeights:r}})},[t.editing,t.texts,t.width,t.height,x,t.id,T.zoomRatio,I]);let H=(0,n.useMemo)(()=>"hierarchicalData"in T&&T.hierarchicalData?(0,l.PW)(T.hierarchicalData,t.id).filter(e=>!e.visible):[],[T,t.id]),X=(0,n.useMemo)(()=>{if(!o)return!1;if(o.id===t.id)return!0;if("hierarchicalData"in T&&T.hierarchicalData){let e=(0,l.Xd)(T.hierarchicalData);return(0,C.K9)(e,o.id,t.id)}return!1},[o,t.id,T]),G=(0,n.useCallback)((e,i)=>{let r=t.sectionHeights[e];if(null!==r&&Math.abs(i-r)>1){let r=[...t.sectionHeights];r[e]=i;let n=(0,d.PC)(t.texts,c.rF.HORIZONTAL),l=r.reduce((e,t)=>e+t,0);x({type:"UPDATE_ELEMENT_SIZE",payload:{id:t.id,width:n,height:l,sectionHeights:r}})}},[x,t]),U=e=>{e.stopPropagation(),console.log(`[DEBUG] Element ${t.id} clicked - current selected: ${t.selected}`),x({type:"SELECT_ELEMENT",payload:{id:t.id,ctrlKey:e.ctrlKey||e.metaKey,shiftKey:e.shiftKey}})},W=(0,n.useCallback)(()=>{$(!0),g&&!v.current&&(g(t.id,!0),v.current=!0)},[t.id,g]),F=(0,n.useCallback)(()=>{$(!1),g&&v.current&&(g(t.id,!1),v.current=!1)},[t.id,g]);return((0,n.useEffect)(()=>()=>{g&&v.current&&g(t.id,!1)},[t.id,g]),I)?(0,r.jsx)(n.Fragment,{children:(0,r.jsxs)("g",{opacity:X?.3:1,onMouseEnter:W,onMouseLeave:F,children:[w(t,x,"hierarchicalData"in T?T.hierarchicalData:null),H.length>0&&(0,r.jsxs)(r.Fragment,{children:[t.texts.length>1?(0,r.jsx)("rect",{x:t.x+c.N,y:t.y+c.N,width:t.width,height:t.height,rx:c.iC.RX,fill:"none",stroke:c.iC.SHADDOW.COLOR,strokeWidth:j},`shadow-${t.id}`):(0,r.jsx)("line",{x1:t.x+c.N,y1:t.y+t.height+c.N,x2:t.x+t.width+c.N,y2:t.y+t.height+c.N,stroke:c.iC.SHADDOW.COLOR,strokeWidth:j},`shadow-line-${t.id}`),(0,r.jsxs)("g",{transform:`translate(${t.x+1.1*t.width},${t.y})`,onClick:e=>{e.stopPropagation(),x({type:"SELECT_ELEMENT",payload:{id:t.id,ctrlKey:!1,shiftKey:!1}}),x({type:"EXPAND_ELEMENT"})},style:{cursor:"pointer"},"data-exclude-from-export":"true",children:[(0,r.jsx)("rect",{x:"0",y:"0",width:"24",height:"24",rx:"4",fill:"white",stroke:"#e0e0e0",strokeWidth:"1"}),(0,r.jsx)("svg",{x:"4",y:"4",width:"16",height:"16",viewBox:"0 0 24 24",children:(0,r.jsx)(m.A,{sx:{color:"#666666"},style:{width:"100%",height:"100%"}})})]})]}),(0,r.jsx)("defs",{children:(0,r.jsx)("filter",{id:"boxShadow",x:"-20%",y:"-20%",width:"140%",height:"140%",children:(0,r.jsx)("feDropShadow",{dx:"2",dy:"2",stdDeviation:"3",floodColor:"gray"})})}),(0,r.jsx)("rect",{x:t.x,y:t.y,width:t.width,height:t.height,rx:c.iC.RX,strokeWidth:j,stroke:t.texts.length>1?t.selected?B:t.tentative?"#9E9E9E":N:"transparent",strokeDasharray:t.tentative?"4 2":"none",onClick:U,onDoubleClick:e=>{console.log(`[DEBUG] onDoubleClick triggered for element ${t.id}`,{editing:t.editing,selected:t.selected}),e.stopPropagation(),x({type:"EDIT_ELEMENT"})},onMouseDown:e=>{console.log(`[DEBUG] onMouseDown triggered for element ${t.id}`,{button:e.button,selected:t.selected}),u(e,t)},onTouchStart:e=>{console.log(`[DEBUG] onTouchStart triggered for element ${t.id}`,{selected:t.selected});let i=e.touches[0];u({clientX:i.clientX,clientY:i.clientY,button:0,buttons:1,ctrlKey:!1,metaKey:!1,shiftKey:!1,altKey:!1,detail:1,currentTarget:e.currentTarget,target:e.target,preventDefault:()=>e.preventDefault(),stopPropagation:()=>e.stopPropagation(),nativeEvent:e.nativeEvent},t)},"data-element-id":t.id,style:{fill:t.id===O&&"child"===a?c.iC.DRAGGING.COLOR:A,strokeOpacity:t.tentative?.6:1,pointerEvents:"all",cursor:S?"pointer":"default",filter:t.selected&&t.texts.length>1?"url(#boxShadow)":"none"}}),1===t.texts.length&&I&&(0,r.jsxs)(r.Fragment,{children:[t.selected&&(0,r.jsx)("line",{x1:t.x+2,y1:t.y+t.height+2,x2:t.x+t.width+1,y2:t.y+t.height+2,strokeOpacity:.4,stroke:N,strokeWidth:t.selected&&0===j?2:j,strokeLinecap:"round",pointerEvents:"none","data-exclude-from-export":"true"}),(0,r.jsx)("line",{x1:t.x,y1:t.y+t.height,x2:t.x+t.width,y2:t.y+t.height,stroke:t.selected?B:t.tentative?"#9E9E9E":N,strokeWidth:t.selected&&0===j?2:j,strokeDasharray:t.tentative?"4 2":"none",pointerEvents:"none"})]}),t.texts.map((e,i)=>(0,r.jsxs)(n.Fragment,{children:[!t.editing&&(0,r.jsx)(E,{x:t.x,y:t.y+t.sectionHeights.slice(0,i).reduce((e,t)=>e+t,0),width:t.width,height:t.sectionHeights[i],text:e,fontSize:c.gI,zoomRatio:T.zoomRatio,fontFamily:L,onHeightChange:e=>G(i,e),onUrlClick:void 0,onElementClick:U,onDoubleClick:e=>{console.log(`[DEBUG] TextDisplayArea onDoubleClick for element ${t.id}`),e.stopPropagation(),x({type:"EDIT_ELEMENT"})},onMouseDown:e=>{console.log(`[DEBUG] TextDisplayArea onMouseDown for element ${t.id}`),u({...e,currentTarget:e.currentTarget,target:e.target,nativeEvent:e.nativeEvent},t)},onTouchStart:e=>{console.log(`[DEBUG] TextDisplayArea onTouchStart for element ${t.id}`);let i=e.touches[0];u({clientX:i.clientX,clientY:i.clientY,button:0,buttons:1,ctrlKey:!1,metaKey:!1,shiftKey:!1,altKey:!1,detail:1,currentTarget:e.currentTarget,target:e.target,preventDefault:()=>e.preventDefault(),stopPropagation:()=>e.stopPropagation(),nativeEvent:e.nativeEvent},t)},isSelected:t.selected}),i<t.texts.length-1&&(0,r.jsx)("line",{x1:t.x,y1:t.y+t.sectionHeights.slice(0,i+1).reduce((e,t)=>e+t,0),x2:t.x+t.width,y2:t.y+t.sectionHeights.slice(0,i+1).reduce((e,t)=>e+t,0),stroke:N,strokeWidth:"1"})]},`${t.id}-section-${i}`))]})},t.id):null});var O=i(8265);let S=e=>{let{element:t,isHovered:i,currentDropTarget:n,dropPosition:l,isDraggedOrDescendant:a,siblingInfo:o,elements:s}=e;return O.y&&i?(0,r.jsx)("foreignObject",{x:t.x+t.width+10,y:t.y-10,width:"360",height:"420",className:"debug-info","data-exclude-from-export":"true",children:(0,r.jsxs)("div",{style:{fontSize:"11px",color:"#000000",backgroundColor:"white",border:"1px solid #ccc",padding:"5px",borderRadius:"4px",boxShadow:"0 2px 5px rgba(0,0,0,0.2)"},children:[(0,r.jsxs)("h3",{style:{margin:"0 0 5px 0"},children:["id: ",t.id]}),(0,r.jsx)("table",{style:{borderCollapse:"collapse",width:"100%"},children:(0,r.jsxs)("tbody",{children:[(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"position"}),(0,r.jsx)("td",{children:":"}),(0,r.jsxs)("td",{children:["x: ",t.x,", y: ",t.y]})]}),(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"size"}),(0,r.jsx)("td",{children:":"}),(0,r.jsxs)("td",{children:["width: ",t.width,", height: ",t.height]})]}),(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"texts"}),(0,r.jsx)("td",{children:":"}),(0,r.jsx)("td",{children:t.texts.map((e,t)=>(0,r.jsxs)("div",{children:[t,": ",e?`"${e}"`:"(empty)"]},t))})]}),(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"sectionHeights"}),(0,r.jsx)("td",{children:":"}),(0,r.jsx)("td",{children:t.sectionHeights.map((e,t)=>(0,r.jsxs)("div",{children:[t,": ",e]},t))})]}),(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"direction"}),(0,r.jsx)("td",{children:":"}),(0,r.jsx)("td",{children:t.direction||"none"})]}),(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"startMarker"}),(0,r.jsx)("td",{children:":"}),(0,r.jsx)("td",{children:t.startMarker})]}),(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"endMarker"}),(0,r.jsx)("td",{children:":"}),(0,r.jsx)("td",{children:t.endMarker})]}),(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"selected"}),(0,r.jsx)("td",{children:":"}),(0,r.jsx)("td",{children:t.selected?"Yes":"No"})]}),(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"visible"}),(0,r.jsx)("td",{children:":"}),(0,r.jsx)("td",{children:t.visible?"Yes":"No"})]}),(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"editing"}),(0,r.jsx)("td",{children:":"}),(0,r.jsx)("td",{children:t.editing?"Yes":"No"})]}),(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"tentative"}),(0,r.jsx)("td",{children:":"}),(0,r.jsx)("td",{children:t.tentative?"Yes":"No"})]}),n&&n.id===t.id&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("tr",{children:(0,r.jsxs)("td",{colSpan:3,style:{color:"blue",fontWeight:"bold"},children:["DROP TARGET (",l,")"]})}),(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"target dir"}),(0,r.jsx)("td",{children:":"}),(0,r.jsx)("td",{children:t.direction||"none"})]}),"none"===t.direction&&(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"child dir guess"}),(0,r.jsx)("td",{children:":"}),(0,r.jsx)("td",{children:"Based on drop position"})]})]}),a&&(0,r.jsx)("tr",{children:(0,r.jsx)("td",{colSpan:3,style:{color:"red"},children:"BEING DRAGGED"})}),o&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("tr",{children:(0,r.jsx)("td",{colSpan:3,style:{fontWeight:"bold"},children:"sibling info:"})}),o.prevElement&&(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"prev"}),(0,r.jsx)("td",{children:":"}),(0,r.jsx)("td",{children:o.prevElement.id})]}),o.nextElement&&(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"next"}),(0,r.jsx)("td",{children:":"}),(0,r.jsx)("td",{children:o.nextElement.id})]})]})]})})]})}):null},$={"Ctrl+z":"UNDO","Ctrl+Shift+z":"REDO",ArrowUp:"ARROW_UP",ArrowDown:"ARROW_DOWN",ArrowRight:"ARROW_RIGHT","Ctrl+ArrowRight":"EXPAND_ELEMENT",ArrowLeft:"ARROW_LEFT","Ctrl+ArrowLeft":"COLLAPSE_ELEMENT","Ctrl+x":"CUT_ELEMENT","Ctrl+c":"COPY_ELEMENT","Ctrl+v":"PASTE_ELEMENT",Tab:"ADD_ELEMENT","Shift+Tab":"ADD_SIBLING_ELEMENT","Shift+Enter":"ADD_SIBLING_ELEMENT","Ctrl+Enter":"ADD_SIBLING_ELEMENT",Delete:"DELETE_ELEMENT",Backspace:"DELETE_ELEMENT",Enter:"EDIT_ELEMENT"},v={Tab:"NEXT_FIELD",Escape:"END_EDITING","Ctrl+Enter":"END_EDITING","Alt+Enter":"END_EDITING","Meta+Enter":"END_EDITING"};var A=i(573);let k=n.memo(e=>{let{element:t,onEndEditing:i}=e,{dispatch:l,state:a}=s(),o=b(),u=(0,n.useRef)([]),[g,p]=(0,n.useState)([]),[f,x]=(0,n.useState)(-1),E=(0,n.useRef)(null),m=(0,n.useRef)(void 0),[y,T]=(0,n.useState)(""),[C,D]=(0,n.useState)(""),[w,I]=(0,n.useState)("");(0,n.useEffect)(()=>{o&&(E.current=document.createElement("canvas").getContext("2d"),T((0,h.af)()),D((0,h.kN)()),I((0,h.vG)()))},[o]),(0,n.useEffect)(()=>{o&&t?.id!==m.current&&(p(t?.sectionHeights||[]),x(0),m.current=t?.id,setTimeout(()=>{let e=u.current[0];if(e){e.focus({preventScroll:!0});let i=t?.texts[0]?.length||0;e.setSelectionRange(i,i)}},50))},[t,o]);let O=(0,n.useCallback)(e=>{let t=c.SK.WIDTH.MAX,i=(0,d.C1)(e,t,a.zoomRatio).length,r=c.gI*c.RZ*a.zoomRatio,n=c.rF.VERTICAL*a.zoomRatio;return Math.max(c.SK.SECTION_HEIGHT*a.zoomRatio,i*r+n)},[a.zoomRatio]),S=(0,n.useCallback)((e,i)=>{let r=e.target.value;if(!(0,A.kb)(r)){console.warn("無効なテキスト入力が検出されました。安全でない内容が含まれている可能性があります。");return}let n=r.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"").replace(/javascript:/gi,"").replace(/data:/gi,"").replace(/on\w+\s*=/gi,""),o=O(n);p(e=>{let t=[...e];return t[i]=o/a.zoomRatio,t}),l({type:"UPDATE_TEXT",payload:{id:t.id,index:i,value:n}});let s=u.current[i];s&&(s.style.height=`${o}px`)},[t,a.zoomRatio,l,O]),$=(0,n.useCallback)(e=>{let r=e+1;if(t&&r<t.texts.length){let e=u.current[r];if(e){let{scrollX:i,scrollY:n}=window;e.focus({preventScroll:!0});let l=t.texts[r]?.length||0;e.setSelectionRange(l,l),x(r),window.scrollTo(i,n)}}else i?.(),l({type:"END_EDITING"})},[t,i,l]),k=(e,t)=>{let r=v[[e.ctrlKey&&"Ctrl",e.altKey&&"Alt",e.metaKey&&"Meta",e.key].filter(Boolean).join("+")];if(r)switch(e.preventDefault(),r){case"NEXT_FIELD":$(t);break;case"END_EDITING":i?.(),l({type:"END_EDITING"})}};return t&&o?(0,r.jsx)(r.Fragment,{children:t.texts.map((e,i)=>{let n=g.slice(0,i).reduce((e,t)=>e+t,0)*a.zoomRatio,l=c.SK.WIDTH.MAX*a.zoomRatio,s=O(e);return(0,r.jsx)("textarea",{ref:e=>{u.current[i]=e,i===f&&o&&e?.focus({preventScroll:!0})},value:e,onChange:e=>S(e,i),onKeyDown:e=>k(e,i),onClick:e=>e.stopPropagation(),style:{position:"absolute",left:`${t.x*a.zoomRatio}px`,top:`${t.y*a.zoomRatio+n}px`,width:`${l}px`,height:`${s}px`,minWidth:`${c.SK.WIDTH.MAX*a.zoomRatio}px`,maxWidth:`${c.SK.WIDTH.MAX*a.zoomRatio}px`,minHeight:`${c.SK.SECTION_HEIGHT*a.zoomRatio}px`,margin:"1px 1px",fontSize:`${c.gI*a.zoomRatio}px`,lineHeight:`${c.RZ}em`,padding:"0 3px",fontFamily:y,backgroundColor:C,color:w,boxSizing:"border-box",WebkitFontSmoothing:"antialiased",MozOsxFontSmoothing:"grayscale",overflow:"hidden",whiteSpace:"pre-wrap",wordWrap:"break-word",resize:"none",zIndex:1e4,opacity:1,transition:"all 0.2s ease-in-out",pointerEvents:"all"}},`${t.id}-${i}`)})}):null}),N={arrow:{id:"arrowhead",width:c.tl.WIDTH,height:c.tl.HEIGHT,isFilled:!1,shape:"polygon",pointsOrAttributes:`${c.tl.WIDTH} 0, ${c.tl.WIDTH} ${c.tl.HEIGHT}, 0 ${c.tl.HEIGHT/2}`},filledArrow:{id:"filledarrowhead",width:c.tl.WIDTH,height:c.tl.HEIGHT,isFilled:!0,shape:"polygon",pointsOrAttributes:`${c.tl.WIDTH} 0, ${c.tl.WIDTH} ${c.tl.HEIGHT}, 0 ${c.tl.HEIGHT/2}`},arrowEnd:{id:"arrowhead-end",width:c.tl.WIDTH,height:c.tl.HEIGHT,isFilled:!1,shape:"polygon",pointsOrAttributes:`0 0, 0 ${c.tl.HEIGHT}, ${c.tl.WIDTH} ${c.tl.HEIGHT/2}`},filledArrowEnd:{id:"filledarrowhead-end",width:c.tl.WIDTH,height:c.tl.HEIGHT,isFilled:!0,shape:"polygon",pointsOrAttributes:`0 0, 0 ${c.tl.HEIGHT}, ${c.tl.WIDTH} ${c.tl.HEIGHT/2}`},circle:{id:"circlemarker",width:c.p1.SIZE,height:c.p1.SIZE,isFilled:!1,shape:"circle",pointsOrAttributes:{cx:c.p1.SIZE/2,cy:c.p1.SIZE/2,r:c.p1.SIZE/2-1}},filledCircle:{id:"filledcirclemarker",width:c.p1.SIZE,height:c.p1.SIZE,isFilled:!0,shape:"circle",pointsOrAttributes:{cx:c.p1.SIZE/2,cy:c.p1.SIZE/2,r:c.p1.SIZE/2-1}},circleEnd:{id:"circlemarker-end",width:c.p1.SIZE,height:c.p1.SIZE,isFilled:!1,shape:"circle",pointsOrAttributes:{cx:c.p1.SIZE/2,cy:c.p1.SIZE/2,r:c.p1.SIZE/2-1}},filledCircleEnd:{id:"filledcirclemarker-end",width:c.p1.SIZE,height:c.p1.SIZE,isFilled:!0,shape:"circle",pointsOrAttributes:{cx:c.p1.SIZE/2,cy:c.p1.SIZE/2,r:c.p1.SIZE/2-1}},square:{id:"squaremarker",width:c.p1.SIZE,height:c.p1.SIZE,isFilled:!1,shape:"rect",pointsOrAttributes:{x:1,y:1,width:c.p1.SIZE-2,height:c.p1.SIZE-2}},filledSquare:{id:"filledsquaremarker",width:c.p1.SIZE,height:c.p1.SIZE,isFilled:!0,shape:"rect",pointsOrAttributes:{x:1,y:1,width:c.p1.SIZE-2,height:c.p1.SIZE-2}},squareEnd:{id:"squaremarker-end",width:c.p1.SIZE,height:c.p1.SIZE,isFilled:!1,shape:"rect",pointsOrAttributes:{x:1,y:1,width:c.p1.SIZE-2,height:c.p1.SIZE-2}},filledSquareEnd:{id:"filledsquaremarker-end",width:c.p1.SIZE,height:c.p1.SIZE,isFilled:!0,shape:"rect",pointsOrAttributes:{x:1,y:1,width:c.p1.SIZE-2,height:c.p1.SIZE-2}},diamond:{id:"diamondmarker",width:c.tl.WIDTH,height:c.tl.HEIGHT,isFilled:!1,shape:"polygon",pointsOrAttributes:`${c.tl.WIDTH/2},1 ${c.tl.WIDTH-1},${c.tl.HEIGHT/2} ${c.tl.WIDTH/2},${c.tl.HEIGHT-1} 1,${c.tl.HEIGHT/2}`},filledDiamond:{id:"filleddiamondmarker",width:c.tl.WIDTH,height:c.tl.HEIGHT,isFilled:!0,shape:"polygon",pointsOrAttributes:`${c.tl.WIDTH/2},1 ${c.tl.WIDTH-1},${c.tl.HEIGHT/2} ${c.tl.WIDTH/2},${c.tl.HEIGHT-1} 1,${c.tl.HEIGHT/2}`},diamondEnd:{id:"diamondmarker-end",width:c.tl.WIDTH,height:c.tl.HEIGHT,isFilled:!1,shape:"polygon",pointsOrAttributes:`${c.tl.WIDTH/2},1 ${c.tl.WIDTH-1},${c.tl.HEIGHT/2} ${c.tl.WIDTH/2},${c.tl.HEIGHT-1} 1,${c.tl.HEIGHT/2}`},filledDiamondEnd:{id:"filleddiamondmarker-end",width:c.tl.WIDTH,height:c.tl.HEIGHT,isFilled:!0,shape:"polygon",pointsOrAttributes:`${c.tl.WIDTH/2},1 ${c.tl.WIDTH-1},${c.tl.HEIGHT/2} ${c.tl.WIDTH/2},${c.tl.HEIGHT-1} 1,${c.tl.HEIGHT/2}`}},R=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=t?"-end":"";switch(e){case"arrow":return`url(#arrowhead${i})`;case"filled_arrow":return`url(#filledarrowhead${i})`;case"circle":return`url(#circlemarker${i})`;case"filled_circle":return`url(#filledcirclemarker${i})`;case"square":return`url(#squaremarker${i})`;case"filled_square":return`url(#filledsquaremarker${i})`;case"diamond":return`url(#diamondmarker${i})`;case"filled_diamond":return`url(#filleddiamondmarker${i})`;default:return}},j=e=>{let{connectionPathColor:t,connectionPathStroke:i}=e;return(0,r.jsx)(r.Fragment,{children:Object.values(N).map(e=>{let n;let{id:l,width:a,height:o,isFilled:s,shape:c,pointsOrAttributes:d}=e,h=s?t:"none",u={id:l,markerWidth:a,markerHeight:o,refX:l.endsWith("-end")?0:a,refY:o/2,orient:"auto",markerUnits:"userSpaceOnUse",viewBox:`0 0 ${a} ${o}`,strokeWidth:i,fill:h,stroke:t};return"polygon"===c?n=(0,r.jsx)("polygon",{points:d,fill:h,stroke:t}):"circle"===c?n=(0,r.jsx)("circle",{cx:d.cx,cy:d.cy,r:d.r,fill:h,stroke:t}):"rect"===c&&(n=(0,r.jsx)("rect",{x:d.x,y:d.y,width:d.width,height:d.height,fill:h,stroke:t})),(0,r.jsx)("marker",{...u,children:n},l)})})},_=e=>{let{popupX:t,popupY:i,isEndMarkerMenu:l,elementId:a,onMarkerSelect:o,onClose:s}=e,[c,d]=(0,n.useState)(null);return(0,r.jsx)("foreignObject",{x:t,y:i,width:150,height:260,className:"popup-menu",children:(0,r.jsx)("div",{className:"popup-menu",style:{backgroundColor:"white",border:"1px solid #ccc",borderRadius:"4px",padding:"8px",boxShadow:"0 2px 10px rgba(0,0,0,0.2)",display:"flex",flexDirection:"column",width:"100%",height:"100%",boxSizing:"border-box",overflowY:"auto",zIndex:1e3},"data-exclude-from-export":"true",children:[{id:"arrow",label:"Arrow"},{id:"filled_arrow",label:"Filled Arrow"},{id:"circle",label:"Circle"},{id:"filled_circle",label:"Filled Circle"},{id:"square",label:"Square"},{id:"filled_square",label:"Filled Square"},{id:"diamond",label:"Diamond"},{id:"filled_diamond",label:"Filled Diamond"},{id:"none",label:"None"}].map(e=>(0,r.jsx)("div",{style:{padding:"4px 0",cursor:"pointer",backgroundColor:c===e.id?"#e0e0e0":"white"},onMouseEnter:()=>d(e.id),onMouseLeave:()=>d(null),onClick:()=>{o(a,e.id,l),s()},children:e.label},e.id))})})},L=e=>{let{element:t,absolutePosition:i,isEndMarker:n=!1,hoverId:a,onHover:o,onShowMenu:d,_isInGroup:h=!1}=e,{state:u}=s();if(n&&!(u.hierarchicalData&&null!==(0,l.c3)(u.hierarchicalData,t.id)))return null;let g=t.height,p=n?`end-${t.id}`:t.id,f=n?i.x-c.tl.WIDTH/2:i.x+t.width+c.tl.WIDTH/2;return(0,r.jsxs)("g",{"data-marker-button":`${p}`,"data-exclude-from-export":"true",pointerEvents:"all",children:[a===p&&(0,r.jsx)("circle",{cx:f,cy:i.y+g/2,r:c.tl.WIDTH/2,fill:"#bfbfbf",opacity:.5,pointerEvents:"none"}),(0,r.jsx)("circle",{cx:f,cy:i.y+g/2,r:c.tl.WIDTH/2,fill:"transparent",stroke:"transparent",strokeWidth:2,onMouseEnter:()=>o(p),onMouseLeave:()=>o(null),onClick:()=>d(p),style:{cursor:"pointer"},pointerEvents:"all"})]},`marker-button-${p}`)},M=e=>{let{parentElement:t,element:i,absolutePositions:n,strokeColor:l=c.lB.COLOR,strokeWidth:a=c.lB.STROKE}=e,o=0;switch(t.startMarker){case"arrow":case"filled_arrow":case"diamond":case"filled_diamond":o=c.tl.OFFSET;break;case"circle":case"filled_circle":case"square":case"filled_square":o=c.p1.OFFSET;break;default:o=0}let s=0;switch(i.endMarker){case"arrow":case"filled_arrow":case"diamond":case"filled_diamond":s=c.tl.OFFSET;break;case"circle":case"filled_circle":case"square":case"filled_square":s=c.p1.OFFSET;break;default:s=0}let d=n.parent,h=n.element,u=i.height,g=i.direction||"right",p="";p="none"===t.direction?"left"===g?`M ${d.x-o},${d.y+t.height/2} C ${d.x-c.mO},${d.y+t.height/2} ${h.x+i.width+c.mO},${h.y+u/2} ${h.x+i.width+s},${h.y+u/2}`:`M ${d.x+t.width+o},${d.y+t.height/2} C ${d.x+t.width+c.mO},${d.y+t.height/2} ${h.x-c.mO},${h.y+u/2} ${h.x-s},${h.y+u/2}`:"left"===g?`M ${d.x},${d.y+t.height/2} C ${d.x-c.mO},${d.y+t.height/2} ${h.x+i.width+c.mO},${h.y+u/2} ${h.x+i.width+s},${h.y+u/2}`:`M ${d.x+t.width+o},${d.y+t.height/2} C ${d.x+t.width+c.mO},${d.y+t.height/2} ${h.x-c.mO},${h.y+u/2} ${h.x-s},${h.y+u/2}`;let f=R(t.startMarker),x=R(i.endMarker,!0);return(0,r.jsx)("path",{d:p,stroke:l,strokeWidth:a,fill:"none",markerStart:f,markerEnd:x,style:{pointerEvents:"none"}})},B=e=>{if(!e)return{width:c.e$.X,height:c.SK.SECTION_HEIGHT*c.zX};let t=(0,l.BK)(e);if(0===t.length)return{width:c.e$.X,height:c.SK.SECTION_HEIGHT*c.zX};let i=Math.max(...t.map(e=>e.x+e.width)),r=Math.max(...t.map(e=>e.y+e.height));return{width:i+c.e$.X,height:r+c.SK.SECTION_HEIGHT*c.zX}},P=e=>{let{setCanvasSize:t,setDisplayArea:i,hierarchicalData:r,zoomRatio:l,isClient:a=!0,isDragInProgress:o=!1}=e,s=(0,n.useMemo)(()=>r?JSON.stringify(r.version||"unknown"):"empty",[r]);(0,n.useEffect)(()=>{if(!a)return;if(o){console.log("[useResizeEffect] Skipping canvas resize during drag");return}let e=B(r),n=window.innerHeight-c.uF;e.width=Math.max(e.width,window.innerWidth),e.height=Math.max(e.height,n);let s={width:e.width,height:e.height};e.width*=l,e.height*=l,t(e),i(`0 0 ${s.width} ${s.height}`)},[s,l,t,i,a,o,r])},H=(e,t)=>{let{dispatch:i}=s();(0,n.useEffect)(()=>{let r=e.current,n=e=>{e.target instanceof SVGElement&&"svg"===e.target.tagName&&(i({type:"DESELECT_ALL"}),t&&i({type:"END_EDITING"}))};return r?.addEventListener("mousedown",n),()=>{r?.removeEventListener("mousedown",n)}},[e,t,i])},X={invalidDrop:"無効なドロップ操作です",dropChildElement:"子要素にドロップすることはできません",dropSelfChild:"自身の子要素に移動することはできません",dropCircularReference:"循環参照となるため移動できません",dropInvalidHierarchy:"要素の階層構造が不正となるため移動できません",noSelect:"要素を選択してから実行してください",dragError:"ドラッグ操作中にエラーが発生しました",noApiKey:"APIキーが設定されていません",noPrompt:"入力情報(プロンプト)が設定されていません",aiNoResults:"該当する結果が0件でした",clipboardEmpty:"クリップボードにテキストがありません"};var G=i(7451);let U=e=>"touches"in e,W=(e,t)=>t?(0,l.PW)(t,e.id).filter(e=>e.visible).sort((e,t)=>e.y-t.y):[],F=(e,t)=>{if(!t)return null;let i=(0,l.c3)(t,e.id);return i?i.data:null},K=(e,t)=>{if(!t)return!1;let i=F(e,t);return"none"===e.direction&&null===i},Y=()=>{let{state:e,dispatch:t}=s(),{addToast:i}=(0,G.d)(),[r,a]=(0,n.useState)(null),[o,d]=(0,n.useState)({x:0,y:0}),[h,u]=(0,n.useState)(null),g=(0,n.useRef)(new Map),p=(0,n.useCallback)(t=>{let i,r;return U(t)?(i=t.touches[0].clientX+window.scrollX,r=t.touches[0].clientY+window.scrollY):(i=t.clientX+window.scrollX,r=t.clientY+window.scrollY),{x:i/e.zoomRatio,y:(r-c.uF)/e.zoomRatio}},[e.zoomRatio]),f=(0,n.useCallback)((t,i)=>{let r;let n=t.y,l=W(t,e.hierarchicalData),a=t.direction||"right";return K(t,e.hierarchicalData),r="left"===a?t.x-c.e$.X:t.x+t.width+c.e$.X,l.length,{position:"child",insertY:n+t.height/2,insertX:r}},[e.hierarchicalData]),x=(0,n.useCallback)((t,i,n)=>{let a;let o=t.y,s=t.y+t.height,d=t.x,h=t.x+t.width,u=K(t,e.hierarchicalData),g=u?2*c.e$.X+(r?.width??0):c.e$.X+(r?.width??0),p=u?2*c.e$.X+(r?.width??0):c.e$.X+(r?.width??0),x=t.direction||"right",E=i>=t.x&&i<h&&n>=o&&n<=s,m=i>=h&&i<h+g&&n>=o&&n<=s,y=i<=d&&i>d-p&&n>=o&&n<=s,T=u&&(m||y)||"right"===x&&m||"left"===x&&y;if(u&&(0,O.c)(`[Root calc] isOnValidSide: ${T}, direction: ${x}`),E)(a=f(t,n)).direction=t.direction||"right",(0,O.c)(`Drop position mode (inside element ${t.id}):`,"child"),(0,O.c)(`[Inside element] Element ${t.id} - direction: ${a.direction}, insertX: ${a.insertX}`);else if(T){let i=W(t,e.hierarchicalData),l=x;if(u&&(l=y?"left":"right",(0,O.c)(`[childDirection calculation] isOnLeftSideInYRange: ${y}, childDirection: ${l}`)),0===i.length){let e="left"===l?t.x-c.e$.X-(r?.width??0):t.x+t.width+c.e$.X;a={position:"child",insertY:t.y+t.height/2,insertX:e,siblingInfo:{},direction:l},(0,O.c)(`Drop position mode (${l} side, no children):`,"child")}else{let e="left"===l?t.x-c.e$.X-(r?.width??0):t.x+t.width+c.e$.X;if(u)a={position:"child",insertY:t.y+t.height/2,insertX:e,siblingInfo:{},direction:l},(0,O.c)(`Drop position mode (${l} side, root with children):`,"child"),(0,O.c)(`[Root result] direction set to: ${l}, insertX: ${e}`);else{let r,o;let s=u?i.filter(e=>e.direction===l):i;for(let e=0;e<s.length;e++){let t=s[e];if(n<t.y){o=t,e>0&&(r=s[e-1]);break}if(n<t.y+t.height){n<t.y+t.height/2?(o=t,e>0&&(r=s[e-1])):(r=t,e<s.length-1&&(o=s[e+1]));break}if(e===s.length-1||n<s[e+1].y){r=t,e<s.length-1&&(o=s[e+1]);break}}if(r&&o){let t=o.y-(r.y+r.height);a={position:"between",insertY:r.y+r.height+t/2,insertX:e,siblingInfo:{prevElement:r,nextElement:o},direction:l}}else a=r?{position:"between",insertY:r.y+r.height+c.e$.Y,insertX:e,siblingInfo:{prevElement:r},direction:l}:o?{position:"between",insertY:o.y-c.e$.Y,insertX:e,siblingInfo:{nextElement:o},direction:l}:{position:"between",insertY:t.y+t.height/2,insertX:e,siblingInfo:{},direction:l};(0,O.c)(`Drop position mode (${l} side, with children):`,"between")}}}else if(!u&&e.hierarchicalData&&(0,l.c3)(e.hierarchicalData,t.id)){let i;let o=r?.id,s=e.hierarchicalData?(0,l.c3)(e.hierarchicalData,t.id):null,d=s?.data.id||null,h=e.hierarchicalData&&d?(0,l.PW)(e.hierarchicalData,d).filter(e=>e.visible&&e.id!==o).sort((e,t)=>e.y-t.y):[];(0,O.c)(`[calculatePositionAndDistance] Found ${h.length} siblings (excluding dragging element) for element ${t.id}`);let u=null,g=null;for(let e=0;e<h.length;e++){let t=h[e];if(t.id===r?.id)continue;let i=t.y+t.height;if(n<t.y){g=t,e>0&&(u=h[e-1]);break}if(n<i){n<t.y+t.height/2?(g=t,e>0&&(u=h[e-1])):(u=t,e<h.length-1&&(g=h[e+1]));break}u=t,e<h.length-1&&(g=h[e+1])}let p="right";u&&u.direction?p=u.direction:g&&g.direction?p=g.direction:t.direction&&"none"!==t.direction&&(p=t.direction);let f=e.hierarchicalData?(0,l.c3)(e.hierarchicalData,t.id):null,x=f?f.data:null;if(i=x?"left"===p?x.x-c.e$.X-(r?.width??0):x.x+x.width+c.e$.X:"left"===p?t.x-c.e$.X-(r?.width??0):t.x+t.width+c.e$.X,u&&g){let e=g.y-(u.y+u.height);a={position:"between",insertY:u.y+u.height+e/2,insertX:i,siblingInfo:{prevElement:u,nextElement:g},direction:p}}else a=u?{position:"between",insertY:u.y+u.height+c.e$.Y,insertX:i,siblingInfo:{prevElement:u},direction:p}:g?{position:"between",insertY:g.y-c.e$.Y,insertX:i,siblingInfo:{nextElement:g},direction:p}:{position:"between",insertY:t.y+t.height+c.e$.Y,insertX:i,siblingInfo:{},direction:p};(0,O.c)(`Drop position mode (between siblings) - direction: ${p}, insertX: ${i}`,"between")}else(0,O.c)(`[Root element ${t.id}] Not on valid side, using default child position`),a={position:"child",insertY:t.y+t.height/2,insertX:t.x+t.width+c.e$.X,siblingInfo:{},direction:t.direction||"right"};let C=t.x+t.width/2,D=t.y+t.height/2,b=i-C,w=n-D,I=b*b+w*w;return(0,O.c)(`[Position calc] Element ${t.id}: mouseInside=${E}, onValidSide=${T}, position=${a.position}, distanceSq=${I.toFixed(2)}`),u&&(0,O.c)(`[Root calc] Final result - position: ${a.position}, distanceSq: ${I}, insertY: ${a.insertY}, direction: ${a.direction}`),{...a,distanceSq:I}},[f,r,e.hierarchicalData]),E=(0,n.useCallback)(t=>{if(!r)return null;let i=p(t),n=i.x,a=i.y,o=(e.hierarchicalData?(0,l.WN)(e.hierarchicalData):[]).map(e=>e.id),s=e.hierarchicalData?.root?.data||null,d=r?.direction||"right";if(s){let e=s.x+s.width/2;d=n<e?"left":"right",(0,O.c)(`[Direction detection] mouse(${n}), rootCenter(${e}), targetDirection: ${d}`)}let h=(0,l.WW)(e.hierarchicalData),u=h.filter(t=>{if(!t.visible||o.includes(t.id))return!1;let i=t.y,h=t.y+t.height,u=t.x,g=t.x+t.width,p="none"===t.direction&&e.hierarchicalData&&null===(0,l.c3)(e.hierarchicalData,t.id),f=!1;if(p){let e=2*c.e$.X+(r?.width??0),t=2*c.e$.X+(r?.width??0),l=i-c.e$.Y,o=h+c.e$.Y,s=u-e,d=g+t;f=n>=s&&n<=d&&a>=l&&a<=o,(0,O.c)(`[Root drop area] mouse(${n},${a}), area(${s},${l},${d},${o}), inArea: ${f}`)}else{let r=e.hierarchicalData?(0,l.c3)(e.hierarchicalData,t.id):null;if(r?.data.id===s?.id&&t.direction!==d)return(0,O.c)(`[Direction filter] Excluding ${t.id} (direction: ${t.direction}, target: ${d})`),!1;let o=c.e$.X,p=c.e$.X,x=i-c.e$.Y,E=h+c.e$.Y;(f=n>=u-o&&n<=g+p&&a>=x&&a<=E)&&(0,O.c)(`[Candidate found] ${t.id} (direction: ${t.direction}, target: ${d})`)}return f});(0,O.c)(`[findDropTarget] Found ${u.length} candidates`),u.forEach(t=>{let i="none"===t.direction&&e.hierarchicalData&&null===(0,l.c3)(e.hierarchicalData,t.id);(0,O.c)(`[findDropTarget] Candidate: ${t.id}, isRoot: ${i}`)});let g={};for(let t in Object.values(h).filter(e=>e.visible&&!o.includes(e.id)).forEach(t=>{let i=e.hierarchicalData?(0,l.c3)(e.hierarchicalData,t.id):null,r=i?.data.id||"root";g[r]||(g[r]=[]),g[r].push(t)}),g)g[t].sort((e,t)=>e.y-t.y);for(let[t,i]of Object.entries(g)){if(i.length<2)continue;let o="root"!==t?(0,l.gn)(e.hierarchicalData,t):null;if(o&&"none"===o.direction&&e.hierarchicalData&&null===(0,l.c3)(e.hierarchicalData,o.id)){let e=r?.direction||"right",t=i.filter(e=>"left"===e.direction).sort((e,t)=>e.y-t.y),l=i.filter(e=>"right"===e.direction).sort((e,t)=>e.y-t.y);if("left"===e)for(let i=0;i<t.length-1;i++){let l=t[i],s=t[i+1],d=s.y-(l.y+l.height);if(d<5)continue;let h=l.y+l.height,u=s.y,g=o.x-2*c.e$.X-(r?.width??0),p=o.x;if((0,O.c)(`[Left gap check] dragging:${e}, mouse(${n},${a}), gapArea(${g},${h},${p},${u})`),n>=g&&n<=p&&a>=h&&a<=u)return(0,O.c)(`[Left gap found] Between ${l.id} and ${s.id}`),{element:l,position:"between",insertY:h+d/2,insertX:o.x-c.e$.X-(r?.width??0),siblingInfo:{prevElement:l,nextElement:s}}}else for(let t=0;t<l.length-1;t++){let i=l[t],s=l[t+1],d=s.y-(i.y+i.height);if(d<5)continue;let h=i.y+i.height,u=s.y,g=o.x+o.width,p=g+2*c.e$.X+(r?.width??0);if((0,O.c)(`[Right gap check] dragging:${e}, mouse(${n},${a}), gapArea(${g},${h},${p},${u})`),n>=g&&n<=p&&a>=h&&a<=u)return(0,O.c)(`[Right gap found] Between ${i.id} and ${s.id}`),{element:i,position:"between",insertY:h+d/2,insertX:o.x+o.width+c.e$.X,siblingInfo:{prevElement:i,nextElement:s}}}}else{i.sort((e,t)=>e.y-t.y);for(let e=0;e<i.length-1;e++){let t=i[e],r=i[e+1],l=r.y-(t.y+t.height);if(l<5)continue;let o=t.y+t.height,s=r.y,c=t.x+t.width,d=r.x+r.width,h=Math.min(t.x,r.x),u=Math.max(c,d);if(n>=h&&n<=u&&a>=o&&a<=s)return{element:t,position:"between",insertY:o+l/2,siblingInfo:{prevElement:t,nextElement:r}}}}}for(let[t,i]of Object.entries(g)){if(0===i.length)continue;let o="root"!==t?(0,l.gn)(e.hierarchicalData,t):null;if(o&&"none"===o.direction&&e.hierarchicalData&&null===(0,l.c3)(e.hierarchicalData,o.id)){let e,t;let l=r?.direction||"right",s=i.filter(e=>"left"===l?"left"===e.direction:"right"===e.direction);if(0===s.length)continue;let d=s.reduce((e,t)=>t.y+t.height>e.y+e.height?t:e,s[0]);"left"===l?(e=o.x-2*c.e$.X-(r?.width??0),t=o.x):t=(e=o.x+o.width)+2*c.e$.X+(r?.width??0);let h=d.y+d.height+2*c.e$.Y;if((0,O.c)(`[Bottom area check] dragging:${l}, mouse(${n},${a}), bottomArea(${e},${d.y+d.height},${t},${h})`),n>=e&&n<=t&&a>=d.y+d.height&&a<=h){let e="left"===l?o.x-c.e$.X-(r?.width??0):o.x+o.width+c.e$.X;return(0,O.c)(`[Bottom area found] Below ${d.id}, direction: ${l}`),{element:d,position:"between",insertY:d.y+d.height+c.e$.Y,insertX:e,siblingInfo:{prevElement:d}}}}else{let e,t;let r=i.reduce((e,t)=>t.y+t.height>e.y+e.height?t:e,i[0]);o?t=(e=o.x+o.width)+2*c.e$.X+r.width:(e=r.x-c.e$.X,t=r.x+r.width+c.e$.X);let l=r.y+r.height+2*c.e$.Y;if(n>=e&&n<=t&&a>=r.y+r.height&&a<=l)return{element:r,position:"between",insertY:r.y+r.height+c.e$.Y,siblingInfo:{prevElement:r}}}}let f=null,E=1/0;for(let t of u){let{position:i,distanceSq:r,insertY:o,insertX:s,siblingInfo:c,direction:d}=x(t,n,a),h="none"===t.direction&&e.hierarchicalData&&null===(0,l.c3)(e.hierarchicalData,t.id),u=h&&("child"===i||"between"===i);if((0,O.c)(`[findDropTarget] Checking element ${t.id}, isRoot: ${h}, position: ${i}, distance: ${r}`),u){(0,O.c)(`[findDropTarget] PRIORITY: Valid root side drop detected for element ${t.id}, position: ${i}`),f={element:t,position:i,insertY:o,insertX:s,siblingInfo:c,direction:d},(0,O.c)(`[findDropTarget] Root side drop - direction: ${d}, insertX: ${s}`);break}r<E&&(E=r,f={element:t,position:i,insertY:o,insertX:s,siblingInfo:c,direction:d},(0,O.c)(`[findDropTarget] New closest: ${t.id}, distance: ${r}, direction: ${d}`))}if(f)(0,O.c)(`[findDropTarget] Final selection: ${f.element.id}, position: ${f.position}, direction: ${f.direction}`);else{if((0,O.c)("[findDropTarget] No drop target found in candidates"),s){let e=s.x+s.width/2,t=s.y-c.e$.Y,i=s.y+s.height+c.e$.Y,l=s.x-2*c.e$.X-(r?.width??0),o=s.x+s.width+2*c.e$.X+(r?.width??0);if(a>=t&&a<=i){if(n>=l&&n<=e)return(0,O.c)("[findDropTarget] Direct drop to root left area"),{element:s,position:"child",insertY:s.y+s.height/2,insertX:s.x-c.e$.X,direction:"left"};if(n>=e&&n<=o)return(0,O.c)("[findDropTarget] Direct drop to root right area"),{element:s,position:"child",insertY:s.y+s.height/2,insertX:s.x+s.width+c.e$.X,direction:"right"}}}(0,O.c)("[findDropTarget] No valid drop target found")}return f},[r,p,x,e.hierarchicalData]),m=(0,n.useCallback)((t,i)=>{let r;let n=e.hierarchicalData?(0,l.c3)(e.hierarchicalData,i.id):null;if(!i.selected||!n&&"none"!==i.direction)return;if(t.stopPropagation&&"function"==typeof t.stopPropagation&&t.stopPropagation(),!t.nativeEvent){(0,O.c)(`[DEBUG] nativeEvent is missing for element ${i.id}`);return}t.nativeEvent instanceof TouchEvent&&t.preventDefault&&"function"==typeof t.preventDefault&&t.preventDefault();let o=p(t.nativeEvent);a(i),d({x:o.x-i.x,y:o.y-i.y}),(0,O.c)(`[Drag started] Element: ${i.id}, startPos: (${o.x}, ${o.y})`),g.current.clear(),(e.hierarchicalData?(0,l.WN)(e.hierarchicalData):[]).forEach(e=>{g.current.set(e.id,{x:e.x,y:e.y})})},[p,t]),y=(0,n.useCallback)(()=>{(e.hierarchicalData?(0,l.WN)(e.hierarchicalData):[]).forEach(e=>{let i=g.current.get(e.id);i&&t({type:"MOVE_ELEMENT",payload:{id:e.id,x:i.x,y:i.y}})}),a(null),g.current.clear()},[t]),T=(0,n.useCallback)((t,i)=>{if(null===i)return{isValid:!0};if(t.id===i)return(0,O.c)(`無効な操作: 自分自身を親にしようとしています element=${t.id}, newParentId=${i}`),{isValid:!1,errorMessage:X.dropSelfChild};if((0,l.OA)(e.hierarchicalData,i,t.id)){let r=e.hierarchicalData?(0,l.c3)(e.hierarchicalData,i):null,n=r?.data.id===t.id;return(0,O.c)(`無効な操作: ${n?"自身の子要素":"循環参照"} element=${t.id}, newParentId=${i}`),{isValid:!1,errorMessage:n?X.dropSelfChild:X.dropCircularReference}}let r=i&&e.hierarchicalData?(0,l.BL)(e.hierarchicalData,i):0;return r>=10?((0,O.c)(`無効な操作: 最大深さ超過 currentDepth=${r}, max=10`),{isValid:!1,errorMessage:X.dropInvalidHierarchy}):{isValid:!0}},[e.hierarchicalData]),C=(0,n.useCallback)((r,n)=>{let a=n.find(e=>!T(e,r.id).isValid);if(a){let{errorMessage:e}=T(a,r.id);return i(e||X.dropChildElement,"warn"),y(),!1}return t({type:"SNAPSHOT"}),n.forEach((i,n)=>{let a;if("none"===r.direction&&e.hierarchicalData&&null===(0,l.c3)(e.hierarchicalData,r.id)){if(h?.direction)a=h.direction,(0,O.c)(`[processChildDrop] Using dropTarget direction: ${a} for element ${i.id}`);else if(h?.insertX!==void 0){let e=r.x+r.width/2;a=h.insertX<e?"left":"right",(0,O.c)(`[processChildDrop] Fallback direction from insertX: ${a} for element ${i.id}`)}else a=i.x<r.x?"left":"right",(0,O.c)(`[processChildDrop] Fallback direction from element position: ${a} for element ${i.id}`)}else a=r.direction||"right";let o=e.hierarchicalData?(0,l.AS)(e.hierarchicalData,r.id):0;t({type:"DROP_ELEMENT",payload:{id:i.id,targetNodeId:r.id,targetIndex:o+n,direction:a}})}),!0},[T,i,y,t,h,e.hierarchicalData]),D=(0,n.useCallback)((r,n)=>{let a;if((0,O.c)(`[processBetweenDrop] target=${r.id}, siblingInfo: ${JSON.stringify({prevElementId:h?.siblingInfo?.prevElement?.id,nextElementId:h?.siblingInfo?.nextElement?.id})}`),h?.siblingInfo){let{prevElement:t,nextElement:i}=h.siblingInfo;if(t&&i){(0,O.c)(`  Between two elements: prev=${t.id}, next=${i.id}`);let r=e.hierarchicalData?(0,l.c3)(e.hierarchicalData,t.id):null;a=r?.data.id||null}else if(t){(0,O.c)(`  After last element: prev=${t.id}`);let i=e.hierarchicalData?(0,l.c3)(e.hierarchicalData,t.id):null;a=i?.data.id||null}else if(i){(0,O.c)(`  Before first element: next=${i.id}`);let t=e.hierarchicalData?(0,l.c3)(e.hierarchicalData,i.id):null;a=t?.data.id||null}else(0,O.c)(`  No siblings: target=${r.id}`),a=r.id}else(0,O.c)(`  No siblings info: target=${r.id}`),a=r.id;if(null===a&&!n.every(t=>!!e.hierarchicalData&&1===(0,l.BL)(e.hierarchicalData,t.id)))return i(X.invalidDrop,"warn"),y(),!1;let o=n.find(e=>!T(e,a).isValid);if(o){let{errorMessage:e}=T(o,a);return i(e||X.dropChildElement,"warn"),y(),!1}t({type:"SNAPSHOT"});let s=n.some(t=>{let i=e.hierarchicalData?(0,l.c3)(e.hierarchicalData,t.id):null;return i?.data.id===a}),c=n.filter(t=>{let i=e.hierarchicalData?(0,l.c3)(e.hierarchicalData,t.id):null;return i?.data.id===a}),d=b(h,c);return s?w(c,d.baseOrder,a):I(d.baseOrder,n.length,a),[...n].reverse().forEach((i,n)=>{let o;if(a){let t=(0,l.gn)(e.hierarchicalData,a);if(t?.direction==="none"&&e.hierarchicalData&&null===(0,l.c3)(e.hierarchicalData,t.id)){if(h?.direction)o=h.direction,(0,O.c)(`[processBetweenDrop] Using dropTarget direction: ${o} for element ${i.id}`);else if(h?.siblingInfo){let{prevElement:e,nextElement:t}=h.siblingInfo;if(e&&e.direction)o=e.direction;else if(t&&t.direction)o=t.direction;else if(h&&r){let e=r.x+r.width/2;o=(void 0!==h.insertX?h.insertX:e)<e?"left":"right"}else o="right"}else if(h&&r){let e=r.x+r.width/2;o=(void 0!==h.insertX?h.insertX:e)<e?"left":"right"}else o="right"}else o=t?.direction||"right"}let s=d.baseOrder;(0,O.c)(`[processBetweenDrop] Dispatching DROP_ELEMENT for: ${i.id}, newOrder: ${s}, newParentId: ${a}`),t({type:"DROP_ELEMENT",payload:{id:i.id,targetNodeId:a,targetIndex:s,direction:o}})}),!0},[h,T,i,y,t,e.hierarchicalData]),b=(0,n.useCallback)((t,i)=>{let r=0;if((0,O.c)(`[calculateTargetOrderValues] DropTarget: ${t?.element?.id}`),(0,O.c)(`[calculateTargetOrderValues] DraggedElements: ${i.map(e=>e.id).join(", ")}`),t?.siblingInfo){let{prevElement:n,nextElement:a}=t.siblingInfo,o=null;if(n){let t=e.hierarchicalData?(0,l.c3)(e.hierarchicalData,n.id):null;o=t?.data.id||null}else if(a){let t=e.hierarchicalData?(0,l.c3)(e.hierarchicalData,a.id):null;o=t?.data.id||null}else o=t.element.id;let s=i.map(e=>e.id),c=e.hierarchicalData&&o?(0,l.PW)(e.hierarchicalData,o).filter(e=>e.visible&&!s.includes(e.id)).sort((e,t)=>e.y-t.y):[];if(n&&a)r=Math.max(0,c.findIndex(e=>e.id===a.id));else if(n){let e=c.findIndex(e=>e.id===n.id);r=e>=0?e+1:c.length}else a?r=0:(r=0,(0,O.c)(`[calculateTargetOrderValues] No siblings - baseOrder: ${r}`))}else if(t){let i=t.element.id,n=e.hierarchicalData?(0,l.PW)(e.hierarchicalData,i).filter(e=>e.visible):[];r=n.length,(0,O.c)(`[calculateTargetOrderValues] Child drop - siblings length: ${n.length}, baseOrder: ${r}`)}return(0,O.c)(`[calculateTargetOrderValues] Final baseOrder: ${r}`),{baseOrder:r}},[e.hierarchicalData]),w=(0,n.useCallback)((e,t,i)=>{},[]),I=(0,n.useCallback)((e,t,i)=>{},[]),S=(0,n.useCallback)(async()=>{if(r)try{let t=e.hierarchicalData?(0,l.WN)(e.hierarchicalData):[];if(h){let{element:e,position:r}=h,n=t.find(t=>!T(t,e.id).isValid);if(n){let{errorMessage:t}=T(n,e.id);i(t||X.dropChildElement,"warn"),y();return}let l=!1;if("child"===r?l=C(e,t):"between"===r&&(l=D(e,t)),!l){y();return}}else y()}catch(e){(0,O.c)("Drag error:",e),i(X.dragError,"warn"),y()}finally{a(null),u(null),g.current.clear()}},[r,h,t,i,y,C,D,T]),$=(0,n.useCallback)(e=>{if(!r)return;e instanceof TouchEvent&&1===e.touches.length&&e.preventDefault();let i=E(e);(!h&&i||h&&!i||h&&i&&(h.element.id!==i.element.id||h.position!==i.position||"between"===i.position&&h.insertY!==i.insertY))&&((0,O.c)("[setCurrentDropTarget] Setting drop target:",i),i&&(0,O.c)(`[setCurrentDropTarget] Direction: ${i.direction}, InsertX: ${i.insertX}`),u(i));let n=p(e),l={x:n.x-o.x,y:n.y-o.y};t({type:"MOVE_ELEMENT",payload:{id:r.id,...l}})},[r,h,E,p,o,t]);return(0,n.useEffect)(()=>{if(!r)return;let e=e=>$(e),t=e=>{1===e.touches.length&&$(e)},i=()=>S(),n=()=>S();return document.addEventListener("mousemove",e),document.addEventListener("touchmove",t,{passive:!1}),document.addEventListener("mouseup",i),document.addEventListener("touchend",n),()=>{document.removeEventListener("mousemove",e),document.removeEventListener("touchmove",t),document.removeEventListener("mouseup",i),document.removeEventListener("touchend",n)}},[r,$,S]),{handleMouseDown:m,handleMouseUp:S,currentDropTarget:h?.element||null,dropPosition:h?.position||null,draggingElement:r,dropInsertY:h?.insertY||void 0,dropInsertX:h?.insertX||void 0,dropTargetDirection:h?.direction||void 0,siblingInfo:h?.siblingInfo||null,isDragInProgress:!!r}},z=e=>{let{handleMouseDown:t,hierarchicalData:i}=e,[r,a]=(0,n.useState)(!1),[o,s]=(0,n.useState)(0),[c,d]=(0,n.useState)({x:0,y:0}),h=(0,n.useCallback)(e=>{if(2===e.touches.length){a(!0);let t=e.touches[0],i=e.touches[1];s(Math.hypot(i.clientX-t.clientX,i.clientY-t.clientY)),d({x:window.scrollX,y:window.scrollY})}else if(1===e.touches.length){e.preventDefault();let r=e.touches[0],n=document.elementFromPoint(r.clientX,r.clientY);if(n&&(function(e){return null!==e&&e instanceof SVGRectElement}(n)||function(e){return null!==e&&e instanceof SVGGElement}(n))){let r=n,a=null;for(;r&&!a;){if(function(e){return null!==e&&"dataset"in e}(r)&&r.dataset.elementId){a=r.dataset.elementId;break}r=r.parentElement}if(a){let r=(0,l.gn)(i,a);if(r){let i=e.touches[0];t({clientX:i.clientX,clientY:i.clientY,button:0,buttons:1,ctrlKey:!1,metaKey:!1,shiftKey:!1,altKey:!1,detail:1,currentTarget:e.currentTarget,target:e.target,preventDefault:()=>e.preventDefault(),stopPropagation:()=>e.stopPropagation(),nativeEvent:e},r)}}}}},[i,t]),u=(0,n.useCallback)(e=>{if(r&&2===e.touches.length){e.preventDefault();let t=e.touches[0],i=e.touches[1],r=Math.hypot(i.clientX-t.clientX,i.clientY-t.clientY),n=t.clientX-i.clientX,l=Math.atan2(t.clientY-i.clientY,n),a=r/o,s=(t.clientX+i.clientX)/2,d=(t.clientY+i.clientY)/2;window.scrollTo({left:c.x+s*(a-1)*Math.cos(l),top:c.y+d*(a-1)*Math.sin(l),behavior:"auto"})}else 1===e.touches.length&&e.preventDefault()},[r,o,c]);return{isPinching:r,handleTouchStart:h,handleTouchMove:u,handleTouchEnd:(0,n.useCallback)(()=>{a(!1),s(0),d({x:0,y:0})},[])}};var V=i(5439);let Z=e=>{let{dispatch:t,hierarchicalData:i,addToast:r}=e;return(0,n.useCallback)(async e=>{e.preventDefault();let n=$[`${e.ctrlKey||e.metaKey?"Ctrl+":""}${e.shiftKey?"Shift+":""}${e.key}`];if("PASTE_ELEMENT"===n){let e=await (0,V.xe)();if(!e){r(X.clipboardEmpty);return}let n=(i?(0,l.WN)(i):[])[0];if(!n){r(X.noSelect);return}if("clipboard"===e.type){let i=e.data;t({type:"ADD_HIERARCHICAL_ELEMENTS",payload:{targetNodeId:n.id,targetPosition:"child",hierarchicalItems:i,onError:e=>{r(`エラー: ${e}`)}}}),r(`${i.length}個の要素を階層構造で貼り付けました`)}else"elements"===e.type&&(t({type:"PASTE_CLIPBOARD_ELEMENTS",payload:{clipboardData:e.data,targetElementId:n.id}}),r(`要素を貼り付けました`))}else n&&("ADD_ELEMENT"===n?t({type:n,payload:{}}):t({type:n}))},[t,i,r])},q=e=>{let t,i,{elements:r,hierarchicalData:n,currentDropTarget:a,draggingElement:o,dropPosition:s,dropInsertY:d,dropInsertX:h,dropTargetDirection:u,direction:g,siblingInfo:p}=e,f=g||u||a.direction||"right",x="none"===a.direction&&!!n&&null===(0,l.c3)(n,a.id);console.log("[calculateDropCoordinates] Input:",{targetId:a.id,direction:f,passedDirection:g,dropTargetDirection:u,isRootInMindmap:x,dropPosition:s,dropInsertX:h,dropInsertY:d,currentTargetX:a.x,currentTargetWidth:a.width,draggingElementWidth:o.width});let E=f;if(x&&"child"===s&&p&&(p.prevElement?E=p.prevElement.direction:p.nextElement&&(E=p.nextElement.direction)),"child"===s)void 0!==h?(t=h,console.log("[calculateDropCoordinates] Using dropInsertX:",{dropInsertX:h,finalX:t,reason:"dropInsertX provided"})):"left"===f||x&&"left"===E?(t=a.x-c.e$.X-o.width,console.log("[calculateDropCoordinates] Left direction calculated:",{targetX:a.x,offset:c.e$.X,draggingWidth:o.width,calculatedX:t,reason:"left direction fallback"})):(t=a.x+a.width+c.e$.X,console.log("[calculateDropCoordinates] Right direction calculated:",{targetX:a.x,targetWidth:a.width,offset:c.e$.X,calculatedX:t,reason:"right direction fallback"})),console.log("[calculateDropCoordinates] Final coordinates:",{x:t,y:i=d?d-o.height/2:a.y+a.height/2-o.height/2,dropPosition:s,direction:f,dropTargetDirection:u,isLeftSide:"left"===f||"left"===u});else{if("between"!==s&&"sibling"!==s)return null;let e=n?(0,l.c3)(n,a.id):null,h=e?r[e.data.id]:null;if(h){let e=h.direction||"right";if(t="left"===(E="none"===h.direction?a.direction||"right":e)?h.x-c.e$.X-o.width:h.x+h.width+c.e$.X,p){let{prevElement:e,nextElement:t}=p;i=t&&!e?t.y-o.height:e&&!t?e.y+e.height:e&&t?d?d-o.height/2:(e.y+e.height+t.y)/2-o.height/2:d?d-o.height/2:a.y+a.height/2-o.height/2}else i=d?d-o.height/2:a.y+a.height/2-o.height/2}else t=c.e$.X,i=d?d-o.height/2:a.y+a.height/2-o.height/2}return{x:t,y:i}},J=function(e){for(var t=arguments.length,i=Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r]},Q={outline:"none",userSelect:"none",WebkitUserSelect:"none"},ee={position:"fixed",top:c.uF,left:0,width:"100vw",height:"calc(100vh - "+c.uF+"px)",overflow:"hidden",zIndex:-1},et={position:"absolute",top:c.uF,left:0,right:0,minWidth:"100%",minHeight:"calc(100vh - "+c.uF+"px)",overflow:"auto"},ei=n.memo(e=>{let{isHelpOpen:t,toggleHelp:i}=e,a=(0,n.useRef)(null),[o,d]=(0,n.useState)(!1),{state:u,dispatch:g}=s(),p=(0,n.useMemo)(()=>(0,l.Xd)(u.hierarchicalData),[u.hierarchicalData]),[f,x]=(0,n.useState)(c.BH),[E,m]=(0,n.useState)(c._o),[y,T]=(0,n.useState)(c.i_),{addToast:D}=(0,G.d)(),[b,w]=(0,n.useState)({width:0,height:0}),[O,$]=(0,n.useState)("0 0 0 0"),v=(0,n.useMemo)(()=>{let e=(0,l.TO)(u.hierarchicalData),t=e[0];return J("[DEBUG] CanvasArea: editingNode search",{totalElements:Object.keys(p).length,editingElements:e.map(e=>({id:e.id,editing:e.editing})),editingNode:t?t.id:"none"}),t},[u.hierarchicalData,p]),[A,N]=(0,n.useState)(null),[R,B]=(0,n.useState)(null),[X,U]=(0,n.useState)({});H(a,!!v);let{handleMouseDown:W,handleMouseUp:F,currentDropTarget:K,dropPosition:V,draggingElement:ei,dropInsertY:er,dropInsertX:en,dropTargetDirection:el,siblingInfo:ea,isDragInProgress:eo}=Y();P({setCanvasSize:w,setDisplayArea:$,hierarchicalData:u.hierarchicalData,zoomRatio:u.zoomRatio,isClient:o,isDragInProgress:eo});let{isPinching:es,handleTouchStart:ec,handleTouchMove:ed,handleTouchEnd:eh}=z({handleMouseDown:W,hierarchicalData:u.hierarchicalData}),eu=Z({dispatch:g,hierarchicalData:u.hierarchicalData,addToast:D});(0,n.useEffect)(()=>{v||requestAnimationFrame(()=>{let{scrollX:e,scrollY:t}=window;a.current?.focus({preventScroll:!0}),window.scrollTo(e,t)})},[v]),(0,n.useEffect)(()=>{d(!0),x((0,h.ZF)()||c.BH),m((0,h.S4)()||c._o),T((0,h.Es)()||c.i_)},[]);let eg=(e,t,i)=>{J("[DEBUG] CanvasArea: handleMarkerSelect called",{elementId:e,markerType:t,isEndMarker:i,currentElement:p[e]}),i?g({type:"UPDATE_END_MARKER",payload:{id:e,endMarker:t}}):g({type:"UPDATE_START_MARKER",payload:{id:e,startMarker:t}}),B(null)},ep=(0,n.useCallback)((e,t)=>{ei||U(i=>{if(i[e]===t)return i;let r={...i};return t?r[e]=!0:Object.prototype.hasOwnProperty.call(r,e)&&delete r[e],r})},[ei]);return(0,n.useEffect)(()=>{let e=e=>{R&&!e.target.closest(".popup-menu")&&B(null)};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[R]),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{style:{...ee,backgroundColor:y}}),(0,r.jsxs)("div",{style:{...et,touchAction:es?"none":"manipulation",backgroundColor:y},children:[o&&(0,r.jsxs)("svg",{"data-testid":"view-area",ref:a,width:b.width,height:b.height,viewBox:O,tabIndex:0,onKeyDown:eu,onTouchStart:ec,onTouchMove:ed,onTouchEnd:eh,style:{...Q,touchAction:es?"none":"manipulation",backgroundColor:y},className:"svg-element",children:[(0,r.jsx)("defs",{children:(0,r.jsx)(j,{connectionPathColor:f,connectionPathStroke:E})}),(()=>{let e={},t=[];return(0,l.BK)(u.hierarchicalData).forEach(i=>{let r=u.hierarchicalData?(0,l.c3)(u.hierarchicalData,i.id):null,n=u.hierarchicalData?(0,l.BL)(u.hierarchicalData,i.id):1,a=r?`${r.data.id}_${n}`:"root";e[a]||(e[a]=[]),e[a].push(i);let o=u.hierarchicalData?(0,l.PW)(u.hierarchicalData,i.id):[];r&&o.some(e=>e.visible)&&t.push(i)}),(0,r.jsxs)(r.Fragment,{children:[Object.entries(e).flatMap(e=>{let[t,i]=e;if("root"===t)return i.map(e=>{let t=(u.hierarchicalData?(0,l.PW)(u.hierarchicalData,e.id):[]).some(e=>e.visible);return(0,r.jsxs)(n.Fragment,{children:[(0,r.jsx)(I,{element:e,currentDropTarget:K,dropPosition:V,draggingElement:ei,handleMouseDown:W,handleMouseUp:F,onHoverChange:ep,_dropInsertY:er,_siblingInfo:ea}),t&&(0,r.jsx)(L,{element:e,absolutePosition:{x:e.x,y:e.y},hoverId:A,onHover:N,onShowMenu:B})]},e.id)});let[a]=t.split("_"),o=p[a];if(!o)return[];let s=o.x+o.width+c.e$.X,d=o.y,h=u.hierarchicalData?(0,l.BL)(u.hierarchicalData,i[0].id):1;return[(0,r.jsx)("g",{transform:`translate(${s}, ${d})`,className:"element-group","data-parent-id":a,"data-depth":h,children:i.map(e=>{let t=e.x-s,i=e.y-d;return(0,r.jsx)(I,{element:{...e,x:t,y:i},currentDropTarget:K,dropPosition:V,draggingElement:ei,handleMouseDown:t=>{W(t,e)},handleMouseUp:F,onHoverChange:ep,_dropInsertY:er,_siblingInfo:ea},e.id)})},t)]}),t.map(e=>(0,r.jsx)(L,{element:e,absolutePosition:{x:e.x,y:e.y},hoverId:A,onHover:N,onShowMenu:B},`marker-start-${e.id}`))]})})(),(0,l.BK)(u.hierarchicalData).filter(e=>!!(u.hierarchicalData?(0,l.c3)(u.hierarchicalData,e.id):null)).map(e=>{let t=u.hierarchicalData?(0,l.c3)(u.hierarchicalData,e.id):null;if(!t)return null;let i=p[t.data.id];return ei&&(e.id===ei.id||(0,C.K9)(p,ei.id,e.id))?null:(0,r.jsxs)(n.Fragment,{children:[(0,r.jsx)(M,{parentElement:i,element:e,absolutePositions:{parent:{x:i.x,y:i.y},element:{x:e.x,y:e.y}},strokeColor:f,strokeWidth:E}),(0,r.jsx)(L,{element:e,absolutePosition:{x:e.x,y:e.y},isEndMarker:!0,hoverId:A,onHover:N,onShowMenu:B})]},`connection-group-${e.id}`)}).filter(Boolean),(()=>{if(!K||!ei||!V)return null;let e=u.hierarchicalData&&"child"!==V?(0,l.c3)(u.hierarchicalData,K.id):null,t="child"===V?K:e?p[e.data.id]:null;if(!t)return null;let i=q({elements:p,hierarchicalData:u.hierarchicalData,currentDropTarget:K,draggingElement:ei,dropPosition:V,dropInsertY:er,dropInsertX:K&&"object"==typeof K&&"insertX"in K?K.insertX:void 0,siblingInfo:ea});if(!i)return null;let n=ei.direction;if("between"===V){if(K.direction)n=K.direction;else if(t&&"none"===t.direction){if(ea?.prevElement?.direction)n=ea.prevElement.direction;else if(ea?.nextElement?.direction)n=ea.nextElement.direction;else{let e=t.x+t.width/2;n=i.x<e?"left":"right"}}else t&&(n=t.direction||"right")}else if("child"===V){let e=u.hierarchicalData?(0,l.c3)(u.hierarchicalData,K.id):null;if("none"!==K.direction||e)n=K.direction||"right";else{let e=K.x+K.width/2;n=i.x<e?"left":"right"}}return(0,r.jsx)(M,{parentElement:t,element:{...ei,x:i.x,y:i.y,direction:n},absolutePositions:{parent:{x:t.x,y:t.y},element:{x:i.x,y:i.y}},strokeColor:c.lB.DRAGGING_COLOR,strokeWidth:c.lB.STROKE})})(),(()=>{let e,t;if(!R)return null;let i=R.startsWith("end-"),n=R;i&&(n=R.substring(4));let l=p[n];if(!l)return null;let a=l.height;return e=i?l.x-170:l.x+l.width+20,t=l.y+a/2-135,(0,r.jsx)(_,{popupX:e,popupY:t,isEndMarkerMenu:i,elementId:n,onMarkerSelect:eg,onClose:()=>B(null)})})(),(()=>{let e=new Set;return(Object.keys(X).forEach(t=>e.add(t)),ei&&K&&e.add(K.id),0===e.size)?null:Array.from(e).map(e=>{let t=p[e];return t&&t.visible?(0,r.jsx)(S,{element:t,isHovered:!0,currentDropTarget:K,dropPosition:V,siblingInfo:ea,elements:p},`debug-${t.id}`):null}).filter(Boolean)})(),(()=>{if(eo&&(!ei||!K||!V))return J("[DropPreview] Missing required data during drag:",{draggingElement:!!ei,currentDropTarget:!!K,dropPosition:V}),null;if(!ei||!K||!V)return null;J("[DropPreview] Rendering preview:",{targetId:K.id,targetDirection:K.direction,dropTargetDirection:el,dropPosition:V,insertX:en,insertY:er}),J("[DropPreview] Direction and insertX from hook:",{dropTargetDirection:el,dropInsertX:en});let e=q({elements:p,hierarchicalData:u.hierarchicalData,currentDropTarget:K,draggingElement:ei,dropPosition:V,dropInsertY:er,dropInsertX:en,dropTargetDirection:el,siblingInfo:ea,direction:el});if(J("[DropPreview] Calculated coordinates:",e),!e)return J("[DropPreview] No coordinates calculated"),null;let t="child"===V?"rgba(103, 208, 113, 0.3)":"rgba(157, 172, 244, 0.3)";return(0,r.jsx)("rect",{x:e.x,y:e.y,width:ei.width,height:ei.height,fill:t,stroke:"#555",strokeDasharray:"2,2",strokeWidth:1,rx:4,ry:4,className:"drop-preview","data-exclude-from-export":"true"})})()]}),(0,r.jsx)(k,{element:v,onEndEditing:()=>{g({type:"END_EDITING"}),a.current?.focus()}})]})]})});var er=i(5194),en=i(1311),el=i(1496),ea=i(9691),eo=i(1081),es=i(8694),ec=i(8283),ed=i(9310),eh=i(5833),eu=i(1401),eg=i(2554),ep=i(7040),ef=i(2152),ex=i(2397),eE=i(6597),em=i(5785),ey=i(9915),eT=i(826);let eC={TAB_BAR:{BACKGROUND:"#f0f0f0",ACTIVE_TAB_BACKGROUND:"#fff",INACTIVE_TAB_BACKGROUND:"#ddd",ACTIVE_TAB_BORDER:"#87CEFA",TAB_TEXT:"#000000",CLOSE_BUTTON_COLOR:"#666",CLOSE_BUTTON_HOVER_COLOR:"#1111ff",ADD_BUTTON_BACKGROUND:"transparent",ADD_BUTTON_TEXT:"#000"},MENU_BAR:{BACKGROUND:"#f1f1f1",ICON_COLOR:"#666666",DIVIDER_COLOR:"#e0e0e0"},MODAL:{BACKGROUND:"#ffffff",TEXT_COLOR:"#000000",BUTTON_BACKGROUND:"#f1f1f1",BUTTON_TEXT:"#000000",BUTTON_BORDER:"#cccccc",BUTTON_PRIMARY_BACKGROUND:"#1976d2",BUTTON_PRIMARY_TEXT:"#ffffff"}},eD={TAB_BAR:{BACKGROUND:"#333333",ACTIVE_TAB_BACKGROUND:"#555555",INACTIVE_TAB_BACKGROUND:"#444444",ACTIVE_TAB_BORDER:"#00aaff",TAB_TEXT:"#ffffff",CLOSE_BUTTON_COLOR:"#aaaaaa",CLOSE_BUTTON_HOVER_COLOR:"#9999ff",ADD_BUTTON_BACKGROUND:"transparent",ADD_BUTTON_TEXT:"#ffffff"},MENU_BAR:{BACKGROUND:"#333333",ICON_COLOR:"#bbbbbb",DIVIDER_COLOR:"#444444"},MODAL:{BACKGROUND:"#333333",TEXT_COLOR:"#fefefe",BUTTON_BACKGROUND:"#555555",BUTTON_TEXT:"#ffffff",BUTTON_BORDER:"#666666",BUTTON_PRIMARY_BACKGROUND:"#1976d2",BUTTON_PRIMARY_TEXT:"#ffffff"}},eb=e=>{let t=e.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,(e,t,i,r)=>t+t+i+i+r+r),i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return i?{r:parseInt(i[1],16),g:parseInt(i[2],16),b:parseInt(i[3],16)}:null},ew=e=>{let t="string"==typeof e?eb(e):e;return t?(299*t.r+587*t.g+114*t.b)/1e3:255},eI=e=>128>ew(e),eO=e=>eI(e)?eD:eC;var eS=i(9137),e$=i.n(eS);let ev=e=>{let{isLoading:t,size:i=24,color:n="#4B5563"}=e;return t?(0,r.jsxs)("div",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",zIndex:9999},className:"jsx-44c6c384c94b6b72",children:[(0,r.jsx)("div",{style:{width:`${i}px`,height:`${i}px`,border:"3px solid rgba(0, 0, 0, 0.1)",borderRadius:"50%",borderTop:`3px solid ${n}`,animation:"spin 1s linear infinite"},className:"jsx-44c6c384c94b6b72"}),(0,r.jsx)(e$(),{id:"44c6c384c94b6b72",children:"@-webkit-keyframes spin{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@-moz-keyframes spin{0%{-moz-transform:rotate(0deg);transform:rotate(0deg)}100%{-moz-transform:rotate(360deg);transform:rotate(360deg)}}@-o-keyframes spin{0%{-o-transform:rotate(0deg);transform:rotate(0deg)}100%{-o-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes spin{0%{-webkit-transform:rotate(0deg);-moz-transform:rotate(0deg);-o-transform:rotate(0deg);transform:rotate(0deg)}100%{-webkit-transform:rotate(360deg);-moz-transform:rotate(360deg);-o-transform:rotate(360deg);transform:rotate(360deg)}}"})]}):null},eA={NEW:"新規作成",OPEN:"ファイルを開く",SAVE:"保存（JSON形式）",SAVE_SVG:"SVG画像で保存",ADD:"新しい要素の追加",DELETE:"要素の削除",AI:"AI機能",EXPAND:"展開",COLLAPSE:"折りたたみ",UNDO:"元に戻す",REDO:"やり直す",ZOOM_IN:"ズームイン",ZOOM_OUT:"ズームアウト",HELP:"ヘルプを表示",SETTINGS:"設定"};var ek=i(4880),eN=i(5857),eR=i(514);let ej=e=>{let{tooltip:t,onClick:i,icon:n,iconColor:l,disabled:a=!1,customContent:o}=e,s=(0,r.jsx)(eN.A,{variant:"text",className:"iconbar-button",onClick:i,disabled:a,children:o||n&&(0,r.jsx)(n,{sx:{color:l}})});return(0,r.jsx)(eR.A,{title:t,children:a?(0,r.jsx)("span",{children:s}):s})},e_=e=>{let{color:t}=e;return(0,r.jsx)("div",{style:{width:"10px",backgroundColor:t,height:"60%",margin:"0 5px",opacity:.3}})},eL=e=>{let{saveSvg:t,loadElements:i,saveElements:l,toggleHelp:a,toggleSettings:o,onAIClick:d,isAILoading:u}=e,{dispatch:g}=s(),{addTab:p}=(0,D.u)(),{isSuggestionEnabled:f,toggleSuggestion:x}=(0,eT.I)(),E=(0,n.useRef)(null),m=(0,n.useRef)(null),y=b(),[T,C]=(0,n.useState)(!1),w=(0,n.useCallback)(e=>()=>{"ZOOM_IN"===e||"ZOOM_OUT"===e?(C(!0),setTimeout(()=>{g({type:e}),setTimeout(()=>{C(!1)},300)},50)):"ADD_ELEMENT"===e?g({type:e,payload:{}}):g({type:e})},[g]);if(!y)return null;let I=eO((0,h.Es)());return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{style:{position:"fixed",width:"100%",height:c.JY,overflowX:"auto",WebkitOverflowScrolling:"touch",msOverflowStyle:"none",scrollbarWidth:"none"},ref:m,children:(0,r.jsxs)("div",{style:{display:"flex",justifyContent:"left",alignItems:"center",height:"100%",backgroundColor:I.MENU_BAR.BACKGROUND,padding:"0 20px",minWidth:"max-content"},children:[!(0,ek.oL)()&&(0,r.jsx)("input",{type:"file",ref:E,onChange:i,style:{display:"none"},accept:".json"}),(0,r.jsx)(ej,{tooltip:eA.NEW,onClick:p,icon:ea.A,iconColor:I.MENU_BAR.ICON_COLOR}),(0,r.jsx)(ej,{tooltip:eA.OPEN,onClick:()=>{(0,ek.oL)()?i():E.current?.click()},icon:er.A,iconColor:I.MENU_BAR.ICON_COLOR}),(0,r.jsx)(ej,{tooltip:eA.SAVE,onClick:l,icon:en.A,iconColor:I.MENU_BAR.ICON_COLOR}),(0,r.jsx)(ej,{tooltip:eA.SAVE_SVG,onClick:t,icon:el.A,iconColor:I.MENU_BAR.ICON_COLOR}),(0,r.jsx)(e_,{color:I.MENU_BAR.DIVIDER_COLOR}),(0,r.jsx)(ej,{tooltip:eA.ADD,onClick:w("ADD_ELEMENT"),icon:eo.A,iconColor:I.MENU_BAR.ICON_COLOR}),(0,r.jsx)(ej,{tooltip:eA.DELETE,onClick:w("DELETE_ELEMENT"),icon:es.A,iconColor:I.MENU_BAR.ICON_COLOR}),(0,r.jsx)(ej,{tooltip:u?"AI生成中...":eA.AI,onClick:u?void 0:d,icon:u?void 0:ec.A,iconColor:I.MENU_BAR.ICON_COLOR,disabled:u,customContent:u?(0,r.jsx)(ey.A,{size:20,thickness:4,sx:{color:I.MENU_BAR.ICON_COLOR}}):void 0}),(0,r.jsx)(ej,{tooltip:f?"サジェスト機能をOFFにする":"サジェスト機能をONにする",onClick:x,icon:f?ed.A:ec.A,iconColor:f?I.MENU_BAR.ICON_COLOR:"#999"}),(0,r.jsx)(ej,{tooltip:eA.EXPAND,onClick:w("EXPAND_ELEMENT"),icon:eh.A,iconColor:I.MENU_BAR.ICON_COLOR}),(0,r.jsx)(ej,{tooltip:eA.COLLAPSE,onClick:w("COLLAPSE_ELEMENT"),icon:eu.A,iconColor:I.MENU_BAR.ICON_COLOR}),(0,r.jsx)(e_,{color:I.MENU_BAR.DIVIDER_COLOR}),(0,r.jsx)(ej,{tooltip:eA.UNDO,onClick:w("UNDO"),icon:eg.A,iconColor:I.MENU_BAR.ICON_COLOR}),(0,r.jsx)(ej,{tooltip:eA.REDO,onClick:w("REDO"),icon:ep.A,iconColor:I.MENU_BAR.ICON_COLOR}),(0,r.jsx)(e_,{color:I.MENU_BAR.DIVIDER_COLOR}),(0,r.jsx)(ej,{tooltip:eA.ZOOM_IN,onClick:w("ZOOM_IN"),icon:ef.A,iconColor:I.MENU_BAR.ICON_COLOR}),(0,r.jsx)(ej,{tooltip:eA.ZOOM_OUT,onClick:w("ZOOM_OUT"),icon:ex.A,iconColor:I.MENU_BAR.ICON_COLOR}),(0,r.jsx)(e_,{color:I.MENU_BAR.DIVIDER_COLOR}),(0,r.jsx)(ej,{tooltip:eA.HELP,onClick:a,icon:eE.A,iconColor:I.MENU_BAR.ICON_COLOR}),(0,r.jsx)(ej,{tooltip:eA.SETTINGS,onClick:o,icon:em.A,iconColor:I.MENU_BAR.ICON_COLOR})]})}),T&&(0,r.jsx)("div",{style:{position:"fixed",zIndex:9500,width:"100%",height:"100%",pointerEvents:"none"},children:(0,r.jsx)(ev,{isLoading:T,size:32,color:"#4B5563"})})]})};async function eM(){return h.$f()}async function eB(e){h.hS(e)}async function eP(){return h.kN()}async function eH(e){h.qu(e)}async function eX(){return h._1()}async function eG(e){h.JT(e)}async function eU(){return h.xo()}async function eW(e){h.Jg(e)}async function eF(){return h.af()}async function eK(e){h.Yu(e)}async function eY(){return h.zn()}async function ez(e){h.li(e)}async function eV(){return h.ZF()}async function eZ(e){h.xN(e)}async function eq(){return h.S4()}async function eJ(e){h.K2(e)}async function eQ(){return h.Es()}async function e0(e){h.QY(e)}async function e1(){return h.vG()}async function e2(e){h.vY(e)}async function e3(){return h.N4()}async function e5(e){h.LL(e)}async function e4(){return await h.CG()}async function e6(e){await h.wt(e)}async function e9(){return h.XH()}async function e8(e){h.bJ(e)}async function e7(){return h.k0()}async function te(e){h.mF(e)}async function tt(){return h.OA()}async function ti(e){h.Iz(e)}async function tr(){return h.G6()}async function tn(){return h.EN()}async function tl(e){h.AN(e)}async function ta(){try{let e=window.vscodeFileAPI;if(e?.getCurrentFileName)return await e.getCurrentFileName();return null}catch(e){return console.error("ファイル名の取得に失敗しました:",e),null}}class to{getStyles(){return h.$f()}setStyles(e){h.hS(e)}getElementColor(){return h.kN()}setElementColor(e){h.qu(e)}getStrokeColor(){return h._1()}setStrokeColor(e){h.JT(e)}getStrokeWidth(){return h.xo()}setStrokeWidth(e){h.Jg(e)}getFontFamily(){return h.af()}setFontFamily(e){h.Yu(e)}getMarkerType(){return h.zn()}setMarkerType(e){h.li(e)}getConnectionPathColor(){return h.ZF()}setConnectionPathColor(e){h.xN(e)}getConnectionPathStroke(){return h.S4()}setConnectionPathStroke(e){h.K2(e)}getCanvasBackgroundColor(){return h.Es()}setCanvasBackgroundColor(e){h.QY(e)}getTextColor(){return h.vG()}setTextColor(e){h.vY(e)}getSelectedStrokeColor(){return h.N4()}setSelectedStrokeColor(e){h.LL(e)}async getApiKey(){return await h.CG()}async setApiKey(e){await h.wt(e)}getPrompt(){return h.XH()}setPrompt(e){h.bJ(e)}getSystemPromptTemplate(){return h.k0()}setSystemPromptTemplate(e){h.mF(e)}getModelType(){return h.OA()}setModelType(e){h.Iz(e)}getApiEndpoint(){return h.G6()}getTabsState(){return h.EN()}setTabsState(e){h.AN(e)}}class ts{async getStyles(){return await eM()}async setStyles(e){await eB(e)}async getElementColor(){return await eP()}async setElementColor(e){await eH(e)}async getStrokeColor(){return await eX()}async setStrokeColor(e){await eG(e)}async getStrokeWidth(){return await eU()}async setStrokeWidth(e){await eW(e)}async getFontFamily(){return await eF()}async setFontFamily(e){await eK(e)}async getMarkerType(){return await eY()}async setMarkerType(e){await ez(e)}async getConnectionPathColor(){return await eV()}async setConnectionPathColor(e){await eZ(e)}async getConnectionPathStroke(){return await eq()}async setConnectionPathStroke(e){await eJ(e)}async getCanvasBackgroundColor(){return await eQ()}async setCanvasBackgroundColor(e){await e0(e)}async getTextColor(){return await e1()}async setTextColor(e){await e2(e)}async getSelectedStrokeColor(){return await e3()}async setSelectedStrokeColor(e){await e5(e)}async getApiKey(){return await e4()}async setApiKey(e){await e6(e)}async getPrompt(){return await e9()}async setPrompt(e){await e8(e)}async getSystemPromptTemplate(){return await e7()}async setSystemPromptTemplate(e){await te(e)}async getModelType(){return await tt()}async setModelType(e){await ti(e)}async getApiEndpoint(){return await tr()}async getTabsState(){return await tn()}async setTabsState(e){await tl(e)}async getCurrentFileName(){return await ta()}}let tc=(0,ek.oL)()?new ts:new to,td=n.memo(e=>{let{tab:t,isCurrent:i,closeTab:l,switchTab:a,theme:o}=e,s=b(),[c,d]=(0,n.useState)(!1),[h,u]=(0,n.useState)(t.name);return((0,n.useEffect)(()=>{if((0,ek.oL)()&&i&&tc.getCurrentFileName){let e=async()=>{try{let e=await tc.getCurrentFileName();e&&e!==t.name&&u(e)}catch(e){console.error("ファイル名の取得に失敗しました:",e)}};{let e=window;e.handleFileNameChanged&&(e.handleFileNameChanged=e=>{u(e)})}e()}else u(t.name)},[t.name,i]),s)?(0,r.jsxs)("div",{style:{padding:"6px",marginRight:"4px",backgroundColor:i?o.TAB_BAR.ACTIVE_TAB_BACKGROUND:o.TAB_BAR.INACTIVE_TAB_BACKGROUND,borderBottom:i?`3px solid ${o.TAB_BAR.ACTIVE_TAB_BORDER}`:"none",paddingBottom:"3px",borderRadius:"5px 5px 0 0",fontSize:"12px",display:"flex",alignItems:"center",color:o.TAB_BAR.TAB_TEXT,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",minWidth:"48px",maxWidth:"150px"},onClick:()=>a(t.id),children:[(0,r.jsxs)("div",{style:{display:"flex",alignItems:"center",flex:"1",overflow:"hidden"},children:[(0,r.jsx)("span",{style:{flex:"0 1 auto",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",minWidth:"0"},children:h}),!t.isSaved&&(0,r.jsx)("span",{style:{flex:"0 0 auto",marginRight:"0px",marginLeft:"2px",fontSize:"12px"},children:"*"})]}),(0,r.jsx)("button",{onClick:e=>{e.stopPropagation(),l(t.id)},onMouseEnter:()=>d(!0),onMouseLeave:()=>d(!1),style:{flex:"0 0 auto",padding:"0px",marginLeft:"0px",marginRight:"2px",border:"0",backgroundColor:"transparent",fontSize:"16px",color:c?o.TAB_BAR.CLOSE_BUTTON_HOVER_COLOR||"#9999ff":o.TAB_BAR.CLOSE_BUTTON_COLOR,fontWeight:"bold",cursor:"pointer",transition:"color 0.2s ease"},children:"\xd7"})]}):null});td.displayName="Tab";let th=n.memo(function(e){let{tabs:t,currentTabId:i,addTab:l,closeTab:a,switchTab:o}=e,s=b(),[,d]=(0,n.useState)(c.i_),[u,g]=(0,n.useState)(()=>eO(c.i_));return((0,n.useEffect)(()=>{if(!s)return;let e=(0,h.Es)();d(e),g(eO(e))},[s]),s)?(0,r.jsxs)("div",{style:{display:"flex",alignItems:"center",backgroundColor:u.TAB_BAR.BACKGROUND,width:"100%",height:c.FM,marginTop:c.JY,position:"fixed"},children:[t.map(e=>(0,r.jsx)(td,{tab:e,isCurrent:i===e.id,closeTab:a,switchTab:o,theme:u},e.id)),(0,r.jsx)("button",{onClick:l,style:{marginLeft:"8px",backgroundColor:u.TAB_BAR.ADD_BUTTON_BACKGROUND,color:u.TAB_BAR.ADD_BUTTON_TEXT,border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"16px",padding:"2px 8px"},children:"+"})]}):null}),tu=e=>{let{isOpen:t,onClose:i,children:l,closeOnOverlayClick:a=!0,title:o,icon:s,modalId:c="unknown-modal",onOpen:d}=e,u=b(),[g,p]=(0,n.useState)(()=>eO((0,h.Es)())),[f,x]=(0,n.useState)(!1),E=(0,n.useRef)(0),m=(0,n.useRef)(t);(0,n.useEffect)(()=>{E.current+=1}),(0,n.useEffect)(()=>{u&&p(eO((0,h.Es)()))},[u,c]),(0,n.useEffect)(()=>(t&&!m.current&&d&&d(),m.current=t,t&&x(!0),()=>{}),[t,c,d]);let y=()=>{x(!1),setTimeout(()=>{i()},200)};if(!t)return null;let T=`
        0 10px 15px -3px rgba(0, 0, 0, 0.1),
        0 4px 6px -2px rgba(0, 0, 0, 0.05),
        0 0 0 1px rgba(255, 255, 255, 0.1)
    `;return(0,r.jsx)("div",{style:{position:"fixed",top:0,left:0,width:"100%",height:"100%",backgroundColor:"rgba(0, 0, 0, 0.6)",display:"flex",justifyContent:"center",alignItems:"center",zIndex:9e3,backdropFilter:"blur(3px)",opacity:+!!f,transition:"opacity 0.3s ease-in-out"},onClick:e=>{a&&y()},children:(0,r.jsxs)("div",{style:{backgroundColor:g.MODAL.BACKGROUND,color:g.MODAL.TEXT_COLOR,padding:"20px 24px 24px",borderRadius:"16px",width:"80%",maxWidth:"500px",overflow:"hidden",position:"relative",zIndex:9001,boxShadow:T,transform:f?"translateY(0) scale(1)":"translateY(20px) scale(0.95)",transition:"transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease-in-out",opacity:+!!f},onClick:e=>e.stopPropagation(),children:[(s||o)&&(0,r.jsxs)("div",{style:{position:"absolute",top:16,left:24,display:"flex",alignItems:"center",gap:"8px"},children:[s&&(0,r.jsx)("div",{style:{display:"flex",alignItems:"center",justifyContent:"center"},children:s}),o&&(0,r.jsx)("div",{style:{fontSize:"1.2em",fontWeight:"bold",color:g.MODAL.TEXT_COLOR,display:"flex",alignItems:"center",height:"32px"},children:o})]}),(0,r.jsx)("button",{onClick:y,style:{position:"absolute",right:16,top:16,background:`${g.MODAL.TEXT_COLOR}15`,border:"none",borderRadius:"50%",width:"32px",height:"32px",display:"flex",justifyContent:"center",alignItems:"center",fontSize:"1.2em",color:g.MODAL.TEXT_COLOR,cursor:"pointer",transition:"all 0.2s ease",outline:"none"},onMouseOver:e=>{e.currentTarget.style.background=`${g.MODAL.TEXT_COLOR}25`,e.currentTarget.style.transform="scale(1.1)"},onMouseOut:e=>{e.currentTarget.style.background=`${g.MODAL.TEXT_COLOR}15`,e.currentTarget.style.transform="scale(1)"},children:"\xd7"}),(0,r.jsx)("div",{style:{position:"relative",maxHeight:"calc(80vh - 56px)",marginTop:s?"40px":o?"24px":"16px",overflowY:"auto",overflowX:"hidden",scrollbarWidth:"thin",scrollbarColor:`${g.MODAL.TEXT_COLOR}40 transparent`},children:l})]})})},tg=()=>(0,r.jsx)("div",{style:{width:"40px",height:"40px",borderRadius:"50%",background:"linear-gradient(135deg, #2f8f67, #049e01)",display:"flex",justifyContent:"center",alignItems:"center",boxShadow:"inset 0 2px 4px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.2)"},children:(0,r.jsx)("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:(0,r.jsx)("path",{d:"M19.14 12.936a7.943 7.943 0 000-1.873l2.036-1.58a.5.5 0 00.11-.643l-1.926-3.33a.5.5 0 00-.607-.22l-2.397.96a7.982 7.982 0 00-1.62-.938l-.36-2.54A.5.5 0 0014.5 2h-5a.5.5 0 00-.493.422l-.36 2.54a7.982 7.982 0 00-1.62.938l-2.397-.96a.5.5 0 00-.607.22l-1.926 3.33a.5.5 0 00.11.643l2.036 1.58a7.943 7.943 0 000 1.873l-2.036 1.58a.5.5 0 00-.11.643l1.926 3.33a.5.5 0 00.607.22l2.397-.96a7.982 7.982 0 001.62.938l.36 2.54A.5.5 0 009.5 22h5a.5.5 0 00.493-.422l.36-2.54a7.982 7.982 0 001.62-.938l2.397.96a.5.5 0 00.607-.22l1.926-3.33a.5.5 0 00-.11-.643l-2.036-1.58zM12 15.5a3.5 3.5 0 110-7 3.5 3.5 0 010 7z",fill:"#ffffff"})})});var tp=i(2582),tf=i(7498),tx=i(9284),tE=i(9868),tm=i(7923),ty=i(3025),tT=i(8893),tC=i(5358),tD=i(7298),tb=i(9439),tw=i(4512),tI=i(8410);let tO=e=>{let{field:t,value:i,error:n=!1,onChange:l}=e;switch(t.type){case"text":return(0,r.jsx)(tp.A,{label:t.label,value:i,onChange:e=>{let i=e.target.value;if("apiKey"===t.key){l(i);return}if(!(0,A.IK)(t.key,i)){console.warn(`設定値が無効です: ${t.key}`);return}l((0,u.jZ)(i))},fullWidth:!0,margin:"normal",multiline:"prompt"===t.key||"systemPromptTemplate"===t.key,rows:"prompt"===t.key||"systemPromptTemplate"===t.key?6:1,type:"apiKey"===t.key?"password":"text",helperText:t.helperText,variant:"prompt"===t.key||"systemPromptTemplate"===t.key?"outlined":"standard"});case"number":return(0,r.jsx)(tp.A,{label:t.label,type:"number",value:i,onChange:e=>l(e.target.value),fullWidth:!0,margin:"normal",inputProps:{min:t.validation?.min,max:t.validation?.max,step:t.validation?.step},error:n,helperText:n?`${t.validation?.min}から${t.validation?.max}の数値を入力してください`:t.helperText});case"select":return(0,r.jsxs)(tf.A,{fullWidth:!0,margin:"normal",children:[(0,r.jsx)(tx.A,{children:t.label}),(0,r.jsx)(tE.A,{value:String(i),label:t.label,onChange:e=>{l(e.target.value)},MenuProps:{sx:{zIndex:9999}},children:t.options?.map(e=>r.jsx(tm.A,{value:e.value,children:e.label},e.value))}),(0,r.jsx)(ty.A,{children:t.helperText})]});case"color":return(0,r.jsxs)(tT.A,{sx:{display:"flex",alignItems:"center",mt:2,mb:1},children:[(0,r.jsxs)(tC.A,{variant:"body1",sx:{mr:2,width:"120px"},children:[t.label,":"]}),(0,r.jsx)("input",{type:"color",value:String(i),onChange:e=>l(e.target.value)}),(0,r.jsx)(ty.A,{children:t.helperText})]});case"radio":return(0,r.jsxs)(tf.A,{component:"fieldset",fullWidth:!0,children:[(0,r.jsx)(tD.A,{component:"legend",children:t.label}),(0,r.jsx)(tb.A,{children:t.options?.map(e=>r.jsx(tw.A,{value:e.value,control:r.jsx(tI.A,{checked:i===e.value,onChange:e=>l(e.target.value)}),label:e.label},e.value))}),(0,r.jsx)(ty.A,{children:t.helperText})]});default:return null}};var tS=i(5055),t$=i(460),tv=i(270),tA=i(3745),tk=i(7790),tN=i(5787);let tR=[{id:0,label:"Elements Setting",fields:[{key:"layoutMode",label:"Layout Mode",type:"radio",helperText:"レイアウトモードの選択 ※現在のタブのみに適用されます",defaultValue:"default",options:[{value:"default",label:"通常モード"},{value:"mindmap",label:"マインドマップモード"}]},{key:"numberOfSections",label:"Number of sections",type:"number",helperText:"同時に表示するセクションの数（1〜10） ※現在のタブと新規作成されるタブのデフォルト値として設定されます",defaultValue:3,validation:{min:1,max:10,required:!0}},{key:"markerType",label:"Default Marker Type",type:"select",helperText:"新規要素作成時のデフォルトマーカータイプ",defaultValue:c.vX.NONE,options:[{value:c.vX.NONE,label:"None"},{value:c.vX.ARROW,label:"Arrow"},{value:c.vX.CIRCLE,label:"Circle"},{value:c.vX.SQUARE,label:"Square"},{value:c.vX.DIAMOND,label:"Diamond"},{value:c.vX.FILLED_ARROW,label:"Filled Arrow"},{value:c.vX.FILLED_CIRCLE,label:"Filled Circle"},{value:c.vX.FILLED_SQUARE,label:"Filled Square"},{value:c.vX.FILLED_DIAMOND,label:"Filled Diamond"}]},{key:"canvasBackgroundColor",label:"Canvas Background Color",type:"color",helperText:"キャンバスの背景色",defaultValue:c.i_},{key:"elementColor",label:"Element Color",type:"color",helperText:"要素の背景色",defaultValue:c.iC.NORMAL.COLOR},{key:"textColor",label:"Text Color",type:"color",helperText:"テキストの色",defaultValue:c._K},{key:"strokeColor",label:"Stroke Color",type:"color",helperText:"要素の枠線色",defaultValue:c.iC.NORMAL.STROKE_COLOR},{key:"selectedStrokeColor",label:"Selected Stroke Color",type:"color",helperText:"選択時の要素の枠線色",defaultValue:c.iC.SELECTED.STROKE_COLOR},{key:"strokeWidth",label:"Stroke Width",type:"number",helperText:"要素の枠線の太さ",defaultValue:1,validation:{min:0,step:.5,required:!0}},{key:"connectionPathColor",label:"Connection Path Color",type:"color",helperText:"接続線の色",defaultValue:c.BH},{key:"connectionPathStroke",label:"Connection Path Stroke",type:"number",helperText:"接続線の太さ",defaultValue:1,validation:{min:.5,step:.5,required:!0}},{key:"fontFamily",label:"Font Family",type:"text",helperText:"表示に使用するフォントファミリ",defaultValue:""}]},{id:1,label:"API Setting",fields:[{key:"modelType",label:"Select Model",type:"radio",helperText:"APIモデルの選択",defaultValue:"gemini-2.0-flash",options:[{value:"gemini-2.0-flash",label:"Gemini-2.0-flash"},{value:"gemini-2.5-flash",label:"Gemini-2.5-flash"}]},{key:"apiKey",label:"Gemini API Key",type:"text",helperText:"入力されたキーは暗号化してlocalStorageに保存されます。サーバに送信されることはありません。",defaultValue:""}]},{id:2,label:"Prompt",fields:[{key:"prompt",label:"inputText",type:"text",helperText:"",defaultValue:""},{key:"systemPromptTemplate",label:"SystemPromptTemplate",type:"text",helperText:"",defaultValue:""}]}],tj=(e,t)=>{let i={};t.forEach(t=>{void 0!==e[t.key]&&(i[t.key]=e[t.key])});let r=new Blob([JSON.stringify(i,null,2)],{type:"application/json"}),n=URL.createObjectURL(r),l=document.createElement("a");l.href=n,l.download=`theme-settings-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(l),l.click(),setTimeout(()=>{document.body.removeChild(l),URL.revokeObjectURL(n)},0)},t_=(e,t)=>{if("number"===e.type){let i="string"==typeof t?parseFloat(t):t;if(e.validation?.required&&(""===t||isNaN(i))||!isNaN(i)&&(e.validation?.min!==void 0&&i<e.validation.min||e.validation?.max!==void 0&&i>e.validation.max))return!1}return!0},tL=(e,t,i,r)=>{let n={...t},l={...i},a=!1;return r.forEach(t=>{void 0!==e[t.key]&&(t_(t,e[t.key])?(n[t.key]=e[t.key],l[t.key]=!1):(a=!0,l[t.key]=!0))}),{newValues:n,newErrors:l,hasError:a}},tM=e=>{let{isOpen:t,onClose:i,dispatch:l,modalId:a,onOpen:o}=e,s=b(),[c,d]=(0,n.useState)(0),[g,p]=(0,n.useState)({}),[f,x]=(0,n.useState)({}),[E,m]=(0,n.useState)("light"),[y,T]=(0,n.useState)(()=>eO((0,h.Es)())),C=(0,n.useRef)(null),{getCurrentTabNumberOfSections:w,updateCurrentTabNumberOfSections:I,getCurrentTabLayoutMode:O,updateCurrentTabLayoutMode:S}=(0,D.u)();if((0,n.useEffect)(()=>{let e=(0,h.Es)();m(eI(e)?"dark":"light"),T(eO(e))},[s]),(0,n.useEffect)(()=>{if(s&&t)try{let e={};e.apiKey=(0,h.CG)(),e.systemPromptTemplate=(0,h.k0)(),e.modelType=(0,h.OA)(),e.prompt=(0,h.XH)(),e.numberOfSections=w(),e.layoutMode=O(),e.elementColor=(0,h.kN)(),e.strokeColor=(0,h._1)(),e.strokeWidth=(0,h.xo)(),e.fontFamily=(0,h.af)(),e.markerType=(0,h.zn)(),e.connectionPathColor=(0,h.ZF)(),e.connectionPathStroke=(0,h.S4)(),e.canvasBackgroundColor=(0,h.Es)(),e.textColor=(0,h.vG)(),e.selectedStrokeColor=(0,h.N4)(),p(e)}catch{}},[s,t,w,O]),!s)return null;let $=(0,tv.A)({palette:{mode:E,background:{default:y.MODAL.BACKGROUND,paper:y.MODAL.BACKGROUND},text:{primary:y.MODAL.TEXT_COLOR,secondary:y.MODAL.TEXT_COLOR}},components:{MuiButton:{styleOverrides:{root:{color:y.MODAL.BUTTON_TEXT,borderColor:y.MODAL.BUTTON_BORDER},contained:{backgroundColor:y.MODAL.BUTTON_PRIMARY_BACKGROUND,color:y.MODAL.BUTTON_PRIMARY_TEXT,"&:hover":{backgroundColor:y.MODAL.BUTTON_PRIMARY_BACKGROUND,opacity:.9}},outlined:{backgroundColor:y.MODAL.BUTTON_BACKGROUND,"&:hover":{backgroundColor:y.MODAL.BUTTON_BACKGROUND,opacity:.9}}}}}}),v=(e,t)=>{if("number"===e.type){let i="string"==typeof t?parseFloat(t):t;if(e.validation?.required&&(""===t||isNaN(i))||!isNaN(i)&&(e.validation?.min!==void 0&&i<e.validation.min||e.validation?.max!==void 0&&i>e.validation.max))return!1}return!0},k=(e,t)=>{p(i=>({...i,[e.key]:t})),x(i=>({...i,[e.key]:!v(e,t)}))};return(0,r.jsx)(tu,{isOpen:t,onClose:i,closeOnOverlayClick:!1,title:"Preference",icon:(0,r.jsx)(tg,{}),dispatch:l,modalId:a,onOpen:o,children:(0,r.jsx)(tA.A,{theme:$,children:(0,r.jsxs)(tT.A,{sx:{backgroundColor:y.MODAL.BACKGROUND,color:y.MODAL.TEXT_COLOR,padding:2,borderRadius:1,display:"flex",flexDirection:"column",height:"80vh",maxHeight:600},children:[(0,r.jsx)(tS.A,{value:c,onChange:(e,t)=>d(t),variant:"scrollable",scrollButtons:"auto",allowScrollButtonsMobile:!0,textColor:"primary",indicatorColor:"primary",children:tR.map(e=>(0,r.jsx)(t$.A,{label:e.label},e.id))}),(0,r.jsx)(tT.A,{sx:{mt:2,flex:1,overflowY:"auto","&::-webkit-scrollbar":{width:"8px"},"&::-webkit-scrollbar-track":{background:"transparent"},"&::-webkit-scrollbar-thumb":{background:y.MODAL.TEXT_COLOR,opacity:.2,borderRadius:"4px"}},children:tR.map(e=>c===e.id&&(0,r.jsx)(tT.A,{children:e.fields.map(e=>(0,r.jsx)(tO,{field:e,value:g[e.key]??e.defaultValue,error:f[e.key],onChange:t=>k(e,t)},e.key))},e.id))}),(0,r.jsxs)(tT.A,{sx:{mt:2,pt:2,display:"flex",flexWrap:"wrap",gap:1,justifyContent:"space-between",alignItems:"center",borderTop:`1px solid ${y.MODAL.TEXT_COLOR}20`,backgroundColor:y.MODAL.BACKGROUND},children:[(0,r.jsx)("input",{type:"file",ref:C,onChange:e=>{let t=e.target.files?.[0];if(!t)return;let i=(0,u.Nz)(t.name);if(!i||!i.endsWith(".json")){alert("Invalid file name or format. Please select a valid JSON file."),e.target&&(e.target.value="");return}if(t.size>1048576){alert("File size too large. Please select a file smaller than 1MB."),e.target&&(e.target.value="");return}let r=new FileReader;r.onload=t=>{try{let i=t.target?.result;if(!(0,A.IU)(i)){alert("File content contains potentially dangerous data. Import cancelled."),e.target&&(e.target.value="");return}if(!(0,A.L5)(i)){alert("Invalid JSON format. Please check the file contents."),e.target&&(e.target.value="");return}let r=(0,u.jZ)(i),n=JSON.parse(r),{newValues:l,newErrors:a,hasError:o}=tL(n,g,f,tR[0].fields);o&&alert("Some imported settings are invalid and will be ignored."),p(l),x(a),e.target&&(e.target.value="")}catch{alert("Failed to parse imported settings. Please check the file format."),e.target&&(e.target.value="")}},r.readAsText(t)},accept:".json",style:{display:"none"}}),(0,r.jsx)(tT.A,{sx:{display:"flex",gap:2},children:0===c&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(eN.A,{variant:"outlined",startIcon:(0,r.jsx)(tk.A,{}),onClick:()=>{tj(g,tR[0].fields)},children:"Export"}),(0,r.jsx)(eN.A,{variant:"outlined",startIcon:(0,r.jsx)(tN.A,{}),onClick:()=>{C.current&&C.current.click()},children:"Import"})]})}),(0,r.jsxs)(tT.A,{sx:{display:"flex",gap:1},children:[(0,r.jsx)(eN.A,{variant:"outlined",onClick:i,children:"Cancel"}),(0,r.jsx)(eN.A,{variant:"contained",onClick:()=>{let e=!1;if(tR.forEach(t=>{t.fields.forEach(t=>{let i=g[t.key];v(t,i)||(e=!0,x(e=>({...e,[t.key]:!0})))})}),e)return;let t=g.apiKey;void 0!==t&&(0,h.wt)(String(t));let r=g.systemPromptTemplate;void 0!==r&&(0,h.mF)(String(r));let n=g.modelType;void 0!==n&&(0,h.Iz)(String(n));let l=g.prompt;void 0!==l&&(0,h.bJ)(String(l));let a=g.numberOfSections;void 0!==a&&I(Number(a));let o=g.layoutMode;void 0!==o&&S(o);let s=g.elementColor;void 0!==s&&(0,h.qu)(String(s));let c=g.strokeColor;void 0!==c&&(0,h.JT)(String(c));let d=g.strokeWidth;void 0!==d&&(0,h.Jg)(Number(d));let u=g.fontFamily;void 0!==u&&(0,h.Yu)(String(u));let p=g.markerType;void 0!==p&&(0,h.li)(String(p));let f=g.connectionPathColor;void 0!==f&&(0,h.xN)(String(f));let E=g.connectionPathStroke;void 0!==E&&(0,h.K2)(Number(E));let m=g.canvasBackgroundColor;void 0!==m&&(0,h.QY)(String(m));let y=g.textColor;void 0!==y&&(0,h.vY)(String(y));let T=g.selectedStrokeColor;void 0!==T&&(0,h.LL)(String(T)),i()},color:"primary",disabled:Object.values(f).some(Boolean),children:"OK"})]})]})]})})})},tB=()=>(0,r.jsx)("div",{style:{width:"40px",height:"40px",borderRadius:"50%",background:"linear-gradient(135deg, #6370e0, #2f3eab)",display:"flex",justifyContent:"center",alignItems:"center",boxShadow:"inset 0 2px 4px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.2)"},children:(0,r.jsxs)("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[(0,r.jsx)("path",{d:"M12 5V13",stroke:"#ffffff",strokeWidth:"2",strokeLinecap:"round"}),(0,r.jsx)("circle",{cx:"12",cy:"17",r:"1",fill:"#ffffff"})]})}),tP=e=>{let{showCloseConfirm:t,setShowCloseConfirm:i,tabToClose:n,closeTab:l,dispatch:a,modalId:o,onOpen:s}=e;if(!t)return null;let c=eO((0,h.Es)());return(0,r.jsx)(tu,{isOpen:t,onClose:()=>i(!1),closeOnOverlayClick:!1,title:"確認",icon:(0,r.jsx)(tB,{}),dispatch:a,modalId:o,onOpen:s,children:(0,r.jsxs)("div",{style:{padding:"10px 5px 20px",textAlign:"left"},children:[(0,r.jsxs)("p",{style:{margin:"0 0 10px",fontSize:"15px",opacity:.8,lineHeight:1.5,maxWidth:"350px",marginTop:"10px"},children:["保存していない変更があります。",(0,r.jsx)("br",{}),"タブを閉じてよろしいですか？"]}),(0,r.jsxs)("div",{style:{display:"flex",justifyContent:"flex-end",gap:"16px",marginTop:"30px"},children:[(0,r.jsx)(eN.A,{variant:"outlined",onClick:()=>i(!1),sx:{borderRadius:"8px",padding:"8px 20px",fontSize:"14px",fontWeight:500,textTransform:"none",boxShadow:"none",transition:"all 0.2s ease",backgroundColor:c.MODAL.BUTTON_BACKGROUND,borderColor:c.MODAL.BUTTON_BORDER,color:c.MODAL.BUTTON_TEXT,"&:hover":{backgroundColor:c.MODAL.BUTTON_BACKGROUND,opacity:.9}},children:"いいえ"}),(0,r.jsx)(eN.A,{variant:"contained",onClick:()=>{n&&l(n),i(!1)},sx:{borderRadius:"8px",padding:"8px 20px",fontSize:"14px",fontWeight:500,textTransform:"none",boxShadow:"none",transition:"all 0.2s ease",backgroundColor:c.MODAL.BUTTON_PRIMARY_BACKGROUND,color:c.MODAL.BUTTON_PRIMARY_TEXT,"&:hover":{backgroundColor:c.MODAL.BUTTON_PRIMARY_BACKGROUND,opacity:.9}},children:"はい"})]})]})})},tH=()=>(0,r.jsx)("div",{style:{width:"40px",height:"40px",borderRadius:"50%",background:"linear-gradient(135deg, #A46365, #B1928A)",boxShadow:"inset 0 2px 4px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.2)",display:"flex",justifyContent:"center",alignItems:"center"},children:(0,r.jsx)(eE.A,{style:{color:"#ffffff"}})}),tX=[{title:"Keyboard shortcuts",items:["Tab: Add a child element to the selected element","Shift + Tab: Add a sibling element to the selected element","Delete/Backspace: Remove the selected element","Enter: Edit the selected element","Esc: Stop editing the selected element","Tab in editing mode: Move the focus to the next text box","Ctrl + Z: Undo the last action","Shift + Ctrl + Z: Redo the last action","Ctrl + X: Cut the selected element","Ctrl + C: Copy the selected element","Ctrl + V: Paste the copied element","Ctrl + ArrowLeft: Collapse the children of the selected element","Ctrl + ArrowRight: Expand the children of the selected element","Arrow keys: Navigate between elements"]},{title:"Mouse operations",items:["Click: Select an element","Double click: Edit the selected element","Clicking outside the element will end the editing mode","Drag: Move the selected element"]},{title:"Menu operations",items:["New: Create a new diagram. Unsaved changes will be discarded.","Open: Load saved data. The current data will be discarded.","Save as: Save the diagram data in JSON format","Export: Export the diagram in SVG format"]}],tG=e=>{let{isOpen:t,onClose:i,dispatch:n,modalId:l,onOpen:a}=e;return(0,r.jsx)(tu,{isOpen:t,onClose:i,title:"ヘルプ",icon:(0,r.jsx)(tH,{}),dispatch:n,modalId:l,onOpen:a,children:(0,r.jsx)("div",{className:"space-y-6",children:tX.map((e,t)=>(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("h4",{className:"text-lg font-semibold text-gray-800 dark:text-gray-200",children:e.title}),(0,r.jsx)("div",{className:"space-y-1",children:e.items.map((e,t)=>(0,r.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:e},t))})]},t))})})};var tU=i(7050),tW=i(5992),tF=i(5071),tK=i(8963),tY=i(4149),tz=i(831),tV=i(5512);let tZ=()=>{let e=(0,n.useRef)(0);(0,n.useEffect)(()=>{e.current+=1});let{tabs:t,currentTabId:i,currentTab:a,addTab:s,closeTab:c,switchTab:d,updateTabState:u,updateTabName:g,updateTabSaveStatus:p,dispatch:f,handleCloseTabRequest:x,updateTabNameFromRootElement:E}=(0,tV.A)(),[{isHelpOpen:m,isSettingsOpen:y,showCloseConfirm:T,tabToClose:D},{toggleHelp:b,toggleSettings:w,setShowCloseConfirm:I,setTabToClose:S}]=function(e){let[t,i]=(0,n.useState)(!1),[r,l]=(0,n.useState)(!1),[a,o]=(0,n.useState)(null),[s,c]=(0,n.useState)(!1),d=(0,n.useCallback)(()=>{e(),i(e=>!e)},[e]),h=(0,n.useCallback)(()=>{e(),l(e=>!e)},[e]);return[{isHelpOpen:t,isSettingsOpen:r,showCloseConfirm:s,tabToClose:a},{toggleHelp:d,toggleSettings:h,openCloseConfirm:(0,n.useCallback)(e=>{o(e),c(!0)},[]),closeConfirmModal:(0,n.useCallback)(()=>{c(!1),o(null)},[]),setShowCloseConfirm:c,setTabToClose:o}]}((0,n.useCallback)(()=>{f({type:"END_EDITING"}),E()},[f,E])),$=(0,n.useCallback)(e=>{let t=x(e);return t.needsConfirmation&&t.tabId&&(S(t.tabId),I(!0)),t},[x,S,I]),{handleAIClick:v,isLoading:A}=function(e){let{currentTab:t,dispatch:i}=e,{addToast:r}=(0,G.d)(),{isSuggestionEnabled:a}=(0,eT.I)(),[o,s]=(0,n.useState)(!1),[c,d]=(0,n.useState)({chatHistory:[],lastParentElementId:null,isActive:!1,isExecuting:!1,contextInitialized:!1,lastInputText:null}),u=(0,n.useCallback)(async e=>{if(o)throw Error("AI処理中です。しばらくお待ちください。");s(!0);try{if(!t)throw Error("タブが選択されていません。");let i=(0,tK.CG)();if(!i)throw Error("APIキーが設定されていません。設定から登録してください。");let r=t.state.hierarchicalData?(0,C.Je)(t.state.hierarchicalData):"階層構造データがありません",n=(0,tY.ie)({selectedElement:"",currentStructure:r,userInput:e}),a=(0,tY.CL)(),o=(0,tK.OA)();(0,O.c)(`[AI Chat] 複数操作API呼び出し開始`),(0,O.c)(`[AI Chat] 送信プロンプト: ${n.substring(0,200)}...`);let s=await (0,tF.pq)(n,i,o,!1,a);if((0,O.c)(`[AI Chat] API結果: ${s?.length}文字`),(0,O.c)(`[AI Chat] クリーンアップ後のレスポンス: ${s}`),!s||""===s.trim())throw Error("AIから有効な結果が得られませんでした。");let c=t.state.hierarchicalData?(0,l.Xd)(t.state.hierarchicalData):{};return await g(s,c)}catch(e){throw(0,O.c)(`[AI Chat] エラー: ${e instanceof Error?e.message:"不明なエラー"}`),e}finally{s(!1)}},[t,i,o]),g=async(e,i)=>{try{let r;(0,O.c)(`[AI Chat] 生のレスポンス: ${e}`);let n=e.trim(),a=n.match(/```json\s*([\s\S]*?)\s*```/);if(!a&&(a=n.match(/\{[\s\S]*\}/))&&(a[1]=a[0]),!a)return(0,O.c)(`[AI Chat] JSONフォーマットが見つからない、フォールバック処理実行`),await y(e,i);(0,O.c)(`[AI Chat] 抽出されたJSON: ${a[1]}`);try{r=JSON.parse(a[1])}catch(t){return(0,O.c)(`[AI Chat] JSONパースエラー: ${t}`),await y(e,i)}let o=r.operations;if(!o||0===o.length)throw(0,O.c)(`[AI Chat] 操作が見つからない`),Error("実行可能な操作が見つかりませんでした。");(0,O.c)(`[AI Chat] 実行する操作数: ${o.length}`);let s=[],c=t?.state.hierarchicalData?(0,l.WN)(t.state.hierarchicalData)[0]:null;for(let e=0;e<o.length;e++){let t=o[e];(0,O.c)(`[AI Chat] 操作 ${e+1}/${o.length}: ${t.type}`);let r=await p(t,i,c?.id||null);s.push(r),"SELECT_ELEMENT"===t.type&&(c=await m(t.targetText)),e<o.length-1&&await new Promise(e=>setTimeout(e,100))}return`${s.length}個の操作を実行しました！

${s.map((e,t)=>`${t+1}. ${e}`).join("\n")}`}catch(t){return(0,O.c)(`[AI Chat] 操作解析エラー: ${t}`),await y(e,i)}},p=async(e,t,i)=>{switch(e.type){case"ADD_ELEMENTS":return await f(e,i);case"SELECT_ELEMENT":return await x(e);case"UPDATE_TEXT":return await E(e,i);case"DELETE_ELEMENT":return await D(i);case"ADD_SIBLING_ELEMENT":return await b();case"COPY_ELEMENT":return await w();case"DROP_ELEMENT":return await I(e,i);case"ERROR":throw Error(String(e.message)||"操作エラーが発生しました");default:return`未対応の操作: ${e.type}`}},f=async(e,r)=>{let n=e.targetId;if("root"===n&&t?.state.hierarchicalData){let e=Object.keys((0,l.Xd)(t.state.hierarchicalData));e.length>0&&(n=e[0])}if(!n&&r&&(n=r),!n)throw Error("追加先の要素が特定できませんでした。要素を選択してから操作してください。");let a=e.elements||[];if(0===a.length)throw Error("追加する要素が指定されていません。");return(0,O.c)(`[AI Chat] 要素追加: ${n} に ${a.join(", ")}`),i({type:"ADD_ELEMENTS_SILENT",payload:{targetNodeId:n,targetPosition:"child",texts:a,tentative:!0,onError:e=>{throw Error(e)}}}),`${a.length}個の要素を追加: ${a.join(", ")}`},x=async e=>{let t=e.targetText;if(!t)throw Error("選択する要素のテキストが指定されていません。");let r=await m(t);if(!r)throw Error(`要素「${t}」が見つかりませんでした。`);return i({type:"SELECT_ELEMENT",payload:r.id}),`要素「${t}」を選択しました`},E=async(e,t)=>{let r=e.targetId||t,n=e.newText;if(!r)throw Error("更新する要素が特定できませんでした。");if(!n)throw Error("新しいテキストが指定されていません。");return i({type:"UPDATE_TEXT",payload:{id:r,index:0,value:n}}),`要素のテキストを「${n}」に更新しました`},m=async e=>{if(!t?.state.hierarchicalData)return null;let i=t=>{for(let r of Array.isArray(t)?t:Object.values(t)){if(r.texts&&r.texts.some(t=>t.includes(e)))return r;if(r.children){let e=i(r.children);if(e)return e}}return null};return i(t.state.hierarchicalData)},y=async(e,r)=>{let n=(t?.state.hierarchicalData?(0,l.WN)(t.state.hierarchicalData):[])[0];if(!n)throw Error("要素が選択されていません。要素を選択してからAIアシスタントを使用してください。");let a=n.id,o=e.replace(/^\s*[\n\r]+|[\n\r]+\s*$/g,"").trim(),s=[],c=o.match(/```[\s\S]*?```/g);if(0===(s=c&&c.length>0?c.flatMap(e=>e.replace(/```.*\n?|```/g,"").split("\n").map(e=>e.trim()).filter(e=>e.length>0&&"```"!==e)):o.split("\n").map(e=>e.trim()).filter(e=>e.length>0&&"```"!==e)).length)throw Error("AIから有効な要素が生成されませんでした。");return i({type:"ADD_ELEMENTS_SILENT",payload:{targetNodeId:a,targetPosition:"child",texts:s,tentative:!0,onError:e=>{throw(0,O.c)(`[AI Chat] リデューサーエラー: ${e}`),Error(e)}}}),(0,O.c)(`[AI Chat] 生成完了: ${s.length}個の要素を追加`),`${s.length}個の要素を追加しました！
追加された要素:
${s.map((e,t)=>`${t+1}. ${e}`).join("\n")}`},T=(0,n.useCallback)(async()=>{if(!o){s(!0);try{if(!t)return;let e=(t.state.hierarchicalData?(0,l.WN)(t.state.hierarchicalData):[])[0];if(!e){r(X.noSelect);return}let n=e.id,a=(0,tK.CG)();if(!a){r(X.noApiKey,"warn");return}let o=(0,tK.XH)();if(!o){r(X.noPrompt);return}await L(o);let s=t.state.hierarchicalData?(0,C.Je)(t.state.hierarchicalData):"階層構造データがありません",d=(0,h.k0)();(0,O.c)(`[AI] systemPrompt: ${d}`),(0,O.c)(`[AI] structureText: ${s}`);let u=c.contextInitialized?`以下の仕様書に基づいて、選択された要素「${e.texts?.join(", ")||""}」の子要素を生成してください。

[Current Structure]
\`\`\`
${s}
\`\`\`

**要求事項：**
1. 事前に送信した仕様書の内容に従って、選択された要素の子要素を生成してください
2. 仕様書で定義されている機能や項目を階層化する際の、論理的な子要素を生成してください
3. 仕様書の構造や分類に従って、適切な粒度で要素を提案してください
4. 各要素は1行ずつ出力してください

提案する要素は、仕様書の内容を反映した具体的で意味のあるものにしてください。`:`以下の仕様書に基づいて、選択された要素「${e.texts?.join(", ")||""}」の子要素を生成してください。

[Current Structure]
\`\`\`
${s}
\`\`\`

【重要】以下の仕様書に従って階層構造を作成することが目的です：
\`\`\`
${o}
\`\`\`

**要求事項：**
1. 仕様書の内容に基づいて、選択された要素の子要素を生成してください
2. 仕様書で定義されている機能や項目を階層化する際の、論理的な子要素を生成してください
3. 仕様書の構造や分類に従って、適切な粒度で要素を提案してください
4. 各要素は1行ずつ出力してください

提案する要素は、仕様書の内容を反映した具体的で意味のあるものにしてください。`;(0,O.c)(`[AI] userPrompt: ${u.substring(0,200)}...`),(0,O.c)(`[AI] コンテキスト初期化済み: ${c.contextInitialized}`);let g=(0,tK.OA)(),p=c.contextInitialized&&c.chatHistory.length>0?await (0,tF.l8)(u,a,g,c.chatHistory,d,!0,!0).then(e=>e.response):await (0,tF.pq)(u,a,g,!0,d);(0,O.c)(`[AI] Geminiレスポンス: ${p?.substring(0,200)}...`);let f=[],x=p.replace(/^```/g,"").replace(/```$/g,""),E=x.match(/```[\s\S]*?```/g);if(f=E&&E.length>0?E.flatMap(e=>e.replace(/```.*\n?|```/g,"").split("\n").map(e=>e.trim()).filter(e=>e.length>0&&"```"!==e)):x.split("\n").map(e=>e.trim()).filter(e=>e.length>0&&"```"!==e),0===f.length){r(X.aiNoResults,"info");return}i({type:"ADD_ELEMENTS_SILENT",payload:{targetNodeId:n,targetPosition:"child",texts:f,tentative:!0,onError:e=>{(0,O.c)(`[AI] リデューサーエラー: ${e}`),r(e,"warn")}}}),(0,O.c)(`[AI] 生成完了: ${f.length}個の要素を追加`)}catch(e){(0,O.c)(`[AI] 予期しないエラー: ${e instanceof Error?e.message:"不明なエラー"}`),r(e instanceof Error?`予期しないエラーが発生しました: ${e.message}`:"予期しないエラーが発生しました","error")}finally{s(!1)}}},[t,i,r,o,c]),D=async e=>{if(!e)throw Error("削除する要素が選択されていません。");return i({type:"DELETE_ELEMENT"}),`要素を削除しました`},b=async()=>(i({type:"ADD_SIBLING_ELEMENT"}),"新しい兄弟要素を追加しました"),w=async()=>(i({type:"COPY_ELEMENT"}),"選択された要素をコピーしました"),I=async(e,t)=>{let r=e.targetNodeId,n=e.targetIndex,l=e.description||"指定された位置";if(!t)throw Error("移動する要素が選択されていません。");return i({type:"DROP_ELEMENT",payload:{id:t,targetNodeId:r,targetIndex:n,direction:e.direction||"none"}}),`要素を${l}に移動しました`},S=(0,n.useCallback)(async function(e){let i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if((0,O.c)(`[Suggestion] handleSiblingNodeSuggestion開始: parentElementId=${e}, fromEndEditing=${i}`),(0,O.c)(`[Suggestion] 現在の状態 - isLoading: ${o}, isExecuting: ${c.isExecuting}`),i&&c.isExecuting){(0,O.c)("[Suggestion] END_EDITINGからの呼び出しのため、フラグをリセットして実行"),d(e=>({...e,isExecuting:!1})),setTimeout(()=>{S(e,!1)},50);return}if(o||c.isExecuting){(0,O.c)("[Suggestion] 既にロード中またはサジェスト実行中のため、サジェストをスキップ");return}s(!0),d(e=>({...e,isExecuting:!0}));try{let i,r;if(!t)return;let n=(0,tK.CG)();if(!n){(0,O.c)("[Suggestion] APIキーが設定されていません");return}let a=c.lastParentElementId!==e;a&&((0,O.c)("[Suggestion] 親要素が変更されたためコンテキストをクリア"),d(t=>({...t,chatHistory:[],lastParentElementId:e,isActive:!0,isExecuting:!0})));let o=t.state.hierarchicalData?(0,C.Je)(t.state.hierarchicalData):"階層構造データがありません",s=(0,l.WN)(t.state.hierarchicalData)[0],h=v(e),u=h?`親要素: ${h.texts?.join(", ")||"テキストなし"}`:"親要素情報が見つかりません",g=s?`現在選択されている要素: ${s.texts?.join(", ")||"テキストなし"} (ID: ${s.id})`:"選択されている要素がありません",p=(0,tK.XH)();await L(p);let f=`以下の仕様書の情報に基づいて、現在選択されている要素に関連する適切な兄弟要素を提案してください。

【重要】以下の仕様書に従って階層構造を作成することが目的です：
${c.contextInitialized?"（仕様書の詳細は事前に送信済みです。その情報を基に判断してください）":p?`
仕様書:
\`\`\`
${p}
\`\`\`
`:""}

${g}
${u}

[現在の階層構造]
\`\`\`
${o}
\`\`\`

**要求事項：**
1. 仕様書の内容に基づいて、選択された要素「${s?.texts?.join(", ")||""}」に関連する兄弟要素を提案してください
2. 仕様書で定義されている機能や項目を階層化する際の、論理的に並ぶべき要素を生成してください
3. 既存の要素と重複しないよう注意してください
4. 仕様書の構造や分類に従って、適切な粒度で要素を提案してください

提案する要素は、仕様書の内容を反映した具体的で意味のあるものにしてください。`;(0,O.c)(`[Suggestion] プロンプト生成完了: コンテキスト初期化済み=${c.contextInitialized}`),(0,O.c)(`[Suggestion] 選択要素: ${g}`),(0,O.c)(`[Suggestion] 仕様書長: ${p?.length||0}文字`);let x=(0,tK.OA)();if(c.contextInitialized&&c.chatHistory.length>0){(0,O.c)("[Suggestion] 初期化済みコンテキストを使用してAPI呼び出し");let e=await (0,tF.l8)(f,n,x,c.chatHistory,tz.Ie,!1);i=e.response,r=e.updatedHistory}else if(a||0===c.chatHistory.length){(0,O.c)("[Suggestion] 初回API呼び出し（コンテキスト未初期化）");let e=await (0,tF.l8)(f,n,x,[],tz.Ie,!1);i=e.response,r=e.updatedHistory}else{(0,O.c)("[Suggestion] スレッド継続API呼び出し");let e=await (0,tF.l8)(f,n,x,c.chatHistory,tz.Ie,!1);i=e.response,r=e.updatedHistory}d(t=>({...t,chatHistory:r,lastParentElementId:e,isActive:!0,isExecuting:!0}));let E=A(i);if(E.length>0){(0,O.c)(`[Suggestion] ${E.length}個の提案を生成: ${E.join(", ")}`);let e=(0,l.WN)(t.state.hierarchicalData)[0];e?await R(e.id,E):(0,O.c)("[Suggestion] 選択された要素がないため、サジェストをスキップ")}else(0,O.c)("[Suggestion] 有効な提案が生成されませんでした")}catch(e){(0,O.c)(`[Suggestion] エラー: ${e instanceof Error?e.message:"不明なエラー"}`)}finally{s(!1),setTimeout(()=>{d(e=>({...e,isExecuting:!1})),(0,O.c)("[Suggestion] 実行フラグをクリアしました")},500)}},[t,i,o,c]),$=(0,n.useCallback)(()=>{d({chatHistory:[],lastParentElementId:null,isActive:!1,isExecuting:!1,contextInitialized:!1,lastInputText:null}),(0,O.c)("[Suggestion] コンテキストをクリアしました")},[]),v=(0,n.useCallback)(e=>t?.state.hierarchicalData&&(0,l.Xd)(t.state.hierarchicalData)[e]||null,[t]),A=e=>{try{let t=e.match(/```[\s\S]*?```/);if(t)return t[0].replace(/```.*\n?|```/g,"").trim().split("\n").map(e=>e.trim()).filter(e=>e.length>0&&!e.startsWith("//")&&!e.startsWith("#")).slice(0,3);return e.split("\n").map(e=>e.trim()).filter(e=>e.length>0&&!e.startsWith("//")&&!e.startsWith("#")).slice(0,3)}catch(e){return(0,O.c)(`[Suggestion] レスポンス解析エラー: ${e}`),[]}},k=(0,n.useCallback)((e,t)=>{if(!t)return!1;let i=t=>{if(!t)return!1;for(let r of Array.isArray(t)?t:Object.values(t)){if((r.data||r).id===e)return!!(r.children&&Array.isArray(r.children)&&r.children.length>0);if(r.children&&Array.isArray(r.children)){let e=i(r.children);if(!1!==e)return e}}return!1};return i(t)},[]),N=(0,n.useCallback)((e,i)=>{(0,O.c)(`[EndEditingSuggestion] 親要素検索開始: elementId=${e}`),(0,O.c)(`[EndEditingSuggestion] elementsMapのキー数: ${Object.keys(i).length}`);let r=(t,i)=>{if(!t)return null;for(let i of Array.isArray(t)?t:Object.values(t)){let t=i.data||i;if((0,O.c)(`[EndEditingSuggestion] 要素チェック: id=${t.id}, 子要素数=${i.children?.length||0}`),i.children&&Array.isArray(i.children)){for(let r of i.children){let i=r.data||r;if((0,O.c)(`[EndEditingSuggestion] 子要素チェック: childId=${i.id}, 検索対象=${e}`),i.id===e)return(0,O.c)(`[EndEditingSuggestion] 親要素を発見: parentId=${t.id}`),t}let n=r(i.children,t);if(n)return n}}return null};if(t?.state.hierarchicalData){let e=r(t.state.hierarchicalData);return(0,O.c)(`[EndEditingSuggestion] 階層構造検索結果: ${e?e.id:"なし"}`),e}return(0,O.c)("[EndEditingSuggestion] elementsMapからの検索はスキップ（階層構造が優先）"),(0,O.c)("[EndEditingSuggestion] 親要素が見つかりませんでした"),null},[t]),R=(0,n.useCallback)(async(e,r)=>{t?.state.hierarchicalData&&((0,O.c)(`[Suggestion] 兄弟要素として追加開始: 選択要素=${e}`),i({type:"ADD_SIBLING_ELEMENTS_SILENT",payload:{targetNodeId:e,position:"after",texts:r,tentative:!0,onError:t=>{(0,O.c)(`[Suggestion] 兄弟要素追加エラー: ${t}`),(0,O.c)("[Suggestion] フォールバック: 子要素として追加"),i({type:"ADD_ELEMENTS_SILENT",payload:{targetNodeId:e,targetPosition:"child",texts:r,tentative:!0,onError:e=>{(0,O.c)(`[Suggestion] フォールバック追加エラー: ${e}`)}}})},onSuccess:e=>{(0,O.c)(`[Suggestion] 兄弟要素追加成功: ${e.join(", ")}`)}}}))},[t,i]),j=(0,n.useRef)(null),_=(0,n.useCallback)(async e=>{if((0,O.c)("[Context] コンテキスト初期化を開始します"),!t?.state.hierarchicalData){(0,O.c)("[Context] hierarchicalDataが存在しません");return}try{let t=(0,tK.CG)();if(!t){(0,O.c)("[Context] APIキーが設定されていません");return}let i=M(e,8e3);(0,O.c)(`[Context] inputTextを${i.length}個のチャンクに分割しました`),(0,O.c)(`[Context] 元のテキスト長: ${e.length}文字`);let r=[];for(let e=0;e<i.length;e++){let n=i[e],l=0===e,a=e===i.length-1;(0,O.c)(`[Context] チャンク ${e+1}/${i.length}: 長さ=${n.length}文字`),(0,O.c)(`[Context] チャンク ${e+1} の先頭50文字: "${n.substring(0,50)}..."`);let o=l?`以下の仕様書を今後のサジェスト生成の基準として記憶してください。${i.length>1?`(${e+1}/${i.length}部分)`:""}

【重要】これは仕様書です。この仕様書に基づいて階層構造を作成することが目的です：
\`\`\`
${n}
\`\`\`

${a?"この仕様書を基に、今後要素の編集完了時に仕様に沿った適切なサジェストを生成してください。仕様書で定義されている機能や項目を階層化するための提案をしてください。":"続きの仕様書を次に送信します。"}`:`仕様書の続き(${e+1}/${i.length}部分):

\`\`\`
${n}
\`\`\`

${a?"これで仕様書の送信は完了です。この仕様書を基に、今後要素の編集完了時に仕様に沿った適切なサジェストを生成してください。仕様書で定義されている機能や項目を階層化するための提案をしてください。":"続きの仕様書を次に送信します。"}`;(0,O.c)(`[Context] チャンク ${e+1}/${i.length} を送信中`),(0,O.c)(`[Context] 送信するプロンプトの先頭200文字: "${o.substring(0,200)}..."`),(0,O.c)(`[Context] プロンプト全体の長さ: ${o.length}文字`),r=(await (0,tF.l8)(o,t,(0,tK.OA)(),r,void 0,!1,!1)).updatedHistory,(0,O.c)(`[Context] チャンク ${e+1}/${i.length} の送信完了`)}d(t=>({...t,chatHistory:r,contextInitialized:!0,lastInputText:e})),(0,O.c)("[Context] コンテキスト初期化が完了しました")}catch(e){(0,O.c)(`[Context] コンテキスト初期化エラー: ${e instanceof Error?e.message:"不明なエラー"}`)}},[t]),L=(0,n.useCallback)(async e=>{c.contextInitialized&&c.lastInputText===e?(0,O.c)("[Context] コンテキストは既に初期化済みです"):e&&e.trim().length>0&&((0,O.c)("[Context] 共通コンテキスト初期化を開始します"),await _(e))},[c.contextInitialized,c.lastInputText,_]),M=(0,n.useCallback)((e,t)=>{let i=[];(0,O.c)(`[splitTextIntoChunks] 分割開始: テキスト長=${e.length}, チャンクサイズ=${t}`);for(let r=0;r<e.length;r+=t){let n=e.slice(r,r+t);i.push(n),(0,O.c)(`[splitTextIntoChunks] チャンク${i.length}: 開始位置=${r}, 長さ=${n.length}, 先頭20文字="${n.substring(0,20)}..."`)}return(0,O.c)(`[splitTextIntoChunks] 分割完了: ${i.length}個のチャンクを生成`),i},[]),B=(0,n.useCallback)(async()=>{if((0,O.c)("[EndEditingSuggestion] handleEndEditingSuggestion関数が呼び出されました"),!a){(0,O.c)("[EndEditingSuggestion] サジェスト機能が無効のため、スキップします");return}j.current&&(clearTimeout(j.current),(0,O.c)("[EndEditingSuggestion] 既存のタイマーをクリアしました")),j.current=setTimeout(async()=>{if((0,O.c)("[EndEditingSuggestion] デバウンス後の実際の処理を開始します"),(0,O.c)(`[EndEditingSuggestion] 現在のisExecutingフラグ: ${c.isExecuting}`),c.isExecuting){(0,O.c)("[EndEditingSuggestion] フラグが残っているため、強制的にリセットします"),d(e=>({...e,isExecuting:!1})),setTimeout(async()=>{(0,O.c)("[EndEditingSuggestion] フラグリセット後、処理を再開します"),await e()},100);return}async function e(){if(!t?.state.hierarchicalData){(0,O.c)("[EndEditingSuggestion] hierarchicalDataが存在しません");return}try{(0,O.c)("[EndEditingSuggestion] サジェスト処理を開始します（フラグ設定なし）");let e=(0,l.WN)(t.state.hierarchicalData);if((0,O.c)(`[EndEditingSuggestion] 選択された要素数: ${e.length}`),0===e.length){(0,O.c)("[EndEditingSuggestion] 選択された要素がありません");return}let i=e[0];(0,O.c)(`[EndEditingSuggestion] 選択された要素: ${i.id}, テキスト: ${i.texts?.join(", ")}`),(0,O.c)("[EndEditingSuggestion] 現在の階層構造:",t.state.hierarchicalData);let r=(0,l.Xd)(t.state.hierarchicalData);(0,O.c)(`[EndEditingSuggestion] elementsMapの内容:`,Object.keys(r).map(e=>({id:e,texts:r[e].texts})));let n=k(i.id,t.state.hierarchicalData);if((0,O.c)(`[EndEditingSuggestion] 選択された要素に子要素があるか: ${n}`),n)(0,O.c)(`[EndEditingSuggestion] END_EDITING後のサジェスト開始: 親要素ID=${i.id}`),setTimeout(()=>{S(i.id)},300);else{let e=N(i.id,r);(0,O.c)(`[EndEditingSuggestion] 親要素検索結果: ${e?e.id:"なし"}`),e?((0,O.c)(`[EndEditingSuggestion] END_EDITING後のサジェスト開始: 親要素ID=${e.id} (兄弟要素として追加)`),S(e.id,!0)):((0,O.c)(`[EndEditingSuggestion] 親要素が見つからないため、選択された要素に子要素を追加: ${i.id}`),S(i.id,!0))}}catch(e){(0,O.c)(`[EndEditingSuggestion] エラー: ${e instanceof Error?e.message:"不明なエラー"}`),d(e=>({...e,isExecuting:!1}))}}await e()},500)},[t,S,k,N,c,a]);return(0,n.useEffect)(()=>(window.__handleEndEditingSuggestion=B,()=>{delete window.__handleEndEditingSuggestion,j.current&&clearTimeout(j.current)}),[B]),{handleAIClick:T,handleAIClickForChat:u,handleSiblingNodeSuggestion:S,clearSuggestionContext:$,handleEndEditingSuggestion:B,isLoading:o,suggestionState:c}}({currentTab:a,dispatch:f}),{handleSaveSvg:k,handleSaveElements:N,handleLoadElements:R}=function(e){let{currentTab:t,addTab:i,updateTabState:r,updateTabName:a,switchTab:o,updateTabSaveStatus:s}=e,{addToast:c}=(0,G.d)(),d=(0,n.useCallback)(async()=>{try{let e=document.querySelector(".svg-element");if(!e){c("SVG要素が見つかりませんでした");return}(0,ek.oL)()?await tW.b.saveSvg(e,"download.svg"):(0,tU.Sz)(e,"download.svg")}catch(e){console.error("[handleSaveSvg] Error during SVG save:",e),c(e instanceof Error?e.message:"SVGの保存中にエラーが発生しました")}},[c]),h=(0,n.useCallback)(async()=>{if(t)try{let e=t.state.hierarchicalData?(0,l.Xd)(t.state.hierarchicalData):{},i=Object.values(e),r=t.name;if((0,ek.oL)()){if(tc.getCurrentFileName){let e=await tc.getCurrentFileName();e&&(r=e.replace(/\.json$/,""))}await tW.b.saveElements(i,r)}else(0,tU.$r)(i,r);if(t.id){let e=t.state.hierarchicalData?(0,l.Xd)(t.state.hierarchicalData):{},i=JSON.parse(JSON.stringify(e)),r=JSON.stringify(i);s(t.id,!0,r)}}catch(e){console.error("[handleSaveElements] Error during file save:",e),c(e instanceof Error?e.message:"ファイルの保存中にエラーが発生しました")}},[t,s,c]);return{handleSaveSvg:d,handleSaveElements:h,handleLoadElements:(0,n.useCallback)(async e=>{try{let t;if((0,ek.oL)())t=await tW.b.loadElements();else{if(!e)throw Error("ブラウザ環境ではイベントが必要です");t=await (0,tU.wl)(e.nativeEvent)}let n=i(),l=t.hierarchicalData;r(n,e=>({...e,hierarchicalData:l||null}));let c=t.fileName.replace(".json","");(0,ek.oL)()&&(c=t.fileName),a(n,c);let d=JSON.stringify(l);s(n,!0,d),o(n)}catch(e){console.error("[handleLoadElements] Error during file load:",e),c(e instanceof Error?e.message:"ファイルの読み込み中にエラーが発生しました")}},[i,r,a,o,s,c])}}({currentTab:a,addTab:s,updateTabState:u,updateTabName:g,switchTab:d,updateTabSaveStatus:p}),j=(0,n.useMemo)(()=>a?(0,r.jsxs)(o,{state:a.state,dispatch:f,children:[(0,r.jsx)(ei,{isHelpOpen:m,toggleHelp:b}),(0,r.jsx)(th,{tabs:t,currentTabId:i,addTab:s,closeTab:$,switchTab:d}),(0,r.jsx)(eL,{saveSvg:k,loadElements:R,saveElements:N,toggleHelp:b,toggleSettings:w,onAIClick:v,isAILoading:A})]}):null,[a,f,b,m,i,w,v,R,N,s,$,d,t,k,A]);return(0,r.jsxs)("div",{children:[j,(0,r.jsx)(tP,{showCloseConfirm:T,setShowCloseConfirm:I,tabToClose:D,closeTab:c,dispatch:f,modalId:"confirm-modal",onOpen:()=>f({type:"END_EDITING"})}),(0,r.jsx)(tM,{isOpen:y,onClose:w,dispatch:f,modalId:"settings-modal",onOpen:()=>f({type:"END_EDITING"})}),(0,r.jsx)(tG,{isOpen:m,onClose:b,dispatch:f,modalId:"help-modal",onOpen:()=>f({type:"END_EDITING"})})]})}}},e=>{var t=t=>e(e.s=t);e.O(0,[659,733,167,441,684,358],()=>t(4224)),_N_E=e.O()}]);
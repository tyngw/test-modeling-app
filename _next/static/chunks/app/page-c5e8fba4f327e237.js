(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{1469:(e,t,l)=>{Promise.resolve().then(l.bind(l,7048))},7048:(e,t,l)=>{"use strict";l.d(t,{default:()=>eD});var r=l(5155);let i={dropChildElement:"子要素にドロップすることはできません",noSelect:"要素を選択してから実行してください",dragError:"ドラッグ操作中にエラーが発生しました",aiError:"AI処理に失敗しました",noApiKey:"APIキーが設定されていません",noPrompt:"入力情報(プロンプト)が設定されていません",clipboardEmpty:"クリップボードにテキストがありません",clipboardReadError:"クリップボードの読み取りに失敗しました"};var n=l(2115);let o=(0,n.createContext)(void 0),a=e=>{let{children:t,state:l,dispatch:i}=e,a=(0,n.useMemo)(()=>({state:l,dispatch:i}),[l,i]);return(0,r.jsx)(o.Provider,{value:a,children:t})},s=()=>{let e=(0,n.useContext)(o);if(!e)throw Error("useCanvas must be used within a CanvasProvider");return e};var d=l(6924),c=l(3346),h=l(8265),u=l(2226);let p=(0,n.memo)(e=>{let{x:t,y:l,width:i,height:o,text:a,zoomRatio:s,fontFamily:p,onHeightChange:x}=e,[E,m]=(0,n.useState)({width:0,height:0}),[f,T]=(0,n.useState)(!1),[A,g]=(0,n.useState)(d._K),C=(0,n.useRef)(null),O=(0,n.useRef)({width:0,height:0}),y=(0,n.useRef)(a);return((0,n.useRef)(x).current=x,(0,n.useEffect)(()=>{g((0,u.vG)())},[]),(0,n.useEffect)(()=>{let e;return T(!0),f&&(a!==y.current||i!==O.current.width||o!==O.current.height)&&(e=requestAnimationFrame(()=>{if(!C.current)return;let e=Math.min(d.SK.WIDTH.MAX,i);(0,h.c)(`[updateDimensions] text: ${a}  size: ${e} x ${o}`);let t=(0,c.C1)(a||"",e,s),l=d.gI*d.RZ*s,r=Math.max(d.SK.SECTION_HEIGHT*s,(l+d.rF.VERTICAL)*s),n=Math.max(t.length*l,r)+d.rF.VERTICAL*s,u=Math.abs(e-O.current.width)>1,p=Math.abs(n-O.current.height)>1;(u||p)&&(m({width:e,height:n}),O.current={width:e,height:n})}),y.current=a),()=>{e&&cancelAnimationFrame(e)}},[a,i,o,s,f]),f)?(0,r.jsx)("foreignObject",{x:t,y:l,width:E.width,height:Math.round(E.height/s),pointerEvents:"none",children:(0,r.jsx)("div",{ref:C,style:{fontFamily:p||d.zs,color:A,fontSize:`${d.gI}px`,lineHeight:d.RZ,width:`${E.width-d.rF.HORIZONTAL}px`,minHeight:`${d.SK.SECTION_HEIGHT}px`,padding:`${.5*d.rF.VERTICAL}px ${.5*d.rF.HORIZONTAL}px`,overflow:"hidden",whiteSpace:"pre-wrap",wordBreak:"break-word",boxSizing:"content-box"},children:a})}):null});var x=l(6670),E=l(840),m=l(9605),f=l(978),T=l(1386);let A=()=>{let[e,t]=(0,n.useState)(!1);return(0,n.useEffect)(()=>{t(!0)},[]),e},g=(e,t,l)=>((e,t)=>{if(!e.tentative)return!1;let l=Math.min(...t.filter(t=>t.parentId===e.parentId&&t.tentative).map(e=>e.order));return e.order===l})(e,l)?(0,r.jsxs)("g",{transform:`translate(${e.x+1.1*e.width},${e.y})`,onClick:e=>e.stopPropagation(),style:{cursor:"pointer",pointerEvents:"all"},children:[(0,r.jsxs)("g",{children:[(0,r.jsx)("rect",{x:"0",y:"0",width:"24",height:"24",rx:"4",fill:"white",stroke:"#e0e0e0",strokeWidth:"1"}),(0,r.jsx)("foreignObject",{x:"4",y:"4",width:"16",height:"16",children:(0,r.jsx)(E.A,{sx:{color:"#4CAF50","&:hover":{color:"#388E3C"},transition:"color 0.2s ease-in-out"},style:{width:"100%",height:"100%"},onClick:()=>t({type:"CONFIRM_TENTATIVE_ELEMENTS",payload:e.parentId})})})]}),(0,r.jsxs)("g",{transform:"translate(30, 0)",children:[(0,r.jsx)("rect",{x:"0",y:"0",width:"24",height:"24",rx:"4",fill:"white",stroke:"#e0e0e0",strokeWidth:"1"}),(0,r.jsx)("foreignObject",{x:"4",y:"4",width:"16",height:"16",children:(0,r.jsx)(m.A,{sx:{color:"#F44336","&:hover":{color:"#D32F2F"},transition:"color 0.2s ease-in-out"},style:{width:"100%",height:"100%"},onClick:()=>t({type:"CANCEL_TENTATIVE_ELEMENTS",payload:e.parentId})})})]})]}):null,C=e=>{let{element:t,isHovered:l}=e;return h.y&&l?(0,r.jsx)("foreignObject",{x:t.x+t.width+10,y:t.y-10,width:"340",height:"200",className:"debug-info",children:(0,r.jsxs)("div",{style:{fontSize:"12px",color:"black",backgroundColor:"white",border:"1px solid black",padding:"5px",borderRadius:"5px",boxShadow:"0 2px 10px rgba(0, 0, 0, 0.2)"},children:[(0,r.jsxs)("div",{children:["id: ",t.id]}),(0,r.jsxs)("div",{children:["parentID: ",t.parentId]}),(0,r.jsxs)("div",{children:["order: ",t.order]}),(0,r.jsxs)("div",{children:["depth: ",t.depth]}),(0,r.jsxs)("div",{children:["children: ",t.children]}),(0,r.jsxs)("div",{children:["arrow: ",t.connectionPathType]}),(0,r.jsxs)("div",{children:["editing: ",t.editing?"true":"false"]}),(0,r.jsxs)("div",{children:["selected: ",t.selected?"true":"false"]}),(0,r.jsxs)("div",{children:["visible: ",t.visible?"true":"false"]}),(0,r.jsxs)("div",{children:["x: ",t.x]}),(0,r.jsxs)("div",{children:["y: ",t.y]}),(0,r.jsxs)("div",{children:["width: ",t.width]}),(0,r.jsxs)("div",{children:["height: ",t.width]})]})}):null},O=n.memo(e=>{let{element:t,currentDropTarget:l,dropPosition:i,draggingElement:o,handleMouseDown:a,onHoverChange:E}=e,{state:m,dispatch:C}=s(),{getCurrentTabState:O,getCurrentTabNumberOfSections:y}=(0,T.u)(),v=O()||{elements:{},zoomRatio:1};y();let R=A(),b=l?.id||-1,[I,k]=(0,n.useState)(!1),S=(0,n.useRef)(!1),[N,_]=(0,n.useState)(d.iC.NORMAL.COLOR),[w,D]=(0,n.useState)(d.iC.NORMAL.STROKE_COLOR),[j,L]=(0,n.useState)(d.iC.STROKE_WIDTH),[M,B]=(0,n.useState)("");(0,n.useEffect)(()=>{R&&(_((0,u.kN)()),D((0,u._1)()),L((0,u.xo)()),B((0,u.af)()))},[R]),(0,n.useEffect)(()=>{if(t.editing||!R)return;let{newWidth:e,newHeight:l,sectionHeights:r}=(()=>{let e=(0,c.PC)(t.texts,d.rF.HORIZONTAL),l=t.texts.map(t=>{let l=(0,c.C1)(t||"",e,v.zoomRatio).length;return Math.max(d.SK.SECTION_HEIGHT*v.zoomRatio,l*d.gI*d.RZ+d.rF.VERTICAL*v.zoomRatio)});return{newWidth:e,newHeight:l.reduce((e,t)=>e+t,0),sectionHeights:l}})();t.editing||e===t.width&&l===t.height||C({type:"UPDATE_ELEMENT_SIZE",payload:{id:t.id,width:e,height:l,sectionHeights:r}})},[t.editing,t.texts,t.width,t.height,C,t.id,v.zoomRatio]);let H=(0,n.useMemo)(()=>Object.values(v.elements).filter(e=>e.parentId===t.id&&!e.visible),[v.elements,t.id]),U=!!o&&(o.id===t.id||(0,f.K9)(v.elements,o.id,t.id)),G=(0,n.useCallback)((e,l)=>{let r=t.sectionHeights[e];if(null!==r&&Math.abs(l-r)>1){let r=[...t.sectionHeights];r[e]=l;let i=(0,c.PC)(t.texts,d.rF.HORIZONTAL),n=r.reduce((e,t)=>e+t,0);(0,h.c)(`[IdeaElement][handleHeightChange] resized: ${t.texts} ${t.width} x ${t.height} -> ${i} x ${n}`),C({type:"UPDATE_ELEMENT_SIZE",payload:{id:t.id,width:i,height:n,sectionHeights:r}})}},[C,t]),W=(0,n.useCallback)(()=>{k(!0),E&&!S.current&&(E(t.id,!0),S.current=!0)},[t.id,E]),K=(0,n.useCallback)(()=>{k(!1),E&&S.current&&(E(t.id,!1),S.current=!1)},[t.id,E]);return((0,n.useEffect)(()=>()=>{E&&S.current&&E(t.id,!1)},[t.id,E]),R)?(0,r.jsx)(n.Fragment,{children:(0,r.jsxs)("g",{opacity:U?.3:1,children:[g(t,C,Object.values(v.elements)),H.length>0&&(0,r.jsxs)(r.Fragment,{children:[t.texts.length>1?(0,r.jsx)("rect",{x:t.x+d.N,y:t.y+d.N,width:t.width,height:t.height,rx:d.iC.RX,fill:"none",stroke:d.iC.SHADDOW.COLOR,strokeWidth:j},`shadow-${t.id}`):(0,r.jsx)("line",{x1:t.x+d.N,y1:t.y+t.height+d.N,x2:t.x+t.width+d.N,y2:t.y+t.height+d.N,stroke:d.iC.SHADDOW.COLOR,strokeWidth:j},`shadow-line-${t.id}`),(0,r.jsxs)("g",{transform:`translate(${t.x+1.1*t.width},${t.y})`,onClick:e=>{e.stopPropagation(),C({type:"SELECT_ELEMENT",payload:{id:t.id,ctrlKey:!1,shiftKey:!1}}),C({type:"EXPAND_ELEMENT"})},style:{cursor:"pointer"},children:[(0,r.jsx)("rect",{x:"0",y:"0",width:"24",height:"24",rx:"4",fill:"white",stroke:"#e0e0e0",strokeWidth:"1"}),(0,r.jsx)("svg",{x:"4",y:"4",width:"16",height:"16",viewBox:"0 0 24 24",children:(0,r.jsx)(x.A,{sx:{color:"#666666"},style:{width:"100%",height:"100%"}})})]})]}),(0,r.jsx)("defs",{children:(0,r.jsx)("filter",{id:"boxShadow",x:"-20%",y:"-20%",width:"140%",height:"140%",children:(0,r.jsx)("feDropShadow",{dx:"2",dy:"2",stdDeviation:"3",floodColor:"gray"})})}),(0,r.jsx)("rect",{x:t.x,y:t.y,width:t.width,height:t.height,rx:d.iC.RX,strokeWidth:j,stroke:t.texts.length>1?t.selected?d.iC.SELECTED.STROKE_COLOR:t.tentative?"#9E9E9E":w:"transparent",strokeDasharray:t.tentative?"4 2":"none",onClick:e=>{e.stopPropagation(),C({type:"SELECT_ELEMENT",payload:{id:t.id,ctrlKey:e.ctrlKey||e.metaKey,shiftKey:e.shiftKey}})},onDoubleClick:()=>C({type:"EDIT_ELEMENT"}),onMouseDown:e=>a(e,t),onMouseEnter:W,onMouseLeave:K,style:{fill:t.id===b&&"child"===i?d.iC.DRAGGING.COLOR:N,strokeOpacity:t.tentative?.6:1,pointerEvents:"all",cursor:I?"pointer":"default",filter:t.selected&&t.texts.length>1?"url(#boxShadow)":"none"}}),1===t.texts.length&&R&&(0,r.jsxs)(r.Fragment,{children:[t.selected&&(0,r.jsx)("line",{x1:t.x+2,y1:t.y+t.height+2,x2:t.x+t.width+1,y2:t.y+t.height+2,stroke:"rgba(0,0,255,0.2)",strokeWidth:j,strokeLinecap:"round",pointerEvents:"none"}),(0,r.jsx)("line",{x1:t.x,y1:t.y+t.height,x2:t.x+t.width,y2:t.y+t.height,stroke:t.selected?d.iC.SELECTED.STROKE_COLOR:t.tentative?"#9E9E9E":w,strokeWidth:j,strokeDasharray:t.tentative?"4 2":"none",pointerEvents:"none"})]}),l?.id===t.id&&o&&"child"!==i&&(0,r.jsx)("rect",{className:"drop-preview",x:t.x,y:"before"===i?t.y-.5*o.height-d.e$.Y:t.y+.5*t.height+d.e$.Y,width:o.width,height:o.height,fill:d.iC.DRAGGING.COLOR,rx:d.iC.RX,stroke:d.iC.DRAGGING.COLOR,strokeWidth:j,style:{pointerEvents:"none"}}),t.texts.map((e,l)=>(0,r.jsxs)(n.Fragment,{children:[!t.editing&&(0,r.jsx)(p,{x:t.x,y:t.y+t.sectionHeights.slice(0,l).reduce((e,t)=>e+t,0),width:t.width,height:t.sectionHeights[l],text:e,fontSize:d.gI,zoomRatio:v.zoomRatio,fontFamily:M,onHeightChange:e=>G(l,e)}),l<t.texts.length-1&&(0,r.jsx)("line",{x1:t.x,y1:t.y+t.sectionHeights.slice(0,l+1).reduce((e,t)=>e+t,0),x2:t.x+t.width,y2:t.y+t.sectionHeights.slice(0,l+1).reduce((e,t)=>e+t,0),stroke:w,strokeWidth:"1"})]},`${t.id}-section-${l}`))]})},t.id):null}),y=n.memo(e=>{let{element:t,onEndEditing:l}=e,{dispatch:i,state:o}=s(),a=A(),h=(0,n.useRef)([]),[p,x]=(0,n.useState)([]),[E,m]=(0,n.useState)(-1),f=(0,n.useRef)(null),T=(0,n.useRef)(void 0),[g,C]=(0,n.useState)(""),[O,y]=(0,n.useState)(""),[v,R]=(0,n.useState)("");(0,n.useEffect)(()=>{a&&(f.current=document.createElement("canvas").getContext("2d"),C((0,u.af)()),y((0,u.kN)()),R((0,u.vG)()))},[a]),(0,n.useEffect)(()=>{a&&t?.id!==T.current&&(x(t?.sectionHeights||[]),m(0),T.current=t?.id,setTimeout(()=>h.current[0]?.focus({preventScroll:!0}),50))},[t,a]);let b=(0,n.useCallback)(e=>{let t=d.SK.WIDTH.MAX,l=(0,c.C1)(e,t,o.zoomRatio).length,r=d.gI*d.RZ*o.zoomRatio,i=d.rF.VERTICAL*o.zoomRatio;return Math.max(d.SK.SECTION_HEIGHT*o.zoomRatio,l*r+i)},[o.zoomRatio]),I=(0,n.useCallback)((e,l)=>{let r=e.target.value,n=b(r);x(e=>{let t=[...e];return t[l]=n/o.zoomRatio,t}),i({type:"UPDATE_TEXT",payload:{id:t.id,index:l,value:r}});let a=h.current[l];a&&(a.style.height=`${n}px`)},[t,o.zoomRatio,i,b]),k=(0,n.useCallback)(e=>{let r=e+1;if(t&&r<t.texts.length){let e=h.current[r];if(e){let{scrollX:t,scrollY:l}=window;e.focus({preventScroll:!0}),m(r),window.scrollTo(t,l)}}else l?.(),i({type:"END_EDITING"})},[t,l,i]),S=(e,t)=>{"Tab"===e.key&&(e.preventDefault(),k(t)),"Escape"===e.key&&(e.preventDefault(),l?.(),i({type:"END_EDITING"}))};return t&&a?(0,r.jsx)(r.Fragment,{children:t.texts.map((e,l)=>{let i=p.slice(0,l).reduce((e,t)=>e+t,0)*o.zoomRatio,n=d.SK.WIDTH.MAX*o.zoomRatio,s=b(e);return(0,r.jsx)("textarea",{ref:e=>{h.current[l]=e,l===E&&a&&e?.focus({preventScroll:!0})},value:e,onChange:e=>I(e,l),onKeyDown:e=>S(e,l),onClick:e=>e.stopPropagation(),style:{position:"absolute",left:`${t.x*o.zoomRatio}px`,top:`${t.y*o.zoomRatio+i}px`,width:`${n}px`,height:`${s}px`,minWidth:`${d.SK.WIDTH.MAX*o.zoomRatio}px`,maxWidth:`${d.SK.WIDTH.MAX*o.zoomRatio}px`,minHeight:`${d.SK.SECTION_HEIGHT*o.zoomRatio}px`,margin:"1px 1px",fontSize:`${d.gI*o.zoomRatio}px`,lineHeight:`${d.RZ}em`,padding:"0 3px",fontFamily:g,backgroundColor:O,color:v,boxSizing:"border-box",WebkitFontSmoothing:"antialiased",MozOsxFontSmoothing:"grayscale",overflow:"hidden",whiteSpace:"pre-wrap",wordWrap:"break-word",resize:"none",zIndex:1e4,opacity:1,transition:"all 0.2s ease-in-out",pointerEvents:"all"}},`${t.id}-${l}`)})}):null}),v=e=>{let t=Object.values(e),l=Math.max(...t.map(e=>e.x+e.width)),r=Math.max(...t.map(e=>e.y+e.height));return{width:l+d.e$.X,height:r+d.SK.SECTION_HEIGHT*d.zX}},R=e=>{let{setCanvasSize:t,setDisplayArea:l,state:r}=e;(0,n.useEffect)(()=>{let e=v(r.elements),i=window.innerHeight-2*d.JY;e.width=Math.max(e.width,window.innerWidth),e.height=Math.max(e.height,i);let n={width:e.width,height:e.height};e.width*=r.zoomRatio,e.height*=r.zoomRatio,t(e),l(`0 0 ${n.width} ${n.height}`)},[r.elements,r.zoomRatio,t,l])},b={"Ctrl+z":"UNDO","Ctrl+Shift+z":"REDO",ArrowUp:"ARROW_UP",ArrowDown:"ARROW_DOWN",ArrowRight:"ARROW_RIGHT","Ctrl+ArrowRight":"EXPAND_ELEMENT",ArrowLeft:"ARROW_LEFT","Ctrl+ArrowLeft":"COLLAPSE_ELEMENT","Ctrl+x":"CUT_ELEMENT","Ctrl+c":"COPY_ELEMENT","Ctrl+v":"PASTE_ELEMENT",Tab:"ADD_ELEMENT","Shift+Tab":"ADD_SIBLING_ELEMENT",Delete:"DELETE_ELEMENT",Backspace:"DELETE_ELEMENT",Enter:"EDIT_ELEMENT"},I=(e,t)=>{let{dispatch:l}=s();(0,n.useEffect)(()=>{let r=e.current,i=e=>{e.target instanceof SVGElement&&"svg"===e.target.tagName&&(l({type:"DESELECT_ALL"}),t&&l({type:"END_EDITING"}))};return r?.addEventListener("mousedown",i),()=>{r?.removeEventListener("mousedown",i)}},[e,t,l])};var k=l(3147);let S=e=>"touches"in e,N=()=>{let{state:e,dispatch:t}=s(),{addToast:l}=(0,k.d)(),[r,o]=(0,n.useState)(null),[a,c]=(0,n.useState)({x:0,y:0}),[h,u]=(0,n.useState)({x:0,y:0}),[p,x]=(0,n.useState)(null),E=(0,n.useRef)(new Map),m=(0,n.useCallback)(t=>{let l,r;return S(t)?(l=t.touches[0].clientX+window.scrollX,r=t.touches[0].clientY+window.scrollY):(l=t.clientX+window.scrollX,r=t.clientY+window.scrollY),{x:l/e.zoomRatio,y:(r-d.uF)/e.zoomRatio}},[e.zoomRatio]),T=(0,n.useCallback)((t,l)=>{let r;if(!l.parentId)return;t.stopPropagation(),t.nativeEvent instanceof TouchEvent&&t.preventDefault();let i=m(t.nativeEvent);o(l),c({x:i.x-l.x,y:i.y-l.y}),u({x:l.x,y:l.y}),E.current.clear(),Object.values(e.elements).filter(e=>e.selected).forEach(e=>{E.current.set(e.id,{x:e.x,y:e.y})})},[m,e.elements]),A=()=>{Object.values(e.elements).filter(e=>e.selected).forEach(e=>{let l=E.current.get(e.id);l&&t({type:"MOVE_ELEMENT",payload:{id:e.id,x:l.x,y:l.y}})}),o(null),E.current.clear()},g=(0,n.useCallback)(async()=>{if(r)try{let r=Object.values(e.elements).filter(e=>e.selected),n=(t,l)=>!(l&&(0,f.K9)(e.elements,t.id,l));if(p){let{element:o,position:a}=p;if(r.some(t=>(0,f.K9)(e.elements,t.id,o.id))){A(),l(i.dropChildElement,"warn");return}let s=!1;if(!("child"===a?(e=>r.some(t=>!n(t,e.id))?(l(i.dropChildElement,"warn"),A(),!1):(t({type:"SNAPSHOT"}),r.forEach(l=>{let i=e.depth+1;t({type:"DROP_ELEMENT",payload:{id:l.id,oldParentId:l.parentId,newParentId:e.id,newOrder:e.children+r.indexOf(l),depth:i}})}),!0))(o):((e,o)=>{let a="before"===o?e.order:e.order+1,s=e.parentId;return r.some(e=>!n(e,s))?(l(i.dropChildElement,"warn"),A(),!1):(t({type:"SNAPSHOT"}),r.forEach((l,r)=>{t({type:"DROP_ELEMENT",payload:{id:l.id,oldParentId:l.parentId,newParentId:s,newOrder:a+r,depth:e.depth}})}),!0)})(o,a))){A();return}}else A()}catch(e){console.error("Drag error:",e),l(i.dragError,"warn"),A()}finally{o(null),x(null),E.current.clear()}},[r,p,e.elements,t,l]);return(0,n.useEffect)(()=>{if(!r)return;let l=t=>{let l=m(t),o=l.x,a=l.y,s=Object.values(e.elements).filter(e=>e.visible&&e.id!==r?.id&&i(e,o)),d=null,c=1/0;for(let e of s){let{position:t,distanceSq:l}=n(e,o,a);l<c&&(c=l,d={element:e,position:t})}return d},i=(e,t)=>t>e.x&&t<e.x+e.width,n=(e,t,l)=>{let r=e.y,i=e.y+e.height,n=.1*e.height,o="child";l<r+n?o="before":l>i-n&&(o="after");let a=e.x+e.width/2,s=r+e.height/2,d=t-a,c=l-s;return{position:o,distanceSq:d*d+c*c}},o=e=>{e instanceof TouchEvent&&1===e.touches.length&&e.preventDefault(),x(l(e));let i=m(e),n={x:i.x-a.x,y:i.y-a.y};t({type:"MOVE_ELEMENT",payload:{id:r.id,...n}})},s=e=>o(e),d=e=>{1===e.touches.length&&o(e)},c=()=>g(),h=()=>g();return document.addEventListener("mousemove",s),document.addEventListener("touchmove",d,{passive:!1}),document.addEventListener("mouseup",c),document.addEventListener("touchend",h),()=>{document.removeEventListener("mousemove",s),document.removeEventListener("touchmove",d),document.removeEventListener("mouseup",c),document.removeEventListener("touchend",h)}},[r,a,e.elements,m,t,g]),{handleMouseDown:T,handleMouseUp:g,currentDropTarget:p?.element||null,dropPosition:p?.position||null,draggingElement:r}};var _=l(8628);let w=n.memo(e=>{let{isHelpOpen:t,toggleHelp:l}=e,o=(0,n.useRef)(null),[a,c]=(0,n.useState)(!1),{state:h,dispatch:p}=s(),{elements:x,zoomRatio:E}=h,[m,T]=(0,n.useState)(d.BH),[A,g]=(0,n.useState)(d._o),[v,S]=(0,n.useState)(d.i_),{addToast:w}=(0,k.d)(),[D,j]=(0,n.useState)({width:0,height:0}),[L,M]=(0,n.useState)("0 0 0 0"),[B,H]=(0,n.useState)(!1),[U,G]=(0,n.useState)(0),[W,K]=(0,n.useState)({x:0,y:0}),X=Object.values(x).find(e=>e.editing),[$,P]=(0,n.useState)(null),[F,Z]=(0,n.useState)(null),[z,V]=(0,n.useState)({});(0,n.useEffect)(()=>{X||requestAnimationFrame(()=>{let{scrollX:e,scrollY:t}=window;o.current?.focus({preventScroll:!0}),window.scrollTo(e,t)})},[X]),(0,n.useEffect)(()=>{c(!0),j({width:window.innerWidth,height:window.innerHeight}),M(`0 0 ${window.innerWidth} ${window.innerHeight-d.JY}`),T((0,u.ZF)()||d.BH),g((0,u.S4)()||d._o),S((0,u.Es)()||d.i_)},[]),R({setCanvasSize:j,setDisplayArea:M,state:h}),I(o,!!X);let{handleMouseDown:Y,handleMouseUp:q,currentDropTarget:Q,dropPosition:J,draggingElement:ee}=N(),et=(0,n.useCallback)(async e=>{e.preventDefault();let t=b[`${e.ctrlKey||e.metaKey?"Ctrl+":""}${e.shiftKey?"Shift+":""}${e.key}`];if("PASTE_ELEMENT"===t){let e=(0,_.Lt)();if(e&&Object.keys(e).length>0)p({type:t});else try{let e=await navigator.clipboard.readText(),t=Object.values(h.elements).find(e=>e.selected);if(!t){w(i.noSelect);return}if(e){let l=e.split("\n").filter(e=>""!==e.trim());if(0===l.length){w(i.clipboardEmpty);return}p({type:"ADD_ELEMENTS_SILENT",payload:{parentId:t.id,texts:l}})}else w(i.clipboardEmpty)}catch(e){console.error("クリップボード読み取りエラー:",e),w(i.clipboardReadError)}}else t&&p({type:t})},[p,h.elements,w]),el=(0,n.useCallback)(e=>{if(2===e.touches.length){H(!0);let t=e.touches[0],l=e.touches[1];G(Math.hypot(l.clientX-t.clientX,l.clientY-t.clientY)),K({x:window.scrollX,y:window.scrollY})}else if(1===e.touches.length){e.preventDefault();let t=e.touches[0],l=document.elementFromPoint(t.clientX,t.clientY);if(l instanceof SVGRectElement){let e=new MouseEvent("mousedown",{clientX:t.clientX,clientY:t.clientY,bubbles:!0});l.dispatchEvent(e)}}},[]),er=(0,n.useCallback)(e=>{if(B&&2===e.touches.length){e.preventDefault();let t=e.touches[0],l=e.touches[1],r=Math.hypot(l.clientX-t.clientX,l.clientY-t.clientY),i=t.clientX-l.clientX,n=Math.atan2(t.clientY-l.clientY,i),o=r/U,a=(t.clientX+l.clientX)/2,s=(t.clientY+l.clientY)/2;window.scrollTo({left:W.x+a*(o-1)*Math.cos(n),top:W.y+s*(o-1)*Math.sin(n),behavior:"auto"})}else 1===e.touches.length&&e.preventDefault()},[B,U,W]),ei=(0,n.useCallback)(()=>{H(!1),G(0),K({x:0,y:0})},[]),en=function(e,t){let l,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:d.lB.COLOR,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:d.lB.STROKE;if(!e)return null;let o=0;switch(e.connectionPathType){case d.vX.ARROW:case d.vX.FILLED_ARROW:o=d.tl.OFFSET;break;case d.vX.CIRCLE:case d.vX.FILLED_CIRCLE:case d.vX.SQUARE:case d.vX.FILLED_SQUARE:o=d.p1.OFFSET;break;case d.vX.DIAMOND:case d.vX.FILLED_DIAMOND:o=d.tl.OFFSET;break;default:o=0}let a=t.height,s=`M ${e.x+e.width+o},${e.y+e.height/2} C ${e.x+e.width+d.mO},${e.y+e.height/2} ${t.x-d.mO},${t.y+a/2} ${t.x},${t.y+a/2}`;switch(e.connectionPathType){case d.vX.ARROW:l="url(#arrowhead)";break;case d.vX.FILLED_ARROW:l="url(#filledarrowhead)";break;case d.vX.CIRCLE:l="url(#circlemarker)";break;case d.vX.FILLED_CIRCLE:l="url(#filledcirclemarker)";break;case d.vX.SQUARE:l="url(#squaremarker)";break;case d.vX.FILLED_SQUARE:l="url(#filledsquaremarker)";break;case d.vX.DIAMOND:l="url(#diamondmarker)";break;case d.vX.FILLED_DIAMOND:l="url(#filleddiamondmarker)"}return(0,r.jsxs)("g",{children:[($===t.id||F===t.id)&&(0,r.jsx)("circle",{cx:t.x+t.width+10,cy:t.y+a/2,r:10,fill:"#bfbfbf",opacity:.5}),(0,r.jsx)("path",{d:s,stroke:i,strokeWidth:n,fill:"none",markerStart:l,style:{pointerEvents:"none"}},`connection-${t.id}-${t.parentId}`),(0,r.jsx)("circle",{cx:t.x+t.width+10,cy:t.y+a/2,r:10,fill:"transparent",onMouseEnter:()=>P(t.id),onMouseLeave:()=>P(null),onClick:()=>Z(t.id)})]},`connection-${t.id}-${t.parentId}`)};(0,n.useEffect)(()=>{let e=e=>{F&&!e.target.closest(".popup-menu")&&Z(null)};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[F]);let eo=(0,n.useCallback)((e,t)=>{V(l=>{if(l[e]===t)return l;let r={...l};return t?r[e]=!0:delete r[e],r})},[]);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{style:{position:"absolute",top:d.uF,left:0,width:"100%",height:"100%",backgroundColor:v,overflow:"hidden",zIndex:-1}}),(0,r.jsxs)("div",{style:{position:"absolute",top:d.uF,left:0,overflow:"auto",touchAction:B?"none":"manipulation",backgroundColor:v},children:[a&&(0,r.jsxs)("svg",{"data-testid":"view-area",ref:o,width:D.width,height:D.height,viewBox:L,tabIndex:0,onKeyDown:et,onTouchStart:el,onTouchMove:er,onTouchEnd:ei,style:{outline:"none",touchAction:B?"none":"manipulation",userSelect:"none",WebkitUserSelect:"none",backgroundColor:v},className:"svg-element",children:[(0,r.jsxs)("defs",{children:[(0,r.jsx)("marker",{id:"arrowhead",markerWidth:d.tl.WIDTH,markerHeight:d.tl.HEIGHT,refX:d.tl.WIDTH,refY:d.tl.HEIGHT/2,orient:"auto",fill:"none",stroke:m,markerUnits:"userSpaceOnUse",viewBox:"0 0 MARKER.WIDTH MARKER.HEIGHT",strokeWidth:A,children:(0,r.jsx)("polygon",{points:`${d.tl.WIDTH} 0, ${d.tl.WIDTH} ${d.tl.HEIGHT}, 0 ${d.tl.HEIGHT/2}`,fill:"none",stroke:m})}),(0,r.jsx)("marker",{markerWidth:d.tl.WIDTH,markerHeight:d.tl.HEIGHT,refX:d.tl.WIDTH,refY:d.tl.HEIGHT/2,orient:"auto",fill:m,stroke:m,markerUnits:"userSpaceOnUse",viewBox:"0 0 MARKER.WIDTH MARKER.HEIGHT",strokeWidth:A,children:(0,r.jsx)("polygon",{points:`${d.tl.WIDTH} 0, ${d.tl.WIDTH} ${d.tl.HEIGHT}, 0 ${d.tl.HEIGHT/2}`,fill:m,stroke:m})}),(0,r.jsx)("marker",{id:"circlemarker",markerWidth:d.p1.SIZE,markerHeight:d.p1.SIZE,refX:d.p1.SIZE,refY:d.p1.SIZE/2,orient:"auto",markerUnits:"userSpaceOnUse",viewBox:"0 0 EQUILATERAL_MARKER.SIZE EQUILATERAL_MARKER.SIZE",strokeWidth:A,children:(0,r.jsx)("circle",{cx:d.p1.SIZE/2,cy:d.p1.SIZE/2,r:d.p1.SIZE/2-1,fill:"none",stroke:m})}),(0,r.jsx)("marker",{id:"filledcirclemarker",markerWidth:d.p1.SIZE,markerHeight:d.p1.SIZE,refX:d.p1.SIZE,refY:d.p1.SIZE/2,orient:"auto",markerUnits:"userSpaceOnUse",viewBox:"0 0 EQUILATERAL_MARKER.SIZE EQUILATERAL_MARKER.SIZE",strokeWidth:A,children:(0,r.jsx)("circle",{cx:d.p1.SIZE/2,cy:d.p1.SIZE/2,r:d.p1.SIZE/2-1,fill:m,stroke:m})}),(0,r.jsx)("marker",{id:"squaremarker",markerWidth:d.p1.SIZE,markerHeight:d.p1.SIZE,refX:d.p1.SIZE,refY:d.p1.SIZE/2,orient:"auto",markerUnits:"userSpaceOnUse",viewBox:"0 0 EQUILATERAL_MARKER.SIZE EQUILATERAL_MARKER.SIZE",strokeWidth:A,children:(0,r.jsx)("rect",{x:"1",y:"1",width:d.p1.SIZE-2,height:d.p1.SIZE-2,fill:"none",stroke:m})}),(0,r.jsx)("marker",{id:"filledsquaremarker",markerWidth:d.p1.SIZE,markerHeight:d.p1.SIZE,refX:d.p1.SIZE,refY:d.p1.SIZE/2,orient:"auto",markerUnits:"userSpaceOnUse",viewBox:"0 0 EQUILATERAL_MARKER.SIZE EQUILATERAL_MARKER.SIZE",strokeWidth:A,children:(0,r.jsx)("rect",{x:"1",y:"1",width:d.p1.SIZE-2,height:d.p1.SIZE-2,fill:m,stroke:m})}),(0,r.jsx)("marker",{id:"diamondmarker",markerWidth:d.tl.WIDTH,markerHeight:d.tl.HEIGHT,refX:d.tl.WIDTH,refY:d.tl.HEIGHT/2,orient:"auto",markerUnits:"userSpaceOnUse",viewBox:"0 0 MARKER.WIDTH MARKER.HEIGHT",strokeWidth:A,children:(0,r.jsx)("polygon",{points:`${d.tl.WIDTH/2},1 ${d.tl.WIDTH-1},${d.tl.HEIGHT/2} ${d.tl.WIDTH/2},${d.tl.HEIGHT-1} 1,${d.tl.HEIGHT/2}`,fill:"none",stroke:m})}),(0,r.jsx)("marker",{id:"filleddiamondmarker",markerWidth:d.tl.WIDTH,markerHeight:d.tl.HEIGHT,refX:d.tl.WIDTH,refY:d.tl.HEIGHT/2,orient:"auto",markerUnits:"userSpaceOnUse",viewBox:"0 0 MARKER.WIDTH MARKER.HEIGHT",strokeWidth:A,children:(0,r.jsx)("polygon",{points:`${d.tl.WIDTH/2},1 ${d.tl.WIDTH-1},${d.tl.HEIGHT/2} ${d.tl.WIDTH/2},${d.tl.HEIGHT-1} 1,${d.tl.HEIGHT/2}`,fill:m,stroke:m})})]}),Object.values(x).filter(e=>e.visible).map(e=>(0,r.jsx)(n.Fragment,{children:(0,r.jsx)(O,{element:e,currentDropTarget:Q,dropPosition:J,draggingElement:ee,handleMouseDown:Y,handleMouseUp:q,onHoverChange:eo})},e.id)),Object.values(x).filter(e=>e.visible&&!!e.parentId).map(e=>{let t=h.elements[e.parentId];return ee&&(e.id===ee.id||(0,f.K9)(h.elements,ee.id,e.id))?null:en(t,e,m,A)}),Q&&ee&&(()=>{let e="child"===J?Q:Q.parentId?h.elements[Q.parentId]:null,t=h.elements[ee.id];return e&&t&&en(e,t,d.lB.DRAGGING_COLOR,d.lB.STROKE)})(),(()=>{if(!F)return null;let e=x[F];if(!e)return null;let t=e.height;return(0,r.jsx)("foreignObject",{x:e.x+e.width+20,y:e.y+t/2-25,width:150,height:270,className:"popup-menu",children:(0,r.jsx)("div",{style:{backgroundColor:"white",border:"2px solid black",borderRadius:"4px",boxShadow:"0 2px 10px rgba(0, 0, 0, 0.2)",padding:"8px"},children:[{id:"arrow",label:"Arrow"},{id:"filled_arrow",label:"Filled Arrow"},{id:"circle",label:"Circle"},{id:"filled_circle",label:"Filled Circle"},{id:"square",label:"Square"},{id:"filled_square",label:"Filled Square"},{id:"diamond",label:"Diamond"},{id:"filled_diamond",label:"Filled Diamond"},{id:"none",label:"None"}].map(t=>(0,r.jsx)("div",{style:{padding:"4px 0",cursor:"pointer",backgroundColor:$===t.id?"#e0e0e0":"white"},onMouseEnter:()=>P(t.id),onMouseLeave:()=>P(null),onClick:()=>{p({type:"UPDATE_CONNECTION_PATH_TYPE",payload:{id:e.id,connectionPathType:t.id}}),Z(null)},children:t.label},t.id))})})})(),Object.keys(z).map(e=>{let t=x[e];return t&&t.visible?(0,r.jsx)(C,{element:t,isHovered:!0},`debug-${e}`):null}).filter(Boolean)]}),(0,r.jsx)(y,{element:X,onEndEditing:()=>{p({type:"END_EDITING"}),o.current?.focus()}})]})]})});var D=l(5857),j=l(2554),L=l(7040),M=l(2152),B=l(2397),H=l(5194),U=l(1311),G=l(1496),W=l(6597),K=l(9691),X=l(1081),$=l(8694),P=l(1401),F=l(5833),Z=l(5785),z=l(8283),V=l(514);let Y={NEW:"新規作成",OPEN:"ファイルを開く",SAVE:"保存（JSON形式）",SAVE_SVG:"SVG画像で保存",ADD:"新しい要素の追加",DELETE:"要素の削除",AI:"AI機能",EXPAND:"展開",COLLAPSE:"折りたたみ",UNDO:"元に戻す",REDO:"やり直す",ZOOM_IN:"ズームイン",ZOOM_OUT:"ズームアウト",HELP:"ヘルプを表示",SETTINGS:"設定"},q={TAB_BAR:{BACKGROUND:"#f0f0f0",ACTIVE_TAB_BACKGROUND:"#fff",INACTIVE_TAB_BACKGROUND:"#ddd",ACTIVE_TAB_BORDER:"#87CEFA",TAB_TEXT:"#000000",CLOSE_BUTTON_COLOR:"#666",ADD_BUTTON_BACKGROUND:"transparent",ADD_BUTTON_TEXT:"#000"},MENU_BAR:{BACKGROUND:"#f1f1f1",ICON_COLOR:"#666666",DIVIDER_COLOR:"#e0e0e0"},MODAL:{BACKGROUND:"#ffffff",TEXT_COLOR:"#000000",BUTTON_BACKGROUND:"#f1f1f1",BUTTON_TEXT:"#000000",BUTTON_BORDER:"#cccccc",BUTTON_PRIMARY_BACKGROUND:"#1976d2",BUTTON_PRIMARY_TEXT:"#ffffff"}},Q={TAB_BAR:{BACKGROUND:"#333333",ACTIVE_TAB_BACKGROUND:"#555555",INACTIVE_TAB_BACKGROUND:"#444444",ACTIVE_TAB_BORDER:"#00aaff",TAB_TEXT:"#ffffff",CLOSE_BUTTON_COLOR:"#aaaaaa",ADD_BUTTON_BACKGROUND:"transparent",ADD_BUTTON_TEXT:"#ffffff"},MENU_BAR:{BACKGROUND:"#333333",ICON_COLOR:"#bbbbbb",DIVIDER_COLOR:"#444444"},MODAL:{BACKGROUND:"#333333",TEXT_COLOR:"#fefefe",BUTTON_BACKGROUND:"#555555",BUTTON_TEXT:"#ffffff",BUTTON_BORDER:"#666666",BUTTON_PRIMARY_BACKGROUND:"#1976d2",BUTTON_PRIMARY_TEXT:"#ffffff"}},J=e=>{let t=e.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,(e,t,l,r)=>t+t+l+l+r+r),l=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return l?{r:parseInt(l[1],16),g:parseInt(l[2],16),b:parseInt(l[3],16)}:null},ee=e=>{let t="string"==typeof e?J(e):e;return t?(299*t.r+587*t.g+114*t.b)/1e3:255},et=e=>128>ee(e),el=e=>et(e)?Q:q,er=e=>{let{saveSvg:t,loadElements:l,saveElements:i,toggleHelp:o,toggleSettings:a,onAIClick:c}=e,{dispatch:h,state:p}=s(),{addTab:x}=(0,T.u)(),E=(0,n.useRef)(null),m=(0,n.useRef)(null);if(!A())return null;let f=el((0,u.Es)()),g=e=>()=>{h({type:e})};return(0,r.jsx)("div",{style:{position:"fixed",width:"100%",height:d.JY,overflowX:"auto",WebkitOverflowScrolling:"touch",msOverflowStyle:"none",scrollbarWidth:"none"},ref:m,children:(0,r.jsxs)("div",{style:{display:"flex",justifyContent:"left",alignItems:"center",height:"100%",backgroundColor:f.MENU_BAR.BACKGROUND,padding:"0 20px",minWidth:"max-content"},children:[(0,r.jsx)("input",{type:"file",ref:E,onChange:l,style:{display:"none"}}),(0,r.jsx)(V.A,{title:Y.NEW,children:(0,r.jsx)(D.A,{variant:"text",className:"iconbar-button",onClick:x,children:(0,r.jsx)(K.A,{sx:{color:f.MENU_BAR.ICON_COLOR}})})}),(0,r.jsx)(V.A,{title:Y.OPEN,children:(0,r.jsx)(D.A,{variant:"text",className:"iconbar-button",onClick:()=>{E.current?.click()},children:(0,r.jsx)(H.A,{sx:{color:f.MENU_BAR.ICON_COLOR}})})}),(0,r.jsx)(V.A,{title:Y.SAVE,children:(0,r.jsx)(D.A,{variant:"text",className:"iconbar-button",onClick:i,children:(0,r.jsx)(U.A,{sx:{color:f.MENU_BAR.ICON_COLOR}})})}),(0,r.jsx)(V.A,{title:Y.SAVE_SVG,children:(0,r.jsx)(D.A,{variant:"text",className:"iconbar-button",onClick:t,children:(0,r.jsx)(G.A,{sx:{color:f.MENU_BAR.ICON_COLOR}})})}),(0,r.jsx)("div",{style:{width:"10px",backgroundColor:f.MENU_BAR.DIVIDER_COLOR,height:"60%",margin:"0 5px",opacity:.3}}),(0,r.jsx)(V.A,{title:Y.ADD,children:(0,r.jsx)(D.A,{variant:"text",className:"iconbar-button",onClick:g("ADD_ELEMENT"),children:(0,r.jsx)(X.A,{sx:{color:f.MENU_BAR.ICON_COLOR}})})}),(0,r.jsx)(V.A,{title:Y.DELETE,children:(0,r.jsx)(D.A,{variant:"text",className:"iconbar-button",onClick:g("DELETE_ELEMENT"),children:(0,r.jsx)($.A,{sx:{color:f.MENU_BAR.ICON_COLOR}})})}),(0,r.jsx)(V.A,{title:Y.AI,children:(0,r.jsx)(D.A,{variant:"text",className:"iconbar-button",onClick:c,children:(0,r.jsx)(z.A,{sx:{color:f.MENU_BAR.ICON_COLOR}})})}),(0,r.jsx)(V.A,{title:Y.EXPAND,children:(0,r.jsx)(D.A,{variant:"text",className:"iconbar-button",onClick:g("EXPAND_ELEMENT"),children:(0,r.jsx)(F.A,{sx:{color:f.MENU_BAR.ICON_COLOR}})})}),(0,r.jsx)(V.A,{title:Y.COLLAPSE,children:(0,r.jsx)(D.A,{variant:"text",className:"iconbar-button",onClick:g("COLLAPSE_ELEMENT"),children:(0,r.jsx)(P.A,{sx:{color:f.MENU_BAR.ICON_COLOR}})})}),(0,r.jsx)("div",{style:{width:"10px",backgroundColor:f.MENU_BAR.DIVIDER_COLOR,height:"60%",margin:"0 5px",opacity:.3}}),(0,r.jsx)(V.A,{title:Y.UNDO,children:(0,r.jsx)(D.A,{variant:"text",className:"iconbar-button",onClick:g("UNDO"),children:(0,r.jsx)(j.A,{sx:{color:f.MENU_BAR.ICON_COLOR}})})}),(0,r.jsx)(V.A,{title:Y.REDO,children:(0,r.jsx)(D.A,{variant:"text",className:"iconbar-button",onClick:g("REDO"),children:(0,r.jsx)(L.A,{sx:{color:f.MENU_BAR.ICON_COLOR}})})}),(0,r.jsx)("div",{style:{width:"10px",backgroundColor:f.MENU_BAR.DIVIDER_COLOR,height:"60%",margin:"0 5px",opacity:.3}}),(0,r.jsx)(V.A,{title:Y.ZOOM_IN,children:(0,r.jsx)(D.A,{variant:"text",className:"iconbar-button",onClick:g("ZOOM_IN"),children:(0,r.jsx)(M.A,{sx:{color:f.MENU_BAR.ICON_COLOR}})})}),(0,r.jsx)(V.A,{title:Y.ZOOM_OUT,children:(0,r.jsx)(D.A,{variant:"text",className:"iconbar-button",onClick:g("ZOOM_OUT"),children:(0,r.jsx)(B.A,{sx:{color:f.MENU_BAR.ICON_COLOR}})})}),(0,r.jsx)("div",{style:{width:"10px",backgroundColor:f.MENU_BAR.DIVIDER_COLOR,height:"60%",margin:"0 5px",opacity:.3}}),(0,r.jsx)(V.A,{title:Y.HELP,children:(0,r.jsx)(D.A,{variant:"text",className:"iconbar-button",onClick:o,children:(0,r.jsx)(W.A,{sx:{color:f.MENU_BAR.ICON_COLOR}})})}),(0,r.jsx)(V.A,{title:Y.SETTINGS,children:(0,r.jsx)(D.A,{variant:"text",className:"iconbar-button",onClick:a,children:(0,r.jsx)(Z.A,{sx:{color:f.MENU_BAR.ICON_COLOR}})})})]})})},ei=n.memo(e=>{let{tab:t,isCurrent:l,closeTab:i,switchTab:n,theme:o}=e;return A()?(0,r.jsxs)("div",{style:{padding:"6px",marginRight:"4px",backgroundColor:l?o.TAB_BAR.ACTIVE_TAB_BACKGROUND:o.TAB_BAR.INACTIVE_TAB_BACKGROUND,borderBottom:l?`3px solid ${o.TAB_BAR.ACTIVE_TAB_BORDER}`:"none",paddingBottom:"3px",borderRadius:"5px 5px 0 0",fontSize:"12px",cursor:"pointer",display:"flex",alignItems:"center",color:o.TAB_BAR.TAB_TEXT,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",minWidth:"48px",maxWidth:"150px"},onClick:()=>n(t.id),children:[(0,r.jsx)("span",{style:{flex:"1 1 auto",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",minWidth:"0"},children:t.name}),(0,r.jsx)("button",{onClick:e=>{e.stopPropagation(),i(t.id)},style:{flex:"0 0 auto",marginLeft:"2px",border:"0",backgroundColor:"transparent",fontSize:"16px",color:o.TAB_BAR.CLOSE_BUTTON_COLOR,fontWeight:"bold",cursor:"pointer"},children:"\xd7"})]}):null}),en=n.memo(e=>{let{tabs:t,currentTabId:l,addTab:i,closeTab:o,switchTab:a}=e,s=A(),[c,h]=(0,n.useState)(d.i_),[p,x]=(0,n.useState)(()=>el(d.i_));return((0,n.useEffect)(()=>{if(!s)return;let e=(0,u.Es)();h(e),x(el(e))},[s]),s)?(0,r.jsxs)("div",{style:{display:"flex",alignItems:"center",backgroundColor:p.TAB_BAR.BACKGROUND,width:"100%",height:d.FM,marginTop:d.JY,position:"fixed"},children:[t.map(e=>(0,r.jsx)(ei,{tab:e,isCurrent:l===e.id,closeTab:o,switchTab:a,theme:p},e.id)),(0,r.jsx)("button",{onClick:i,style:{marginLeft:"8px",backgroundColor:p.TAB_BAR.ADD_BUTTON_BACKGROUND,color:p.TAB_BAR.ADD_BUTTON_TEXT,border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"16px",padding:"2px 8px"},children:"+"})]}):null}),eo=e=>{let{isOpen:t,onClose:l,children:i}=e,o=A(),[a,d]=(0,n.useState)(()=>el((0,u.Es)())),{dispatch:c}=s();return((0,n.useEffect)(()=>{o&&d(el((0,u.Es)()))},[o]),(0,n.useEffect)(()=>{t&&c({type:"END_EDITING"})},[t,c]),t)?(0,r.jsx)("div",{style:{position:"fixed",top:0,left:0,width:"100%",height:"100%",backgroundColor:"rgba(0, 0, 0, 0.5)",display:"flex",justifyContent:"center",alignItems:"center",zIndex:9e3},children:(0,r.jsx)("div",{style:{backgroundColor:a.MODAL.BACKGROUND,color:a.MODAL.TEXT_COLOR,padding:"40px 24px 24px",borderRadius:"10px",width:"80%",maxWidth:"500px",overflow:"hidden",position:"relative",zIndex:9001},children:(0,r.jsxs)("div",{style:{maxHeight:"80vh",overflow:"auto"},children:[(0,r.jsx)("button",{onClick:l,style:{position:"absolute",right:10,top:10,background:"transparent",border:"none",fontSize:"1.5em",color:a.MODAL.TEXT_COLOR,cursor:"pointer"},children:"\xd7"}),(0,r.jsx)("div",{style:{flex:1,overflow:"auto",paddingRight:"8px"},children:i})]})})}):null};var ea=l(2582),es=l(7498),ed=l(9284),ec=l(9868),eh=l(7923),eu=l(3025),ep=l(8893),ex=l(5358),eE=l(7298),em=l(9439),ef=l(4512),eT=l(8410);let eA=e=>{let{field:t,value:l,error:i=!1,onChange:n}=e;switch(t.type){case"text":return(0,r.jsx)(ea.A,{label:t.label,value:l,onChange:e=>n(e.target.value),fullWidth:!0,margin:"normal",multiline:"prompt"===t.key||"systemPromptTemplate"===t.key,rows:"prompt"===t.key||"systemPromptTemplate"===t.key?6:1,type:"apiKey"===t.key?"password":"text",helperText:t.helperText,variant:"prompt"===t.key||"systemPromptTemplate"===t.key?"outlined":"standard"});case"number":return(0,r.jsx)(ea.A,{label:t.label,type:"number",value:l,onChange:e=>n(e.target.value),fullWidth:!0,margin:"normal",inputProps:{min:t.validation?.min,max:t.validation?.max,step:t.validation?.step},error:i,helperText:i?`${t.validation?.min}から${t.validation?.max}の数値を入力してください`:t.helperText});case"select":return(0,r.jsxs)(es.A,{fullWidth:!0,margin:"normal",children:[(0,r.jsx)(ed.A,{children:t.label}),(0,r.jsx)(ec.A,{value:String(l),label:t.label,onChange:e=>{n(e.target.value)},MenuProps:{sx:{zIndex:9999}},children:t.options?.map(e=>r.jsx(eh.A,{value:e.value,children:e.label},e.value))}),(0,r.jsx)(eu.A,{children:t.helperText})]});case"color":return(0,r.jsxs)(ep.A,{sx:{display:"flex",alignItems:"center",mt:2,mb:1},children:[(0,r.jsxs)(ex.A,{variant:"body1",sx:{mr:2,width:"120px"},children:[t.label,":"]}),(0,r.jsx)("input",{type:"color",value:String(l),onChange:e=>n(e.target.value)}),(0,r.jsx)(eu.A,{children:t.helperText})]});case"radio":return(0,r.jsxs)(es.A,{component:"fieldset",fullWidth:!0,children:[(0,r.jsx)(eE.A,{component:"legend",children:t.label}),(0,r.jsx)(em.A,{children:t.options?.map(e=>r.jsx(ef.A,{value:e.value,control:r.jsx(eT.A,{checked:l===e.value,onChange:e=>n(e.target.value)}),label:e.label},e.value))}),(0,r.jsx)(eu.A,{children:t.helperText})]});default:return null}};var eg=l(5055),eC=l(460),eO=l(270),ey=l(3745);let ev=[{id:0,label:"Elements Setting",fields:[{key:"numberOfSections",label:"Number of sections",type:"number",helperText:"同時に表示するセクションの数（1〜10） ※タブごとに設定されます",defaultValue:3,validation:{min:1,max:10,required:!0}},{key:"markerType",label:"Default Marker Type",type:"select",helperText:"新規要素作成時のデフォルトマーカータイプ",defaultValue:d.vX.NONE,options:[{value:d.vX.NONE,label:"None"},{value:d.vX.ARROW,label:"Arrow"},{value:d.vX.CIRCLE,label:"Circle"},{value:d.vX.SQUARE,label:"Square"},{value:d.vX.DIAMOND,label:"Diamond"},{value:d.vX.FILLED_ARROW,label:"Filled Arrow"},{value:d.vX.FILLED_CIRCLE,label:"Filled Circle"},{value:d.vX.FILLED_SQUARE,label:"Filled Square"},{value:d.vX.FILLED_DIAMOND,label:"Filled Diamond"}]},{key:"canvasBackgroundColor",label:"Canvas Background Color",type:"color",helperText:"キャンバスの背景色",defaultValue:"#ffffff"},{key:"elementColor",label:"Element Color",type:"color",helperText:"要素の背景色",defaultValue:"#ffffff"},{key:"textColor",label:"Text Color",type:"color",helperText:"テキストの色",defaultValue:"#000000"},{key:"strokeColor",label:"Stroke Color",type:"color",helperText:"要素の枠線色",defaultValue:"#000000"},{key:"strokeWidth",label:"Stroke Width",type:"number",helperText:"要素の枠線の太さ",defaultValue:1,validation:{min:.5,step:.5,required:!0}},{key:"connectionPathColor",label:"Connection Path Color",type:"color",helperText:"接続線の色",defaultValue:"#000000"},{key:"connectionPathStroke",label:"Connection Path Stroke",type:"number",helperText:"接続線の太さ",defaultValue:1,validation:{min:.5,step:.5,required:!0}},{key:"fontFamily",label:"Font Family",type:"text",helperText:"表示に使用するフォントファミリ",defaultValue:""}]},{id:1,label:"API Setting",fields:[{key:"modelType",label:"Select Model",type:"radio",helperText:"APIモデルの選択",defaultValue:"gemini-1.5-flash",options:[{value:"gemini-1.5-flash",label:"Gemini-1.5-flash"},{value:"gemini-2.0-flash",label:"Gemini-2.0-flash"}]},{key:"apiKey",label:"Gemini API Key",type:"text",helperText:"入力されたキーは暗号化してlocalStorageに保存されます。サーバに送信されることはありません。",defaultValue:""}]},{id:2,label:"Prompt",fields:[{key:"prompt",label:"inputText",type:"text",helperText:"",defaultValue:""},{key:"systemPromptTemplate",label:"SystemPromptTemplate",type:"text",helperText:"",defaultValue:""}]}],eR=e=>{let{isOpen:t,onClose:l}=e,i=A(),[o,a]=(0,n.useState)(0),[s,d]=(0,n.useState)({}),[c,h]=(0,n.useState)({}),[p,x]=(0,n.useState)("light"),[E,m]=(0,n.useState)(()=>el((0,u.Es)())),{getCurrentTabNumberOfSections:f,updateCurrentTabNumberOfSections:g}=(0,T.u)();if((0,n.useEffect)(()=>{let e=(0,u.Es)();x(et(e)?"dark":"light"),m(el(e))},[i]),(0,n.useEffect)(()=>{i&&t&&(async()=>{let e={};try{e.apiKey=await (0,u.CG)(),e.systemPromptTemplate=(0,u.k0)(),e.modelType=(0,u.OA)(),e.prompt=(0,u.XH)(),e.numberOfSections=f(),e.elementColor=(0,u.kN)(),e.strokeColor=(0,u._1)(),e.strokeWidth=(0,u.xo)(),e.fontFamily=(0,u.af)(),e.markerType=(0,u.zn)(),e.connectionPathColor=(0,u.ZF)(),e.connectionPathStroke=(0,u.S4)(),e.canvasBackgroundColor=(0,u.Es)(),e.textColor=(0,u.vG)(),d(e)}catch(e){console.error("Failed to load settings:",e)}})()},[i,t,f]),!i)return null;let C=(0,eO.A)({palette:{mode:p,background:{default:E.MODAL.BACKGROUND,paper:E.MODAL.BACKGROUND},text:{primary:E.MODAL.TEXT_COLOR,secondary:E.MODAL.TEXT_COLOR}},components:{MuiButton:{styleOverrides:{root:{color:E.MODAL.BUTTON_TEXT,borderColor:E.MODAL.BUTTON_BORDER},contained:{backgroundColor:E.MODAL.BUTTON_PRIMARY_BACKGROUND,color:E.MODAL.BUTTON_PRIMARY_TEXT,"&:hover":{backgroundColor:E.MODAL.BUTTON_PRIMARY_BACKGROUND,opacity:.9}},outlined:{backgroundColor:E.MODAL.BUTTON_BACKGROUND,"&:hover":{backgroundColor:E.MODAL.BUTTON_BACKGROUND,opacity:.9}}}}}}),O=(e,t)=>{if("number"===e.type){let l="string"==typeof t?parseFloat(t):t;if(e.validation?.required&&(""===t||isNaN(l))||!isNaN(l)&&(e.validation?.min!==void 0&&l<e.validation.min||e.validation?.max!==void 0&&l>e.validation.max))return!1}return!0},y=(e,t)=>{d(l=>({...l,[e.key]:t})),h(l=>({...l,[e.key]:!O(e,t)}))},v=async()=>{let e=!1;if(ev.forEach(t=>{t.fields.forEach(t=>{let l=s[t.key];O(t,l)||(e=!0,h(e=>({...e,[t.key]:!0})))})}),e)return;let t=s.apiKey;void 0!==t&&await (0,u.wt)(String(t));let r=s.systemPromptTemplate;void 0!==r&&(0,u.mF)(String(r));let i=s.modelType;void 0!==i&&(0,u.Iz)(String(i));let n=s.prompt;void 0!==n&&(0,u.bJ)(String(n));let o=s.numberOfSections;if(void 0!==o){let e=Number(o);(0,u.jE)(e),g(e)}let a=s.elementColor;void 0!==a&&(0,u.qu)(String(a));let d=s.strokeColor;void 0!==d&&(0,u.JT)(String(d));let c=s.strokeWidth;void 0!==c&&(0,u.Jg)(Number(c));let p=s.fontFamily;void 0!==p&&(0,u.Yu)(String(p));let x=s.markerType;void 0!==x&&(0,u.li)(String(x));let E=s.connectionPathColor;void 0!==E&&(0,u.xN)(String(E));let m=s.connectionPathStroke;void 0!==m&&(0,u.K2)(Number(m));let f=s.canvasBackgroundColor;void 0!==f&&(0,u.QY)(String(f));let T=s.textColor;void 0!==T&&(0,u.vY)(String(T)),l()};return(0,r.jsx)(eo,{isOpen:t,onClose:l,children:(0,r.jsx)(ey.A,{theme:C,children:(0,r.jsxs)(ep.A,{sx:{backgroundColor:E.MODAL.BACKGROUND,color:E.MODAL.TEXT_COLOR,padding:2,borderRadius:1},children:[(0,r.jsx)(ex.A,{variant:"h6",gutterBottom:!0,color:"textPrimary",children:"Preference"}),(0,r.jsx)(eg.A,{value:o,onChange:(e,t)=>a(t),textColor:"primary",indicatorColor:"primary",children:ev.map(e=>(0,r.jsx)(eC.A,{label:e.label},e.id))}),(0,r.jsx)(ep.A,{sx:{mt:2,minHeight:300},children:ev.map(e=>o===e.id&&(0,r.jsx)(ep.A,{children:e.fields.map(e=>(0,r.jsx)(eA,{field:e,value:s[e.key]??e.defaultValue,error:c[e.key],onChange:t=>y(e,t)},e.key))},e.id))}),(0,r.jsxs)(ep.A,{sx:{mt:2,display:"flex",justifyContent:"flex-end",gap:1},children:[(0,r.jsx)(D.A,{variant:"outlined",onClick:l,children:"Cancel"}),(0,r.jsx)(D.A,{variant:"contained",onClick:v,color:"primary",disabled:Object.values(c).some(Boolean),children:"OK"})]})]})})})},eb=e=>{let{showCloseConfirm:t,setShowCloseConfirm:l,tabToClose:i,closeTab:n}=e;return t?(0,r.jsx)(eo,{isOpen:t,onClose:()=>l(!1),children:(0,r.jsxs)("div",{style:{padding:"20px"},children:[(0,r.jsx)("p",{style:{marginBottom:"20px"},children:"タブを閉じてよろしいですか？"}),(0,r.jsxs)("div",{style:{display:"flex",justifyContent:"flex-end",gap:"10px"},children:[(0,r.jsx)(D.A,{variant:"outlined",onClick:()=>l(!1),children:"いいえ"}),(0,r.jsx)(D.A,{variant:"contained",color:"primary",onClick:()=>{i&&n(i),l(!1)},children:"はい"})]})]})}):null},eI=`
<h4>Keyboard shortcuts</h4>
<p>Tab: Add a child element to the selected element</p>
<p>Shift + Tab: Add a sibling element to the selected element</p>
<p>Delete/Backspace: Remove the selected element</p>
<p>Enter: Edit the selected element</p>
<p>Esc: Stop editing the selected element</p>
<p>Tab in editing mode: Move the focus to the next text box</p>
<p>Ctrl + Z: Undo the last action</p>
<p>Shift + Ctrl + Z: Redo the last action</p>
<p>Ctrl + X: Cut the selected element</p>
<p>Ctrl + C: Copy the selected element</p>
<p>Ctrl + V: Paste the copied element</p>
<p>Ctrl + ArrowLeft: Collapse the children of the selected element</p>
<p>Ctrl + ArrowRight: Expand the children of the selected element</p>
<p>Arrow keys: Navigate between elements</p>

<h4>Mouse operations</h4>
<p>Click: Select an element</p>
<p>Double click: Edit the selected element</p>
<p>Clicking outside the element will end the editing mode</p>
<p>Drag: Move the selected element</p>

<h4>Menu operations</h4>
<p>New: Create a new diagram. Unsaved changes will be discarded.</p>
<p>Open: Load saved data. The current data will be discarded.</p>
<p>Save as: Save the diagram data in JSON format</p>
<p>Export: Export the diagram in SVG format</p>
`;var ek=l(6545),eS=l(4098),eN=l(3464);let e_=async(e,t,l)=>{try{console.log("prompt: \n",e);let l=`${(0,u.G6)()}?key=${t}`,r=await eN.A.post(l,{contents:[{parts:[{text:e}]}]},{headers:{"Content-Type":"application/json"}}),i=r.data.candidates?.[0]?.content?.parts?.[0]?.text||"";return console.log(i),i}catch(e){throw console.error("Gemini API Error:",e),Error("API呼び出しに失敗しました")}},ew=e=>{let{structureText:t,inputText:l}=e;return(0,u.k0)().replace("{{structureText}}",t).replace("{{inputText}}",l)},eD=()=>{let{tabs:e,currentTabId:t,addTab:l,closeTab:o,switchTab:s,updateTabState:d,updateTabName:c}=(0,T.u)(),h=(0,n.useMemo)(()=>e.find(e=>e.id===t),[e,t]),[p,x]=(0,n.useState)(!1),[E,m]=(0,n.useState)(!1),[A,g]=(0,n.useState)(null),[C,O]=(0,n.useState)(!1),{addToast:y}=(0,k.d)(),v=(0,n.useCallback)(e=>{d(t,t=>(0,ek.F)(t,e))},[t,d]),R=(0,n.useCallback)(()=>{v({type:"END_EDITING"}),x(e=>!e)},[v]),b=(0,n.useCallback)(()=>{v({type:"END_EDITING"}),m(e=>!e)},[v]),I=e=>{g(e),O(!0)},S=(0,n.useCallback)(async()=>{if(!h)return;let e=Object.values(h.state.elements).find(e=>e.selected);if(!e){y(i.noSelect);return}let t=await (0,u.CG)();if(!t){y(i.noApiKey,"warn");return}let l=localStorage.getItem("prompt")||"";if(!l){y(i.noPrompt);return}try{let r=(0,f.YV)(h.state.elements,e.id),i=ew({structureText:r,inputText:l}),n=(0,u.OA)(),o=await e_(i,t,n),a=[];Array.isArray(o)?a=o:"string"==typeof o&&(a=(o.match(/```[\s\S]*?```/g)||[]).flatMap(e=>e.replace(/```/g,"").split("\n").map(e=>e.trim()).filter(e=>e.length>0))),v({type:"ADD_ELEMENTS_SILENT",payload:{parentId:e.id,texts:a,tentative:!0}})}catch(e){y(e instanceof Error?`${i.aiError}: ${e.message}`:i.aiError)}},[h,v,y]),N=(0,n.useMemo)(()=>h?(0,r.jsxs)(a,{state:h.state,dispatch:v,children:[(0,r.jsx)(w,{isHelpOpen:p,toggleHelp:R}),(0,r.jsx)(en,{tabs:e,currentTabId:t,addTab:l,closeTab:I,switchTab:s}),(0,r.jsx)(er,{saveSvg:()=>(0,eS.Sz)(document.querySelector(".svg-element"),"download.svg"),loadElements:e=>(0,eS.wl)(e.nativeEvent).then(e=>{let{elements:l,fileName:r}=e;v({type:"LOAD_ELEMENTS",payload:l}),c(t,r.replace(".json",""))}).catch(e=>y(e.message)),saveElements:()=>(0,eS.$r)(Object.values(h.state.elements),h.name),toggleHelp:R,toggleSettings:b,onAIClick:S}),(0,r.jsx)(eb,{showCloseConfirm:C,setShowCloseConfirm:O,tabToClose:A,closeTab:o}),(0,r.jsx)(eR,{isOpen:E,onClose:b}),(0,r.jsx)(eo,{isOpen:p,onClose:R,children:(0,r.jsx)("div",{dangerouslySetInnerHTML:{__html:eI}})})]}):null,[h,v,R,p,t,c,b,y,S,C,A,o,E]);return(0,r.jsx)("div",{children:N})}}},e=>{var t=t=>e(e.s=t);e.O(0,[629,255,441,684,358],()=>t(1469)),_N_E=e.O()}]);
(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{2152:(e,t,i)=>{"use strict";i.d(t,{default:()=>tt});var r=i(5155),l=i(2115);let n=(0,l.createContext)(void 0),o=e=>{let{children:t,state:i,dispatch:o}=e,a=(0,l.useMemo)(()=>({state:i,dispatch:o}),[i,o]);return(0,r.jsx)(n.Provider,{value:a,children:t})},a=()=>{let e=(0,l.useContext)(n);if(!e)throw Error("useCanvas must be used within a CanvasProvider");return e};var s=i(829),d=i(3346),c=i(8265),h=i(6323),p=i(2135);let u=(0,l.memo)(function(e){let{x:t,y:i,width:n,height:o,text:a,zoomRatio:u,fontFamily:x,onHeightChange:f}=e,[g,m]=(0,l.useState)({width:0,height:0}),[E,y]=(0,l.useState)(!1),[b,T]=(0,l.useState)(s._K),O=(0,l.useRef)(null),C=(0,l.useRef)({width:0,height:0}),I=(0,l.useRef)(a);if((0,l.useRef)(f).current=f,(0,l.useEffect)(()=>{T((0,h.vG)())},[]),(0,l.useEffect)(()=>{let e;return y(!0),E&&(a!==I.current||n!==C.current.width||o!==C.current.height)&&(e=requestAnimationFrame(()=>{if(!O.current)return;let e=Math.min(s.SK.WIDTH.MAX,n);(0,c.c)(`[updateDimensions] text: ${a}  size: ${e} x ${o}`);let t=(0,d.C1)(a||"",e,u),i=s.gI*s.RZ*u,r=Math.max(s.SK.SECTION_HEIGHT*u,(i+s.rF.VERTICAL)*u),l=Math.max(t.length*i,r)+s.rF.VERTICAL*u,h=Math.abs(e-C.current.width)>1,p=Math.abs(l-C.current.height)>1;(h||p)&&(m({width:e,height:l}),C.current={width:e,height:l})}),I.current=a),()=>{e&&cancelAnimationFrame(e)}},[a,n,o,u,E]),!E)return null;let v=(0,p.jZ)(a||"");return(0,r.jsx)("foreignObject",{x:t,y:i,width:g.width,height:Math.round(g.height/u),pointerEvents:"none",children:(0,r.jsx)("div",{ref:O,style:{fontFamily:x||s.zs,color:b,fontSize:`${s.gI}px`,lineHeight:s.RZ,width:`${g.width-s.rF.HORIZONTAL}px`,minHeight:`${s.SK.SECTION_HEIGHT}px`,padding:`${.5*s.rF.VERTICAL}px ${.5*s.rF.HORIZONTAL}px`,overflow:"hidden",whiteSpace:"pre-wrap",wordBreak:"break-word",boxSizing:"content-box"},children:v})})});var x=i(6670),f=i(840),g=i(9605),m=i(9499),E=i(7242);let y=()=>{let[e,t]=(0,l.useState)(!1);return(0,l.useEffect)(()=>{t(!0)},[]),e},b=(e,t,i)=>((e,t)=>{if(!e.tentative)return!1;let i=Math.min(...t.filter(t=>t.parentId===e.parentId&&t.tentative).map(e=>e.order));return e.order===i})(e,i)?(0,r.jsxs)("g",{transform:`translate(${e.x+1.1*e.width},${e.y})`,onClick:e=>e.stopPropagation(),style:{cursor:"pointer",pointerEvents:"all"},"data-exclude-from-export":"true",children:[(0,r.jsxs)("g",{children:[(0,r.jsx)("rect",{x:"0",y:"0",width:"24",height:"24",rx:"4",fill:"white",stroke:"#e0e0e0",strokeWidth:"1"}),(0,r.jsx)("foreignObject",{x:"4",y:"4",width:"16",height:"16",children:(0,r.jsx)(f.A,{sx:{color:"#4CAF50","&:hover":{color:"#388E3C"},transition:"color 0.2s ease-in-out"},style:{width:"100%",height:"100%"},onClick:()=>t({type:"CONFIRM_TENTATIVE_ELEMENTS",payload:e.parentId})})})]}),(0,r.jsxs)("g",{transform:"translate(30, 0)",children:[(0,r.jsx)("rect",{x:"0",y:"0",width:"24",height:"24",rx:"4",fill:"white",stroke:"#e0e0e0",strokeWidth:"1"}),(0,r.jsx)("foreignObject",{x:"4",y:"4",width:"16",height:"16",children:(0,r.jsx)(g.A,{sx:{color:"#F44336","&:hover":{color:"#D32F2F"},transition:"color 0.2s ease-in-out"},style:{width:"100%",height:"100%"},onClick:()=>t({type:"CANCEL_TENTATIVE_ELEMENTS",payload:e.parentId})})})]})]}):null,T=l.memo(e=>{let{element:t,currentDropTarget:i,dropPosition:n,draggingElement:o,handleMouseDown:p,onHoverChange:f,_dropInsertY:g,_siblingInfo:T}=e,{dispatch:O}=a(),{getCurrentTabState:C}=(0,E.u)(),I=C()||{elements:{},zoomRatio:1},v=y(),w=i?.id||-1,[A,j]=(0,l.useState)(!1),k=(0,l.useRef)(!1),[R,D]=(0,l.useState)(s.iC.NORMAL.COLOR),[S,N]=(0,l.useState)(s.iC.NORMAL.STROKE_COLOR),[_,$]=(0,l.useState)(s.iC.STROKE_WIDTH),[L,M]=(0,l.useState)(""),[B,H]=(0,l.useState)(s.iC.SELECTED.STROKE_COLOR);(0,l.useEffect)(()=>{v&&(D((0,h.kN)()),N((0,h._1)()),$((0,h.xo)()),M((0,h.af)()),H((0,h.N4)()))},[v]),(0,l.useEffect)(()=>{if(t.editing||!v)return;let{newWidth:e,newHeight:i,sectionHeights:r}=(()=>{let e=(0,d.PC)(t.texts,s.rF.HORIZONTAL),i=t.texts.map(t=>{let i=(0,d.C1)(t||"",e,I.zoomRatio).length;return Math.max(s.SK.SECTION_HEIGHT*I.zoomRatio,i*s.gI*s.RZ+s.rF.VERTICAL*I.zoomRatio)});return{newWidth:e,newHeight:i.reduce((e,t)=>e+t,0),sectionHeights:i}})();t.editing||e===t.width&&i===t.height||O({type:"UPDATE_ELEMENT_SIZE",payload:{id:t.id,width:e,height:i,sectionHeights:r}})},[t.editing,t.texts,t.width,t.height,O,t.id,I.zoomRatio]);let U=(0,l.useMemo)(()=>Object.values(I.elements).filter(e=>e.parentId===t.id&&!e.visible),[I.elements,t.id]),X=!!o&&(o.id===t.id||(0,m.K9)(I.elements,o.id,t.id)),G=(0,l.useCallback)((e,i)=>{let r=t.sectionHeights[e];if(null!==r&&Math.abs(i-r)>1){let r=[...t.sectionHeights];r[e]=i;let l=(0,d.PC)(t.texts,s.rF.HORIZONTAL),n=r.reduce((e,t)=>e+t,0);(0,c.c)(`[IdeaElement][handleHeightChange] resized: ${t.texts} ${t.width} x ${t.height} -> ${l} x ${n}`),O({type:"UPDATE_ELEMENT_SIZE",payload:{id:t.id,width:l,height:n,sectionHeights:r}})}},[O,t]),P=(0,l.useCallback)(()=>{j(!0),f&&!k.current&&(f(t.id,!0),k.current=!0)},[t.id,f]),F=(0,l.useCallback)(()=>{j(!1),f&&k.current&&(f(t.id,!1),k.current=!1)},[t.id,f]);return((0,l.useEffect)(()=>()=>{f&&k.current&&f(t.id,!1)},[t.id,f]),v)?(0,r.jsx)(l.Fragment,{children:(0,r.jsxs)("g",{opacity:X?.3:1,children:[b(t,O,Object.values(I.elements)),U.length>0&&(0,r.jsxs)(r.Fragment,{children:[t.texts.length>1?(0,r.jsx)("rect",{x:t.x+s.N,y:t.y+s.N,width:t.width,height:t.height,rx:s.iC.RX,fill:"none",stroke:s.iC.SHADDOW.COLOR,strokeWidth:_},`shadow-${t.id}`):(0,r.jsx)("line",{x1:t.x+s.N,y1:t.y+t.height+s.N,x2:t.x+t.width+s.N,y2:t.y+t.height+s.N,stroke:s.iC.SHADDOW.COLOR,strokeWidth:_},`shadow-line-${t.id}`),(0,r.jsxs)("g",{transform:`translate(${t.x+1.1*t.width},${t.y})`,onClick:e=>{e.stopPropagation(),O({type:"SELECT_ELEMENT",payload:{id:t.id,ctrlKey:!1,shiftKey:!1}}),O({type:"EXPAND_ELEMENT"})},style:{cursor:"pointer"},"data-exclude-from-export":"true",children:[(0,r.jsx)("rect",{x:"0",y:"0",width:"24",height:"24",rx:"4",fill:"white",stroke:"#e0e0e0",strokeWidth:"1"}),(0,r.jsx)("svg",{x:"4",y:"4",width:"16",height:"16",viewBox:"0 0 24 24",children:(0,r.jsx)(x.A,{sx:{color:"#666666"},style:{width:"100%",height:"100%"}})})]})]}),(0,r.jsx)("defs",{children:(0,r.jsx)("filter",{id:"boxShadow",x:"-20%",y:"-20%",width:"140%",height:"140%",children:(0,r.jsx)("feDropShadow",{dx:"2",dy:"2",stdDeviation:"3",floodColor:"gray"})})}),(0,r.jsx)("rect",{x:t.x,y:t.y,width:t.width,height:t.height,rx:s.iC.RX,strokeWidth:_,stroke:t.texts.length>1?t.selected?B:t.tentative?"#9E9E9E":S:"transparent",strokeDasharray:t.tentative?"4 2":"none",onClick:e=>{e.stopPropagation(),O({type:"SELECT_ELEMENT",payload:{id:t.id,ctrlKey:e.ctrlKey||e.metaKey,shiftKey:e.shiftKey}})},onDoubleClick:()=>O({type:"EDIT_ELEMENT"}),onMouseDown:e=>p(e,t),onMouseEnter:P,onMouseLeave:F,"data-element-id":t.id,style:{fill:t.id===w&&"child"===n?s.iC.DRAGGING.COLOR:R,strokeOpacity:t.tentative?.6:1,pointerEvents:"all",cursor:A?"pointer":"default",filter:t.selected&&t.texts.length>1?"url(#boxShadow)":"none"}}),1===t.texts.length&&v&&(0,r.jsxs)(r.Fragment,{children:[t.selected&&(0,r.jsx)("line",{x1:t.x+2,y1:t.y+t.height+2,x2:t.x+t.width+1,y2:t.y+t.height+2,strokeOpacity:.4,stroke:S,strokeWidth:t.selected&&0===_?2:_,strokeLinecap:"round",pointerEvents:"none","data-exclude-from-export":"true"}),(0,r.jsx)("line",{x1:t.x,y1:t.y+t.height,x2:t.x+t.width,y2:t.y+t.height,stroke:t.selected?B:t.tentative?"#9E9E9E":S,strokeWidth:t.selected&&0===_?2:_,strokeDasharray:t.tentative?"4 2":"none",pointerEvents:"none"})]}),t.texts.map((e,i)=>(0,r.jsxs)(l.Fragment,{children:[!t.editing&&(0,r.jsx)(u,{x:t.x,y:t.y+t.sectionHeights.slice(0,i).reduce((e,t)=>e+t,0),width:t.width,height:t.sectionHeights[i],text:e,fontSize:s.gI,zoomRatio:I.zoomRatio,fontFamily:L,onHeightChange:e=>G(i,e)}),i<t.texts.length-1&&(0,r.jsx)("line",{x1:t.x,y1:t.y+t.sectionHeights.slice(0,i+1).reduce((e,t)=>e+t,0),x2:t.x+t.width,y2:t.y+t.sectionHeights.slice(0,i+1).reduce((e,t)=>e+t,0),stroke:S,strokeWidth:"1"})]},`${t.id}-section-${i}`))]})},t.id):null}),O=e=>{let{element:t,isHovered:i,currentDropTarget:l,dropPosition:n,isDraggedOrDescendant:o,siblingInfo:a,elements:s}=e;return c.y&&i?(0,r.jsx)("foreignObject",{x:t.x+t.width+10,y:t.y-10,width:"360",height:"420",className:"debug-info","data-exclude-from-export":"true",children:(0,r.jsxs)("div",{style:{fontSize:"11px",color:"black",backgroundColor:"white",border:"1px solid #ccc",padding:"5px",borderRadius:"4px",boxShadow:"0 2px 5px rgba(0,0,0,0.2)"},children:[(0,r.jsxs)("h3",{style:{margin:"0 0 5px 0"},children:["id: ",t.id]}),(0,r.jsx)("table",{style:{borderCollapse:"collapse",width:"100%"},children:(0,r.jsxs)("tbody",{children:[(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"position"}),(0,r.jsx)("td",{children:":"}),(0,r.jsxs)("td",{children:["x: ",t.x,", y: ",t.y]})]}),(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"size"}),(0,r.jsx)("td",{children:":"}),(0,r.jsxs)("td",{children:["width: ",t.width,", height: ",t.height]})]}),(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"texts"}),(0,r.jsx)("td",{children:":"}),(0,r.jsx)("td",{children:t.texts.map((e,t)=>(0,r.jsxs)("div",{children:[t,": ",e?`"${e}"`:"(empty)"]},t))})]}),(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"sectionHeights"}),(0,r.jsx)("td",{children:":"}),(0,r.jsx)("td",{children:t.sectionHeights.map((e,t)=>(0,r.jsxs)("div",{children:[t,": ",e]},t))})]}),(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"parent"}),(0,r.jsx)("td",{children:":"}),(0,r.jsx)("td",{children:t.parentId||"root"})]}),(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"depth"}),(0,r.jsx)("td",{children:":"}),(0,r.jsx)("td",{children:t.depth})]}),(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"order"}),(0,r.jsx)("td",{children:":"}),(0,r.jsx)("td",{children:t.order})]}),(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"children"}),(0,r.jsx)("td",{children:":"}),(0,r.jsx)("td",{children:t.children})]}),(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"direction"}),(0,r.jsx)("td",{children:":"}),(0,r.jsx)("td",{children:t.direction||"none"})]}),(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"startMarker"}),(0,r.jsx)("td",{children:":"}),(0,r.jsx)("td",{children:t.startMarker})]}),(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"endMarker"}),(0,r.jsx)("td",{children:":"}),(0,r.jsx)("td",{children:t.endMarker})]}),(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"selected"}),(0,r.jsx)("td",{children:":"}),(0,r.jsx)("td",{children:t.selected?"Yes":"No"})]}),(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"visible"}),(0,r.jsx)("td",{children:":"}),(0,r.jsx)("td",{children:t.visible?"Yes":"No"})]}),(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"editing"}),(0,r.jsx)("td",{children:":"}),(0,r.jsx)("td",{children:t.editing?"Yes":"No"})]}),(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"tentative"}),(0,r.jsx)("td",{children:":"}),(0,r.jsx)("td",{children:t.tentative?"Yes":"No"})]}),l&&l.id===t.id&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("tr",{children:(0,r.jsxs)("td",{colSpan:3,style:{color:"blue",fontWeight:"bold"},children:["DROP TARGET (",n,")"]})}),(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"target dir"}),(0,r.jsx)("td",{children:":"}),(0,r.jsx)("td",{children:t.direction||"none"})]}),"none"===t.direction&&(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"child dir guess"}),(0,r.jsx)("td",{children:":"}),(0,r.jsx)("td",{children:"Based on drop position"})]}),t.parentId&&(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"parent dir"}),(0,r.jsx)("td",{children:":"}),(0,r.jsx)("td",{children:s[t.parentId]?.direction||"none"})]})]}),o&&(0,r.jsx)("tr",{children:(0,r.jsx)("td",{colSpan:3,style:{color:"red"},children:"BEING DRAGGED"})}),a&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("tr",{children:(0,r.jsx)("td",{colSpan:3,style:{fontWeight:"bold"},children:"sibling info:"})}),a.prevElement&&(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"prev"}),(0,r.jsx)("td",{children:":"}),(0,r.jsxs)("td",{children:[a.prevElement.id," (order: ",a.prevElement.order,")"]})]}),a.nextElement&&(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:"next"}),(0,r.jsx)("td",{children:":"}),(0,r.jsxs)("td",{children:[a.nextElement.id," (order: ",a.nextElement.order,")"]})]})]})]})})]})}):null},C={"Ctrl+z":"UNDO","Ctrl+Shift+z":"REDO",ArrowUp:"ARROW_UP",ArrowDown:"ARROW_DOWN",ArrowRight:"ARROW_RIGHT","Ctrl+ArrowRight":"EXPAND_ELEMENT",ArrowLeft:"ARROW_LEFT","Ctrl+ArrowLeft":"COLLAPSE_ELEMENT","Ctrl+x":"CUT_ELEMENT","Ctrl+c":"COPY_ELEMENT","Ctrl+v":"PASTE_ELEMENT",Tab:"ADD_ELEMENT","Shift+Tab":"ADD_SIBLING_ELEMENT","Shift+Enter":"ADD_SIBLING_ELEMENT","Ctrl+Enter":"ADD_SIBLING_ELEMENT",Delete:"DELETE_ELEMENT",Backspace:"DELETE_ELEMENT",Enter:"EDIT_ELEMENT"},I={Tab:"NEXT_FIELD",Escape:"END_EDITING","Ctrl+Enter":"END_EDITING","Alt+Enter":"END_EDITING","Meta+Enter":"END_EDITING"};var v=i(573);let w=l.memo(e=>{let{element:t,onEndEditing:i}=e,{dispatch:n,state:o}=a(),c=y(),p=(0,l.useRef)([]),[u,x]=(0,l.useState)([]),[f,g]=(0,l.useState)(-1),m=(0,l.useRef)(null),E=(0,l.useRef)(void 0),[b,T]=(0,l.useState)(""),[O,C]=(0,l.useState)(""),[w,A]=(0,l.useState)("");(0,l.useEffect)(()=>{c&&(m.current=document.createElement("canvas").getContext("2d"),T((0,h.af)()),C((0,h.kN)()),A((0,h.vG)()))},[c]),(0,l.useEffect)(()=>{c&&t?.id!==E.current&&(x(t?.sectionHeights||[]),g(0),E.current=t?.id,setTimeout(()=>{let e=p.current[0];if(e){e.focus({preventScroll:!0});let i=t?.texts[0]?.length||0;e.setSelectionRange(i,i)}},50))},[t,c]);let j=(0,l.useCallback)(e=>{let t=s.SK.WIDTH.MAX,i=(0,d.C1)(e,t,o.zoomRatio).length,r=s.gI*s.RZ*o.zoomRatio,l=s.rF.VERTICAL*o.zoomRatio;return Math.max(s.SK.SECTION_HEIGHT*o.zoomRatio,i*r+l)},[o.zoomRatio]),k=(0,l.useCallback)((e,i)=>{let r=e.target.value;if(!(0,v.kb)(r)){console.warn("無効なテキスト入力が検出されました。安全でない内容が含まれている可能性があります。");return}let l=r.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"").replace(/javascript:/gi,"").replace(/data:/gi,"").replace(/on\w+\s*=/gi,""),a=j(l);x(e=>{let t=[...e];return t[i]=a/o.zoomRatio,t}),n({type:"UPDATE_TEXT",payload:{id:t.id,index:i,value:l}});let s=p.current[i];s&&(s.style.height=`${a}px`)},[t,o.zoomRatio,n,j]),R=(0,l.useCallback)(e=>{let r=e+1;if(t&&r<t.texts.length){let e=p.current[r];if(e){let{scrollX:i,scrollY:l}=window;e.focus({preventScroll:!0});let n=t.texts[r]?.length||0;e.setSelectionRange(n,n),g(r),window.scrollTo(i,l)}}else i?.(),n({type:"END_EDITING"})},[t,i,n]),D=(e,t)=>{let r=I[[e.ctrlKey&&"Ctrl",e.altKey&&"Alt",e.metaKey&&"Meta",e.key].filter(Boolean).join("+")];if(r)switch(e.preventDefault(),r){case"NEXT_FIELD":R(t);break;case"END_EDITING":i?.(),n({type:"END_EDITING"})}};return t&&c?(0,r.jsx)(r.Fragment,{children:t.texts.map((e,i)=>{let l=u.slice(0,i).reduce((e,t)=>e+t,0)*o.zoomRatio,n=s.SK.WIDTH.MAX*o.zoomRatio,a=j(e);return(0,r.jsx)("textarea",{ref:e=>{p.current[i]=e,i===f&&c&&e?.focus({preventScroll:!0})},value:e,onChange:e=>k(e,i),onKeyDown:e=>D(e,i),onClick:e=>e.stopPropagation(),style:{position:"absolute",left:`${t.x*o.zoomRatio}px`,top:`${t.y*o.zoomRatio+l}px`,width:`${n}px`,height:`${a}px`,minWidth:`${s.SK.WIDTH.MAX*o.zoomRatio}px`,maxWidth:`${s.SK.WIDTH.MAX*o.zoomRatio}px`,minHeight:`${s.SK.SECTION_HEIGHT*o.zoomRatio}px`,margin:"1px 1px",fontSize:`${s.gI*o.zoomRatio}px`,lineHeight:`${s.RZ}em`,padding:"0 3px",fontFamily:b,backgroundColor:O,color:w,boxSizing:"border-box",WebkitFontSmoothing:"antialiased",MozOsxFontSmoothing:"grayscale",overflow:"hidden",whiteSpace:"pre-wrap",wordWrap:"break-word",resize:"none",zIndex:1e4,opacity:1,transition:"all 0.2s ease-in-out",pointerEvents:"all"}},`${t.id}-${i}`)})}):null}),A={arrow:{id:"arrowhead",width:s.tl.WIDTH,height:s.tl.HEIGHT,isFilled:!1,shape:"polygon",pointsOrAttributes:`${s.tl.WIDTH} 0, ${s.tl.WIDTH} ${s.tl.HEIGHT}, 0 ${s.tl.HEIGHT/2}`},filledArrow:{id:"filledarrowhead",width:s.tl.WIDTH,height:s.tl.HEIGHT,isFilled:!0,shape:"polygon",pointsOrAttributes:`${s.tl.WIDTH} 0, ${s.tl.WIDTH} ${s.tl.HEIGHT}, 0 ${s.tl.HEIGHT/2}`},arrowEnd:{id:"arrowhead-end",width:s.tl.WIDTH,height:s.tl.HEIGHT,isFilled:!1,shape:"polygon",pointsOrAttributes:`0 0, 0 ${s.tl.HEIGHT}, ${s.tl.WIDTH} ${s.tl.HEIGHT/2}`},filledArrowEnd:{id:"filledarrowhead-end",width:s.tl.WIDTH,height:s.tl.HEIGHT,isFilled:!0,shape:"polygon",pointsOrAttributes:`0 0, 0 ${s.tl.HEIGHT}, ${s.tl.WIDTH} ${s.tl.HEIGHT/2}`},circle:{id:"circlemarker",width:s.p1.SIZE,height:s.p1.SIZE,isFilled:!1,shape:"circle",pointsOrAttributes:{cx:s.p1.SIZE/2,cy:s.p1.SIZE/2,r:s.p1.SIZE/2-1}},filledCircle:{id:"filledcirclemarker",width:s.p1.SIZE,height:s.p1.SIZE,isFilled:!0,shape:"circle",pointsOrAttributes:{cx:s.p1.SIZE/2,cy:s.p1.SIZE/2,r:s.p1.SIZE/2-1}},circleEnd:{id:"circlemarker-end",width:s.p1.SIZE,height:s.p1.SIZE,isFilled:!1,shape:"circle",pointsOrAttributes:{cx:s.p1.SIZE/2,cy:s.p1.SIZE/2,r:s.p1.SIZE/2-1}},filledCircleEnd:{id:"filledcirclemarker-end",width:s.p1.SIZE,height:s.p1.SIZE,isFilled:!0,shape:"circle",pointsOrAttributes:{cx:s.p1.SIZE/2,cy:s.p1.SIZE/2,r:s.p1.SIZE/2-1}},square:{id:"squaremarker",width:s.p1.SIZE,height:s.p1.SIZE,isFilled:!1,shape:"rect",pointsOrAttributes:{x:1,y:1,width:s.p1.SIZE-2,height:s.p1.SIZE-2}},filledSquare:{id:"filledsquaremarker",width:s.p1.SIZE,height:s.p1.SIZE,isFilled:!0,shape:"rect",pointsOrAttributes:{x:1,y:1,width:s.p1.SIZE-2,height:s.p1.SIZE-2}},squareEnd:{id:"squaremarker-end",width:s.p1.SIZE,height:s.p1.SIZE,isFilled:!1,shape:"rect",pointsOrAttributes:{x:1,y:1,width:s.p1.SIZE-2,height:s.p1.SIZE-2}},filledSquareEnd:{id:"filledsquaremarker-end",width:s.p1.SIZE,height:s.p1.SIZE,isFilled:!0,shape:"rect",pointsOrAttributes:{x:1,y:1,width:s.p1.SIZE-2,height:s.p1.SIZE-2}},diamond:{id:"diamondmarker",width:s.tl.WIDTH,height:s.tl.HEIGHT,isFilled:!1,shape:"polygon",pointsOrAttributes:`${s.tl.WIDTH/2},1 ${s.tl.WIDTH-1},${s.tl.HEIGHT/2} ${s.tl.WIDTH/2},${s.tl.HEIGHT-1} 1,${s.tl.HEIGHT/2}`},filledDiamond:{id:"filleddiamondmarker",width:s.tl.WIDTH,height:s.tl.HEIGHT,isFilled:!0,shape:"polygon",pointsOrAttributes:`${s.tl.WIDTH/2},1 ${s.tl.WIDTH-1},${s.tl.HEIGHT/2} ${s.tl.WIDTH/2},${s.tl.HEIGHT-1} 1,${s.tl.HEIGHT/2}`},diamondEnd:{id:"diamondmarker-end",width:s.tl.WIDTH,height:s.tl.HEIGHT,isFilled:!1,shape:"polygon",pointsOrAttributes:`${s.tl.WIDTH/2},1 ${s.tl.WIDTH-1},${s.tl.HEIGHT/2} ${s.tl.WIDTH/2},${s.tl.HEIGHT-1} 1,${s.tl.HEIGHT/2}`},filledDiamondEnd:{id:"filleddiamondmarker-end",width:s.tl.WIDTH,height:s.tl.HEIGHT,isFilled:!0,shape:"polygon",pointsOrAttributes:`${s.tl.WIDTH/2},1 ${s.tl.WIDTH-1},${s.tl.HEIGHT/2} ${s.tl.WIDTH/2},${s.tl.HEIGHT-1} 1,${s.tl.HEIGHT/2}`}},j=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=t?"-end":"";switch(e){case"arrow":return`url(#arrowhead${i})`;case"filled_arrow":return`url(#filledarrowhead${i})`;case"circle":return`url(#circlemarker${i})`;case"filled_circle":return`url(#filledcirclemarker${i})`;case"square":return`url(#squaremarker${i})`;case"filled_square":return`url(#filledsquaremarker${i})`;case"diamond":return`url(#diamondmarker${i})`;case"filled_diamond":return`url(#filleddiamondmarker${i})`;default:return}},k=e=>{let{connectionPathColor:t,connectionPathStroke:i}=e;return(0,r.jsx)(r.Fragment,{children:Object.values(A).map(e=>{let l;let{id:n,width:o,height:a,isFilled:s,shape:d,pointsOrAttributes:c}=e,h=s?t:"none",p={id:n,markerWidth:o,markerHeight:a,refX:n.endsWith("-end")?0:o,refY:a/2,orient:"auto",markerUnits:"userSpaceOnUse",viewBox:`0 0 ${o} ${a}`,strokeWidth:i,fill:h,stroke:t};return"polygon"===d?l=(0,r.jsx)("polygon",{points:c,fill:h,stroke:t}):"circle"===d?l=(0,r.jsx)("circle",{cx:c.cx,cy:c.cy,r:c.r,fill:h,stroke:t}):"rect"===d&&(l=(0,r.jsx)("rect",{x:c.x,y:c.y,width:c.width,height:c.height,fill:h,stroke:t})),(0,r.jsx)("marker",{...p,children:l},n)})})},R=e=>{let{popupX:t,popupY:i,isEndMarkerMenu:n,elementId:o,onMarkerSelect:a,onClose:s}=e,[d,c]=(0,l.useState)(null);return(0,r.jsx)("foreignObject",{x:t,y:i,width:150,height:270,className:"popup-menu",children:(0,r.jsx)("div",{className:"popup-menu",style:{position:"absolute",left:`${t}px`,top:`${i}px`,backgroundColor:"white",border:"1px solid #ccc",borderRadius:"4px",padding:"10px",boxShadow:"0 2px 10px rgba(0,0,0,0.2)",zIndex:1e3,display:"flex",flexDirection:"column",width:"150px",maxHeight:"300px",overflowY:"auto"},"data-exclude-from-export":"true",children:[{id:"arrow",label:"Arrow"},{id:"filled_arrow",label:"Filled Arrow"},{id:"circle",label:"Circle"},{id:"filled_circle",label:"Filled Circle"},{id:"square",label:"Square"},{id:"filled_square",label:"Filled Square"},{id:"diamond",label:"Diamond"},{id:"filled_diamond",label:"Filled Diamond"},{id:"none",label:"None"}].map(e=>(0,r.jsx)("div",{style:{padding:"4px 0",cursor:"pointer",backgroundColor:d===e.id?"#e0e0e0":"white"},onMouseEnter:()=>c(e.id),onMouseLeave:()=>c(null),onClick:()=>{a(o,e.id,n),s()},children:e.label},e.id))})})},D=e=>{let{element:t,absolutePosition:i,isEndMarker:l=!1,hoverId:n,onHover:o,onShowMenu:a,_isInGroup:d=!1}=e;if(l&&!t.parentId)return null;let c=t.height,h=l?`end-${t.id}`:t.id,p=l?i.x-s.tl.WIDTH/2:i.x+t.width+s.tl.WIDTH/2;return(0,r.jsxs)("g",{"data-marker-button":`${h}`,"data-exclude-from-export":"true",pointerEvents:"all",children:[n===h&&(0,r.jsx)("circle",{cx:p,cy:i.y+c/2,r:s.tl.WIDTH/2,fill:"#bfbfbf",opacity:.5,pointerEvents:"none"}),(0,r.jsx)("circle",{cx:p,cy:i.y+c/2,r:s.tl.WIDTH/2,fill:"transparent",stroke:"transparent",strokeWidth:2,onMouseEnter:()=>o(h),onMouseLeave:()=>o(null),onClick:()=>a(h),style:{cursor:"pointer"},pointerEvents:"all"})]},`marker-button-${h}`)},S=e=>{let{parentElement:t,element:i,absolutePositions:l,strokeColor:n=s.lB.COLOR,strokeWidth:o=s.lB.STROKE}=e,a=0;switch(t.startMarker){case"arrow":case"filled_arrow":case"diamond":case"filled_diamond":a=s.tl.OFFSET;break;case"circle":case"filled_circle":case"square":case"filled_square":a=s.p1.OFFSET;break;default:a=0}let d=0;switch(i.endMarker){case"arrow":case"filled_arrow":case"diamond":case"filled_diamond":d=s.tl.OFFSET;break;case"circle":case"filled_circle":case"square":case"filled_square":d=s.p1.OFFSET;break;default:d=0}let c=l.parent,h=l.element,p=i.height,u=i.direction||"right",x="";x="none"===t.direction?"left"===u?`M ${c.x},${c.y+t.height/2} C ${c.x-s.mO},${c.y+t.height/2} ${h.x+i.width+s.mO},${h.y+p/2} ${h.x+i.width+d},${h.y+p/2}`:`M ${c.x+t.width},${c.y+t.height/2} C ${c.x+t.width+s.mO},${c.y+t.height/2} ${h.x-s.mO},${h.y+p/2} ${h.x-d},${h.y+p/2}`:"left"===u?`M ${c.x},${c.y+t.height/2} C ${c.x-s.mO},${c.y+t.height/2} ${h.x+i.width+s.mO},${h.y+p/2} ${h.x+i.width+d},${h.y+p/2}`:`M ${c.x+t.width+a},${c.y+t.height/2} C ${c.x+t.width+s.mO},${c.y+t.height/2} ${h.x-s.mO},${h.y+p/2} ${h.x-d},${h.y+p/2}`;let f=j(t.startMarker),g=j(i.endMarker,!0);return(0,r.jsx)("path",{d:x,stroke:n,strokeWidth:o,fill:"none",markerStart:f,markerEnd:g,style:{pointerEvents:"none"}})},N=e=>{let t=Object.values(e),i=Math.max(...t.map(e=>e.x+e.width)),r=Math.max(...t.map(e=>e.y+e.height));return{width:i+s.e$.X,height:r+s.SK.SECTION_HEIGHT*s.zX}},_=e=>{let{setCanvasSize:t,setDisplayArea:i,state:r,isClient:n}=e;(0,l.useEffect)(()=>{if(!n)return;let e=N(r.elements),l=window.innerHeight-s.uF;e.width=Math.max(e.width,window.innerWidth),e.height=Math.max(e.height,l);let o={width:e.width,height:e.height};e.width*=r.zoomRatio,e.height*=r.zoomRatio,t(e),i(`0 0 ${o.width} ${o.height}`)},[r.elements,r.zoomRatio,t,i,n])},$=(e,t)=>{let{dispatch:i}=a();(0,l.useEffect)(()=>{let r=e.current,l=e=>{e.target instanceof SVGElement&&"svg"===e.target.tagName&&(i({type:"DESELECT_ALL"}),t&&i({type:"END_EDITING"}))};return r?.addEventListener("mousedown",l),()=>{r?.removeEventListener("mousedown",l)}},[e,t,i])},L={invalidDrop:"無効なドロップ操作です",dropChildElement:"子要素にドロップすることはできません",dropSelfChild:"自身の子要素に移動することはできません",dropCircularReference:"循環参照となるため移動できません",dropInvalidHierarchy:"要素の階層構造が不正となるため移動できません",noSelect:"要素を選択してから実行してください",dragError:"ドラッグ操作中にエラーが発生しました",aiError:"AI処理に失敗しました",noApiKey:"APIキーが設定されていません",noPrompt:"入力情報(プロンプト)が設定されていません",clipboardEmpty:"クリップボードにテキストがありません",clipboardReadError:"クリップボードの読み取りに失敗しました"};var M=i(7451);let B=e=>"touches"in e,H=(e,t)=>Object.values(t).filter(t=>t.parentId===e.id&&t.visible).sort((e,t)=>e.order-t.order),U=()=>{let{state:e,dispatch:t}=a(),{addToast:i}=(0,M.d)(),[r,n]=(0,l.useState)(null),[o,d]=(0,l.useState)({x:0,y:0}),[h,p]=(0,l.useState)(null),u=(0,l.useRef)(new Map),x=(0,l.useCallback)(t=>{let i,r;return B(t)?(i=t.touches[0].clientX+window.scrollX,r=t.touches[0].clientY+window.scrollY):(i=t.clientX+window.scrollX,r=t.clientY+window.scrollY),{x:i/e.zoomRatio,y:(r-s.uF)/e.zoomRatio}},[e.zoomRatio]),f=(0,l.useCallback)((e,t,i)=>{let r;let l=e.y,n=H(e,i),o=e.direction||"right",a="none"===e.direction&&null===e.parentId,d=o;return a&&(d="right"),r="left"===o||a&&"left"===d?e.x-s.e$.X:e.x+e.width+s.e$.X,n.length,{position:"child",insertY:l+e.height/2,insertX:r}},[]),g=(0,l.useCallback)((e,t,i,l)=>{let n;let o=e.y,a=e.y+e.height,d=e.x,h=e.x+e.width,p="none"===e.direction&&null===e.parentId,u=p?2*s.e$.X+(r?.width??0):s.e$.X+(r?.width??0),x=p?2*s.e$.X+(r?.width??0):s.e$.X+(r?.width??0),g=e.direction||"right",m=t>=h&&t<h+u,E=t<=d&&t>d-x,y=t>=e.x&&t<h&&i>=o&&i<=a,b=m&&i>=o&&i<=a,T=E&&i>=o&&i<=a;p&&((0,c.c)(`[Root calc] mouseX: ${t}, elemLeft: ${d}, elemRight: ${h}`),(0,c.c)(`[Root calc] leftPadding: ${x}, rightPadding: ${u}`),(0,c.c)(`[Root calc] isOnLeftSide: ${E}, isOnRightSide: ${m}`),(0,c.c)(`[Root calc] leftSideInRange: ${T}, rightSideInRange: ${b}`),(0,c.c)(`[Root calc] insideElement: ${y}`));let O=p&&(b||T)||"right"===g&&b||"left"===g&&T;if(p&&(0,c.c)(`[Root calc] isOnValidSide: ${O}, direction: ${g}`),y)n=f(e,i,l),(0,c.c)("Drop position mode (inside element):","child");else if(O){let t=H(e,l),o=g;if(p&&(o=T?"left":"right"),0===t.length){let t="left"===o?e.x-s.e$.X-(r?.width??0):e.x+e.width+s.e$.X;n={position:"child",insertY:e.y+e.height/2,insertX:t,siblingInfo:{}},(0,c.c)(`Drop position mode (${o} side, no children):`,"child")}else{let l,a;let d="left"===o?e.x-s.e$.X-(r?.width??0):e.x+e.width+s.e$.X,h=p?t.filter(e=>e.direction===o):t;for(let e=0;e<h.length;e++){let t=h[e];if(i<t.y){a=t,e>0&&(l=h[e-1]);break}if(i<t.y+t.height){i<t.y+t.height/2?(a=t,e>0&&(l=h[e-1])):(l=t,e<h.length-1&&(a=h[e+1]));break}if(e===h.length-1||i<h[e+1].y){l=t,e<h.length-1&&(a=h[e+1]);break}}if(l&&a){let e=a.y-(l.y+l.height);n={position:"between",insertY:l.y+l.height+e/2,insertX:d,siblingInfo:{prevElement:l,nextElement:a}}}else n=l?{position:"between",insertY:l.y+l.height+s.e$.Y,insertX:d,siblingInfo:{prevElement:l}}:a?{position:"between",insertY:a.y-s.e$.Y,insertX:d,siblingInfo:{nextElement:a}}:{position:"between",insertY:e.y+e.height/2,insertX:d,siblingInfo:{}};(0,c.c)(`Drop position mode (${o} side, with children):`,"between")}}else{let t;let o=r?.id,a=Object.values(l).filter(t=>t.visible&&t.parentId===e.parentId&&t.depth===e.depth&&t.id!==o).sort((e,t)=>e.y-t.y);(0,c.c)(`[calculatePositionAndDistance] Found ${a.length} siblings (excluding dragging element) for element ${e.id}`);let d=null,h=null;for(let e=0;e<a.length;e++){let t=a[e];if(t.id===r?.id)continue;let l=t.y+t.height;if(i<t.y){h=t,e>0&&(d=a[e-1]);break}if(i<l){i<t.y+t.height/2?(h=t,e>0&&(d=a[e-1])):(d=t,e<a.length-1&&(h=a[e+1]));break}d=t,e<a.length-1&&(h=a[e+1])}let p="right";d&&d.direction?p=d.direction:h&&h.direction?p=h.direction:e.direction&&"none"!==e.direction&&(p=e.direction);let u=e.parentId?l[e.parentId]:null;if(t=u?"left"===p?u.x-s.e$.X-(r?.width??0):u.x+u.width+s.e$.X:"left"===p?e.x-s.e$.X-(r?.width??0):e.x+e.width+s.e$.X,d&&h){let e=h.y-(d.y+d.height);n={position:"between",insertY:d.y+d.height+e/2,insertX:t,siblingInfo:{prevElement:d,nextElement:h}}}else n=d?{position:"between",insertY:d.y+d.height+s.e$.Y,insertX:t,siblingInfo:{prevElement:d}}:h?{position:"between",insertY:h.y-s.e$.Y,insertX:t,siblingInfo:{nextElement:h}}:{position:"between",insertY:e.y+e.height+s.e$.Y,insertX:t,siblingInfo:{}};(0,c.c)(`Drop position mode (between siblings) - direction: ${p}, insertX: ${t}`,"between")}let C=e.x+e.width/2,I=e.y+e.height/2,v=t-C,w=i-I,A=v*v+w*w;return p&&(0,c.c)(`[Root calc] Final result - position: ${n.position}, distanceSq: ${A}, insertY: ${n.insertY}`),{...n,distanceSq:A}},[f,r,e.zoomRatio]),E=(0,l.useCallback)((e,t)=>{if(!r)return null;let i=x(e),l=i.x,n=i.y,o=Object.values(t).filter(e=>e.selected).map(e=>e.id),a=Object.values(t).filter(e=>{if(!e.visible||o.includes(e.id))return!1;let t=e.y,i=e.y+e.height,a=e.x,d=e.x+e.width,h="none"===e.direction&&null===e.parentId,p=h?2*s.e$.X+(r?.width??0):s.e$.X,u=h?2*s.e$.X+(r?.width??0):s.e$.X,x=t-s.e$.Y,f=i+s.e$.Y,g=a-p,m=d+u,E=l>=g&&l<=m&&n>=x&&n<=f;return h&&(0,c.c)(`[Root drop area] mouse(${l},${n}), area(${g},${x},${m},${f}), inArea: ${E}`),E});(0,c.c)(`[findDropTarget] Found ${a.length} candidates`),a.forEach(e=>{let t="none"===e.direction&&null===e.parentId;(0,c.c)(`[findDropTarget] Candidate: ${e.id}, isRoot: ${t}`)});let d={};for(let e in Object.values(t).filter(e=>e.visible&&!o.includes(e.id)).forEach(e=>{let t=e.parentId||"root";d[t]||(d[t]=[]),d[t].push(e)}),d)d[e].sort((e,t)=>e.y-t.y);for(let[e,i]of Object.entries(d)){if(i.length<2)continue;let o="root"!==e?t[e]:null;if(o&&"none"===o.direction&&null===o.parentId){let e=i.filter(e=>"left"===e.direction).sort((e,t)=>e.y-t.y),t=i.filter(e=>"right"===e.direction).sort((e,t)=>e.y-t.y);for(let t=0;t<e.length-1;t++){let i=e[t],a=e[t+1],d=a.y-(i.y+i.height);if(d<5)continue;let h=i.y+i.height,p=a.y,u=o.x-2*s.e$.X-(r?.width??0),x=o.x;if((0,c.c)(`[Left gap check] mouse(${l},${n}), gapArea(${u},${h},${x},${p})`),l>=u&&l<=x&&n>=h&&n<=p)return(0,c.c)(`[Left gap found] Between ${i.id} and ${a.id}`),{element:i,position:"between",insertY:h+d/2,insertX:o.x-s.e$.X-(r?.width??0),siblingInfo:{prevElement:i,nextElement:a}}}for(let e=0;e<t.length-1;e++){let i=t[e],a=t[e+1],d=a.y-(i.y+i.height);if(d<5)continue;let h=i.y+i.height,p=a.y,u=o.x+o.width,x=u+2*s.e$.X+(r?.width??0);if((0,c.c)(`[Right gap check] mouse(${l},${n}), gapArea(${u},${h},${x},${p})`),l>=u&&l<=x&&n>=h&&n<=p)return(0,c.c)(`[Right gap found] Between ${i.id} and ${a.id}`),{element:i,position:"between",insertY:h+d/2,insertX:o.x+o.width+s.e$.X,siblingInfo:{prevElement:i,nextElement:a}}}}else{i.sort((e,t)=>e.y-t.y);for(let e=0;e<i.length-1;e++){let t=i[e],r=i[e+1],o=r.y-(t.y+t.height);if(o<5)continue;let a=t.y+t.height,s=r.y,d=t.x+t.width,c=r.x+r.width,h=Math.min(t.x,r.x),p=Math.max(d,c);if(l>=h&&l<=p&&n>=a&&n<=s)return{element:t,position:"between",insertY:a+o/2,siblingInfo:{prevElement:t,nextElement:r}}}}}for(let[e,i]of Object.entries(d)){let r,o;if(0===i.length)continue;let a=i.reduce((e,t)=>t.y+t.height>e.y+e.height?t:e,i[0]),d="root"!==e?t[e]:null;d?o=(r=d.x+d.width)+2*s.e$.X+a.width:(r=a.x-s.e$.X,o=a.x+a.width+s.e$.X);let c=a.y+a.height+2*s.e$.Y;if(l>=r&&l<=o&&n>=a.y+a.height&&n<=c)return{element:a,position:"between",insertY:a.y+a.height+s.e$.Y,siblingInfo:{prevElement:a}}}let h=null,p=1/0;for(let e of a){let{position:i,distanceSq:r,insertY:o,insertX:a,siblingInfo:s}=g(e,l,n,t),d="none"===e.direction&&null===e.parentId,u=d&&("child"===i||"between"===i);if((0,c.c)(`[findDropTarget] Checking element ${e.id}, isRoot: ${d}, position: ${i}, distance: ${r}`),u){(0,c.c)(`[findDropTarget] PRIORITY: Valid root side drop detected for element ${e.id}, position: ${i}`),h={element:e,position:i,insertY:o,insertX:a,siblingInfo:s};break}r<p&&(p=r,h={element:e,position:i,insertY:o,insertX:a,siblingInfo:s},(0,c.c)(`[findDropTarget] New closest: ${e.id}, distance: ${r}`))}return h?(0,c.c)(`[findDropTarget] Final selection: ${h.element.id}, position: ${h.position}`):(0,c.c)("[findDropTarget] No drop target found"),h},[r,x,g]),y=(0,l.useCallback)((t,i)=>{let r;if(!i.selected||!i.parentId)return;t.stopPropagation(),t.nativeEvent instanceof TouchEvent&&t.preventDefault();let l=x(t.nativeEvent);n(i),d({x:l.x-i.x,y:l.y-i.y}),(0,c.c)(`[Drag started] Element: ${i.id}, startPos: (${l.x}, ${l.y})`),u.current.clear(),Object.values(e.elements).filter(e=>e.selected).forEach(e=>{u.current.set(e.id,{x:e.x,y:e.y})})},[x,e.elements,t]),b=(0,l.useCallback)(()=>{Object.values(e.elements).filter(e=>e.selected).forEach(e=>{let i=u.current.get(e.id);i&&t({type:"MOVE_ELEMENT",payload:{id:e.id,x:i.x,y:i.y}})}),n(null),u.current.clear()},[e.elements,t]),T=(0,l.useCallback)((t,i)=>{if(null===i)return{isValid:!0};if(t.id===i)return(0,c.c)(`無効な操作: 自分自身を親にしようとしています element=${t.id}, newParentId=${i}`),{isValid:!1,errorMessage:L.dropSelfChild};if((0,m.K9)(e.elements,t.id,i)){let r=e.elements[i]?.parentId===t.id;return(0,c.c)(`無効な操作: ${r?"自身の子要素":"循環参照"} element=${t.id}, newParentId=${i}`),{isValid:!1,errorMessage:r?L.dropSelfChild:L.dropCircularReference}}let r=i&&e.elements[i]?.depth||0;return r>=10?((0,c.c)(`無効な操作: 最大深さ超過 currentDepth=${r}, max=10`),{isValid:!1,errorMessage:L.dropInvalidHierarchy}):{isValid:!0}},[e.elements]),O=(0,l.useCallback)((e,r)=>{let l=r.find(t=>!T(t,e.id).isValid);if(l){let{errorMessage:t}=T(l,e.id);return i(t||L.dropChildElement,"warn"),b(),!1}return t({type:"SNAPSHOT"}),r.forEach((i,r)=>{let l;let n=e.depth+1;l="none"===e.direction&&null===e.parentId?h?.insertX!==void 0?h.insertX<e.x?"left":"right":i.x<e.x?"left":"right":e.direction||"right",t({type:"DROP_ELEMENT",payload:{id:i.id,oldParentId:i.parentId,newParentId:e.id,newOrder:e.children+r,depth:n,direction:l}})}),!0},[T,i,b,t]),C=(0,l.useCallback)((r,l)=>{let n;if((0,c.c)(`[processBetweenDrop] target=${r.id}, siblingInfo: ${JSON.stringify({prevElementId:h?.siblingInfo?.prevElement?.id,nextElementId:h?.siblingInfo?.nextElement?.id})}`),h?.siblingInfo){let{prevElement:e,nextElement:t}=h.siblingInfo;e&&t?((0,c.c)(`  Between two elements: prev=${e.id}(order=${e.order}), next=${t.id}(order=${t.order})`),n=e.parentId):e?((0,c.c)(`  After last element: prev=${e.id}(order=${e.order})`),n=e.parentId):t?((0,c.c)(`  Before first element: next=${t.id}(order=${t.order})`),n=t.parentId):((0,c.c)(`  No siblings: target=${r.id}`),n=r.id)}else(0,c.c)(`  No siblings info: target=${r.id}`),n=r.id;if(null===n&&!l.every(e=>1===e.depth))return i(L.invalidDrop,"warn"),b(),!1;let o=l.find(e=>!T(e,n).isValid);if(o){let{errorMessage:e}=T(o,n);return i(e||L.dropChildElement,"warn"),b(),!1}t({type:"SNAPSHOT"});let a=l.some(e=>e.parentId===n),s=l.filter(e=>e.parentId===n),d=I(h,s);return a?v(s,d.baseOrder,n):w(d.baseOrder,l.length,n),l.forEach((i,l)=>{let o;let a=n===r.id?r.depth+1:r.depth;if(n){let t=e.elements[n];if(t?.direction==="none"&&t?.parentId===null){if(h?.siblingInfo){let{prevElement:e,nextElement:t}=h.siblingInfo;if(e&&e.direction)o=e.direction,(0,c.c)(`[processBetweenDrop] Between mode - inherit direction from prev: ${o}`);else if(t&&t.direction)o=t.direction,(0,c.c)(`[processBetweenDrop] Between mode - inherit direction from next: ${o}`);else if(h&&r){let e=r.x+r.width/2;o=(void 0!==h.insertX?h.insertX:e)<e?"left":"right",(0,c.c)(`[processBetweenDrop] Between mode fallback - mouse position: ${o}`)}else o="right"}else if(h&&r){let e=r.x+r.width/2,t=void 0!==h.insertX?h.insertX:e;o=t<e?"left":"right",(0,c.c)(`[processBetweenDrop] Root drop direction: ${o}, mouseX: ${t}, rootCenterX: ${e}`)}else o="right"}else o=t?.direction||"right"}t({type:"DROP_ELEMENT",payload:{id:i.id,oldParentId:i.parentId,newParentId:n,newOrder:d.baseOrder+l,depth:a,direction:o}})}),!0},[h,T,i,b,t,e.elements]),I=(0,l.useCallback)((e,t)=>{let i=0;if(e?.siblingInfo){let{prevElement:r,nextElement:l}=e.siblingInfo;r&&l?i=t.some(e=>e.order>r.order&&e.order<l.order)?t[0].order:t.every(e=>e.order<r.order)?l.order-t.length:r.order+1:r?i=r.order+1:l&&(t.some(e=>0===e.order)&&(l.order,t.length),i=0)}else i=0;return{baseOrder:i}},[]),v=(0,l.useCallback)((i,r,l)=>{if(0===i.length)return;let n=i.map(e=>e.order).sort((e,t)=>e-t),o=n[0],a=n[n.length-1];a<r?Object.values(e.elements).filter(e=>e.parentId===l&&e.order>a&&e.order<r+i.length&&!i.some(t=>t.id===e.id)).forEach(e=>{t({type:"UPDATE_ELEMENT_ORDER",payload:{id:e.id,order:e.order-i.length}})}):o>r&&Object.values(e.elements).filter(e=>e.parentId===l&&e.order>=r&&e.order<o&&!i.some(t=>t.id===e.id)).forEach(e=>{t({type:"UPDATE_ELEMENT_ORDER",payload:{id:e.id,order:e.order+i.length}})})},[e.elements,t]),w=(0,l.useCallback)((i,r,l)=>{Object.values(e.elements).filter(e=>e.parentId===l&&e.order>=i).forEach(e=>{t({type:"UPDATE_ELEMENT_ORDER",payload:{id:e.id,order:e.order+r}})})},[e.elements,t]),A=(0,l.useCallback)(async()=>{if(r)try{let t=Object.values(e.elements).filter(e=>e.selected);if(h){let{element:e,position:r}=h,l=t.find(t=>!T(t,e.id).isValid);if(l){let{errorMessage:t}=T(l,e.id);i(t||L.dropChildElement,"warn"),b();return}let n=!1;if("child"===r?n=O(e,t):"between"===r&&(n=C(e,t)),!n){b();return}}else b()}catch(e){(0,c.c)("Drag error:",e),i(L.dragError,"warn"),b()}finally{n(null),p(null),u.current.clear()}},[r,h,e.elements,t,i,b,O,C,T]),j=(0,l.useCallback)(i=>{if(!r)return;i instanceof TouchEvent&&1===i.touches.length&&i.preventDefault();let l=E(i,e.elements);(!h&&l||h&&!l||h&&l&&(h.element.id!==l.element.id||h.position!==l.position||"between"===l.position&&h.insertY!==l.insertY))&&p(l);let n=x(i),a={x:n.x-o.x,y:n.y-o.y};t({type:"MOVE_ELEMENT",payload:{id:r.id,...a}})},[r,h,e.elements,E,x,o,t]);return(0,l.useEffect)(()=>{if(!r)return;let e=e=>j(e),t=e=>{1===e.touches.length&&j(e)},i=()=>A(),l=()=>A();return document.addEventListener("mousemove",e),document.addEventListener("touchmove",t,{passive:!1}),document.addEventListener("mouseup",i),document.addEventListener("touchend",l),()=>{document.removeEventListener("mousemove",e),document.removeEventListener("touchmove",t),document.removeEventListener("mouseup",i),document.removeEventListener("touchend",l)}},[r,j,A]),{handleMouseDown:y,handleMouseUp:A,currentDropTarget:h?.element||null,dropPosition:h?.position||null,draggingElement:r,dropInsertY:h?.insertY||void 0,siblingInfo:h?.siblingInfo||null}},X=e=>{let{handleMouseDown:t,elements:i}=e,[r,n]=(0,l.useState)(!1),[o,a]=(0,l.useState)(0),[s,d]=(0,l.useState)({x:0,y:0}),c=(0,l.useCallback)(e=>{if(2===e.touches.length){n(!0);let t=e.touches[0],i=e.touches[1];a(Math.hypot(i.clientX-t.clientX,i.clientY-t.clientY)),d({x:window.scrollX,y:window.scrollY})}else if(1===e.touches.length){e.preventDefault();let r=e.touches[0],l=document.elementFromPoint(r.clientX,r.clientY);if(l&&(function(e){return null!==e&&e instanceof SVGRectElement}(l)||function(e){return null!==e&&e instanceof SVGGElement}(l))){let r=l,n=null;for(;r&&!n;){if(function(e){return null!==e&&"dataset"in e}(r)&&r.dataset.elementId){n=r.dataset.elementId;break}r=r.parentElement}if(n){let r=i[n];r&&t(e,r)}}}},[i,t]),h=(0,l.useCallback)(e=>{if(r&&2===e.touches.length){e.preventDefault();let t=e.touches[0],i=e.touches[1],r=Math.hypot(i.clientX-t.clientX,i.clientY-t.clientY),l=t.clientX-i.clientX,n=Math.atan2(t.clientY-i.clientY,l),a=r/o,d=(t.clientX+i.clientX)/2,c=(t.clientY+i.clientY)/2;window.scrollTo({left:s.x+d*(a-1)*Math.cos(n),top:s.y+c*(a-1)*Math.sin(n),behavior:"auto"})}else 1===e.touches.length&&e.preventDefault()},[r,o,s]);return{isPinching:r,handleTouchStart:c,handleTouchMove:h,handleTouchEnd:(0,l.useCallback)(()=>{n(!1),a(0),d({x:0,y:0})},[])}};var G=i(5439);let P=e=>{let{dispatch:t,elements:i,addToast:r}=e;return(0,l.useCallback)(async e=>{e.preventDefault();let l=C[`${e.ctrlKey||e.metaKey?"Ctrl+":""}${e.shiftKey?"Shift+":""}${e.key}`];if("PASTE_ELEMENT"===l){let e=(0,G.Lt)();if(e&&Object.keys(e).length>0)t({type:l});else try{let e=await navigator.clipboard.readText(),l=Object.values(i).find(e=>e.selected);if(!l){r(L.noSelect);return}if(e){let i=e.split("\n").filter(e=>""!==e.trim());if(0===i.length){r(L.clipboardEmpty);return}t({type:"ADD_ELEMENTS_SILENT",payload:{parentId:l.id,texts:i}})}else r(L.clipboardEmpty)}catch(e){console.error("クリップボード読み取りエラー:",e),r(L.clipboardReadError)}}else l&&("ADD_ELEMENT"===l?t({type:l,payload:{}}):t({type:l}))},[t,i,r])},F=e=>{let t,i,{elements:r,currentDropTarget:l,draggingElement:n,dropPosition:o,dropInsertY:a,siblingInfo:d}=e,c=l.direction||"right",h="none"===l.direction&&null===l.parentId,p=c;if(h&&"child"===o&&d&&(d.prevElement?p=d.prevElement.direction:d.nextElement&&(p=d.nextElement.direction)),"child"===o)t="left"===c||h&&"left"===p?l.x-s.e$.X-n.width:l.x+l.width+s.e$.X,i=a?a-n.height/2:l.y+l.height/2-n.height/2;else{if("between"!==o&&"sibling"!==o)return null;let e=l.parentId?r[l.parentId]:null;if(e){let r=e.direction||"right";if(t="left"===(p="none"===e.direction?l.direction||"right":r)?e.x-s.e$.X-n.width:e.x+e.width+s.e$.X,d){let{prevElement:e,nextElement:t}=d;i=t&&!e?t.y-n.height:e&&!t?e.y+e.height:e&&t?a?a-n.height/2:(e.y+e.height+t.y)/2-n.height/2:a?a-n.height/2:l.y+l.height/2-n.height/2}else i=a?a-n.height/2:l.y+l.height/2-n.height/2}else t=s.e$.X,i=a?a-n.height/2:l.y+l.height/2-n.height/2}return{x:t,y:i}},W={outline:"none",userSelect:"none",WebkitUserSelect:"none"},K={position:"fixed",top:s.uF,left:0,width:"100vw",height:"calc(100vh - "+s.uF+"px)",overflow:"hidden",zIndex:-1},z={position:"absolute",top:s.uF,left:0,right:0,minWidth:"100%",minHeight:"calc(100vh - "+s.uF+"px)",overflow:"auto"},Y=l.memo(e=>{let{isHelpOpen:t,toggleHelp:i}=e,n=(0,l.useRef)(null),[o,d]=(0,l.useState)(!1),{state:c,dispatch:p}=a(),{elements:u}=c,[x,f]=(0,l.useState)(s.BH),[g,E]=(0,l.useState)(s._o),[y,b]=(0,l.useState)(s.i_),{addToast:C}=(0,M.d)(),[I,v]=(0,l.useState)({width:0,height:0}),[A,j]=(0,l.useState)("0 0 0 0"),N=Object.values(u).find(e=>e.editing),[L,B]=(0,l.useState)(null),[H,G]=(0,l.useState)(null),[Y,V]=(0,l.useState)({});_({setCanvasSize:v,setDisplayArea:j,state:c,isClient:o}),$(n,!!N);let{handleMouseDown:Z,handleMouseUp:q,currentDropTarget:J,dropPosition:Q,draggingElement:ee,dropInsertY:et,siblingInfo:ei}=U(),{isPinching:er,handleTouchStart:el,handleTouchMove:en,handleTouchEnd:eo}=X({handleMouseDown:Z,elements:c.elements}),ea=P({dispatch:p,elements:c.elements,addToast:C});(0,l.useEffect)(()=>{N||requestAnimationFrame(()=>{let{scrollX:e,scrollY:t}=window;n.current?.focus({preventScroll:!0}),window.scrollTo(e,t)})},[N]),(0,l.useEffect)(()=>{d(!0),f((0,h.ZF)()||s.BH),E((0,h.S4)()||s._o),b((0,h.Es)()||s.i_)},[]);let es=(e,t,i)=>{i?p({type:"UPDATE_END_MARKER",payload:{id:e,endMarker:t}}):p({type:"UPDATE_START_MARKER",payload:{id:e,startMarker:t}}),G(null)},ed=(0,l.useCallback)((e,t)=>{ee||V(i=>{if(i[e]===t)return i;let r={...i};return t?r[e]=!0:Object.prototype.hasOwnProperty.call(r,e)&&delete r[e],r})},[ee]);return(0,l.useEffect)(()=>{let e=e=>{H&&!e.target.closest(".popup-menu")&&G(null)};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[H]),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{style:{...K,backgroundColor:y}}),(0,r.jsxs)("div",{style:{...z,touchAction:er?"none":"manipulation",backgroundColor:y},children:[o&&(0,r.jsxs)("svg",{"data-testid":"view-area",ref:n,width:I.width,height:I.height,viewBox:A,tabIndex:0,onKeyDown:ea,onTouchStart:el,onTouchMove:en,onTouchEnd:eo,style:{...W,touchAction:er?"none":"manipulation",backgroundColor:y},className:"svg-element",children:[(0,r.jsx)("defs",{children:(0,r.jsx)(k,{connectionPathColor:x,connectionPathStroke:g})}),(()=>{let e={},t=[];return Object.values(u).filter(e=>e.visible).forEach(i=>{let r=i.parentId?`${i.parentId}_${i.depth}`:"root";e[r]||(e[r]=[]),e[r].push(i),i.parentId&&Object.values(u).some(e=>e.parentId===i.id&&e.visible)&&t.push(i)}),(0,r.jsxs)(r.Fragment,{children:[Object.entries(e).flatMap(e=>{let[t,i]=e;if("root"===t)return i.map(e=>{let t=Object.values(u).some(t=>t.parentId===e.id&&t.visible);return(0,r.jsxs)(l.Fragment,{children:[(0,r.jsx)(T,{element:e,currentDropTarget:J,dropPosition:Q,draggingElement:ee,handleMouseDown:Z,handleMouseUp:q,onHoverChange:ed,_dropInsertY:et,_siblingInfo:ei}),t&&(0,r.jsx)(D,{element:e,absolutePosition:{x:e.x,y:e.y},hoverId:L,onHover:B,onShowMenu:G})]},e.id)});let[n]=t.split("_"),o=u[n];if(!o)return[];let a=o.x+o.width+s.e$.X,d=o.y;return[(0,r.jsx)("g",{transform:`translate(${a}, ${d})`,className:"element-group","data-parent-id":n,"data-depth":i[0].depth,children:i.map(e=>{let t=e.x-a,i=e.y-d;return(0,r.jsx)(T,{element:{...e,x:t,y:i},currentDropTarget:J,dropPosition:Q,draggingElement:ee,handleMouseDown:t=>{Z(t,e)},handleMouseUp:q,onHoverChange:ed,_dropInsertY:et,_siblingInfo:ei},e.id)})},t)]}),t.map(e=>(0,r.jsx)(D,{element:e,absolutePosition:{x:e.x,y:e.y},hoverId:L,onHover:B,onShowMenu:G},`marker-start-${e.id}`))]})})(),Object.values(u).filter(e=>e.visible&&!!e.parentId).map(e=>{let t=e.parentId;if(!t)return null;let i=u[t];return ee&&(e.id===ee.id||(0,m.K9)(u,ee.id,e.id))?null:(0,r.jsxs)(l.Fragment,{children:[(0,r.jsx)(S,{parentElement:i,element:e,absolutePositions:{parent:{x:i.x,y:i.y},element:{x:e.x,y:e.y}},strokeColor:x,strokeWidth:g}),(0,r.jsx)(D,{element:e,absolutePosition:{x:e.x,y:e.y},isEndMarker:!0,hoverId:L,onHover:B,onShowMenu:G})]},`connection-group-${e.id}`)}).filter(Boolean),(()=>{if(!J||!ee||!Q)return null;let e="child"===Q?J:J.parentId?u[J.parentId]:null;if(!e)return null;let t=F({elements:u,currentDropTarget:J,draggingElement:ee,dropPosition:Q,dropInsertY:et,siblingInfo:ei});if(!t)return null;let i=ee.direction;if("between"===Q){if(J.direction)i=J.direction;else if(e&&"none"===e.direction){if(ei?.prevElement?.direction)i=ei.prevElement.direction;else if(ei?.nextElement?.direction)i=ei.nextElement.direction;else{let r=e.x+e.width/2;i=t.x<r?"left":"right"}}else e&&(i=e.direction||"right")}else if("child"===Q){if("none"===J.direction&&null===J.parentId){let e=J.x+J.width/2;i=t.x<e?"left":"right"}else i=J.direction||"right"}return(0,r.jsx)(S,{parentElement:e,element:{...ee,x:t.x,y:t.y,direction:i},absolutePositions:{parent:{x:e.x,y:e.y},element:{x:t.x,y:t.y}},strokeColor:s.lB.DRAGGING_COLOR,strokeWidth:s.lB.STROKE})})(),(()=>{let e,t;if(!H)return null;let i=H.startsWith("end-"),l=H;i&&(l=H.substring(4));let n=u[l];if(!n)return null;let o=n.height;return e=i?n.x-170:n.x+n.width+20,t=n.y+o/2-135,(0,r.jsx)(R,{popupX:e,popupY:t,isEndMarkerMenu:i,elementId:l,onMarkerSelect:es,onClose:()=>G(null)})})(),(()=>{let e=new Set;return(Object.keys(Y).forEach(t=>e.add(t)),ee&&J&&e.add(J.id),0===e.size)?null:Array.from(e).map(e=>{let t=u[e];return t&&t.visible?(0,r.jsx)(O,{element:t,isHovered:!0,currentDropTarget:J,dropPosition:Q,siblingInfo:ei,elements:u},`debug-${t.id}`):null}).filter(Boolean)})(),(()=>{if(!ee||!J||!Q)return null;let e=F({elements:u,currentDropTarget:J,draggingElement:ee,dropPosition:Q,dropInsertY:et,siblingInfo:ei});return e?(0,r.jsx)("rect",{x:e.x,y:e.y,width:ee.width,height:ee.height,fill:"child"===Q?"rgba(103, 208, 113, 0.3)":"rgba(157, 172, 244, 0.3)",stroke:"#555",strokeDasharray:"2,2",strokeWidth:1,rx:4,ry:4,className:"drop-preview","data-exclude-from-export":"true"}):null})()]}),(0,r.jsx)(w,{element:N,onEndEditing:()=>{p({type:"END_EDITING"}),n.current?.focus()}})]})]})});var V=i(5194),Z=i(1311),q=i(1496),J=i(9691),Q=i(1081),ee=i(8694),et=i(8283),ei=i(5833),er=i(1401),el=i(2554),en=i(7040),eo=i(7390),ea=i(2397),es=i(6597),ed=i(5785);let ec={TAB_BAR:{BACKGROUND:"#f0f0f0",ACTIVE_TAB_BACKGROUND:"#fff",INACTIVE_TAB_BACKGROUND:"#ddd",ACTIVE_TAB_BORDER:"#87CEFA",TAB_TEXT:"#000000",CLOSE_BUTTON_COLOR:"#666",CLOSE_BUTTON_HOVER_COLOR:"#1111ff",ADD_BUTTON_BACKGROUND:"transparent",ADD_BUTTON_TEXT:"#000"},MENU_BAR:{BACKGROUND:"#f1f1f1",ICON_COLOR:"#666666",DIVIDER_COLOR:"#e0e0e0"},MODAL:{BACKGROUND:"#ffffff",TEXT_COLOR:"#000000",BUTTON_BACKGROUND:"#f1f1f1",BUTTON_TEXT:"#000000",BUTTON_BORDER:"#cccccc",BUTTON_PRIMARY_BACKGROUND:"#1976d2",BUTTON_PRIMARY_TEXT:"#ffffff"}},eh={TAB_BAR:{BACKGROUND:"#333333",ACTIVE_TAB_BACKGROUND:"#555555",INACTIVE_TAB_BACKGROUND:"#444444",ACTIVE_TAB_BORDER:"#00aaff",TAB_TEXT:"#ffffff",CLOSE_BUTTON_COLOR:"#aaaaaa",CLOSE_BUTTON_HOVER_COLOR:"#9999ff",ADD_BUTTON_BACKGROUND:"transparent",ADD_BUTTON_TEXT:"#ffffff"},MENU_BAR:{BACKGROUND:"#333333",ICON_COLOR:"#bbbbbb",DIVIDER_COLOR:"#444444"},MODAL:{BACKGROUND:"#333333",TEXT_COLOR:"#fefefe",BUTTON_BACKGROUND:"#555555",BUTTON_TEXT:"#ffffff",BUTTON_BORDER:"#666666",BUTTON_PRIMARY_BACKGROUND:"#1976d2",BUTTON_PRIMARY_TEXT:"#ffffff"}},ep=e=>{let t=e.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,(e,t,i,r)=>t+t+i+i+r+r),i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return i?{r:parseInt(i[1],16),g:parseInt(i[2],16),b:parseInt(i[3],16)}:null},eu=e=>{let t="string"==typeof e?ep(e):e;return t?(299*t.r+587*t.g+114*t.b)/1e3:255},ex=e=>128>eu(e),ef=e=>ex(e)?eh:ec;var eg=i(9137),em=i.n(eg);let eE=e=>{let{isLoading:t,size:i=24,color:l="#4B5563"}=e;return t?(0,r.jsxs)("div",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",zIndex:9999},className:"jsx-44c6c384c94b6b72",children:[(0,r.jsx)("div",{style:{width:`${i}px`,height:`${i}px`,border:"3px solid rgba(0, 0, 0, 0.1)",borderRadius:"50%",borderTop:`3px solid ${l}`,animation:"spin 1s linear infinite"},className:"jsx-44c6c384c94b6b72"}),(0,r.jsx)(em(),{id:"44c6c384c94b6b72",children:"@-webkit-keyframes spin{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@-moz-keyframes spin{0%{-moz-transform:rotate(0deg);transform:rotate(0deg)}100%{-moz-transform:rotate(360deg);transform:rotate(360deg)}}@-o-keyframes spin{0%{-o-transform:rotate(0deg);transform:rotate(0deg)}100%{-o-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes spin{0%{-webkit-transform:rotate(0deg);-moz-transform:rotate(0deg);-o-transform:rotate(0deg);transform:rotate(0deg)}100%{-webkit-transform:rotate(360deg);-moz-transform:rotate(360deg);-o-transform:rotate(360deg);transform:rotate(360deg)}}"})]}):null},ey={NEW:"新規作成",OPEN:"ファイルを開く",SAVE:"保存（JSON形式）",SAVE_SVG:"SVG画像で保存",ADD:"新しい要素の追加",DELETE:"要素の削除",AI:"AI機能",EXPAND:"展開",COLLAPSE:"折りたたみ",UNDO:"元に戻す",REDO:"やり直す",ZOOM_IN:"ズームイン",ZOOM_OUT:"ズームアウト",HELP:"ヘルプを表示",SETTINGS:"設定"};var eb=i(5857),eT=i(514);let eO=e=>{let{tooltip:t,onClick:i,icon:l,iconColor:n}=e;return(0,r.jsx)(eT.A,{title:t,children:(0,r.jsx)(eb.A,{variant:"text",className:"iconbar-button",onClick:i,children:(0,r.jsx)(l,{sx:{color:n}})})})},eC=e=>{let{color:t}=e;return(0,r.jsx)("div",{style:{width:"10px",backgroundColor:t,height:"60%",margin:"0 5px",opacity:.3}})},eI=e=>{let{saveSvg:t,loadElements:i,saveElements:n,toggleHelp:o,toggleSettings:d,onAIClick:c}=e,{dispatch:p}=a(),{addTab:u}=(0,E.u)(),x=(0,l.useRef)(null),f=(0,l.useRef)(null),g=y(),[m,b]=(0,l.useState)(!1),T=(0,l.useCallback)(e=>()=>{"ZOOM_IN"===e||"ZOOM_OUT"===e?(b(!0),setTimeout(()=>{p({type:e}),setTimeout(()=>{b(!1)},300)},50)):"ADD_ELEMENT"===e?p({type:e,payload:{}}):p({type:e})},[p]);if(!g)return null;let O=ef((0,h.Es)());return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{style:{position:"fixed",width:"100%",height:s.JY,overflowX:"auto",WebkitOverflowScrolling:"touch",msOverflowStyle:"none",scrollbarWidth:"none"},ref:f,children:(0,r.jsxs)("div",{style:{display:"flex",justifyContent:"left",alignItems:"center",height:"100%",backgroundColor:O.MENU_BAR.BACKGROUND,padding:"0 20px",minWidth:"max-content"},children:[(0,r.jsx)("input",{type:"file",ref:x,onChange:i,style:{display:"none"}}),(0,r.jsx)(eO,{tooltip:ey.NEW,onClick:u,icon:J.A,iconColor:O.MENU_BAR.ICON_COLOR}),(0,r.jsx)(eO,{tooltip:ey.OPEN,onClick:()=>{x.current?.click()},icon:V.A,iconColor:O.MENU_BAR.ICON_COLOR}),(0,r.jsx)(eO,{tooltip:ey.SAVE,onClick:n,icon:Z.A,iconColor:O.MENU_BAR.ICON_COLOR}),(0,r.jsx)(eO,{tooltip:ey.SAVE_SVG,onClick:t,icon:q.A,iconColor:O.MENU_BAR.ICON_COLOR}),(0,r.jsx)(eC,{color:O.MENU_BAR.DIVIDER_COLOR}),(0,r.jsx)(eO,{tooltip:ey.ADD,onClick:T("ADD_ELEMENT"),icon:Q.A,iconColor:O.MENU_BAR.ICON_COLOR}),(0,r.jsx)(eO,{tooltip:ey.DELETE,onClick:T("DELETE_ELEMENT"),icon:ee.A,iconColor:O.MENU_BAR.ICON_COLOR}),(0,r.jsx)(eO,{tooltip:ey.AI,onClick:c,icon:et.A,iconColor:O.MENU_BAR.ICON_COLOR}),(0,r.jsx)(eO,{tooltip:ey.EXPAND,onClick:T("EXPAND_ELEMENT"),icon:ei.A,iconColor:O.MENU_BAR.ICON_COLOR}),(0,r.jsx)(eO,{tooltip:ey.COLLAPSE,onClick:T("COLLAPSE_ELEMENT"),icon:er.A,iconColor:O.MENU_BAR.ICON_COLOR}),(0,r.jsx)(eC,{color:O.MENU_BAR.DIVIDER_COLOR}),(0,r.jsx)(eO,{tooltip:ey.UNDO,onClick:T("UNDO"),icon:el.A,iconColor:O.MENU_BAR.ICON_COLOR}),(0,r.jsx)(eO,{tooltip:ey.REDO,onClick:T("REDO"),icon:en.A,iconColor:O.MENU_BAR.ICON_COLOR}),(0,r.jsx)(eC,{color:O.MENU_BAR.DIVIDER_COLOR}),(0,r.jsx)(eO,{tooltip:ey.ZOOM_IN,onClick:T("ZOOM_IN"),icon:eo.A,iconColor:O.MENU_BAR.ICON_COLOR}),(0,r.jsx)(eO,{tooltip:ey.ZOOM_OUT,onClick:T("ZOOM_OUT"),icon:ea.A,iconColor:O.MENU_BAR.ICON_COLOR}),(0,r.jsx)(eC,{color:O.MENU_BAR.DIVIDER_COLOR}),(0,r.jsx)(eO,{tooltip:ey.HELP,onClick:o,icon:es.A,iconColor:O.MENU_BAR.ICON_COLOR}),(0,r.jsx)(eO,{tooltip:ey.SETTINGS,onClick:d,icon:ed.A,iconColor:O.MENU_BAR.ICON_COLOR})]})}),m&&(0,r.jsx)("div",{style:{position:"fixed",zIndex:9500,width:"100%",height:"100%",pointerEvents:"none"},children:(0,r.jsx)(eE,{isLoading:m,size:32,color:"#4B5563"})})]})},ev=l.memo(e=>{let{tab:t,isCurrent:i,closeTab:n,switchTab:o,theme:a}=e,s=y(),[d,c]=(0,l.useState)(!1);return s?(0,r.jsxs)("div",{style:{padding:"6px",marginRight:"4px",backgroundColor:i?a.TAB_BAR.ACTIVE_TAB_BACKGROUND:a.TAB_BAR.INACTIVE_TAB_BACKGROUND,borderBottom:i?`3px solid ${a.TAB_BAR.ACTIVE_TAB_BORDER}`:"none",paddingBottom:"3px",borderRadius:"5px 5px 0 0",fontSize:"12px",display:"flex",alignItems:"center",color:a.TAB_BAR.TAB_TEXT,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",minWidth:"48px",maxWidth:"150px"},onClick:()=>o(t.id),children:[(0,r.jsxs)("div",{style:{display:"flex",alignItems:"center",flex:"1",overflow:"hidden"},children:[(0,r.jsx)("span",{style:{flex:"0 1 auto",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",minWidth:"0"},children:t.name}),!t.isSaved&&(0,r.jsx)("span",{style:{flex:"0 0 auto",marginRight:"0px",marginLeft:"2px",fontSize:"12px"},children:"*"})]}),(0,r.jsx)("button",{onClick:e=>{e.stopPropagation(),n(t.id)},onMouseEnter:()=>c(!0),onMouseLeave:()=>c(!1),style:{flex:"0 0 auto",padding:"0px",marginLeft:"0px",marginRight:"2px",border:"0",backgroundColor:"transparent",fontSize:"16px",color:d?a.TAB_BAR.CLOSE_BUTTON_HOVER_COLOR||"#9999ff":a.TAB_BAR.CLOSE_BUTTON_COLOR,fontWeight:"bold",cursor:"pointer",transition:"color 0.2s ease"},children:"\xd7"})]}):null});ev.displayName="Tab";let ew=l.memo(function(e){let{tabs:t,currentTabId:i,addTab:n,closeTab:o,switchTab:a}=e,d=y(),[,c]=(0,l.useState)(s.i_),[p,u]=(0,l.useState)(()=>ef(s.i_));return((0,l.useEffect)(()=>{if(!d)return;let e=(0,h.Es)();c(e),u(ef(e))},[d]),d)?(0,r.jsxs)("div",{style:{display:"flex",alignItems:"center",backgroundColor:p.TAB_BAR.BACKGROUND,width:"100%",height:s.FM,marginTop:s.JY,position:"fixed"},children:[t.map(e=>(0,r.jsx)(ev,{tab:e,isCurrent:i===e.id,closeTab:o,switchTab:a,theme:p},e.id)),(0,r.jsx)("button",{onClick:n,style:{marginLeft:"8px",backgroundColor:p.TAB_BAR.ADD_BUTTON_BACKGROUND,color:p.TAB_BAR.ADD_BUTTON_TEXT,border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"16px",padding:"2px 8px"},children:"+"})]}):null}),eA=e=>{let{isOpen:t,onClose:i,children:n,closeOnOverlayClick:o=!0,title:a,icon:s,modalId:d="unknown-modal",onOpen:c}=e,p=y(),[u,x]=(0,l.useState)(()=>ef((0,h.Es)())),[f,g]=(0,l.useState)(!1),m=(0,l.useRef)(0),E=(0,l.useRef)(t);(0,l.useEffect)(()=>{m.current+=1}),(0,l.useEffect)(()=>{p&&x(ef((0,h.Es)()))},[p,d]),(0,l.useEffect)(()=>(t&&!E.current&&c&&c(),E.current=t,t&&g(!0),()=>{}),[t,d,c]);let b=()=>{g(!1),setTimeout(()=>{i()},200)};if(!t)return null;let T=`
        0 10px 15px -3px rgba(0, 0, 0, 0.1),
        0 4px 6px -2px rgba(0, 0, 0, 0.05),
        0 0 0 1px rgba(255, 255, 255, 0.1)
    `;return(0,r.jsx)("div",{style:{position:"fixed",top:0,left:0,width:"100%",height:"100%",backgroundColor:"rgba(0, 0, 0, 0.6)",display:"flex",justifyContent:"center",alignItems:"center",zIndex:9e3,backdropFilter:"blur(3px)",opacity:+!!f,transition:"opacity 0.3s ease-in-out"},onClick:e=>{o&&b()},children:(0,r.jsxs)("div",{style:{backgroundColor:u.MODAL.BACKGROUND,color:u.MODAL.TEXT_COLOR,padding:"20px 24px 24px",borderRadius:"16px",width:"80%",maxWidth:"500px",overflow:"hidden",position:"relative",zIndex:9001,boxShadow:T,transform:f?"translateY(0) scale(1)":"translateY(20px) scale(0.95)",transition:"transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease-in-out",opacity:+!!f},onClick:e=>e.stopPropagation(),children:[(s||a)&&(0,r.jsxs)("div",{style:{position:"absolute",top:16,left:24,display:"flex",alignItems:"center",gap:"8px"},children:[s&&(0,r.jsx)("div",{style:{display:"flex",alignItems:"center",justifyContent:"center"},children:s}),a&&(0,r.jsx)("div",{style:{fontSize:"1.2em",fontWeight:"bold",color:u.MODAL.TEXT_COLOR,display:"flex",alignItems:"center",height:"32px"},children:a})]}),(0,r.jsx)("button",{onClick:b,style:{position:"absolute",right:16,top:16,background:`${u.MODAL.TEXT_COLOR}15`,border:"none",borderRadius:"50%",width:"32px",height:"32px",display:"flex",justifyContent:"center",alignItems:"center",fontSize:"1.2em",color:u.MODAL.TEXT_COLOR,cursor:"pointer",transition:"all 0.2s ease",outline:"none"},onMouseOver:e=>{e.currentTarget.style.background=`${u.MODAL.TEXT_COLOR}25`,e.currentTarget.style.transform="scale(1.1)"},onMouseOut:e=>{e.currentTarget.style.background=`${u.MODAL.TEXT_COLOR}15`,e.currentTarget.style.transform="scale(1)"},children:"\xd7"}),(0,r.jsx)("div",{style:{position:"relative",maxHeight:"calc(80vh - 56px)",marginTop:s?"40px":a?"24px":"16px",overflowY:"auto",overflowX:"hidden",scrollbarWidth:"thin",scrollbarColor:`${u.MODAL.TEXT_COLOR}40 transparent`},children:n})]})})},ej=()=>(0,r.jsx)("div",{style:{width:"40px",height:"40px",borderRadius:"50%",background:"linear-gradient(135deg, #2f8f67, #049e01)",display:"flex",justifyContent:"center",alignItems:"center",boxShadow:"inset 0 2px 4px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.2)"},children:(0,r.jsx)("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:(0,r.jsx)("path",{d:"M19.14 12.936a7.943 7.943 0 000-1.873l2.036-1.58a.5.5 0 00.11-.643l-1.926-3.33a.5.5 0 00-.607-.22l-2.397.96a7.982 7.982 0 00-1.62-.938l-.36-2.54A.5.5 0 0014.5 2h-5a.5.5 0 00-.493.422l-.36 2.54a7.982 7.982 0 00-1.62.938l-2.397-.96a.5.5 0 00-.607.22l-1.926 3.33a.5.5 0 00.11.643l2.036 1.58a7.943 7.943 0 000 1.873l-2.036 1.58a.5.5 0 00-.11.643l1.926 3.33a.5.5 0 00.607.22l2.397-.96a7.982 7.982 0 001.62.938l.36 2.54A.5.5 0 009.5 22h5a.5.5 0 00.493-.422l.36-2.54a7.982 7.982 0 001.62-.938l2.397.96a.5.5 0 00.607-.22l1.926-3.33a.5.5 0 00-.11-.643l-2.036-1.58zM12 15.5a3.5 3.5 0 110-7 3.5 3.5 0 010 7z",fill:"#ffffff"})})});var ek=i(2582),eR=i(7498),eD=i(9284),eS=i(9868),eN=i(7923),e_=i(3025),e$=i(8893),eL=i(5358),eM=i(7298),eB=i(9439),eH=i(4512),eU=i(8410);let eX=e=>{let{field:t,value:i,error:l=!1,onChange:n}=e;switch(t.type){case"text":return(0,r.jsx)(ek.A,{label:t.label,value:i,onChange:e=>{let i=e.target.value;if(!(0,v.IK)(t.key,i)){console.warn(`設定値が無効です: ${t.key}`);return}n("apiKey"===t.key?i:(0,p.jZ)(i))},fullWidth:!0,margin:"normal",multiline:"prompt"===t.key||"systemPromptTemplate"===t.key,rows:"prompt"===t.key||"systemPromptTemplate"===t.key?6:1,type:"apiKey"===t.key?"password":"text",helperText:t.helperText,variant:"prompt"===t.key||"systemPromptTemplate"===t.key?"outlined":"standard"});case"number":return(0,r.jsx)(ek.A,{label:t.label,type:"number",value:i,onChange:e=>n(e.target.value),fullWidth:!0,margin:"normal",inputProps:{min:t.validation?.min,max:t.validation?.max,step:t.validation?.step},error:l,helperText:l?`${t.validation?.min}から${t.validation?.max}の数値を入力してください`:t.helperText});case"select":return(0,r.jsxs)(eR.A,{fullWidth:!0,margin:"normal",children:[(0,r.jsx)(eD.A,{children:t.label}),(0,r.jsx)(eS.A,{value:String(i),label:t.label,onChange:e=>{n(e.target.value)},MenuProps:{sx:{zIndex:9999}},children:t.options?.map(e=>r.jsx(eN.A,{value:e.value,children:e.label},e.value))}),(0,r.jsx)(e_.A,{children:t.helperText})]});case"color":return(0,r.jsxs)(e$.A,{sx:{display:"flex",alignItems:"center",mt:2,mb:1},children:[(0,r.jsxs)(eL.A,{variant:"body1",sx:{mr:2,width:"120px"},children:[t.label,":"]}),(0,r.jsx)("input",{type:"color",value:String(i),onChange:e=>n(e.target.value)}),(0,r.jsx)(e_.A,{children:t.helperText})]});case"radio":return(0,r.jsxs)(eR.A,{component:"fieldset",fullWidth:!0,children:[(0,r.jsx)(eM.A,{component:"legend",children:t.label}),(0,r.jsx)(eB.A,{children:t.options?.map(e=>r.jsx(eH.A,{value:e.value,control:r.jsx(eU.A,{checked:i===e.value,onChange:e=>n(e.target.value)}),label:e.label},e.value))}),(0,r.jsx)(e_.A,{children:t.helperText})]});default:return null}};var eG=i(5055),eP=i(460),eF=i(270),eW=i(3745),eK=i(7790),ez=i(5787);let eY=[{id:0,label:"Elements Setting",fields:[{key:"layoutMode",label:"Layout Mode",type:"radio",helperText:"レイアウトモードの選択 ※現在のタブのみに適用されます",defaultValue:"default",options:[{value:"default",label:"通常モード"},{value:"mindmap",label:"マインドマップモード"}]},{key:"numberOfSections",label:"Number of sections",type:"number",helperText:"同時に表示するセクションの数（1〜10） ※現在のタブと新規作成されるタブのデフォルト値として設定されます",defaultValue:3,validation:{min:1,max:10,required:!0}},{key:"markerType",label:"Default Marker Type",type:"select",helperText:"新規要素作成時のデフォルトマーカータイプ",defaultValue:s.vX.NONE,options:[{value:s.vX.NONE,label:"None"},{value:s.vX.ARROW,label:"Arrow"},{value:s.vX.CIRCLE,label:"Circle"},{value:s.vX.SQUARE,label:"Square"},{value:s.vX.DIAMOND,label:"Diamond"},{value:s.vX.FILLED_ARROW,label:"Filled Arrow"},{value:s.vX.FILLED_CIRCLE,label:"Filled Circle"},{value:s.vX.FILLED_SQUARE,label:"Filled Square"},{value:s.vX.FILLED_DIAMOND,label:"Filled Diamond"}]},{key:"canvasBackgroundColor",label:"Canvas Background Color",type:"color",helperText:"キャンバスの背景色",defaultValue:s.i_},{key:"elementColor",label:"Element Color",type:"color",helperText:"要素の背景色",defaultValue:s.iC.NORMAL.COLOR},{key:"textColor",label:"Text Color",type:"color",helperText:"テキストの色",defaultValue:s._K},{key:"strokeColor",label:"Stroke Color",type:"color",helperText:"要素の枠線色",defaultValue:s.iC.NORMAL.STROKE_COLOR},{key:"selectedStrokeColor",label:"Selected Stroke Color",type:"color",helperText:"選択時の要素の枠線色",defaultValue:s.iC.SELECTED.STROKE_COLOR},{key:"strokeWidth",label:"Stroke Width",type:"number",helperText:"要素の枠線の太さ",defaultValue:1,validation:{min:0,step:.5,required:!0}},{key:"connectionPathColor",label:"Connection Path Color",type:"color",helperText:"接続線の色",defaultValue:s.BH},{key:"connectionPathStroke",label:"Connection Path Stroke",type:"number",helperText:"接続線の太さ",defaultValue:1,validation:{min:.5,step:.5,required:!0}},{key:"fontFamily",label:"Font Family",type:"text",helperText:"表示に使用するフォントファミリ",defaultValue:""}]},{id:1,label:"API Setting",fields:[{key:"modelType",label:"Select Model",type:"radio",helperText:"APIモデルの選択",defaultValue:"gemini-1.5-flash",options:[{value:"gemini-1.5-flash",label:"Gemini-1.5-flash"},{value:"gemini-2.0-flash",label:"Gemini-2.0-flash"}]},{key:"apiKey",label:"Gemini API Key",type:"text",helperText:"入力されたキーは暗号化してlocalStorageに保存されます。サーバに送信されることはありません。",defaultValue:""}]},{id:2,label:"Prompt",fields:[{key:"prompt",label:"inputText",type:"text",helperText:"",defaultValue:""},{key:"systemPromptTemplate",label:"SystemPromptTemplate",type:"text",helperText:"",defaultValue:""}]}],eV=(e,t)=>{let i={};t.forEach(t=>{void 0!==e[t.key]&&(i[t.key]=e[t.key])});let r=new Blob([JSON.stringify(i,null,2)],{type:"application/json"}),l=URL.createObjectURL(r),n=document.createElement("a");n.href=l,n.download=`theme-settings-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(n),n.click(),setTimeout(()=>{document.body.removeChild(n),URL.revokeObjectURL(l)},0)},eZ=(e,t)=>{if("number"===e.type){let i="string"==typeof t?parseFloat(t):t;if(e.validation?.required&&(""===t||isNaN(i))||!isNaN(i)&&(e.validation?.min!==void 0&&i<e.validation.min||e.validation?.max!==void 0&&i>e.validation.max))return!1}return!0},eq=(e,t,i,r)=>{let l={...t},n={...i},o=!1;return r.forEach(t=>{void 0!==e[t.key]&&(eZ(t,e[t.key])?(l[t.key]=e[t.key],n[t.key]=!1):(o=!0,n[t.key]=!0))}),{newValues:l,newErrors:n,hasError:o}},eJ=e=>{let{isOpen:t,onClose:i,dispatch:n,modalId:o,onOpen:a}=e,s=y(),[d,c]=(0,l.useState)(0),[u,x]=(0,l.useState)({}),[f,g]=(0,l.useState)({}),[m,b]=(0,l.useState)("light"),[T,O]=(0,l.useState)(()=>ef((0,h.Es)())),C=(0,l.useRef)(null),{getCurrentTabNumberOfSections:I,updateCurrentTabNumberOfSections:w,getCurrentTabLayoutMode:A,updateCurrentTabLayoutMode:j}=(0,E.u)();if((0,l.useEffect)(()=>{let e=(0,h.Es)();b(ex(e)?"dark":"light"),O(ef(e))},[s]),(0,l.useEffect)(()=>{s&&t&&(async()=>{let e={};try{e.apiKey=await (0,h.CG)(),e.systemPromptTemplate=(0,h.k0)(),e.modelType=(0,h.OA)(),e.prompt=(0,h.XH)(),e.numberOfSections=I(),e.layoutMode=A(),e.elementColor=(0,h.kN)(),e.strokeColor=(0,h._1)(),e.strokeWidth=(0,h.xo)(),e.fontFamily=(0,h.af)(),e.markerType=(0,h.zn)(),e.connectionPathColor=(0,h.ZF)(),e.connectionPathStroke=(0,h.S4)(),e.canvasBackgroundColor=(0,h.Es)(),e.textColor=(0,h.vG)(),e.selectedStrokeColor=(0,h.N4)(),x(e)}catch(e){}})()},[s,t,I,A]),!s)return null;let k=(0,eF.A)({palette:{mode:m,background:{default:T.MODAL.BACKGROUND,paper:T.MODAL.BACKGROUND},text:{primary:T.MODAL.TEXT_COLOR,secondary:T.MODAL.TEXT_COLOR}},components:{MuiButton:{styleOverrides:{root:{color:T.MODAL.BUTTON_TEXT,borderColor:T.MODAL.BUTTON_BORDER},contained:{backgroundColor:T.MODAL.BUTTON_PRIMARY_BACKGROUND,color:T.MODAL.BUTTON_PRIMARY_TEXT,"&:hover":{backgroundColor:T.MODAL.BUTTON_PRIMARY_BACKGROUND,opacity:.9}},outlined:{backgroundColor:T.MODAL.BUTTON_BACKGROUND,"&:hover":{backgroundColor:T.MODAL.BUTTON_BACKGROUND,opacity:.9}}}}}}),R=(e,t)=>{if("number"===e.type){let i="string"==typeof t?parseFloat(t):t;if(e.validation?.required&&(""===t||isNaN(i))||!isNaN(i)&&(e.validation?.min!==void 0&&i<e.validation.min||e.validation?.max!==void 0&&i>e.validation.max))return!1}return!0},D=(e,t)=>{x(i=>({...i,[e.key]:t})),g(i=>({...i,[e.key]:!R(e,t)}))},S=async()=>{let e=!1;if(eY.forEach(t=>{t.fields.forEach(t=>{let i=u[t.key];R(t,i)||(e=!0,g(e=>({...e,[t.key]:!0})))})}),e)return;let t=u.apiKey;void 0!==t&&await (0,h.wt)(String(t));let r=u.systemPromptTemplate;void 0!==r&&(0,h.mF)(String(r));let l=u.modelType;void 0!==l&&(0,h.Iz)(String(l));let n=u.prompt;void 0!==n&&(0,h.bJ)(String(n));let o=u.numberOfSections;void 0!==o&&w(Number(o));let a=u.layoutMode;void 0!==a&&j(a);let s=u.elementColor;void 0!==s&&(0,h.qu)(String(s));let d=u.strokeColor;void 0!==d&&(0,h.JT)(String(d));let c=u.strokeWidth;void 0!==c&&(0,h.Jg)(Number(c));let p=u.fontFamily;void 0!==p&&(0,h.Yu)(String(p));let x=u.markerType;void 0!==x&&(0,h.li)(String(x));let f=u.connectionPathColor;void 0!==f&&(0,h.xN)(String(f));let m=u.connectionPathStroke;void 0!==m&&(0,h.K2)(Number(m));let E=u.canvasBackgroundColor;void 0!==E&&(0,h.QY)(String(E));let y=u.textColor;void 0!==y&&(0,h.vY)(String(y));let b=u.selectedStrokeColor;void 0!==b&&(0,h.LL)(String(b)),i()};return(0,r.jsx)(eA,{isOpen:t,onClose:i,closeOnOverlayClick:!1,title:"Preference",icon:(0,r.jsx)(ej,{}),dispatch:n,modalId:o,onOpen:a,children:(0,r.jsx)(eW.A,{theme:k,children:(0,r.jsxs)(e$.A,{sx:{backgroundColor:T.MODAL.BACKGROUND,color:T.MODAL.TEXT_COLOR,padding:2,borderRadius:1,display:"flex",flexDirection:"column",height:"80vh",maxHeight:600},children:[(0,r.jsx)(eG.A,{value:d,onChange:(e,t)=>c(t),variant:"scrollable",scrollButtons:"auto",allowScrollButtonsMobile:!0,textColor:"primary",indicatorColor:"primary",children:eY.map(e=>(0,r.jsx)(eP.A,{label:e.label},e.id))}),(0,r.jsx)(e$.A,{sx:{mt:2,flex:1,overflowY:"auto","&::-webkit-scrollbar":{width:"8px"},"&::-webkit-scrollbar-track":{background:"transparent"},"&::-webkit-scrollbar-thumb":{background:T.MODAL.TEXT_COLOR,opacity:.2,borderRadius:"4px"}},children:eY.map(e=>d===e.id&&(0,r.jsx)(e$.A,{children:e.fields.map(e=>(0,r.jsx)(eX,{field:e,value:u[e.key]??e.defaultValue,error:f[e.key],onChange:t=>D(e,t)},e.key))},e.id))}),(0,r.jsxs)(e$.A,{sx:{mt:2,pt:2,display:"flex",flexWrap:"wrap",gap:1,justifyContent:"space-between",alignItems:"center",borderTop:`1px solid ${T.MODAL.TEXT_COLOR}20`,backgroundColor:T.MODAL.BACKGROUND},children:[(0,r.jsx)("input",{type:"file",ref:C,onChange:e=>{let t=e.target.files?.[0];if(!t)return;let i=(0,p.Nz)(t.name);if(!i||!i.endsWith(".json")){alert("Invalid file name or format. Please select a valid JSON file."),e.target&&(e.target.value="");return}if(t.size>1048576){alert("File size too large. Please select a file smaller than 1MB."),e.target&&(e.target.value="");return}let r=new FileReader;r.onload=t=>{try{let i=t.target?.result;if(!(0,v.IU)(i)){alert("File content contains potentially dangerous data. Import cancelled."),e.target&&(e.target.value="");return}if(!(0,v.L5)(i)){alert("Invalid JSON format. Please check the file contents."),e.target&&(e.target.value="");return}let r=(0,p.jZ)(i),l=JSON.parse(r),{newValues:n,newErrors:o,hasError:a}=eq(l,u,f,eY[0].fields);a&&alert("Some imported settings are invalid and will be ignored."),x(n),g(o),e.target&&(e.target.value="")}catch(t){alert("Failed to parse imported settings. Please check the file format."),e.target&&(e.target.value="")}},r.readAsText(t)},accept:".json",style:{display:"none"}}),(0,r.jsx)(e$.A,{sx:{display:"flex",gap:2},children:0===d&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(eb.A,{variant:"outlined",startIcon:(0,r.jsx)(eK.A,{}),onClick:()=>{eV(u,eY[0].fields)},children:"Export"}),(0,r.jsx)(eb.A,{variant:"outlined",startIcon:(0,r.jsx)(ez.A,{}),onClick:()=>{C.current&&C.current.click()},children:"Import"})]})}),(0,r.jsxs)(e$.A,{sx:{display:"flex",gap:1},children:[(0,r.jsx)(eb.A,{variant:"outlined",onClick:i,children:"Cancel"}),(0,r.jsx)(eb.A,{variant:"contained",onClick:S,color:"primary",disabled:Object.values(f).some(Boolean),children:"OK"})]})]})]})})})},eQ=()=>(0,r.jsx)("div",{style:{width:"40px",height:"40px",borderRadius:"50%",background:"linear-gradient(135deg, #6370e0, #2f3eab)",display:"flex",justifyContent:"center",alignItems:"center",boxShadow:"inset 0 2px 4px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.2)"},children:(0,r.jsxs)("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[(0,r.jsx)("path",{d:"M12 5V13",stroke:"#ffffff",strokeWidth:"2",strokeLinecap:"round"}),(0,r.jsx)("circle",{cx:"12",cy:"17",r:"1",fill:"#ffffff"})]})}),e0=e=>{let{showCloseConfirm:t,setShowCloseConfirm:i,tabToClose:l,closeTab:n,dispatch:o,modalId:a,onOpen:s}=e;if(!t)return null;let d=ef((0,h.Es)());return(0,r.jsx)(eA,{isOpen:t,onClose:()=>i(!1),closeOnOverlayClick:!1,title:"確認",icon:(0,r.jsx)(eQ,{}),dispatch:o,modalId:a,onOpen:s,children:(0,r.jsxs)("div",{style:{padding:"10px 5px 20px",textAlign:"left"},children:[(0,r.jsxs)("p",{style:{margin:"0 0 10px",fontSize:"15px",opacity:.8,lineHeight:1.5,maxWidth:"350px",marginTop:"10px"},children:["保存していない変更があります。",(0,r.jsx)("br",{}),"タブを閉じてよろしいですか？"]}),(0,r.jsxs)("div",{style:{display:"flex",justifyContent:"flex-end",gap:"16px",marginTop:"30px"},children:[(0,r.jsx)(eb.A,{variant:"outlined",onClick:()=>i(!1),sx:{borderRadius:"8px",padding:"8px 20px",fontSize:"14px",fontWeight:500,textTransform:"none",boxShadow:"none",transition:"all 0.2s ease",backgroundColor:d.MODAL.BUTTON_BACKGROUND,borderColor:d.MODAL.BUTTON_BORDER,color:d.MODAL.BUTTON_TEXT,"&:hover":{backgroundColor:d.MODAL.BUTTON_BACKGROUND,opacity:.9}},children:"いいえ"}),(0,r.jsx)(eb.A,{variant:"contained",onClick:()=>{l&&n(l),i(!1)},sx:{borderRadius:"8px",padding:"8px 20px",fontSize:"14px",fontWeight:500,textTransform:"none",boxShadow:"none",transition:"all 0.2s ease",backgroundColor:d.MODAL.BUTTON_PRIMARY_BACKGROUND,color:d.MODAL.BUTTON_PRIMARY_TEXT,"&:hover":{backgroundColor:d.MODAL.BUTTON_PRIMARY_BACKGROUND,opacity:.9}},children:"はい"})]})]})})},e1=()=>(0,r.jsx)("div",{style:{width:"40px",height:"40px",borderRadius:"50%",background:"linear-gradient(135deg, #A46365, #B1928A)",boxShadow:"inset 0 2px 4px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.2)",display:"flex",justifyContent:"center",alignItems:"center"},children:(0,r.jsx)(es.A,{style:{color:"#ffffff"}})}),e2=[{title:"Keyboard shortcuts",items:["Tab: Add a child element to the selected element","Shift + Tab: Add a sibling element to the selected element","Delete/Backspace: Remove the selected element","Enter: Edit the selected element","Esc: Stop editing the selected element","Tab in editing mode: Move the focus to the next text box","Ctrl + Z: Undo the last action","Shift + Ctrl + Z: Redo the last action","Ctrl + X: Cut the selected element","Ctrl + C: Copy the selected element","Ctrl + V: Paste the copied element","Ctrl + ArrowLeft: Collapse the children of the selected element","Ctrl + ArrowRight: Expand the children of the selected element","Arrow keys: Navigate between elements"]},{title:"Mouse operations",items:["Click: Select an element","Double click: Edit the selected element","Clicking outside the element will end the editing mode","Drag: Move the selected element"]},{title:"Menu operations",items:["New: Create a new diagram. Unsaved changes will be discarded.","Open: Load saved data. The current data will be discarded.","Save as: Save the diagram data in JSON format","Export: Export the diagram in SVG format"]}],e5=e=>{let{isOpen:t,onClose:i,dispatch:l,modalId:n,onOpen:o}=e;return(0,r.jsx)(eA,{isOpen:t,onClose:i,title:"ヘルプ",icon:(0,r.jsx)(e1,{}),dispatch:l,modalId:n,onOpen:o,children:(0,r.jsx)("div",{className:"space-y-6",children:e2.map((e,t)=>(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("h4",{className:"text-lg font-semibold text-gray-800 dark:text-gray-200",children:e.title}),(0,r.jsx)("div",{className:"space-y-1",children:e.items.map((e,t)=>(0,r.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:e},t))})]},t))})})};var e3=i(6497),e4=i(3464);i(831);let e6=()=>(0,h.k0)(),e9=e=>{let{structureText:t,inputText:i}=e;return(0,h.k0)().replace("{{structureText}}",t).replace("{{inputText}}",i)},e8=async(e,t,i)=>{try{console.log("prompt: \n",e);let i=`${(0,h.G6)()}?key=${t}`,r=e6(),l=await e4.A.post(i,{contents:[{role:"user",parts:[{text:e}]}],systemInstruction:{parts:[{text:r}]},generationConfig:{temperature:.2,topP:.8,topK:40,maxOutputTokens:1024,responseSchema:{type:"string",format:"text/plain",description:"A list of items, each on a new line. Do not include bullet points or numbering."}}},{headers:{"Content-Type":"application/json"}}),n=l.data.candidates?.[0]?.content?.parts?.[0]?.text||"",o=(0,p.Rq)(n);return console.log("Sanitized response:",o),o}catch(e){throw console.error("Gemini API Error:",e),Error("API呼び出しに失敗しました")}};var e7=i(1050),te=i(1231);let tt=()=>{let e=(0,l.useRef)(0);(0,l.useEffect)(()=>{e.current+=1});let{tabs:t,currentTabId:i,currentTab:n,addTab:a,closeTab:s,switchTab:d,updateTabState:c,updateTabName:p,updateTabSaveStatus:u,dispatch:x,handleCloseTabRequest:f,updateTabNameFromRootElement:g}=function(){let{tabs:e,currentTabId:t,addTab:i,closeTab:r,switchTab:n,updateTabState:o,updateTabName:a,updateTabSaveStatus:s}=(0,E.u)(),d=e.find(e=>e.id===t),c=(0,l.useCallback)(e=>{t&&o(t,i=>{let r=(0,te.F)(i,e);if("END_EDITING"===e.type){let e=Object.values(r.elements),i=(0,e3.Wy)(e);if(i){let e=(0,e3.re)(d?.name||"無題",i);e!==d?.name&&a(t,e)}}return r})},[t,o,d,a]),h=(0,l.useCallback)(()=>{if(!d||!t)return;let e=Object.values(d.state.elements),i=(0,e3.Wy)(e);if(i){let e=(0,e3.re)(d.name,i);e!==d.name&&a(t,e)}},[d,t,a]),p=(0,l.useCallback)(t=>{let i=e.find(e=>e.id===t);return i?i.isSaved?(r(t),{needsConfirmation:!1}):{needsConfirmation:!0,tabId:t}:(r(t),{needsConfirmation:!1})},[e,r]),u=(0,l.useCallback)(e=>{r(e)},[r]);return{tabs:e,currentTabId:t,currentTab:d,addTab:i,closeTab:r,switchTab:n,updateTabState:o,updateTabName:a,updateTabSaveStatus:s,forceCloseTab:u,dispatch:c,updateTabNameFromRootElement:h,handleCloseTabRequest:p}}(),[{isHelpOpen:m,isSettingsOpen:y,showCloseConfirm:b,tabToClose:T},{toggleHelp:O,toggleSettings:C,setShowCloseConfirm:I,setTabToClose:v}]=function(e){let[t,i]=(0,l.useState)(!1),[r,n]=(0,l.useState)(!1),[o,a]=(0,l.useState)(null),[s,d]=(0,l.useState)(!1),c=(0,l.useCallback)(()=>{e(),i(e=>!e)},[e]),h=(0,l.useCallback)(()=>{e(),n(e=>!e)},[e]);return[{isHelpOpen:t,isSettingsOpen:r,showCloseConfirm:s,tabToClose:o},{toggleHelp:c,toggleSettings:h,openCloseConfirm:(0,l.useCallback)(e=>{a(e),d(!0)},[]),closeConfirmModal:(0,l.useCallback)(()=>{d(!1),a(null)},[]),setShowCloseConfirm:d,setTabToClose:a}]}((0,l.useCallback)(()=>{x({type:"END_EDITING"}),g()},[x,g])),{addToast:w}=(0,M.d)(),A=(0,l.useCallback)(e=>{let t=f(e);return t.needsConfirmation&&t.tabId&&(v(t.tabId),I(!0)),t},[f,v,I]),{handleAIClick:j}=function(e){let{currentTab:t,dispatch:i}=e,{addToast:r}=(0,M.d)();return{handleAIClick:(0,l.useCallback)(async()=>{if(!t)return;let e=Object.values(t.state.elements).find(e=>e.selected);if(!e){r(L.noSelect);return}let l=await (0,h.CG)();if(!l){r(L.noApiKey,"warn");return}let n=localStorage.getItem("prompt")||"";if(!n){r(L.noPrompt);return}try{let r=(0,e7.YV)(t.state.elements,e.id),o=e9({structureText:r,inputText:n}),a=(0,h.OA)(),s=await e8(o,l,a),d=[],c=s.replace(/^```/g,"").replace(/```$/g,""),p=c.match(/```[\s\S]*?```/g);d=p&&p.length>0?p.flatMap(e=>e.replace(/```.*\n?|```/g,"").split("\n").map(e=>e.trim()).filter(e=>e.length>0&&"```"!==e)):c.split("\n").map(e=>e.trim()).filter(e=>e.length>0&&"```"!==e),i({type:"ADD_ELEMENTS_SILENT",payload:{parentId:e.id,texts:d,tentative:!0}})}catch(e){r(e instanceof Error?`${L.aiError}: ${e.message}`:L.aiError)}},[t,i,r])}}({currentTab:n,dispatch:x}),{handleSaveSvg:k,handleSaveElements:R,handleLoadElements:D}=function(e){let{currentTab:t,addTab:i,updateTabState:r,updateTabName:n,switchTab:o,updateTabSaveStatus:a}=e,{addToast:s}=(0,M.d)(),d=(0,l.useCallback)(()=>{let e=document.querySelector(".svg-element");e&&(0,e3.Sz)(e,"download.svg")},[]);return{handleSaveSvg:d,handleSaveElements:(0,l.useCallback)(()=>{if(t&&((0,e3.$r)(Object.values(t.state.elements),t.name),t.id)){let e=JSON.stringify(JSON.parse(JSON.stringify(t.state.elements)));console.log("保存処理: タブID",t.id),console.log("保存処理: 要素の状態",e.substring(0,50)+"..."),a(t.id,!0,e),console.log("保存処理: 保存済みフラグを設定",!0)}},[t,a]),handleLoadElements:(0,l.useCallback)(async e=>{try{let t=await (0,e3.wl)(e.nativeEvent),l=i();r(l,e=>({...e,elements:t.elements}));let s=t.fileName.replace(".json","");n(l,s);let d=JSON.stringify(t.elements);a(l,!0,d),o(l)}catch(e){s(e.message)}},[i,r,n,o,a,s])}}({currentTab:n,addTab:a,updateTabState:c,updateTabName:p,switchTab:d,updateTabSaveStatus:u}),S=(0,l.useMemo)(()=>n?(0,r.jsxs)(o,{state:n.state,dispatch:x,children:[(0,r.jsx)(Y,{isHelpOpen:m,toggleHelp:O}),(0,r.jsx)(ew,{tabs:t,currentTabId:i,addTab:a,closeTab:A,switchTab:d}),(0,r.jsx)(eI,{saveSvg:k,loadElements:D,saveElements:R,toggleHelp:O,toggleSettings:C,onAIClick:j})]}):null,[n,x,O,m,i,p,C,w,j,D,R,a,A,d,t,k]);return(0,r.jsxs)("div",{children:[S,(0,r.jsx)(e0,{showCloseConfirm:b,setShowCloseConfirm:I,tabToClose:T,closeTab:s,dispatch:x,modalId:"confirm-modal",onOpen:()=>x({type:"END_EDITING"})}),(0,r.jsx)(eJ,{isOpen:y,onClose:C,dispatch:x,modalId:"settings-modal",onOpen:()=>x({type:"END_EDITING"})}),(0,r.jsx)(e5,{isOpen:m,onClose:O,dispatch:x,modalId:"help-modal",onOpen:()=>x({type:"END_EDITING"})})]})}},4224:(e,t,i)=>{Promise.resolve().then(i.bind(i,2152))}},e=>{var t=t=>e(e.s=t);e.O(0,[675,980,441,684,358],()=>t(4224)),_N_E=e.O()}]);
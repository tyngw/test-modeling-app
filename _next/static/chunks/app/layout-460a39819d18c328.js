(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[177],{395:(e,t,r)=>{"use strict";r.d(t,{GoogleAnalytics:()=>d});var a=r(5155),n=r(5695),i=r(2115),o=r(1195),s=r(7358);function l(){let e=(0,n.usePathname)(),t=(0,n.useSearchParams)(),r=s.env.NEXT_PUBLIC_GA_TRACKING_ID;return(0,i.useEffect)(()=>{r&&o.Ay.initialize(r)},[r]),(0,i.useEffect)(()=>{if(r){let r=e+(t.toString()?`?${t}`:"");o.Ay.send({hitType:"pageview",page:r})}},[e,t,r]),null}function d(){return(0,a.jsx)(i.Suspense,{fallback:null,children:(0,a.jsx)(l,{})})}},4581:(e,t,r)=>{"use strict";r.d(t,{Providers:()=>y});var a=r(5155),n=r(2115),i=r(7242),o=r(7451),s=r(826),l=r(7650);let d=e=>{let{className:t="",size:r=24}=e;return(0,a.jsxs)("svg",{width:r,height:r,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:t,children:[(0,a.jsx)("path",{d:"M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V15Z",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),(0,a.jsx)("path",{d:"M8 9H16",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),(0,a.jsx)("path",{d:"M8 13H12",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})]})};var c=r(4146),h=r(1970);let g=e=>{let{onSendMessage:t,isLoading:r=!1,isVisible:i=!1,onToggle:o,externalMessage:s,onExternalMessageProcessed:g}=e,[p,u]=(0,n.useState)([]),[x,f]=(0,n.useState)(""),m=(0,n.useRef)(null),E=(0,n.useRef)(null),[b,y]=(0,n.useState)(null);(0,n.useEffect)(()=>{{y(document.body);let e=document.createElement("style");return e.textContent=`
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
      `,document.head.appendChild(e),()=>{document.head.removeChild(e)}}},[]),(0,n.useEffect)(()=>{m.current?.scrollIntoView({behavior:"smooth"})},[p]),(0,n.useEffect)(()=>{i&&(E.current?.focus(),setTimeout(()=>{m.current?.scrollIntoView({behavior:"smooth"})},0))},[i]),(0,n.useEffect)(()=>{s&&s.trim()&&(w(s),g?.())},[s]);let w=async e=>{let a=e||x.trim();if(!a||r)return;let n={id:Date.now().toString(),text:a,sender:"user",timestamp:new Date};u(e=>[...e,n]),e||f(""),f("");try{let e=await t(n.text),r={id:(Date.now()+1).toString(),text:e||"操作を実行しました！",sender:"assistant",timestamp:new Date};u(e=>[...e,r])}catch(t){let e={id:(Date.now()+1).toString(),text:`エラーが発生しました: ${t instanceof Error?t.message:"不明なエラー"}`,sender:"assistant",timestamp:new Date};u(t=>[...t,e])}},C=(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"fixed bottom-4 right-4 z-50",style:{position:"fixed",bottom:"16px",right:"16px",zIndex:50},children:(0,a.jsx)("button",{onClick:o,"aria-label":"チャットアシスタントを開く",style:{width:"56px",height:"56px",backgroundColor:"#e5e7eb",border:"none",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",transition:"all 0.2s ease",boxShadow:"0 4px 6px -1px rgba(0, 0, 0, 0.08), 0 2px 4px -1px rgba(0, 0, 0, 0.04)",outline:"none"},onMouseOver:e=>{e.currentTarget.style.backgroundColor="#d1d5db",e.currentTarget.style.transform="scale(1.05)",e.currentTarget.style.boxShadow="0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04)"},onMouseOut:e=>{e.currentTarget.style.backgroundColor="#e5e7eb",e.currentTarget.style.transform="scale(1)",e.currentTarget.style.boxShadow="0 4px 6px -1px rgba(0, 0, 0, 0.08), 0 2px 4px -1px rgba(0, 0, 0, 0.04)"},children:(0,a.jsx)(d,{size:24})})}),i&&(0,a.jsx)("div",{style:{position:"fixed",top:0,left:0,width:"100%",height:"100%",display:"flex",justifyContent:"flex-end",alignItems:"flex-end",zIndex:9e3,padding:"20px"},onClick:o,children:(0,a.jsxs)("div",{style:{background:"linear-gradient(135deg, #f3f4f6 0%, #e5e7ef 100%)",borderRadius:"16px",width:"400px",height:"600px",position:"relative",overflow:"hidden",boxShadow:`
                0 10px 15px -3px rgba(0, 0, 0, 0.1),
                0 4px 6px -2px rgba(0, 0, 0, 0.05),
                0 0 0 1px rgba(255, 255, 255, 0.1)
              `,border:"2px solid #d1d5db",transform:"translateY(0) scale(1)",transition:"transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)",marginRight:"20px",marginBottom:"100px"},onClick:e=>e.stopPropagation(),children:[(0,a.jsxs)("div",{style:{position:"absolute",top:16,left:24,display:"flex",alignItems:"center",gap:"8px"},children:[(0,a.jsx)("div",{style:{display:"flex",alignItems:"center",justifyContent:"center"},children:(0,a.jsx)("div",{className:"w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center",children:(0,a.jsx)(d,{size:16,className:"text-white"})})}),(0,a.jsx)("div",{style:{fontSize:"1.2em",fontWeight:"bold",color:"#1f2937",display:"flex",alignItems:"center",height:"32px"},children:"AIアシスタント"})]}),(0,a.jsx)("button",{onClick:o,style:{position:"absolute",right:16,top:16,background:"#1f293715",border:"none",borderRadius:"50%",width:"32px",height:"32px",display:"flex",justifyContent:"center",alignItems:"center",fontSize:"1.2em",color:"#1f2937",cursor:"pointer",transition:"all 0.2s ease",outline:"none"},onMouseOver:e=>{e.currentTarget.style.background="#1f293725",e.currentTarget.style.transform="scale(1.1)"},onMouseOut:e=>{e.currentTarget.style.background="#1f293715",e.currentTarget.style.transform="scale(1)"},children:"\xd7"}),(0,a.jsx)("div",{style:{position:"relative",maxHeight:"calc(600px - 140px)",marginTop:"72px",overflowY:"auto",overflowX:"hidden",padding:"0 24px",scrollbarWidth:"thin",scrollbarColor:"#1f293740 transparent"},children:(0,a.jsxs)("div",{style:{padding:"16px 0",minHeight:"300px"},children:[0===p.length?(0,a.jsx)("div",{style:{textAlign:"center",paddingTop:"40px"},children:(0,a.jsxs)("div",{style:{color:"#6b7280",fontSize:"0.875rem",lineHeight:"1.5"},children:[(0,a.jsx)("p",{style:{fontWeight:"500",marginBottom:"8px"},children:"複数の操作を組み合わせた指示も可能です"}),(0,a.jsxs)("div",{style:{fontSize:"0.75rem",color:"#9ca3af",display:"flex",flexDirection:"column",gap:"4px"},children:[(0,a.jsx)("p",{children:"\uD83E\uDDE9 例: 子要素「概要」「詳細」を追加して"}),(0,a.jsx)("p",{children:"✏️ 例: テキストを「新しいタイトル」に変更して"}),(0,a.jsx)("p",{children:"� 例: ルート要素に「テスト」を追加し、そこに移動して"}),(0,a.jsx)("p",{children:"\uD83D\uDCDD 例: 「概要」要素を選択して内容を「新しい概要」に変更"})]})]})}):(0,a.jsx)("div",{style:{display:"flex",flexDirection:"column",gap:"16px"},children:p.map(e=>(0,a.jsx)("div",{style:{display:"flex",justifyContent:"user"===e.sender?"flex-end":"flex-start"},children:(0,a.jsx)("div",{style:{maxWidth:"75%",padding:"12px 16px",borderRadius:"16px",fontSize:"0.875rem",fontWeight:"500",boxShadow:"0 1px 2px 0 rgba(0, 0, 0, 0.05)",whiteSpace:"pre-wrap",..."user"===e.sender?{background:"linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)",color:"#ffffff",marginLeft:"16px"}:{backgroundColor:"#f9fafb",border:"1px solid #e5e7eb",color:"#1f2937",marginRight:"16px"}},children:e.text})},e.id))}),(0,a.jsx)("div",{ref:m})]})}),(0,a.jsx)("div",{style:{position:"absolute",bottom:0,left:0,right:0,padding:"12px 12px",borderTop:"1px solid #e5e7eb",background:"linear-gradient(135deg, #f8fafc 0%, #e5e7eb 100%)",borderRadius:"0 0 16px 16px"},children:(0,a.jsxs)("div",{style:{display:"flex",gap:"8px"},children:[(0,a.jsx)("input",{ref:E,type:"text",value:x,onChange:e=>f(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),w())},placeholder:"メッセージを入力...",disabled:r,style:{flex:1,padding:"6px 10px",border:"1px solid #e5e7eb",borderRadius:"8px",fontSize:"0.85rem",outline:"none",backgroundColor:"#f9fafb",transition:"all 0.2s ease",boxShadow:"0 1px 2px 0 rgba(0, 0, 0, 0.05)",minHeight:"32px",height:"32px",lineHeight:"20px",boxSizing:"border-box",display:"block"},onFocus:e=>{e.target.style.borderColor="#3b82f6",e.target.style.backgroundColor="#ffffff",e.target.style.boxShadow="0 0 0 3px rgba(59, 130, 246, 0.1)"},onBlur:e=>{e.target.style.borderColor="#e5e7eb",e.target.style.backgroundColor="#f9fafb",e.target.style.boxShadow="0 1px 2px 0 rgba(0, 0, 0, 0.05)"}}),(0,a.jsx)(c.A,{onClick:()=>w(),disabled:!x.trim()||r,"aria-label":"送信",size:"small",sx:{background:!x.trim()||r?"linear-gradient(135deg, #dbeafe 0%, #93c5fd 100%)":"linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)",color:"#fff",borderRadius:"8px",boxShadow:"0 2px 4px 0 rgba(0,0,0,0.1)",opacity:!x.trim()||r?.5:1,width:"32px",height:"32px",transition:"all 0.2s ease",display:"flex",alignItems:"center",justifyContent:"center","&:hover":{background:!r&&x.trim()?"linear-gradient(135deg, #2563eb 0%, #3b82f6 100%)":"linear-gradient(135deg, #dbeafe 0%, #93c5fd 100%)",boxShadow:"0 4px 8px 0 rgba(0,0,0,0.15)"}},children:r?(0,a.jsx)("div",{style:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center"},children:(0,a.jsx)("div",{style:{width:"14px",height:"14px",border:"2px solid #ffffff",borderTop:"2px solid transparent",borderRadius:"50%",animation:"spin 1s linear infinite"}})}):(0,a.jsx)("span",{style:{display:"flex",alignItems:"center",justifyContent:"center",padding:"2px"},children:(0,a.jsx)(h.A,{style:{fontSize:14},htmlColor:"#fff"})})})]})})]})})]});return b?(0,l.createPortal)(C,b):null};var p=r(5071),u=r(8963),x=r(4149),f=r(9929),m=r(1782);async function E(e,t,r,a,n,i,o,s,l){let{type:d}=e,c=t;switch(!c&&a.state.hierarchicalData&&(c=Object.keys((0,m.Xd)(a.state.hierarchicalData))[0]),d){case"ADD_ELEMENTS":{let t=e.elements||[],n="current"===e.targetId?c:e.targetId,i=e.autoSelect||!1,o=`ADD_ELEMENTS_${n}_${t.join("_")}`;if(s&&s(o,{targetId:n,elements:t},2e3))return Promise.resolve({message:"重複実行を防止しました"});if(console.log(`[Chat] ADD_ELEMENTS: targetId=${n}, selectedElementId=${c}, operation.targetId=${e.targetId}`),a.state.hierarchicalData){let e=(0,m.nn)(a.state.hierarchicalData);console.log(`[Chat] 現在の要素数: ${e.length}`)}if(n&&!(0,m.sv)(a.state.hierarchicalData,n)){if(console.error(`[Chat] 要素が見つかりません: targetId=${n}, hierarchicalData exists=${!!a.state.hierarchicalData}`),a.state.hierarchicalData){let e=(0,m.nn)(a.state.hierarchicalData).map(e=>e.id);console.log(`[Chat] 利用可能な要素ID: ${e.join(", ")}`)}throw Error(`対象要素（ID: ${n}）が見つかりません。要素が削除されている可能性があります。`)}return new Promise((e,a)=>{r({type:"ADD_ELEMENTS_SILENT",payload:{targetNodeId:n,targetPosition:"child",texts:t,tentative:!1,onSuccess:a=>{if(console.log(`[Chat] 要素追加成功: ${a.join(", ")}`),l&&l(o,{targetId:n,elements:t}),i&&a.length>0){let n=a[0],i=t[0];console.log(`[Chat] autoSelect: 「${i}」(ID: ${n})を選択します`),setTimeout(()=>{r({type:"SELECT_ELEMENT",payload:{id:n}})},100),e({message:`${t.length}個の要素を追加し、「${i}」を選択しました`,newSelectedElementId:n})}else e({message:`${t.length}個の要素を追加しました: ${t.join(", ")}`})},onError:e=>{a(Error(`要素の追加に失敗しました: ${e}`))}}})})}case"SELECT_ELEMENT":{let t=e.targetText,n=e.targetId;if(t){var h,g;let e=null;for(let r=0;r<5&&(h=a,g=t,!(e=h.state.hierarchicalData?function e(t){if(t.data?.texts?.includes(g))return{id:t.data.id};if(t.children)for(let r of t.children){let t=e(r);if(t)return t}return null}(h.state.hierarchicalData.root):null));r++)await new Promise(e=>setTimeout(e,50));if(e)return r({type:"SELECT_ELEMENT",payload:{id:e.id}}),{message:`要素「${t}」を選択しました`,newSelectedElementId:e.id};return console.log(`[Chat] SELECT_ELEMENT: 「${t}」が見つかりません`),{message:`要素「${t}」が見つかりませんでした。状態更新を待機してください。`}}if(n)return r({type:"SELECT_ELEMENT",payload:{id:n}}),{message:`要素を選択しました`,newSelectedElementId:n};return{message:"選択対象が指定されていません"}}case"UPDATE_TEXT":return r({type:"UPDATE_TEXT",payload:{id:c,index:0,value:e.newText||""}}),{message:`テキストを「${e.newText||""}」に更新しました`};case"DELETE_ELEMENT":return r({type:"DELETE_ELEMENT"}),{message:"要素を削除しました"};case"ADD_SIBLING_ELEMENT":return r({type:"ADD_SIBLING_ELEMENT"}),{message:"兄弟要素を追加しました"};case"COPY_ELEMENT":return r({type:"COPY_ELEMENT"}),{message:"要素をコピーしました"};case"DROP_ELEMENT":{let t="current"===e.targetNodeId?c:e.targetNodeId;if(console.log(`[Chat] DROP_ELEMENT: operation.targetNodeId=${e.targetNodeId}, resolvedTargetNodeId=${t}, selectedElementId=${c}`),"current"===e.targetNodeId&&t){let e=n?n():a;if(e?.state.hierarchicalData&&!(0,m.sv)(e.state.hierarchicalData,t)){console.error(`[Chat] DROP_ELEMENT: 新しい親 ${t} が階層データに見つかりません`);let r=(0,m.nn)(e.state.hierarchicalData).map(e=>e.id);throw console.log(`[Chat] 利用可能な要素ID: ${r.join(", ")}`),Error(`新しい親 current が見つかりません。ID: ${t}`)}}let i={id:c,targetNodeId:t||null};return void 0!==e.targetIndex&&(i.targetIndex=e.targetIndex),void 0!==e.direction&&("left"===e.direction||"right"===e.direction||"none"===e.direction)&&(i.direction=e.direction),r({type:"DROP_ELEMENT",payload:i}),{message:"要素を移動しました"}}case"ERROR":throw Error(e.message||"操作エラーが発生しました");default:throw Error(`サポートされていない操作です: ${d}`)}}var b=r(5512);function y(e){let{children:t}=e;return(0,a.jsx)(o.t,{children:(0,a.jsx)(s.K,{children:(0,a.jsxs)(i.O,{children:[t,(0,a.jsx)(w,{})]})})})}function w(){let{currentTab:e,dispatch:t}=(0,b.A)(),r=n.useCallback(()=>e,[e]),{handleChatMessage:i,isLoading:o}=function(e){let{currentTab:t,dispatch:r,getLatestState:a}=e,[i,o]=(0,n.useState)(!1),[s,l]=(0,n.useState)(0),d=(0,n.useRef)(new Map),c=function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2e3,a=t?`${e}_${JSON.stringify(t)}`:e,n=Date.now(),i=d.current.get(a);return i&&n-i<r?(console.log(`[${e}] 重複実行を防止しました (前回実行: ${n-i}ms前, key: ${a})`),!0):(d.current.set(a,n),!1)},h=(e,t)=>{let r=t?`${e}_${JSON.stringify(t)}`:e;d.current.delete(r),console.log(`[${e}] 操作完了、重複防止キーをクリア: ${r}`)};return{handleChatMessage:(0,n.useCallback)(async e=>{if(i)throw Error("処理中です。しばらくお待ちください。");o(!0);let n=null;try{if(!t)throw Error("アクティブなタブがありません。");let i=t.state.hierarchicalData?(0,m.WN)(t.state.hierarchicalData):[];if(0===i.length){let e=t.state.hierarchicalData?(0,m.Xd)(t.state.hierarchicalData):{},r=Object.keys(e)[0];n=e[r]||null}else n=i[0];let o=(0,f.EJ)(n?.texts?.[0]||"")||"未選択",d=t.state.hierarchicalData?(0,m.Xd)(t.state.hierarchicalData):{},g=t.state.hierarchicalData?(0,f.Je)(t.state.hierarchicalData):"階層構造データがありません";console.log("[Chat] 構造情報:",{hasHierarchicalData:!!t.state.hierarchicalData,elementsMapSize:Object.keys(d).length,structureLength:g.length});let b=await (0,u.CG)();if(!b)throw Error("APIキーが設定されていません。設定画面からAPIキーを設定してください。");let y=(0,x.ie)({selectedElement:o,currentStructure:g,userInput:e}),w=(0,x.CL)();console.log("[Chat] リクエスト:",{selectedElement:o,instruction:e}),console.log("[Chat] ユーザープロンプト:",y),console.log("[Chat] システムプロンプト:",w);let C=(0,u.OA)(),D=await (0,p.pq)(y,b,C,!1,w);if("string"==typeof D){let e;if(!D.trim())throw Error("AIからの応答が空でした。プロンプトを確認してください。");let i=D.replace(/```json\s*|```\s*/g,"").trim();console.log("[Chat] クリーンアップ後のレスポンス:",i);try{e=JSON.parse(i)}catch(e){throw console.log("[Chat] JSONパースエラー:",{error:e,originalResponse:D,cleanedResponse:i}),Error("AIからの応答を解析できませんでした。再度お試しください。")}let o=e.operations;if(!o||0===o.length)throw Error("実行可能な操作が見つかりませんでした。");let d=[],g=n.id;for(let e=0;e<o.length;e++){let n=o[e];e>0&&await new Promise(e=>setTimeout(e,300)),console.log(`[Chat] 操作 ${e+1}/${o.length} 実行中: ${n.type}, currentSelectedElementId=${g}`);let i=await E(n,g,r,t,a,s,l,c,h);d.push(i.message),i.newSelectedElementId&&(g=i.newSelectedElementId,console.log(`[Chat] 選択要素IDを更新: ${g}`),await new Promise(e=>setTimeout(e,400))),e<o.length-1&&await new Promise(e=>setTimeout(e,200))}return console.log("[Chat] 結果:",{operationsCount:o.length,results:d}),1===d.length?d[0]:`${d.length}個の操作を実行しました:
${d.map((e,t)=>`${t+1}. ${e}`).join("\n")}`}if("object"==typeof D&&null!==D)return console.log("[Chat] オブジェクトレスポンス:",D),"オブジェクトレスポンスを受信しました";throw Error("予期しないレスポンスの型です")}catch(r){let e=r instanceof Error?r.message:"不明なエラーが発生しました";console.error("[Chat] エラー詳細:",{message:e,error:r,selectedElementId:n?.id,selectedElementText:n?.texts?.[0],timestamp:new Date().toISOString()});let t=e;throw e.includes("要素が削除されている可能性があります")?t="操作対象の要素が見つかりません。ページを更新するか、別の要素を選択してください。":e.includes("選択された要素がありません")?t="要素を選択してから操作を実行してください。":e.includes("応答を解析できませんでした")&&(t="AIからの応答を処理できませんでした。もう一度お試しください。"),Error(t)}finally{o(!1)}},[t,r,i,a,s,l]),isLoading:i}}({currentTab:e,dispatch:t,getLatestState:r}),[s,l]=n.useState(!1),[d,c]=n.useState(""),h=n.useCallback(()=>{l(e=>!e)},[]),y=n.useCallback(()=>{c("")},[]);return n.useEffect(()=>{let e=e=>{let t=e.detail.message;l(!0),c(t)};return window.addEventListener("aiAssistantMessage",e),()=>{window.removeEventListener("aiAssistantMessage",e)}},[]),(0,a.jsx)(g,{onSendMessage:i,isLoading:o,isVisible:s,onToggle:h,externalMessage:d,onExternalMessageProcessed:y})}},6948:(e,t,r)=>{Promise.resolve().then(r.bind(r,395)),Promise.resolve().then(r.bind(r,4581)),Promise.resolve().then(r.t.bind(r,7107,23))},7107:()=>{}},e=>{var t=t=>e(e.s=t);e.O(0,[578,659,169,167,441,684,358],()=>t(6948)),_N_E=e.O()}]);
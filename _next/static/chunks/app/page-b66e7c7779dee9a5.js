(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{653:(e,t,r)=>{Promise.resolve().then(r.bind(r,1359))},1359:(e,t,r)=>{"use strict";r.d(t,{default:()=>e3});var l=r(5155);let i={invalidDrop:"無効なドロップ操作です",dropChildElement:"子要素にドロップすることはできません",dropSelfChild:"自身の子要素に移動することはできません",dropCircularReference:"循環参照となるため移動できません",dropInvalidHierarchy:"要素の階層構造が不正となるため移動できません",noSelect:"要素を選択してから実行してください",dragError:"ドラッグ操作中にエラーが発生しました",aiError:"AI処理に失敗しました",noApiKey:"APIキーが設定されていません",noPrompt:"入力情報(プロンプト)が設定されていません",clipboardEmpty:"クリップボードにテキストがありません",clipboardReadError:"クリップボードの読み取りに失敗しました"};var n=r(2115);let o=(0,n.createContext)(void 0),a=e=>{let{children:t,state:r,dispatch:i}=e,a=(0,n.useMemo)(()=>({state:r,dispatch:i}),[r,i]);return(0,l.jsx)(o.Provider,{value:a,children:t})},s=()=>{let e=(0,n.useContext)(o);if(!e)throw Error("useCanvas must be used within a CanvasProvider");return e};var d=r(829),c=r(3346),h=r(8265),p=r(7871);let u=(0,n.memo)(e=>{let{x:t,y:r,width:i,height:o,text:a,zoomRatio:s,fontFamily:u,onHeightChange:x,onTextClick:f}=e,[m,g]=(0,n.useState)({width:0,height:0}),[E,y]=(0,n.useState)(!1),[T,O]=(0,n.useState)(d._K),b=(0,n.useRef)(null),C=(0,n.useRef)({width:0,height:0}),I=(0,n.useRef)(a);return((0,n.useRef)(x).current=x,(0,n.useEffect)(()=>{O((0,p.vG)())},[]),(0,n.useEffect)(()=>{let e;return y(!0),E&&(a!==I.current||i!==C.current.width||o!==C.current.height)&&(e=requestAnimationFrame(()=>{if(!b.current)return;let e=Math.min(d.SK.WIDTH.MAX,i);(0,h.c)(`[updateDimensions] text: ${a}  size: ${e} x ${o}`);let t=(0,c.C1)(a||"",e,s),r=d.gI*d.RZ*s,l=Math.max(d.SK.SECTION_HEIGHT*s,(r+d.rF.VERTICAL)*s),n=Math.max(t.length*r,l)+d.rF.VERTICAL*s,p=Math.abs(e-C.current.width)>1,u=Math.abs(n-C.current.height)>1;(p||u)&&(g({width:e,height:n}),C.current={width:e,height:n})}),I.current=a),()=>{e&&cancelAnimationFrame(e)}},[a,i,o,s,E]),E)?(0,l.jsx)("foreignObject",{x:t,y:r,width:m.width,height:Math.round(m.height/s),pointerEvents:"auto",children:(0,l.jsx)("div",{ref:b,onClick:e=>{f?f(e,a):e.stopPropagation()},style:{fontFamily:u||d.zs,color:T,fontSize:`${d.gI}px`,lineHeight:d.RZ,width:`${m.width-d.rF.HORIZONTAL}px`,minHeight:`${d.SK.SECTION_HEIGHT}px`,padding:`${.5*d.rF.VERTICAL}px ${.5*d.rF.HORIZONTAL}px`,overflow:"hidden",whiteSpace:"pre-wrap",wordBreak:"break-word",boxSizing:"content-box",cursor:"pointer"},children:a})}):null});var x=r(6670),f=r(840),m=r(9605),g=r(9499),E=r(7242);let y=()=>{let[e,t]=(0,n.useState)(!1);return(0,n.useEffect)(()=>{t(!0)},[]),e},T=(e,t,r)=>((e,t)=>{if(!e.tentative)return!1;let r=Math.min(...t.filter(t=>t.parentId===e.parentId&&t.tentative).map(e=>e.order));return e.order===r})(e,r)?(0,l.jsxs)("g",{transform:`translate(${e.x+1.1*e.width},${e.y})`,onClick:e=>e.stopPropagation(),style:{cursor:"pointer",pointerEvents:"all"},"data-exclude-from-export":"true",children:[(0,l.jsxs)("g",{children:[(0,l.jsx)("rect",{x:"0",y:"0",width:"24",height:"24",rx:"4",fill:"white",stroke:"#e0e0e0",strokeWidth:"1"}),(0,l.jsx)("foreignObject",{x:"4",y:"4",width:"16",height:"16",children:(0,l.jsx)(f.A,{sx:{color:"#4CAF50","&:hover":{color:"#388E3C"},transition:"color 0.2s ease-in-out"},style:{width:"100%",height:"100%"},onClick:()=>t({type:"CONFIRM_TENTATIVE_ELEMENTS",payload:e.parentId})})})]}),(0,l.jsxs)("g",{transform:"translate(30, 0)",children:[(0,l.jsx)("rect",{x:"0",y:"0",width:"24",height:"24",rx:"4",fill:"white",stroke:"#e0e0e0",strokeWidth:"1"}),(0,l.jsx)("foreignObject",{x:"4",y:"4",width:"16",height:"16",children:(0,l.jsx)(m.A,{sx:{color:"#F44336","&:hover":{color:"#D32F2F"},transition:"color 0.2s ease-in-out"},style:{width:"100%",height:"100%"},onClick:()=>t({type:"CANCEL_TENTATIVE_ELEMENTS",payload:e.parentId})})})]})]}):null,O=n.memo(e=>{let{element:t,currentDropTarget:r,dropPosition:i,draggingElement:o,handleMouseDown:a,onHoverChange:f,dropInsertY:m,siblingInfo:O}=e,{state:b,dispatch:C}=s(),{getCurrentTabState:I,getCurrentTabNumberOfSections:v}=(0,E.u)(),A=I()||{elements:{},zoomRatio:1};v();let w=y(),k=r?.id||-1,[R,j]=(0,n.useState)(!1),S=(0,n.useRef)(!1),[_,D]=(0,n.useState)(d.iC.NORMAL.COLOR),[N,L]=(0,n.useState)(d.iC.NORMAL.STROKE_COLOR),[M,$]=(0,n.useState)(d.iC.STROKE_WIDTH),[B,H]=(0,n.useState)(""),[U,G]=(0,n.useState)(d.iC.SELECTED.STROKE_COLOR);(0,n.useEffect)(()=>{w&&(D((0,p.kN)()),L((0,p._1)()),$((0,p.xo)()),H((0,p.af)()),G((0,p.N4)()))},[w]),(0,n.useEffect)(()=>{if(t.editing||!w)return;let{newWidth:e,newHeight:r,sectionHeights:l}=(()=>{let e=(0,c.PC)(t.texts,d.rF.HORIZONTAL),r=t.texts.map(t=>{let r=(0,c.C1)(t||"",e,A.zoomRatio).length;return Math.max(d.SK.SECTION_HEIGHT*A.zoomRatio,r*d.gI*d.RZ+d.rF.VERTICAL*A.zoomRatio)});return{newWidth:e,newHeight:r.reduce((e,t)=>e+t,0),sectionHeights:r}})();t.editing||e===t.width&&r===t.height||C({type:"UPDATE_ELEMENT_SIZE",payload:{id:t.id,width:e,height:r,sectionHeights:l}})},[t.editing,t.texts,t.width,t.height,C,t.id,A.zoomRatio]);let P=(0,n.useMemo)(()=>Object.values(A.elements).filter(e=>e.parentId===t.id&&!e.visible),[A.elements,t.id]),F=!!o&&(o.id===t.id||(0,g.K9)(A.elements,o.id,t.id)),W=(0,n.useCallback)((e,r)=>{let l=t.sectionHeights[e];if(null!==l&&Math.abs(r-l)>1){let l=[...t.sectionHeights];l[e]=r;let i=(0,c.PC)(t.texts,d.rF.HORIZONTAL),n=l.reduce((e,t)=>e+t,0);(0,h.c)(`[IdeaElement][handleHeightChange] resized: ${t.texts} ${t.width} x ${t.height} -> ${i} x ${n}`),C({type:"UPDATE_ELEMENT_SIZE",payload:{id:t.id,width:i,height:n,sectionHeights:l}})}},[C,t]),X=e=>{e.stopPropagation(),C({type:"SELECT_ELEMENT",payload:{id:t.id,ctrlKey:e.ctrlKey||e.metaKey,shiftKey:e.shiftKey}})},K=(0,n.useCallback)(()=>{j(!0),f&&!S.current&&(f(t.id,!0),S.current=!0)},[t.id,f]),Y=(0,n.useCallback)(()=>{j(!1),f&&S.current&&(f(t.id,!1),S.current=!1)},[t.id,f]);(0,n.useEffect)(()=>()=>{f&&S.current&&f(t.id,!1)},[t.id,f]);let z=/(https?:\/\/[^\s]+)/g,V=(0,n.useCallback)((e,t)=>{e.stopPropagation();let r=t.match(z);if((e.ctrlKey||e.metaKey)&&r&&r.length>0){let e=window.getSelection();if(e&&e.toString()){let t=e.toString(),l=r.find(e=>t.includes(e)||e.includes(t));if(l){window.open(l,"_blank");return}}else for(let e of r)if(-1!==t.indexOf(e)){window.open(e,"_blank");return}}X(e)},[]);return w?(0,l.jsx)(n.Fragment,{children:(0,l.jsxs)("g",{opacity:F?.3:1,children:[T(t,C,Object.values(A.elements)),P.length>0&&(0,l.jsxs)(l.Fragment,{children:[t.texts.length>1?(0,l.jsx)("rect",{x:t.x+d.N,y:t.y+d.N,width:t.width,height:t.height,rx:d.iC.RX,fill:"none",stroke:d.iC.SHADDOW.COLOR,strokeWidth:M},`shadow-${t.id}`):(0,l.jsx)("line",{x1:t.x+d.N,y1:t.y+t.height+d.N,x2:t.x+t.width+d.N,y2:t.y+t.height+d.N,stroke:d.iC.SHADDOW.COLOR,strokeWidth:M},`shadow-line-${t.id}`),(0,l.jsxs)("g",{transform:`translate(${t.x+1.1*t.width},${t.y})`,onClick:e=>{e.stopPropagation(),C({type:"SELECT_ELEMENT",payload:{id:t.id,ctrlKey:!1,shiftKey:!1}}),C({type:"EXPAND_ELEMENT"})},style:{cursor:"pointer"},"data-exclude-from-export":"true",children:[(0,l.jsx)("rect",{x:"0",y:"0",width:"24",height:"24",rx:"4",fill:"white",stroke:"#e0e0e0",strokeWidth:"1"}),(0,l.jsx)("svg",{x:"4",y:"4",width:"16",height:"16",viewBox:"0 0 24 24",children:(0,l.jsx)(x.A,{sx:{color:"#666666"},style:{width:"100%",height:"100%"}})})]})]}),(0,l.jsx)("defs",{children:(0,l.jsx)("filter",{id:"boxShadow",x:"-20%",y:"-20%",width:"140%",height:"140%",children:(0,l.jsx)("feDropShadow",{dx:"2",dy:"2",stdDeviation:"3",floodColor:"gray"})})}),(0,l.jsx)("rect",{x:t.x,y:t.y,width:t.width,height:t.height,rx:d.iC.RX,strokeWidth:M,stroke:t.texts.length>1?t.selected?U:t.tentative?"#9E9E9E":N:"transparent",strokeDasharray:t.tentative?"4 2":"none",onClick:X,onDoubleClick:()=>C({type:"EDIT_ELEMENT"}),onMouseDown:e=>a(e,t),onMouseEnter:K,onMouseLeave:Y,"data-element-id":t.id,style:{fill:t.id===k&&"child"===i?d.iC.DRAGGING.COLOR:_,strokeOpacity:t.tentative?.6:1,pointerEvents:"all",cursor:R?"pointer":"default",filter:t.selected&&t.texts.length>1?"url(#boxShadow)":"none"}}),1===t.texts.length&&w&&(0,l.jsxs)(l.Fragment,{children:[t.selected&&(0,l.jsx)("line",{x1:t.x+2,y1:t.y+t.height+2,x2:t.x+t.width+1,y2:t.y+t.height+2,strokeOpacity:.4,stroke:N,strokeWidth:t.selected&&0===M?2:M,strokeLinecap:"round",pointerEvents:"none","data-exclude-from-export":"true"}),(0,l.jsx)("line",{x1:t.x,y1:t.y+t.height,x2:t.x+t.width,y2:t.y+t.height,stroke:t.selected?U:t.tentative?"#9E9E9E":N,strokeWidth:t.selected&&0===M?2:M,strokeDasharray:t.tentative?"4 2":"none",pointerEvents:"none"})]}),t.texts.map((e,r)=>(0,l.jsxs)(n.Fragment,{children:[!t.editing&&(0,l.jsx)(u,{x:t.x,y:t.y+t.sectionHeights.slice(0,r).reduce((e,t)=>e+t,0),width:t.width,height:t.sectionHeights[r],text:e,fontSize:d.gI,zoomRatio:A.zoomRatio,fontFamily:B,onHeightChange:e=>W(r,e),onTextClick:V}),r<t.texts.length-1&&(0,l.jsx)("line",{x1:t.x,y1:t.y+t.sectionHeights.slice(0,r+1).reduce((e,t)=>e+t,0),x2:t.x+t.width,y2:t.y+t.sectionHeights.slice(0,r+1).reduce((e,t)=>e+t,0),stroke:N,strokeWidth:"1"})]},`${t.id}-section-${r}`))]})},t.id):null}),b=e=>{let{element:t,isHovered:r,currentDropTarget:i,dropPosition:n,isDraggedOrDescendant:o,siblingInfo:a}=e;return h.y&&r?(0,l.jsx)("foreignObject",{x:t.x+t.width+10,y:t.y-10,width:"360",height:"420",className:"debug-info","data-exclude-from-export":"true",children:(0,l.jsxs)("div",{style:{fontSize:"11px",color:"black",backgroundColor:"white",border:"1px solid #ccc",padding:"5px",borderRadius:"4px",boxShadow:"0 2px 5px rgba(0,0,0,0.2)"},children:[(0,l.jsxs)("h3",{style:{margin:"0 0 5px 0"},children:["id: ",t.id]}),(0,l.jsx)("table",{style:{borderCollapse:"collapse",width:"100%"},children:(0,l.jsxs)("tbody",{children:[(0,l.jsxs)("tr",{children:[(0,l.jsx)("td",{children:"position"}),(0,l.jsx)("td",{children:":"}),(0,l.jsxs)("td",{children:["x: ",t.x,", y: ",t.y]})]}),(0,l.jsxs)("tr",{children:[(0,l.jsx)("td",{children:"size"}),(0,l.jsx)("td",{children:":"}),(0,l.jsxs)("td",{children:["width: ",t.width,", height: ",t.height]})]}),(0,l.jsxs)("tr",{children:[(0,l.jsx)("td",{children:"texts"}),(0,l.jsx)("td",{children:":"}),(0,l.jsx)("td",{children:t.texts.map((e,t)=>(0,l.jsxs)("div",{children:[t,": ",e?`"${e}"`:"(empty)"]},t))})]}),(0,l.jsxs)("tr",{children:[(0,l.jsx)("td",{children:"sectionHeights"}),(0,l.jsx)("td",{children:":"}),(0,l.jsx)("td",{children:t.sectionHeights.map((e,t)=>(0,l.jsxs)("div",{children:[t,": ",e]},t))})]}),(0,l.jsxs)("tr",{children:[(0,l.jsx)("td",{children:"parent"}),(0,l.jsx)("td",{children:":"}),(0,l.jsx)("td",{children:t.parentId||"root"})]}),(0,l.jsxs)("tr",{children:[(0,l.jsx)("td",{children:"depth"}),(0,l.jsx)("td",{children:":"}),(0,l.jsx)("td",{children:t.depth})]}),(0,l.jsxs)("tr",{children:[(0,l.jsx)("td",{children:"order"}),(0,l.jsx)("td",{children:":"}),(0,l.jsx)("td",{children:t.order})]}),(0,l.jsxs)("tr",{children:[(0,l.jsx)("td",{children:"children"}),(0,l.jsx)("td",{children:":"}),(0,l.jsx)("td",{children:t.children})]}),(0,l.jsxs)("tr",{children:[(0,l.jsx)("td",{children:"startMarker"}),(0,l.jsx)("td",{children:":"}),(0,l.jsx)("td",{children:t.startMarker})]}),(0,l.jsxs)("tr",{children:[(0,l.jsx)("td",{children:"endMarker"}),(0,l.jsx)("td",{children:":"}),(0,l.jsx)("td",{children:t.endMarker})]}),(0,l.jsxs)("tr",{children:[(0,l.jsx)("td",{children:"selected"}),(0,l.jsx)("td",{children:":"}),(0,l.jsx)("td",{children:t.selected?"Yes":"No"})]}),(0,l.jsxs)("tr",{children:[(0,l.jsx)("td",{children:"visible"}),(0,l.jsx)("td",{children:":"}),(0,l.jsx)("td",{children:t.visible?"Yes":"No"})]}),(0,l.jsxs)("tr",{children:[(0,l.jsx)("td",{children:"editing"}),(0,l.jsx)("td",{children:":"}),(0,l.jsx)("td",{children:t.editing?"Yes":"No"})]}),(0,l.jsxs)("tr",{children:[(0,l.jsx)("td",{children:"tentative"}),(0,l.jsx)("td",{children:":"}),(0,l.jsx)("td",{children:t.tentative?"Yes":"No"})]}),i&&i.id===t.id&&(0,l.jsx)("tr",{children:(0,l.jsxs)("td",{colSpan:3,style:{color:"blue"},children:["DROP TARGET (",n,")"]})}),o&&(0,l.jsx)("tr",{children:(0,l.jsx)("td",{colSpan:3,style:{color:"red"},children:"BEING DRAGGED"})}),a&&(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("tr",{children:(0,l.jsx)("td",{colSpan:3,style:{fontWeight:"bold"},children:"sibling info:"})}),a.prevElement&&(0,l.jsxs)("tr",{children:[(0,l.jsx)("td",{children:"prev"}),(0,l.jsx)("td",{children:":"}),(0,l.jsxs)("td",{children:[a.prevElement.id," (order: ",a.prevElement.order,")"]})]}),a.nextElement&&(0,l.jsxs)("tr",{children:[(0,l.jsx)("td",{children:"next"}),(0,l.jsx)("td",{children:":"}),(0,l.jsxs)("td",{children:[a.nextElement.id," (order: ",a.nextElement.order,")"]})]})]})]})})]})}):null},C={"Ctrl+z":"UNDO","Ctrl+Shift+z":"REDO",ArrowUp:"ARROW_UP",ArrowDown:"ARROW_DOWN",ArrowRight:"ARROW_RIGHT","Ctrl+ArrowRight":"EXPAND_ELEMENT",ArrowLeft:"ARROW_LEFT","Ctrl+ArrowLeft":"COLLAPSE_ELEMENT","Ctrl+x":"CUT_ELEMENT","Ctrl+c":"COPY_ELEMENT","Ctrl+v":"PASTE_ELEMENT",Tab:"ADD_ELEMENT","Shift+Tab":"ADD_SIBLING_ELEMENT","Shift+Enter":"ADD_SIBLING_ELEMENT",Delete:"DELETE_ELEMENT",Backspace:"DELETE_ELEMENT",Enter:"EDIT_ELEMENT"},I={Tab:"NEXT_FIELD",Escape:"END_EDITING","Ctrl+Enter":"END_EDITING","Alt+Enter":"END_EDITING","Meta+Enter":"END_EDITING"},v=n.memo(e=>{let{element:t,onEndEditing:r}=e,{dispatch:i,state:o}=s(),a=y(),h=(0,n.useRef)([]),[u,x]=(0,n.useState)([]),[f,m]=(0,n.useState)(-1),g=(0,n.useRef)(null),E=(0,n.useRef)(void 0),[T,O]=(0,n.useState)(""),[b,C]=(0,n.useState)(""),[v,A]=(0,n.useState)("");(0,n.useEffect)(()=>{a&&(g.current=document.createElement("canvas").getContext("2d"),O((0,p.af)()),C((0,p.kN)()),A((0,p.vG)()))},[a]),(0,n.useEffect)(()=>{a&&t?.id!==E.current&&(x(t?.sectionHeights||[]),m(0),E.current=t?.id,setTimeout(()=>{let e=h.current[0];if(e){e.focus({preventScroll:!0});let r=t?.texts[0]?.length||0;e.setSelectionRange(r,r)}},50))},[t,a]);let w=(0,n.useCallback)(e=>{let t=d.SK.WIDTH.MAX,r=(0,c.C1)(e,t,o.zoomRatio).length,l=d.gI*d.RZ*o.zoomRatio,i=d.rF.VERTICAL*o.zoomRatio;return Math.max(d.SK.SECTION_HEIGHT*o.zoomRatio,r*l+i)},[o.zoomRatio]),k=(0,n.useCallback)((e,r)=>{let l=e.target.value,n=w(l);x(e=>{let t=[...e];return t[r]=n/o.zoomRatio,t}),i({type:"UPDATE_TEXT",payload:{id:t.id,index:r,value:l}});let a=h.current[r];a&&(a.style.height=`${n}px`)},[t,o.zoomRatio,i,w]),R=(0,n.useCallback)(e=>{let l=e+1;if(t&&l<t.texts.length){let e=h.current[l];if(e){let{scrollX:r,scrollY:i}=window;e.focus({preventScroll:!0});let n=t.texts[l]?.length||0;e.setSelectionRange(n,n),m(l),window.scrollTo(r,i)}}else r?.(),i({type:"END_EDITING"})},[t,r,i]),j=(e,t)=>{let l=I[[e.ctrlKey&&"Ctrl",e.altKey&&"Alt",e.metaKey&&"Meta",e.key].filter(Boolean).join("+")];if(l)switch(e.preventDefault(),l){case"NEXT_FIELD":R(t);break;case"END_EDITING":r?.(),i({type:"END_EDITING"})}};return t&&a?(0,l.jsx)(l.Fragment,{children:t.texts.map((e,r)=>{let i=u.slice(0,r).reduce((e,t)=>e+t,0)*o.zoomRatio,n=d.SK.WIDTH.MAX*o.zoomRatio,s=w(e);return(0,l.jsx)("textarea",{ref:e=>{h.current[r]=e,r===f&&a&&e?.focus({preventScroll:!0})},value:e,onChange:e=>k(e,r),onKeyDown:e=>j(e,r),onClick:e=>e.stopPropagation(),style:{position:"absolute",left:`${t.x*o.zoomRatio}px`,top:`${t.y*o.zoomRatio+i}px`,width:`${n}px`,height:`${s}px`,minWidth:`${d.SK.WIDTH.MAX*o.zoomRatio}px`,maxWidth:`${d.SK.WIDTH.MAX*o.zoomRatio}px`,minHeight:`${d.SK.SECTION_HEIGHT*o.zoomRatio}px`,margin:"1px 1px",fontSize:`${d.gI*o.zoomRatio}px`,lineHeight:`${d.RZ}em`,padding:"0 3px",fontFamily:T,backgroundColor:b,color:v,boxSizing:"border-box",WebkitFontSmoothing:"antialiased",MozOsxFontSmoothing:"grayscale",overflow:"hidden",whiteSpace:"pre-wrap",wordWrap:"break-word",resize:"none",zIndex:1e4,opacity:1,transition:"all 0.2s ease-in-out",pointerEvents:"all"}},`${t.id}-${r}`)})}):null}),A={arrow:{id:"arrowhead",width:d.tl.WIDTH,height:d.tl.HEIGHT,isFilled:!1,shape:"polygon",pointsOrAttributes:`${d.tl.WIDTH} 0, ${d.tl.WIDTH} ${d.tl.HEIGHT}, 0 ${d.tl.HEIGHT/2}`},filledArrow:{id:"filledarrowhead",width:d.tl.WIDTH,height:d.tl.HEIGHT,isFilled:!0,shape:"polygon",pointsOrAttributes:`${d.tl.WIDTH} 0, ${d.tl.WIDTH} ${d.tl.HEIGHT}, 0 ${d.tl.HEIGHT/2}`},arrowEnd:{id:"arrowhead-end",width:d.tl.WIDTH,height:d.tl.HEIGHT,isFilled:!1,shape:"polygon",pointsOrAttributes:`0 0, 0 ${d.tl.HEIGHT}, ${d.tl.WIDTH} ${d.tl.HEIGHT/2}`},filledArrowEnd:{id:"filledarrowhead-end",width:d.tl.WIDTH,height:d.tl.HEIGHT,isFilled:!0,shape:"polygon",pointsOrAttributes:`0 0, 0 ${d.tl.HEIGHT}, ${d.tl.WIDTH} ${d.tl.HEIGHT/2}`},circle:{id:"circlemarker",width:d.p1.SIZE,height:d.p1.SIZE,isFilled:!1,shape:"circle",pointsOrAttributes:{cx:d.p1.SIZE/2,cy:d.p1.SIZE/2,r:d.p1.SIZE/2-1}},filledCircle:{id:"filledcirclemarker",width:d.p1.SIZE,height:d.p1.SIZE,isFilled:!0,shape:"circle",pointsOrAttributes:{cx:d.p1.SIZE/2,cy:d.p1.SIZE/2,r:d.p1.SIZE/2-1}},circleEnd:{id:"circlemarker-end",width:d.p1.SIZE,height:d.p1.SIZE,isFilled:!1,shape:"circle",pointsOrAttributes:{cx:d.p1.SIZE/2,cy:d.p1.SIZE/2,r:d.p1.SIZE/2-1}},filledCircleEnd:{id:"filledcirclemarker-end",width:d.p1.SIZE,height:d.p1.SIZE,isFilled:!0,shape:"circle",pointsOrAttributes:{cx:d.p1.SIZE/2,cy:d.p1.SIZE/2,r:d.p1.SIZE/2-1}},square:{id:"squaremarker",width:d.p1.SIZE,height:d.p1.SIZE,isFilled:!1,shape:"rect",pointsOrAttributes:{x:1,y:1,width:d.p1.SIZE-2,height:d.p1.SIZE-2}},filledSquare:{id:"filledsquaremarker",width:d.p1.SIZE,height:d.p1.SIZE,isFilled:!0,shape:"rect",pointsOrAttributes:{x:1,y:1,width:d.p1.SIZE-2,height:d.p1.SIZE-2}},squareEnd:{id:"squaremarker-end",width:d.p1.SIZE,height:d.p1.SIZE,isFilled:!1,shape:"rect",pointsOrAttributes:{x:1,y:1,width:d.p1.SIZE-2,height:d.p1.SIZE-2}},filledSquareEnd:{id:"filledsquaremarker-end",width:d.p1.SIZE,height:d.p1.SIZE,isFilled:!0,shape:"rect",pointsOrAttributes:{x:1,y:1,width:d.p1.SIZE-2,height:d.p1.SIZE-2}},diamond:{id:"diamondmarker",width:d.tl.WIDTH,height:d.tl.HEIGHT,isFilled:!1,shape:"polygon",pointsOrAttributes:`${d.tl.WIDTH/2},1 ${d.tl.WIDTH-1},${d.tl.HEIGHT/2} ${d.tl.WIDTH/2},${d.tl.HEIGHT-1} 1,${d.tl.HEIGHT/2}`},filledDiamond:{id:"filleddiamondmarker",width:d.tl.WIDTH,height:d.tl.HEIGHT,isFilled:!0,shape:"polygon",pointsOrAttributes:`${d.tl.WIDTH/2},1 ${d.tl.WIDTH-1},${d.tl.HEIGHT/2} ${d.tl.WIDTH/2},${d.tl.HEIGHT-1} 1,${d.tl.HEIGHT/2}`},diamondEnd:{id:"diamondmarker-end",width:d.tl.WIDTH,height:d.tl.HEIGHT,isFilled:!1,shape:"polygon",pointsOrAttributes:`${d.tl.WIDTH/2},1 ${d.tl.WIDTH-1},${d.tl.HEIGHT/2} ${d.tl.WIDTH/2},${d.tl.HEIGHT-1} 1,${d.tl.HEIGHT/2}`},filledDiamondEnd:{id:"filleddiamondmarker-end",width:d.tl.WIDTH,height:d.tl.HEIGHT,isFilled:!0,shape:"polygon",pointsOrAttributes:`${d.tl.WIDTH/2},1 ${d.tl.WIDTH-1},${d.tl.HEIGHT/2} ${d.tl.WIDTH/2},${d.tl.HEIGHT-1} 1,${d.tl.HEIGHT/2}`}},w=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=t?"-end":"";switch(e){case"arrow":return`url(#arrowhead${r})`;case"filled_arrow":return`url(#filledarrowhead${r})`;case"circle":return`url(#circlemarker${r})`;case"filled_circle":return`url(#filledcirclemarker${r})`;case"square":return`url(#squaremarker${r})`;case"filled_square":return`url(#filledsquaremarker${r})`;case"diamond":return`url(#diamondmarker${r})`;case"filled_diamond":return`url(#filleddiamondmarker${r})`;default:return}},k=e=>{let{connectionPathColor:t,connectionPathStroke:r}=e;return(0,l.jsx)(l.Fragment,{children:Object.values(A).map(e=>{let i;let{id:n,width:o,height:a,isFilled:s,shape:d,pointsOrAttributes:c}=e,h=s?t:"none",p={id:n,markerWidth:o,markerHeight:a,refX:n.endsWith("-end")?0:o,refY:a/2,orient:"auto",markerUnits:"userSpaceOnUse",viewBox:`0 0 ${o} ${a}`,strokeWidth:r,fill:h,stroke:t};return"polygon"===d?i=(0,l.jsx)("polygon",{points:c,fill:h,stroke:t}):"circle"===d?i=(0,l.jsx)("circle",{cx:c.cx,cy:c.cy,r:c.r,fill:h,stroke:t}):"rect"===d&&(i=(0,l.jsx)("rect",{x:c.x,y:c.y,width:c.width,height:c.height,fill:h,stroke:t})),(0,l.jsx)("marker",{...p,children:i},n)})})},R=e=>{let{popupX:t,popupY:r,isEndMarkerMenu:i,elementId:o,onMarkerSelect:a,onClose:s}=e,[d,c]=(0,n.useState)(null);return(0,l.jsx)("foreignObject",{x:t,y:r,width:150,height:270,className:"popup-menu",children:(0,l.jsx)("div",{className:"popup-menu",style:{position:"absolute",left:`${t}px`,top:`${r}px`,backgroundColor:"white",border:"1px solid #ccc",borderRadius:"4px",padding:"10px",boxShadow:"0 2px 10px rgba(0,0,0,0.2)",zIndex:1e3,display:"flex",flexDirection:"column",width:"150px",maxHeight:"300px",overflowY:"auto"},"data-exclude-from-export":"true",children:[{id:"arrow",label:"Arrow"},{id:"filled_arrow",label:"Filled Arrow"},{id:"circle",label:"Circle"},{id:"filled_circle",label:"Filled Circle"},{id:"square",label:"Square"},{id:"filled_square",label:"Filled Square"},{id:"diamond",label:"Diamond"},{id:"filled_diamond",label:"Filled Diamond"},{id:"none",label:"None"}].map(e=>(0,l.jsx)("div",{style:{padding:"4px 0",cursor:"pointer",backgroundColor:d===e.id?"#e0e0e0":"white"},onMouseEnter:()=>c(e.id),onMouseLeave:()=>c(null),onClick:()=>{a(o,e.id,i),s()},children:e.label},e.id))})})},j=e=>{let{element:t,absolutePosition:r,isEndMarker:i=!1,hoverId:n,onHover:o,onShowMenu:a,isInGroup:s=!1}=e;if(i&&!t.parentId)return null;let c=t.height,h=i?`end-${t.id}`:t.id,p=i?r.x-d.tl.WIDTH/2:r.x+t.width+d.tl.WIDTH/2;return(0,l.jsxs)("g",{"data-marker-button":`${h}`,"data-exclude-from-export":"true",pointerEvents:"all",children:[n===h&&(0,l.jsx)("circle",{cx:p,cy:r.y+c/2,r:d.tl.WIDTH/2,fill:"#bfbfbf",opacity:.5,pointerEvents:"none"}),(0,l.jsx)("circle",{cx:p,cy:r.y+c/2,r:d.tl.WIDTH/2,fill:"transparent",stroke:"transparent",strokeWidth:2,onMouseEnter:()=>o(h),onMouseLeave:()=>o(null),onClick:()=>a(h),style:{cursor:"pointer"},pointerEvents:"all"})]},`marker-button-${h}`)},S=e=>{let{parentElement:t,element:r,absolutePositions:i,strokeColor:n=d.lB.COLOR,strokeWidth:o=d.lB.STROKE}=e,a=0;switch(t.startMarker){case"arrow":case"filled_arrow":case"diamond":case"filled_diamond":a=d.tl.OFFSET;break;case"circle":case"filled_circle":case"square":case"filled_square":a=d.p1.OFFSET;break;default:a=0}let s=0;switch(r.endMarker){case"arrow":case"filled_arrow":case"diamond":case"filled_diamond":s=d.tl.OFFSET;break;case"circle":case"filled_circle":case"square":case"filled_square":s=d.p1.OFFSET;break;default:s=0}let c=i.parent,h=i.element,p=r.height,u=`M ${c.x+t.width+a},${c.y+t.height/2} C ${c.x+t.width+d.mO},${c.y+t.height/2} ${h.x-d.mO},${h.y+p/2} ${h.x-s},${h.y+p/2}`,x=w(t.startMarker),f=w(r.endMarker,!0);return(0,l.jsx)("path",{d:u,stroke:n,strokeWidth:o,fill:"none",markerStart:x,markerEnd:f,style:{pointerEvents:"none"}})},_=e=>{let t=Object.values(e),r=Math.max(...t.map(e=>e.x+e.width)),l=Math.max(...t.map(e=>e.y+e.height));return{width:r+d.e$.X,height:l+d.SK.SECTION_HEIGHT*d.zX}},D=e=>{let{setCanvasSize:t,setDisplayArea:r,state:l}=e;(0,n.useEffect)(()=>{let e=_(l.elements),i=window.innerHeight-2*d.JY;e.width=Math.max(e.width,window.innerWidth),e.height=Math.max(e.height,i);let n={width:e.width,height:e.height};e.width*=l.zoomRatio,e.height*=l.zoomRatio,t(e),r(`0 0 ${n.width} ${n.height}`)},[l.elements,l.zoomRatio,t,r])},N=(e,t)=>{let{dispatch:r}=s();(0,n.useEffect)(()=>{let l=e.current,i=e=>{e.target instanceof SVGElement&&"svg"===e.target.tagName&&(r({type:"DESELECT_ALL"}),t&&r({type:"END_EDITING"}))};return l?.addEventListener("mousedown",i),()=>{l?.removeEventListener("mousedown",i)}},[e,t,r])};var L=r(7451);let M=e=>"touches"in e,$=(e,t)=>Object.values(t).filter(t=>t.parentId===e.id&&t.visible).sort((e,t)=>e.order-t.order),B=()=>{let{state:e,dispatch:t}=s(),{addToast:r}=(0,L.d)(),[l,o]=(0,n.useState)(null),[a,c]=(0,n.useState)({x:0,y:0}),[p,u]=(0,n.useState)(null),x=(0,n.useRef)(new Map),f=(0,n.useCallback)(t=>{let r,l;return M(t)?(r=t.touches[0].clientX+window.scrollX,l=t.touches[0].clientY+window.scrollY):(r=t.clientX+window.scrollX,l=t.clientY+window.scrollY),{x:r/e.zoomRatio,y:(l-d.uF)/e.zoomRatio}},[e.zoomRatio]),m=(0,n.useCallback)((e,t,r)=>{let l=e.y,i=$(e,r),n=e.x+e.width+d.e$.X;return i.length,{position:"child",insertY:l+e.height/2,insertX:n}},[]),E=(0,n.useCallback)((e,t,r,i)=>{let n;let o=e.y,a=e.y+e.height,s=e.x+e.width,c=d.e$.X+(l?.width??0),p=t>=e.x&&t<s&&r>=o&&r<=a,u=t>=s&&t<s+c&&r>=o&&r<=a;if(p)n=m(e,r,i),(0,h.c)("Drop position mode (inside element):","child");else if(u){let t=$(e,i);if(0===t.length)e.x,e.width,d.e$.X,n={position:"child",insertY:e.y+e.height/2,siblingInfo:{}},(0,h.c)("Drop position mode (right side, no children):","child");else{let l,i;for(let e=0;e<t.length;e++){let n=t[e];if(r<n.y){i=n,e>0&&(l=t[e-1]);break}if(r<n.y+n.height){r<n.y+n.height/2?(i=n,e>0&&(l=t[e-1])):(l=n,e<t.length-1&&(i=t[e+1]));break}if(e===t.length-1||r<t[e+1].y){l=n,e<t.length-1&&(i=t[e+1]);break}}if(l&&i){let e=i.y-(l.y+l.height);n={position:"between",insertY:l.y+l.height+e/2,siblingInfo:{prevElement:l,nextElement:i}}}else n=l?{position:"between",insertY:l.y+l.height+d.e$.Y,siblingInfo:{prevElement:l}}:i?{position:"between",insertY:i.y-d.e$.Y,siblingInfo:{nextElement:i}}:{position:"between",insertY:e.y+e.height/2,siblingInfo:{}};(0,h.c)("Drop position mode (right side, with children):","between")}}else{let t=l?.id,o=Object.values(i).filter(r=>r.visible&&r.parentId===e.parentId&&r.depth===e.depth&&r.id!==t).sort((e,t)=>e.y-t.y);(0,h.c)(`[calculatePositionAndDistance] Found ${o.length} siblings (excluding dragging element) for element ${e.id}`);let a=null,s=null;for(let e=0;e<o.length;e++){let t=o[e];if(t.id===l?.id)continue;let i=t.y+t.height;if(r<t.y){s=t,e>0&&(a=o[e-1]);break}if(r<i){r<t.y+t.height/2?(s=t,e>0&&(a=o[e-1])):(a=t,e<o.length-1&&(s=o[e+1]));break}a=t,e<o.length-1&&(s=o[e+1])}if(a&&s){let e=s.y-(a.y+a.height);n={position:"between",insertY:a.y+a.height+e/2,siblingInfo:{prevElement:a,nextElement:s}}}else n=a?{position:"between",insertY:a.y+a.height+d.e$.Y,siblingInfo:{prevElement:a}}:s?{position:"between",insertY:s.y-d.e$.Y,siblingInfo:{nextElement:s}}:{position:"between",insertY:e.y+e.height+d.e$.Y,siblingInfo:{}};(0,h.c)("Drop position mode (between siblings):","between")}let x=e.x+e.width/2,f=e.y+e.height/2,g=t-x,E=r-f;return{...n,distanceSq:g*g+E*E}},[m,l,e.zoomRatio]),y=(0,n.useCallback)((e,t)=>{if(!l)return null;let r=f(e),i=r.x,n=r.y,o=Object.values(t).filter(e=>e.selected).map(e=>e.id),a=Object.values(t).filter(e=>{if(!e.visible||o.includes(e.id))return!1;let t=e.y,r=e.y+e.height,l=e.x,a=e.x+e.width,s=t-d.e$.Y,c=r+d.e$.Y,h=l-d.e$.X,p=a+d.e$.X;return i>=h&&i<=p&&n>=s&&n<=c});if(0===a.length){let e={};for(let r in Object.values(t).filter(e=>e.visible&&!o.includes(e.id)).forEach(t=>{let r=t.parentId||"root";e[r]||(e[r]=[]),e[r].push(t)}),e)e[r].sort((e,t)=>e.y-t.y);for(let[t,r]of Object.entries(e))if(!(r.length<2))for(let e=0;e<r.length-1;e++){let t=r[e],l=r[e+1],o=l.y-(t.y+t.height);if(o<5)continue;let a=t.y+t.height,s=l.y,d=t.x+t.width,c=l.x+l.width,h=Math.min(t.x,l.x),p=Math.max(d,c);if(i>=h&&i<=p&&n>=a&&n<=s)return{element:t,position:"between",insertY:a+o/2,siblingInfo:{prevElement:t,nextElement:l}}}for(let[r,l]of Object.entries(e)){let e,o;if(0===l.length)continue;let a=l.reduce((e,t)=>t.y+t.height>e.y+e.height?t:e,l[0]),s="root"!==r?t[r]:null;s?o=(e=s.x+s.width)+2*d.e$.X+a.width:(e=a.x-d.e$.X,o=a.x+a.width+d.e$.X);let c=a.y+a.height+2*d.e$.Y;if(i>=e&&i<=o&&n>=a.y+a.height&&n<=c)return{element:a,position:"between",insertY:a.y+a.height+d.e$.Y,siblingInfo:{prevElement:a}}}}let s=null,c=1/0;for(let e of a){let{position:r,distanceSq:l,insertY:o,siblingInfo:a}=E(e,i,n,t);l<c&&(c=l,s={element:e,position:r,insertY:o,siblingInfo:a})}return s},[l,f,E]),T=(0,n.useCallback)((t,r)=>{let l;if(!r.selected||!r.parentId)return;t.stopPropagation(),t.nativeEvent instanceof TouchEvent&&t.preventDefault();let i=f(t.nativeEvent);o(r),c({x:i.x-r.x,y:i.y-r.y}),x.current.clear(),Object.values(e.elements).filter(e=>e.selected).forEach(e=>{x.current.set(e.id,{x:e.x,y:e.y})})},[f,e.elements,t]),O=(0,n.useCallback)(()=>{Object.values(e.elements).filter(e=>e.selected).forEach(e=>{let r=x.current.get(e.id);r&&t({type:"MOVE_ELEMENT",payload:{id:e.id,x:r.x,y:r.y}})}),o(null),x.current.clear()},[e.elements,t]),b=(0,n.useCallback)((t,r)=>{if(null===r)return{isValid:!0};if(t.id===r)return(0,h.c)(`無効な操作: 自分自身を親にしようとしています element=${t.id}, newParentId=${r}`),{isValid:!1,errorMessage:i.dropSelfChild};if((0,g.K9)(e.elements,t.id,r)){let l=e.elements[r]?.parentId===t.id;return(0,h.c)(`無効な操作: ${l?"自身の子要素":"循環参照"} element=${t.id}, newParentId=${r}`),{isValid:!1,errorMessage:l?i.dropSelfChild:i.dropCircularReference}}let l=r&&e.elements[r]?.depth||0;return l>=10?((0,h.c)(`無効な操作: 最大深さ超過 currentDepth=${l}, max=10`),{isValid:!1,errorMessage:i.dropInvalidHierarchy}):{isValid:!0}},[e.elements]),C=(0,n.useCallback)((e,l)=>{let n=l.find(t=>!b(t,e.id).isValid);if(n){let{errorMessage:t}=b(n,e.id);return r(t||i.dropChildElement,"warn"),O(),!1}return t({type:"SNAPSHOT"}),l.forEach((r,l)=>{let i=e.depth+1;t({type:"DROP_ELEMENT",payload:{id:r.id,oldParentId:r.parentId,newParentId:e.id,newOrder:e.children+l,depth:i}})}),!0},[b,r,O,t]),I=(0,n.useCallback)((e,l)=>{let n;if((0,h.c)(`[processBetweenDrop] target=${e.id}, siblingInfo: ${JSON.stringify({prevElementId:p?.siblingInfo?.prevElement?.id,nextElementId:p?.siblingInfo?.nextElement?.id})}`),p?.siblingInfo){let{prevElement:t,nextElement:r}=p.siblingInfo;t&&r?((0,h.c)(`  Between two elements: prev=${t.id}(order=${t.order}), next=${r.id}(order=${r.order})`),n=t.parentId):t?((0,h.c)(`  After last element: prev=${t.id}(order=${t.order})`),n=t.parentId):r?((0,h.c)(`  Before first element: next=${r.id}(order=${r.order})`),n=r.parentId):((0,h.c)(`  No siblings: target=${e.id}`),n=e.id)}else(0,h.c)(`  No siblings info: target=${e.id}`),n=e.id;if(null===n&&!l.every(e=>1===e.depth))return r(i.invalidDrop,"warn"),O(),!1;let o=l.find(e=>!b(e,n).isValid);if(o){let{errorMessage:e}=b(o,n);return r(e||i.dropChildElement,"warn"),O(),!1}t({type:"SNAPSHOT"});let a=l.some(e=>e.parentId===n),s=l.filter(e=>e.parentId===n),d=v(p,s);return a?A(s,d.baseOrder,n):w(d.baseOrder,l.length,n),l.forEach((r,l)=>{let i=n===e.id?e.depth+1:e.depth;t({type:"DROP_ELEMENT",payload:{id:r.id,oldParentId:r.parentId,newParentId:n,newOrder:d.baseOrder+l,depth:i}})}),!0},[p,b,r,O,t,e.elements]),v=(0,n.useCallback)((e,t)=>{let r=0;if(e?.siblingInfo){let{prevElement:l,nextElement:i}=e.siblingInfo;l&&i?r=t.some(e=>e.order>l.order&&e.order<i.order)?t[0].order:t.every(e=>e.order<l.order)?i.order-t.length:l.order+1:l?r=l.order+1:i&&(t.some(e=>0===e.order)&&(i.order,t.length),r=0)}else r=0;return{baseOrder:r}},[]),A=(0,n.useCallback)((r,l,i)=>{if(0===r.length)return;let n=r.map(e=>e.order).sort((e,t)=>e-t),o=n[0],a=n[n.length-1];a<l?Object.values(e.elements).filter(e=>e.parentId===i&&e.order>a&&e.order<l+r.length&&!r.some(t=>t.id===e.id)).forEach(e=>{t({type:"UPDATE_ELEMENT_ORDER",payload:{id:e.id,order:e.order-r.length}})}):o>l&&Object.values(e.elements).filter(e=>e.parentId===i&&e.order>=l&&e.order<o&&!r.some(t=>t.id===e.id)).forEach(e=>{t({type:"UPDATE_ELEMENT_ORDER",payload:{id:e.id,order:e.order+r.length}})})},[e.elements,t]),w=(0,n.useCallback)((r,l,i)=>{Object.values(e.elements).filter(e=>e.parentId===i&&e.order>=r).forEach(e=>{t({type:"UPDATE_ELEMENT_ORDER",payload:{id:e.id,order:e.order+l}})})},[e.elements,t]),k=(0,n.useCallback)(async()=>{if(l)try{let t=Object.values(e.elements).filter(e=>e.selected);if(p){let{element:e,position:l}=p,n=t.find(t=>!b(t,e.id).isValid);if(n){let{errorMessage:t}=b(n,e.id);r(t||i.dropChildElement,"warn"),O();return}let o=!1;if("child"===l?o=C(e,t):"between"===l&&(o=I(e,t)),!o){O();return}}else O()}catch(e){console.error("Drag error:",e),r(i.dragError,"warn"),O()}finally{o(null),u(null),x.current.clear()}},[l,p,e.elements,t,r,O,C,I,b]),R=(0,n.useCallback)(r=>{if(!l)return;r instanceof TouchEvent&&1===r.touches.length&&r.preventDefault();let i=y(r,e.elements);(!p&&i||p&&!i||p&&i&&(p.element.id!==i.element.id||p.position!==i.position||"between"===i.position&&p.insertY!==i.insertY))&&u(i);let n=f(r),o={x:n.x-a.x,y:n.y-a.y};t({type:"MOVE_ELEMENT",payload:{id:l.id,...o}})},[l,p,e.elements,y,f,a,t]);return(0,n.useEffect)(()=>{if(!l)return;let e=e=>R(e),t=e=>{1===e.touches.length&&R(e)},r=()=>k(),i=()=>k();return document.addEventListener("mousemove",e),document.addEventListener("touchmove",t,{passive:!1}),document.addEventListener("mouseup",r),document.addEventListener("touchend",i),()=>{document.removeEventListener("mousemove",e),document.removeEventListener("touchmove",t),document.removeEventListener("mouseup",r),document.removeEventListener("touchend",i)}},[l,R,k]),{handleMouseDown:T,handleMouseUp:k,currentDropTarget:p?.element||null,dropPosition:p?.position||null,draggingElement:l,dropInsertY:p?.insertY,siblingInfo:p?.siblingInfo||null}},H=e=>{let{handleMouseDown:t,elements:r}=e,[l,i]=(0,n.useState)(!1),[o,a]=(0,n.useState)(0),[s,d]=(0,n.useState)({x:0,y:0}),c=(0,n.useCallback)(e=>{if(2===e.touches.length){i(!0);let t=e.touches[0],r=e.touches[1];a(Math.hypot(r.clientX-t.clientX,r.clientY-t.clientY)),d({x:window.scrollX,y:window.scrollY})}else if(1===e.touches.length){e.preventDefault();let l=e.touches[0],i=document.elementFromPoint(l.clientX,l.clientY);if(i&&(i instanceof SVGRectElement||i instanceof SVGGElement)){let n=i,o=null;for(;n&&!o;){if(n.dataset&&n.dataset.elementId){o=n.dataset.elementId;break}n=n.parentElement}if(o){let i=r[o];i&&t({nativeEvent:e.nativeEvent,stopPropagation:()=>{},preventDefault:()=>{},clientX:l.clientX,clientY:l.clientY},i)}}}},[r,t]),h=(0,n.useCallback)(e=>{if(l&&2===e.touches.length){e.preventDefault();let t=e.touches[0],r=e.touches[1],l=Math.hypot(r.clientX-t.clientX,r.clientY-t.clientY),i=t.clientX-r.clientX,n=Math.atan2(t.clientY-r.clientY,i),a=l/o,d=(t.clientX+r.clientX)/2,c=(t.clientY+r.clientY)/2;window.scrollTo({left:s.x+d*(a-1)*Math.cos(n),top:s.y+c*(a-1)*Math.sin(n),behavior:"auto"})}else 1===e.touches.length&&e.preventDefault()},[l,o,s]);return{isPinching:l,handleTouchStart:c,handleTouchMove:h,handleTouchEnd:(0,n.useCallback)(()=>{i(!1),a(0),d({x:0,y:0})},[])}};var U=r(5439);let G=e=>{let{dispatch:t,elements:r,addToast:l}=e;return(0,n.useCallback)(async e=>{e.preventDefault();let n=C[`${e.ctrlKey||e.metaKey?"Ctrl+":""}${e.shiftKey?"Shift+":""}${e.key}`];if("PASTE_ELEMENT"===n){let e=(0,U.Lt)();if(e&&Object.keys(e).length>0)t({type:n});else try{let e=await navigator.clipboard.readText(),n=Object.values(r).find(e=>e.selected);if(!n){l(i.noSelect);return}if(e){let r=e.split("\n").filter(e=>""!==e.trim());if(0===r.length){l(i.clipboardEmpty);return}t({type:"ADD_ELEMENTS_SILENT",payload:{parentId:n.id,texts:r}})}else l(i.clipboardEmpty)}catch(e){console.error("クリップボード読み取りエラー:",e),l(i.clipboardReadError)}}else n&&t({type:n})},[t,r,l])},P=e=>{let t,r,{elements:l,currentDropTarget:i,draggingElement:n,dropPosition:o,dropInsertY:a,siblingInfo:s}=e;if("child"===o)t=i.x+i.width+d.e$.X,r=a?a-n.height/2:i.y+i.height/2-n.height/2;else{if("between"!==o&&"sibling"!==o)return null;let e=i.parentId?l[i.parentId]:null;if(e){if(t=e.x+e.width+d.e$.X,s){let{prevElement:e,nextElement:t}=s;r=t&&!e?t.y-n.height:e&&!t?e.y+e.height:e&&t?a?a-n.height/2:(e.y+e.height+t.y)/2-n.height/2:a?a-n.height/2:i.y+i.height/2-n.height/2}else r=a?a-n.height/2:i.y+i.height/2-n.height/2}else t=d.e$.X,r=a?a-n.height/2:i.y+i.height/2-n.height/2}return{x:t,y:r}},F={outline:"none",userSelect:"none",WebkitUserSelect:"none"},W={position:"absolute",top:d.uF,left:0,width:"100%",height:"100%",overflow:"hidden",zIndex:-1},X={position:"absolute",top:d.uF,left:0,overflow:"auto"},K=n.memo(e=>{let{isHelpOpen:t,toggleHelp:r}=e,i=(0,n.useRef)(null),[o,a]=(0,n.useState)(!1),{state:c,dispatch:h}=s(),{elements:u,zoomRatio:x}=c,[f,m]=(0,n.useState)(d.BH),[E,y]=(0,n.useState)(d._o),[T,C]=(0,n.useState)(d.i_),{addToast:I}=(0,L.d)(),[A,w]=(0,n.useState)({width:0,height:0}),[_,M]=(0,n.useState)("0 0 0 0"),$=Object.values(u).find(e=>e.editing),[U,K]=(0,n.useState)(null),[Y,z]=(0,n.useState)(null),[V,Z]=(0,n.useState)({});D({setCanvasSize:w,setDisplayArea:M,state:c}),N(i,!!$);let{handleMouseDown:q,handleMouseUp:J,currentDropTarget:Q,dropPosition:ee,draggingElement:et,dropInsertY:er,siblingInfo:el}=B(),{isPinching:ei,handleTouchStart:en,handleTouchMove:eo,handleTouchEnd:ea}=H({handleMouseDown:q,elements:c.elements}),es=G({dispatch:h,elements:c.elements,addToast:I});(0,n.useEffect)(()=>{$||requestAnimationFrame(()=>{let{scrollX:e,scrollY:t}=window;i.current?.focus({preventScroll:!0}),window.scrollTo(e,t)})},[$]),(0,n.useEffect)(()=>{a(!0),w({width:window.innerWidth,height:window.innerHeight}),M(`0 0 ${window.innerWidth} ${window.innerHeight-d.JY}`),m((0,p.ZF)()||d.BH),y((0,p.S4)()||d._o),C((0,p.Es)()||d.i_)},[]);let ed=(e,t,r)=>{r?h({type:"UPDATE_END_MARKER",payload:{id:e,endMarker:t}}):h({type:"UPDATE_START_MARKER",payload:{id:e,startMarker:t}}),z(null)},ec=(0,n.useCallback)((e,t)=>{et||Z(r=>{if(r[e]===t)return r;let l={...r};return t?l[e]=!0:Object.prototype.hasOwnProperty.call(l,e)&&delete l[e],l})},[et]);return(0,n.useEffect)(()=>{let e=e=>{Y&&!e.target.closest(".popup-menu")&&z(null)};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[Y]),(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("div",{style:{...W,backgroundColor:T}}),(0,l.jsxs)("div",{style:{...X,touchAction:ei?"none":"manipulation",backgroundColor:T},children:[o&&(0,l.jsxs)("svg",{"data-testid":"view-area",ref:i,width:A.width,height:A.height,viewBox:_,tabIndex:0,onKeyDown:es,onTouchStart:en,onTouchMove:eo,onTouchEnd:ea,style:{...F,touchAction:ei?"none":"manipulation",backgroundColor:T},className:"svg-element",children:[(0,l.jsx)("defs",{children:(0,l.jsx)(k,{connectionPathColor:f,connectionPathStroke:E})}),(()=>{let e={},t=[];return Object.values(u).filter(e=>e.visible).forEach(r=>{let l=r.parentId?`${r.parentId}_${r.depth}`:"root";e[l]||(e[l]=[]),e[l].push(r),r.parentId&&Object.values(u).some(e=>e.parentId===r.id&&e.visible)&&t.push(r)}),(0,l.jsxs)(l.Fragment,{children:[Object.entries(e).flatMap(e=>{let[t,r]=e;if("root"===t)return r.map(e=>{let t=Object.values(u).some(t=>t.parentId===e.id&&t.visible);return(0,l.jsxs)(n.Fragment,{children:[(0,l.jsx)(O,{element:e,currentDropTarget:Q,dropPosition:ee,draggingElement:et,handleMouseDown:q,handleMouseUp:J,onHoverChange:ec,dropInsertY:er,siblingInfo:el}),t&&(0,l.jsx)(j,{element:e,absolutePosition:{x:e.x,y:e.y},hoverId:U,onHover:K,onShowMenu:z})]},e.id)});let[i]=t.split("_"),o=u[i];if(!o)return[];let a=o.x+o.width+d.e$.X,s=o.y;return[(0,l.jsx)("g",{transform:`translate(${a}, ${s})`,className:"element-group","data-parent-id":i,"data-depth":r[0].depth,children:r.map(e=>{let t=e.x-a,r=e.y-s;return(0,l.jsx)(O,{element:{...e,x:t,y:r},currentDropTarget:Q,dropPosition:ee,draggingElement:et,handleMouseDown:t=>{q(t,e)},handleMouseUp:J,onHoverChange:ec,dropInsertY:er,siblingInfo:el},e.id)})},t)]}),t.map(e=>(0,l.jsx)(j,{element:e,absolutePosition:{x:e.x,y:e.y},hoverId:U,onHover:K,onShowMenu:z},`marker-start-${e.id}`))]})})(),Object.values(u).filter(e=>e.visible&&!!e.parentId).map(e=>{let t=u[e.parentId];return et&&(e.id===et.id||(0,g.K9)(u,et.id,e.id))?null:(0,l.jsxs)(n.Fragment,{children:[(0,l.jsx)(S,{parentElement:t,element:e,absolutePositions:{parent:{x:t.x,y:t.y},element:{x:e.x,y:e.y}},strokeColor:f,strokeWidth:E}),(0,l.jsx)(j,{element:e,absolutePosition:{x:e.x,y:e.y},isEndMarker:!0,hoverId:U,onHover:K,onShowMenu:z})]},`connection-group-${e.id}`)}).filter(Boolean),(()=>{if(!Q||!et)return null;let e="child"===ee?Q:Q.parentId?u[Q.parentId]:null;if(!e)return null;let t=P({elements:u,currentDropTarget:Q,draggingElement:et,dropPosition:ee,dropInsertY:er,siblingInfo:el});return t?(0,l.jsx)(S,{parentElement:e,element:{...et,x:t.x,y:t.y},absolutePositions:{parent:{x:e.x,y:e.y},element:{x:t.x,y:t.y}},strokeColor:d.lB.DRAGGING_COLOR,strokeWidth:d.lB.STROKE}):null})(),(()=>{let e,t;if(!Y)return null;let r=Y.startsWith("end-"),i=Y;r&&(i=Y.substring(4));let n=u[i];if(!n)return null;let o=n.height;return e=r?n.x-170:n.x+n.width+20,t=n.y+o/2-135,(0,l.jsx)(R,{popupX:e,popupY:t,isEndMarkerMenu:r,elementId:i,onMarkerSelect:ed,onClose:()=>z(null)})})(),(()=>{let e=new Set;return(Object.keys(V).forEach(t=>e.add(t)),et&&Q&&e.add(Q.id),0===e.size)?null:Array.from(e).map(e=>{let t=u[e];return t&&t.visible?(0,l.jsx)(b,{element:t,isHovered:!0,currentDropTarget:Q,dropPosition:ee,siblingInfo:el},`debug-${t.id}`):null}).filter(Boolean)})(),(()=>{if(!et||!Q)return null;let e=P({elements:u,currentDropTarget:Q,draggingElement:et,dropPosition:ee,dropInsertY:er,siblingInfo:el});return e?(0,l.jsx)("rect",{x:e.x,y:e.y,width:et.width,height:et.height,fill:"child"===ee?"rgba(103, 208, 113, 0.3)":"rgba(157, 172, 244, 0.3)",stroke:"#555",strokeDasharray:"2,2",strokeWidth:1,rx:4,ry:4,className:"drop-preview","data-exclude-from-export":"true"}):null})()]}),(0,l.jsx)(v,{element:$,onEndEditing:()=>{h({type:"END_EDITING"}),i.current?.focus()}})]})]})});var Y=r(5194),z=r(1311),V=r(1496),Z=r(9691),q=r(1081),J=r(8694),Q=r(8283),ee=r(5833),et=r(1401),er=r(2554),el=r(7040),ei=r(2152),en=r(2397),eo=r(6597),ea=r(5785);let es={TAB_BAR:{BACKGROUND:"#f0f0f0",ACTIVE_TAB_BACKGROUND:"#fff",INACTIVE_TAB_BACKGROUND:"#ddd",ACTIVE_TAB_BORDER:"#87CEFA",TAB_TEXT:"#000000",CLOSE_BUTTON_COLOR:"#666",CLOSE_BUTTON_HOVER_COLOR:"#1111ff",ADD_BUTTON_BACKGROUND:"transparent",ADD_BUTTON_TEXT:"#000"},MENU_BAR:{BACKGROUND:"#f1f1f1",ICON_COLOR:"#666666",DIVIDER_COLOR:"#e0e0e0"},MODAL:{BACKGROUND:"#ffffff",TEXT_COLOR:"#000000",BUTTON_BACKGROUND:"#f1f1f1",BUTTON_TEXT:"#000000",BUTTON_BORDER:"#cccccc",BUTTON_PRIMARY_BACKGROUND:"#1976d2",BUTTON_PRIMARY_TEXT:"#ffffff"}},ed={TAB_BAR:{BACKGROUND:"#333333",ACTIVE_TAB_BACKGROUND:"#555555",INACTIVE_TAB_BACKGROUND:"#444444",ACTIVE_TAB_BORDER:"#00aaff",TAB_TEXT:"#ffffff",CLOSE_BUTTON_COLOR:"#aaaaaa",CLOSE_BUTTON_HOVER_COLOR:"#9999ff",ADD_BUTTON_BACKGROUND:"transparent",ADD_BUTTON_TEXT:"#ffffff"},MENU_BAR:{BACKGROUND:"#333333",ICON_COLOR:"#bbbbbb",DIVIDER_COLOR:"#444444"},MODAL:{BACKGROUND:"#333333",TEXT_COLOR:"#fefefe",BUTTON_BACKGROUND:"#555555",BUTTON_TEXT:"#ffffff",BUTTON_BORDER:"#666666",BUTTON_PRIMARY_BACKGROUND:"#1976d2",BUTTON_PRIMARY_TEXT:"#ffffff"}},ec=e=>{let t=e.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,(e,t,r,l)=>t+t+r+r+l+l),r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return r?{r:parseInt(r[1],16),g:parseInt(r[2],16),b:parseInt(r[3],16)}:null},eh=e=>{let t="string"==typeof e?ec(e):e;return t?(299*t.r+587*t.g+114*t.b)/1e3:255},ep=e=>128>eh(e),eu=e=>ep(e)?ed:es;var ex=r(9137),ef=r.n(ex);let em=e=>{let{isLoading:t,size:r=24,color:i="#4B5563"}=e;return t?(0,l.jsxs)("div",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",zIndex:9999},className:"jsx-ff161281ed666c63",children:[(0,l.jsx)("div",{style:{width:`${r}px`,height:`${r}px`,border:"3px solid rgba(0, 0, 0, 0.1)",borderRadius:"50%",borderTop:`3px solid ${i}`,animation:"spin 1s linear infinite"},className:"jsx-ff161281ed666c63"}),(0,l.jsx)(ef(),{id:"ff161281ed666c63",children:"@-webkit-keyframes spin{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@-moz-keyframes spin{0%{-moz-transform:rotate(0deg);transform:rotate(0deg)}100%{-moz-transform:rotate(360deg);transform:rotate(360deg)}}@-o-keyframes spin{0%{-o-transform:rotate(0deg);transform:rotate(0deg)}100%{-o-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes spin{0%{-webkit-transform:rotate(0deg);-moz-transform:rotate(0deg);-o-transform:rotate(0deg);transform:rotate(0deg)}100%{-webkit-transform:rotate(360deg);-moz-transform:rotate(360deg);-o-transform:rotate(360deg);transform:rotate(360deg)}}"})]}):null},eg={NEW:"新規作成",OPEN:"ファイルを開く",SAVE:"保存（JSON形式）",SAVE_SVG:"SVG画像で保存",ADD:"新しい要素の追加",DELETE:"要素の削除",AI:"AI機能",EXPAND:"展開",COLLAPSE:"折りたたみ",UNDO:"元に戻す",REDO:"やり直す",ZOOM_IN:"ズームイン",ZOOM_OUT:"ズームアウト",HELP:"ヘルプを表示",SETTINGS:"設定"};var eE=r(5857),ey=r(514);let eT=e=>{let{tooltip:t,onClick:r,icon:i,iconColor:n}=e;return(0,l.jsx)(ey.A,{title:t,children:(0,l.jsx)(eE.A,{variant:"text",className:"iconbar-button",onClick:r,children:(0,l.jsx)(i,{sx:{color:n}})})})},eO=e=>{let{color:t}=e;return(0,l.jsx)("div",{style:{width:"10px",backgroundColor:t,height:"60%",margin:"0 5px",opacity:.3}})},eb=e=>{let{saveSvg:t,loadElements:r,saveElements:i,toggleHelp:o,toggleSettings:a,onAIClick:c}=e,{dispatch:h,state:u}=s(),{addTab:x}=(0,E.u)(),f=(0,n.useRef)(null),m=(0,n.useRef)(null),g=y(),[T,O]=(0,n.useState)(!1),b=(0,n.useCallback)(e=>()=>{"ZOOM_IN"===e||"ZOOM_OUT"===e?(O(!0),setTimeout(()=>{h({type:e}),setTimeout(()=>{O(!1)},300)},50)):h({type:e})},[h]);if(!g)return null;let C=eu((0,p.Es)());return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("div",{style:{position:"fixed",width:"100%",height:d.JY,overflowX:"auto",WebkitOverflowScrolling:"touch",msOverflowStyle:"none",scrollbarWidth:"none"},ref:m,children:(0,l.jsxs)("div",{style:{display:"flex",justifyContent:"left",alignItems:"center",height:"100%",backgroundColor:C.MENU_BAR.BACKGROUND,padding:"0 20px",minWidth:"max-content"},children:[(0,l.jsx)("input",{type:"file",ref:f,onChange:r,style:{display:"none"}}),(0,l.jsx)(eT,{tooltip:eg.NEW,onClick:x,icon:Z.A,iconColor:C.MENU_BAR.ICON_COLOR}),(0,l.jsx)(eT,{tooltip:eg.OPEN,onClick:()=>{f.current?.click()},icon:Y.A,iconColor:C.MENU_BAR.ICON_COLOR}),(0,l.jsx)(eT,{tooltip:eg.SAVE,onClick:i,icon:z.A,iconColor:C.MENU_BAR.ICON_COLOR}),(0,l.jsx)(eT,{tooltip:eg.SAVE_SVG,onClick:t,icon:V.A,iconColor:C.MENU_BAR.ICON_COLOR}),(0,l.jsx)(eO,{color:C.MENU_BAR.DIVIDER_COLOR}),(0,l.jsx)(eT,{tooltip:eg.ADD,onClick:b("ADD_ELEMENT"),icon:q.A,iconColor:C.MENU_BAR.ICON_COLOR}),(0,l.jsx)(eT,{tooltip:eg.DELETE,onClick:b("DELETE_ELEMENT"),icon:J.A,iconColor:C.MENU_BAR.ICON_COLOR}),(0,l.jsx)(eT,{tooltip:eg.AI,onClick:c,icon:Q.A,iconColor:C.MENU_BAR.ICON_COLOR}),(0,l.jsx)(eT,{tooltip:eg.EXPAND,onClick:b("EXPAND_ELEMENT"),icon:ee.A,iconColor:C.MENU_BAR.ICON_COLOR}),(0,l.jsx)(eT,{tooltip:eg.COLLAPSE,onClick:b("COLLAPSE_ELEMENT"),icon:et.A,iconColor:C.MENU_BAR.ICON_COLOR}),(0,l.jsx)(eO,{color:C.MENU_BAR.DIVIDER_COLOR}),(0,l.jsx)(eT,{tooltip:eg.UNDO,onClick:b("UNDO"),icon:er.A,iconColor:C.MENU_BAR.ICON_COLOR}),(0,l.jsx)(eT,{tooltip:eg.REDO,onClick:b("REDO"),icon:el.A,iconColor:C.MENU_BAR.ICON_COLOR}),(0,l.jsx)(eO,{color:C.MENU_BAR.DIVIDER_COLOR}),(0,l.jsx)(eT,{tooltip:eg.ZOOM_IN,onClick:b("ZOOM_IN"),icon:ei.A,iconColor:C.MENU_BAR.ICON_COLOR}),(0,l.jsx)(eT,{tooltip:eg.ZOOM_OUT,onClick:b("ZOOM_OUT"),icon:en.A,iconColor:C.MENU_BAR.ICON_COLOR}),(0,l.jsx)(eO,{color:C.MENU_BAR.DIVIDER_COLOR}),(0,l.jsx)(eT,{tooltip:eg.HELP,onClick:o,icon:eo.A,iconColor:C.MENU_BAR.ICON_COLOR}),(0,l.jsx)(eT,{tooltip:eg.SETTINGS,onClick:a,icon:ea.A,iconColor:C.MENU_BAR.ICON_COLOR})]})}),T&&(0,l.jsx)("div",{style:{position:"fixed",zIndex:9500,width:"100%",height:"100%",pointerEvents:"none"},children:(0,l.jsx)(em,{isLoading:T,size:32,color:"#4B5563"})})]})},eC=n.memo(e=>{let{tab:t,isCurrent:r,closeTab:i,switchTab:o,theme:a}=e,s=y(),[d,c]=(0,n.useState)(!1);return s?(0,l.jsxs)("div",{style:{padding:"6px",marginRight:"4px",backgroundColor:r?a.TAB_BAR.ACTIVE_TAB_BACKGROUND:a.TAB_BAR.INACTIVE_TAB_BACKGROUND,borderBottom:r?`3px solid ${a.TAB_BAR.ACTIVE_TAB_BORDER}`:"none",paddingBottom:"3px",borderRadius:"5px 5px 0 0",fontSize:"12px",display:"flex",alignItems:"center",color:a.TAB_BAR.TAB_TEXT,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",minWidth:"48px",maxWidth:"150px"},onClick:()=>o(t.id),children:[(0,l.jsx)("span",{style:{flex:"1 1 auto",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",minWidth:"0"},children:t.name}),(0,l.jsx)("button",{onClick:e=>{e.stopPropagation(),i(t.id)},onMouseEnter:()=>c(!0),onMouseLeave:()=>c(!1),style:{flex:"0 0 auto",marginLeft:"2px",border:"0",backgroundColor:"transparent",fontSize:"16px",color:d?a.TAB_BAR.CLOSE_BUTTON_HOVER_COLOR||"#9999ff":a.TAB_BAR.CLOSE_BUTTON_COLOR,fontWeight:"bold",cursor:"pointer",transition:"color 0.2s ease"},children:"\xd7"})]}):null}),eI=n.memo(e=>{let{tabs:t,currentTabId:r,addTab:i,closeTab:o,switchTab:a}=e,s=y(),[c,h]=(0,n.useState)(d.i_),[u,x]=(0,n.useState)(()=>eu(d.i_));return((0,n.useEffect)(()=>{if(!s)return;let e=(0,p.Es)();h(e),x(eu(e))},[s]),s)?(0,l.jsxs)("div",{style:{display:"flex",alignItems:"center",backgroundColor:u.TAB_BAR.BACKGROUND,width:"100%",height:d.FM,marginTop:d.JY,position:"fixed"},children:[t.map(e=>(0,l.jsx)(eC,{tab:e,isCurrent:r===e.id,closeTab:o,switchTab:a,theme:u},e.id)),(0,l.jsx)("button",{onClick:i,style:{marginLeft:"8px",backgroundColor:u.TAB_BAR.ADD_BUTTON_BACKGROUND,color:u.TAB_BAR.ADD_BUTTON_TEXT,border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"16px",padding:"2px 8px"},children:"+"})]}):null}),ev=e=>{let{isOpen:t,onClose:r,children:i,closeOnOverlayClick:o=!0}=e,a=y(),[d,c]=(0,n.useState)(()=>eu((0,p.Es)())),{dispatch:h}=s(),[u,x]=(0,n.useState)(!1);(0,n.useEffect)(()=>{a&&c(eu((0,p.Es)()))},[a]),(0,n.useEffect)(()=>{t&&(h({type:"END_EDITING"}),x(!0))},[t,h]);let f=()=>{x(!1),setTimeout(()=>{r()},300)};if(!t)return null;let m=`
        0 10px 15px -3px rgba(0, 0, 0, 0.1),
        0 4px 6px -2px rgba(0, 0, 0, 0.05),
        0 0 0 1px rgba(255, 255, 255, 0.1)
    `;return(0,l.jsx)("div",{style:{position:"fixed",top:0,left:0,width:"100%",height:"100%",backgroundColor:"rgba(0, 0, 0, 0.6)",display:"flex",justifyContent:"center",alignItems:"center",zIndex:9e3,backdropFilter:"blur(3px)",opacity:+!!u,transition:"opacity 0.3s ease-in-out"},onClick:e=>{o&&f()},children:(0,l.jsxs)("div",{style:{backgroundColor:d.MODAL.BACKGROUND,color:d.MODAL.TEXT_COLOR,padding:"20px 24px 24px",borderRadius:"16px",width:"80%",maxWidth:"500px",overflow:"hidden",position:"relative",zIndex:9001,boxShadow:m,transform:u?"translateY(0) scale(1)":"translateY(20px) scale(0.95)",transition:"transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease-in-out",opacity:+!!u},onClick:e=>e.stopPropagation(),children:[(0,l.jsx)("button",{onClick:f,style:{position:"absolute",right:16,top:16,background:`${d.MODAL.TEXT_COLOR}15`,border:"none",borderRadius:"50%",width:"32px",height:"32px",display:"flex",justifyContent:"center",alignItems:"center",fontSize:"1.2em",color:d.MODAL.TEXT_COLOR,cursor:"pointer",transition:"all 0.2s ease",outline:"none"},onMouseOver:e=>{e.currentTarget.style.background=`${d.MODAL.TEXT_COLOR}25`,e.currentTarget.style.transform="scale(1.1)"},onMouseOut:e=>{e.currentTarget.style.background=`${d.MODAL.TEXT_COLOR}15`,e.currentTarget.style.transform="scale(1)"},children:"\xd7"}),(0,l.jsx)("div",{style:{position:"relative",maxHeight:"calc(80vh - 56px)",marginTop:"32px",overflowY:"auto",overflowX:"hidden",scrollbarWidth:"thin",scrollbarColor:`${d.MODAL.TEXT_COLOR}40 transparent`},children:i})]})})};var eA=r(2582),ew=r(7498),ek=r(9284),eR=r(9868),ej=r(7923),eS=r(3025),e_=r(8893),eD=r(5358),eN=r(7298),eL=r(9439),eM=r(4512),e$=r(8410);let eB=e=>{let{field:t,value:r,error:i=!1,onChange:n}=e;switch(t.type){case"text":return(0,l.jsx)(eA.A,{label:t.label,value:r,onChange:e=>n(e.target.value),fullWidth:!0,margin:"normal",multiline:"prompt"===t.key||"systemPromptTemplate"===t.key,rows:"prompt"===t.key||"systemPromptTemplate"===t.key?6:1,type:"apiKey"===t.key?"password":"text",helperText:t.helperText,variant:"prompt"===t.key||"systemPromptTemplate"===t.key?"outlined":"standard"});case"number":return(0,l.jsx)(eA.A,{label:t.label,type:"number",value:r,onChange:e=>n(e.target.value),fullWidth:!0,margin:"normal",inputProps:{min:t.validation?.min,max:t.validation?.max,step:t.validation?.step},error:i,helperText:i?`${t.validation?.min}から${t.validation?.max}の数値を入力してください`:t.helperText});case"select":return(0,l.jsxs)(ew.A,{fullWidth:!0,margin:"normal",children:[(0,l.jsx)(ek.A,{children:t.label}),(0,l.jsx)(eR.A,{value:String(r),label:t.label,onChange:e=>{n(e.target.value)},MenuProps:{sx:{zIndex:9999}},children:t.options?.map(e=>l.jsx(ej.A,{value:e.value,children:e.label},e.value))}),(0,l.jsx)(eS.A,{children:t.helperText})]});case"color":return(0,l.jsxs)(e_.A,{sx:{display:"flex",alignItems:"center",mt:2,mb:1},children:[(0,l.jsxs)(eD.A,{variant:"body1",sx:{mr:2,width:"120px"},children:[t.label,":"]}),(0,l.jsx)("input",{type:"color",value:String(r),onChange:e=>n(e.target.value)}),(0,l.jsx)(eS.A,{children:t.helperText})]});case"radio":return(0,l.jsxs)(ew.A,{component:"fieldset",fullWidth:!0,children:[(0,l.jsx)(eN.A,{component:"legend",children:t.label}),(0,l.jsx)(eL.A,{children:t.options?.map(e=>l.jsx(eM.A,{value:e.value,control:l.jsx(e$.A,{checked:r===e.value,onChange:e=>n(e.target.value)}),label:e.label},e.value))}),(0,l.jsx)(eS.A,{children:t.helperText})]});default:return null}};var eH=r(5055),eU=r(460),eG=r(270),eP=r(3745),eF=r(7790),eW=r(5787);let eX=[{id:0,label:"Elements Setting",fields:[{key:"numberOfSections",label:"Number of sections",type:"number",helperText:"同時に表示するセクションの数（1〜10） ※現在のタブと新規作成されるタブのデフォルト値として設定されます",defaultValue:3,validation:{min:1,max:10,required:!0}},{key:"markerType",label:"Default Marker Type",type:"select",helperText:"新規要素作成時のデフォルトマーカータイプ",defaultValue:d.vX.NONE,options:[{value:d.vX.NONE,label:"None"},{value:d.vX.ARROW,label:"Arrow"},{value:d.vX.CIRCLE,label:"Circle"},{value:d.vX.SQUARE,label:"Square"},{value:d.vX.DIAMOND,label:"Diamond"},{value:d.vX.FILLED_ARROW,label:"Filled Arrow"},{value:d.vX.FILLED_CIRCLE,label:"Filled Circle"},{value:d.vX.FILLED_SQUARE,label:"Filled Square"},{value:d.vX.FILLED_DIAMOND,label:"Filled Diamond"}]},{key:"canvasBackgroundColor",label:"Canvas Background Color",type:"color",helperText:"キャンバスの背景色",defaultValue:d.i_},{key:"elementColor",label:"Element Color",type:"color",helperText:"要素の背景色",defaultValue:d.iC.NORMAL.COLOR},{key:"textColor",label:"Text Color",type:"color",helperText:"テキストの色",defaultValue:d._K},{key:"strokeColor",label:"Stroke Color",type:"color",helperText:"要素の枠線色",defaultValue:d.iC.NORMAL.STROKE_COLOR},{key:"selectedStrokeColor",label:"Selected Stroke Color",type:"color",helperText:"選択時の要素の枠線色",defaultValue:d.iC.SELECTED.STROKE_COLOR},{key:"strokeWidth",label:"Stroke Width",type:"number",helperText:"要素の枠線の太さ",defaultValue:1,validation:{min:0,step:.5,required:!0}},{key:"connectionPathColor",label:"Connection Path Color",type:"color",helperText:"接続線の色",defaultValue:d.BH},{key:"connectionPathStroke",label:"Connection Path Stroke",type:"number",helperText:"接続線の太さ",defaultValue:1,validation:{min:.5,step:.5,required:!0}},{key:"fontFamily",label:"Font Family",type:"text",helperText:"表示に使用するフォントファミリ",defaultValue:""}]},{id:1,label:"API Setting",fields:[{key:"modelType",label:"Select Model",type:"radio",helperText:"APIモデルの選択",defaultValue:"gemini-1.5-flash",options:[{value:"gemini-1.5-flash",label:"Gemini-1.5-flash"},{value:"gemini-2.0-flash",label:"Gemini-2.0-flash"}]},{key:"apiKey",label:"Gemini API Key",type:"text",helperText:"入力されたキーは暗号化してlocalStorageに保存されます。サーバに送信されることはありません。",defaultValue:""}]},{id:2,label:"Prompt",fields:[{key:"prompt",label:"inputText",type:"text",helperText:"",defaultValue:""},{key:"systemPromptTemplate",label:"SystemPromptTemplate",type:"text",helperText:"",defaultValue:""}]}],eK=(e,t)=>{let r={};t.forEach(t=>{void 0!==e[t.key]&&(r[t.key]=e[t.key])});let l=new Blob([JSON.stringify(r,null,2)],{type:"application/json"}),i=URL.createObjectURL(l),n=document.createElement("a");n.href=i,n.download=`theme-settings-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(n),n.click(),setTimeout(()=>{document.body.removeChild(n),URL.revokeObjectURL(i)},0)},eY=(e,t)=>{if("number"===e.type){let r="string"==typeof t?parseFloat(t):t;if(e.validation?.required&&(""===t||isNaN(r))||!isNaN(r)&&(e.validation?.min!==void 0&&r<e.validation.min||e.validation?.max!==void 0&&r>e.validation.max))return!1}return!0},ez=(e,t,r,l)=>{let i={...t},n={...r},o=!1;return l.forEach(t=>{void 0!==e[t.key]&&(eY(t,e[t.key])?(i[t.key]=e[t.key],n[t.key]=!1):(o=!0,n[t.key]=!0))}),{newValues:i,newErrors:n,hasError:o}},eV=e=>{let{isOpen:t,onClose:r}=e,i=y(),[o,a]=(0,n.useState)(0),[s,d]=(0,n.useState)({}),[c,h]=(0,n.useState)({}),[u,x]=(0,n.useState)("light"),[f,m]=(0,n.useState)(()=>eu((0,p.Es)())),g=(0,n.useRef)(null),{getCurrentTabNumberOfSections:T,updateCurrentTabNumberOfSections:O}=(0,E.u)();if((0,n.useEffect)(()=>{let e=(0,p.Es)();x(ep(e)?"dark":"light"),m(eu(e))},[i]),(0,n.useEffect)(()=>{i&&t&&(async()=>{let e={};try{e.apiKey=await (0,p.CG)(),e.systemPromptTemplate=(0,p.k0)(),e.modelType=(0,p.OA)(),e.prompt=(0,p.XH)(),e.numberOfSections=T(),e.elementColor=(0,p.kN)(),e.strokeColor=(0,p._1)(),e.strokeWidth=(0,p.xo)(),e.fontFamily=(0,p.af)(),e.markerType=(0,p.zn)(),e.connectionPathColor=(0,p.ZF)(),e.connectionPathStroke=(0,p.S4)(),e.canvasBackgroundColor=(0,p.Es)(),e.textColor=(0,p.vG)(),e.selectedStrokeColor=(0,p.N4)(),d(e)}catch(e){console.error("Failed to load settings:",e)}})()},[i,t,T]),!i)return null;let b=(0,eG.A)({palette:{mode:u,background:{default:f.MODAL.BACKGROUND,paper:f.MODAL.BACKGROUND},text:{primary:f.MODAL.TEXT_COLOR,secondary:f.MODAL.TEXT_COLOR}},components:{MuiButton:{styleOverrides:{root:{color:f.MODAL.BUTTON_TEXT,borderColor:f.MODAL.BUTTON_BORDER},contained:{backgroundColor:f.MODAL.BUTTON_PRIMARY_BACKGROUND,color:f.MODAL.BUTTON_PRIMARY_TEXT,"&:hover":{backgroundColor:f.MODAL.BUTTON_PRIMARY_BACKGROUND,opacity:.9}},outlined:{backgroundColor:f.MODAL.BUTTON_BACKGROUND,"&:hover":{backgroundColor:f.MODAL.BUTTON_BACKGROUND,opacity:.9}}}}}}),C=(e,t)=>{if("number"===e.type){let r="string"==typeof t?parseFloat(t):t;if(e.validation?.required&&(""===t||isNaN(r))||!isNaN(r)&&(e.validation?.min!==void 0&&r<e.validation.min||e.validation?.max!==void 0&&r>e.validation.max))return!1}return!0},I=(e,t)=>{d(r=>({...r,[e.key]:t})),h(r=>({...r,[e.key]:!C(e,t)}))},v=async()=>{let e=!1;if(eX.forEach(t=>{t.fields.forEach(t=>{let r=s[t.key];C(t,r)||(e=!0,h(e=>({...e,[t.key]:!0})))})}),e)return;let t=s.apiKey;void 0!==t&&await (0,p.wt)(String(t));let l=s.systemPromptTemplate;void 0!==l&&(0,p.mF)(String(l));let i=s.modelType;void 0!==i&&(0,p.Iz)(String(i));let n=s.prompt;void 0!==n&&(0,p.bJ)(String(n));let o=s.numberOfSections;void 0!==o&&O(Number(o));let a=s.elementColor;void 0!==a&&(0,p.qu)(String(a));let d=s.strokeColor;void 0!==d&&(0,p.JT)(String(d));let c=s.strokeWidth;void 0!==c&&(0,p.Jg)(Number(c));let u=s.fontFamily;void 0!==u&&(0,p.Yu)(String(u));let x=s.markerType;void 0!==x&&(0,p.li)(String(x));let f=s.connectionPathColor;void 0!==f&&(0,p.xN)(String(f));let m=s.connectionPathStroke;void 0!==m&&(0,p.K2)(Number(m));let g=s.canvasBackgroundColor;void 0!==g&&(0,p.QY)(String(g));let E=s.textColor;void 0!==E&&(0,p.vY)(String(E));let y=s.selectedStrokeColor;void 0!==y&&(0,p.LL)(String(y)),r()};return(0,l.jsx)(ev,{isOpen:t,onClose:r,closeOnOverlayClick:!1,children:(0,l.jsx)(eP.A,{theme:b,children:(0,l.jsxs)(e_.A,{sx:{backgroundColor:f.MODAL.BACKGROUND,color:f.MODAL.TEXT_COLOR,padding:2,borderRadius:1,display:"flex",flexDirection:"column",height:"80vh",maxHeight:600},children:[(0,l.jsx)(eD.A,{variant:"h6",gutterBottom:!0,color:"textPrimary",children:"Preference"}),(0,l.jsx)(eH.A,{value:o,onChange:(e,t)=>a(t),textColor:"primary",indicatorColor:"primary",children:eX.map(e=>(0,l.jsx)(eU.A,{label:e.label},e.id))}),(0,l.jsx)(e_.A,{sx:{mt:2,flex:1,overflowY:"auto","&::-webkit-scrollbar":{width:"8px"},"&::-webkit-scrollbar-track":{background:"transparent"},"&::-webkit-scrollbar-thumb":{background:f.MODAL.TEXT_COLOR,opacity:.2,borderRadius:"4px"}},children:eX.map(e=>o===e.id&&(0,l.jsx)(e_.A,{children:e.fields.map(e=>(0,l.jsx)(eB,{field:e,value:s[e.key]??e.defaultValue,error:c[e.key],onChange:t=>I(e,t)},e.key))},e.id))}),(0,l.jsxs)(e_.A,{sx:{mt:2,pt:2,display:"flex",justifyContent:"space-between",alignItems:"center",borderTop:`1px solid ${f.MODAL.TEXT_COLOR}20`,backgroundColor:f.MODAL.BACKGROUND},children:[(0,l.jsx)("input",{type:"file",ref:g,onChange:e=>{let t=e.target.files?.[0];if(!t)return;let r=new FileReader;r.onload=t=>{try{let r=t.target?.result,l=JSON.parse(r),{newValues:i,newErrors:n,hasError:o}=ez(l,s,c,eX[0].fields);o&&alert("Some imported settings are invalid and will be ignored."),d(i),h(n),e.target&&(e.target.value="")}catch(e){console.error("Failed to parse imported settings:",e),alert("Failed to parse imported settings. Please check the file format.")}},r.readAsText(t)},accept:".json",style:{display:"none"}}),(0,l.jsx)(e_.A,{sx:{display:"flex",gap:2},children:0===o&&(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(eE.A,{variant:"outlined",startIcon:(0,l.jsx)(eF.A,{}),onClick:()=>{eK(s,eX[0].fields)},children:"Export"}),(0,l.jsx)(eE.A,{variant:"outlined",startIcon:(0,l.jsx)(eW.A,{}),onClick:()=>{g.current&&g.current.click()},children:"Import"})]})}),(0,l.jsxs)(e_.A,{sx:{display:"flex",gap:1},children:[(0,l.jsx)(eE.A,{variant:"outlined",onClick:r,children:"Cancel"}),(0,l.jsx)(eE.A,{variant:"contained",onClick:v,color:"primary",disabled:Object.values(c).some(Boolean),children:"OK"})]})]})]})})})},eZ=e=>{let{showCloseConfirm:t,setShowCloseConfirm:r,tabToClose:i,closeTab:n}=e;if(!t)return null;let o=eu((0,p.Es)());return(0,l.jsx)(ev,{isOpen:t,onClose:()=>r(!1),closeOnOverlayClick:!1,children:(0,l.jsxs)("div",{style:{padding:"10px 5px 20px",textAlign:"center"},children:[(0,l.jsxs)("div",{style:{marginBottom:"20px",display:"flex",flexDirection:"column",alignItems:"center",gap:"15px"},children:[(0,l.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"15px",marginBottom:"10px"},children:[(0,l.jsx)("div",{style:{width:"40px",height:"40px",borderRadius:"50%",backgroundColor:`${o.MODAL.TEXT_COLOR}15`,display:"flex",justifyContent:"center",alignItems:"center"},children:(0,l.jsxs)("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[(0,l.jsx)("path",{d:"M12 5V13",stroke:o.MODAL.TEXT_COLOR,strokeWidth:"2",strokeLinecap:"round"}),(0,l.jsx)("circle",{cx:"12",cy:"17",r:"1",fill:o.MODAL.TEXT_COLOR})]})}),(0,l.jsx)("h3",{style:{margin:0,fontSize:"20px",fontWeight:600},children:"確認"})]}),(0,l.jsx)("p",{style:{margin:"0 0 10px",fontSize:"15px",opacity:.8,lineHeight:1.5,maxWidth:"350px"},children:"タブを閉じてよろしいですか？"})]}),(0,l.jsxs)("div",{style:{display:"flex",justifyContent:"center",gap:"16px",marginTop:"30px"},children:[(0,l.jsx)(eE.A,{variant:"outlined",onClick:()=>r(!1),sx:{borderRadius:"8px",padding:"8px 20px",fontSize:"14px",fontWeight:500,textTransform:"none",boxShadow:"none",transition:"all 0.2s ease",backgroundColor:o.MODAL.BUTTON_BACKGROUND,borderColor:o.MODAL.BUTTON_BORDER,color:o.MODAL.BUTTON_TEXT,"&:hover":{backgroundColor:o.MODAL.BUTTON_BACKGROUND,opacity:.9}},children:"いいえ"}),(0,l.jsx)(eE.A,{variant:"contained",onClick:()=>{i&&n(i),r(!1)},sx:{borderRadius:"8px",padding:"8px 20px",fontSize:"14px",fontWeight:500,textTransform:"none",boxShadow:"none",transition:"all 0.2s ease",backgroundColor:o.MODAL.BUTTON_PRIMARY_BACKGROUND,color:o.MODAL.BUTTON_PRIMARY_TEXT,"&:hover":{backgroundColor:o.MODAL.BUTTON_PRIMARY_BACKGROUND,opacity:.9}},children:"はい"})]})]})})},eq=`
<h4>Keyboard shortcuts</h4>
<p>Tab: Add a child element to the selected element</p>
<p>Shift + Tab: Add a sibling element to the selected element</p>
<p>Delete/Backspace: Remove the selected element</p>
<p>Enter: Edit the selected element</p>
<p>Esc: Stop editing the selected element</p>
<p>Tab in editing mode: Move the focus to the next text box</p>
<p>Ctrl + Z: Undo the last action</p>
<p>Shift + Ctrl + Z: Redo the last action</p>
<p>Ctrl + X: Cut the selected element</p>
<p>Ctrl + C: Copy the selected element</p>
<p>Ctrl + V: Paste the copied element</p>
<p>Ctrl + ArrowLeft: Collapse the children of the selected element</p>
<p>Ctrl + ArrowRight: Expand the children of the selected element</p>
<p>Arrow keys: Navigate between elements</p>

<h4>Mouse operations</h4>
<p>Click: Select an element</p>
<p>Double click: Edit the selected element</p>
<p>Clicking outside the element will end the editing mode</p>
<p>Drag: Move the selected element</p>

<h4>Menu operations</h4>
<p>New: Create a new diagram. Unsaved changes will be discarded.</p>
<p>Open: Load saved data. The current data will be discarded.</p>
<p>Save as: Save the diagram data in JSON format</p>
<p>Export: Export the diagram in SVG format</p>
`;var eJ=r(1231),eQ=r(6497),e0=r(3464);let e1=async(e,t,r)=>{try{console.log("prompt: \n",e);let r=`${(0,p.G6)()}?key=${t}`,l=await e0.A.post(r,{contents:[{parts:[{text:e}]}]},{headers:{"Content-Type":"application/json"}}),i=l.data.candidates?.[0]?.content?.parts?.[0]?.text||"";return console.log(i),i}catch(e){throw console.error("Gemini API Error:",e),Error("API呼び出しに失敗しました")}};var e2=r(1050);let e5=e=>{let{structureText:t,inputText:r}=e;return(0,p.k0)().replace("{{structureText}}",t).replace("{{inputText}}",r)},e3=()=>{let{tabs:e,currentTabId:t,addTab:r,closeTab:o,switchTab:s,updateTabState:d,updateTabName:c}=(0,E.u)(),h=(0,n.useMemo)(()=>e.find(e=>e.id===t),[e,t]),[u,x]=(0,n.useState)(!1),[f,m]=(0,n.useState)(!1),[g,y]=(0,n.useState)(null),[T,O]=(0,n.useState)(!1),{addToast:b}=(0,L.d)(),C=(0,n.useCallback)(e=>{d(t,t=>(0,eJ.F)(t,e))},[t,d]),I=(0,n.useCallback)(()=>{C({type:"END_EDITING"}),x(e=>!e)},[C]),v=(0,n.useCallback)(()=>{C({type:"END_EDITING"}),m(e=>!e)},[C]),A=e=>{y(e),O(!0)},w=(0,n.useCallback)(async()=>{if(!h)return;let e=Object.values(h.state.elements).find(e=>e.selected);if(!e){b(i.noSelect);return}let t=await (0,p.CG)();if(!t){b(i.noApiKey,"warn");return}let r=localStorage.getItem("prompt")||"";if(!r){b(i.noPrompt);return}try{let l=(0,e2.YV)(h.state.elements,e.id),i=e5({structureText:l,inputText:r}),n=(0,p.OA)(),o=await e1(i,t,n),a=[];Array.isArray(o)?a=o:"string"==typeof o&&(a=(o.match(/```[\s\S]*?```/g)||[]).flatMap(e=>e.replace(/```/g,"").split("\n").map(e=>e.trim()).filter(e=>e.length>0))),C({type:"ADD_ELEMENTS_SILENT",payload:{parentId:e.id,texts:a,tentative:!0}})}catch(e){b(e instanceof Error?`${i.aiError}: ${e.message}`:i.aiError)}},[h,C,b]),k=(0,n.useMemo)(()=>h?(0,l.jsxs)(a,{state:h.state,dispatch:C,children:[(0,l.jsx)(K,{isHelpOpen:u,toggleHelp:I}),(0,l.jsx)(eI,{tabs:e,currentTabId:t,addTab:r,closeTab:A,switchTab:s}),(0,l.jsx)(eb,{saveSvg:()=>(0,eQ.Sz)(document.querySelector(".svg-element"),"download.svg"),loadElements:e=>(0,eQ.wl)(e.nativeEvent).then(e=>{let{elements:r,fileName:l}=e;C({type:"LOAD_ELEMENTS",payload:r}),c(t,l.replace(".json",""))}).catch(e=>b(e.message)),saveElements:()=>(0,eQ.$r)(Object.values(h.state.elements),h.name),toggleHelp:I,toggleSettings:v,onAIClick:w}),(0,l.jsx)(eZ,{showCloseConfirm:T,setShowCloseConfirm:O,tabToClose:g,closeTab:o}),(0,l.jsx)(eV,{isOpen:f,onClose:v}),(0,l.jsx)(ev,{isOpen:u,onClose:I,children:(0,l.jsx)("div",{dangerouslySetInnerHTML:{__html:eq}})})]}):null,[h,C,I,u,t,c,v,b,w,T,g,o,f]);return(0,l.jsx)("div",{children:k})}}},e=>{var t=t=>e(e.s=t);e.O(0,[675,980,441,684,358],()=>t(653)),_N_E=e.O()}]);